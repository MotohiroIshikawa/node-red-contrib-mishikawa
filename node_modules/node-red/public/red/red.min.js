/**
 * Copyright JS Foundation and other contributors, http://js.foundation
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 **/
var RED={};RED.events=function(){var e={};return{on:function(t,n){e[t]=e[t]||[],e[t].push(n)},off:function(t,n){var o=e[t];if(o)for(var a=0;a<o.length;a++)if(o[a]===n)return void o.splice(a,1)},emit:function(t,n){if(e[t])for(var o=0;o<e[t].length;o++)try{e[t][o](n)}catch(e){console.log("RED.events.emit error: ["+t+"] "+e.toString()),console.log(e)}}}}(),RED.i18n={init:function(e){i18n.init({resGetPath:"locales/__ns__?lng=__lng__",dynamicLoad:!1,load:"current",ns:{namespaces:["editor","node-red","jsonata","infotips"],defaultNs:"editor"},fallbackLng:["en-US"],useCookie:!1},function(){e()}),RED._=function(){return i18n.t.apply(null,arguments)}},loadCatalog:function(e,t){var n=i18n.functions.toLanguages(i18n.detectLanguage()),o=n.length;n.forEach(function(n){$.ajax({headers:{Accept:"application/json"},cache:!1,url:"locales/"+e+"?lng="+n,success:function(a){i18n.addResourceBundle(n,e,a),0==--o&&t()}})})},loadNodeCatalogs:function(e){var t=i18n.functions.toLanguages(i18n.detectLanguage()),n=t.length;t.forEach(function(t){$.ajax({headers:{Accept:"application/json"},cache:!1,url:"locales/nodes?lng="+t,success:function(o){Object.keys(o).forEach(function(e){i18n.addResourceBundle(t,e,o[e])}),0==--n&&e()}})})}},RED.settings=function(){var e,t={},n={},o=function(){try{return"localStorage"in window&&null!==window.localStorage}catch(e){return!1}},a=function(e){n=e},i=function(e){$.ajax({headers:{Accept:"application/json"},dataType:"json",cache:!1,url:"settings",success:function(n){!function(e){for(var n in t)t.hasOwnProperty(n)&&RED.settings.hasOwnProperty(n)&&delete RED.settings[n];for(n in e)e.hasOwnProperty(n)&&(RED.settings[n]=e[n]);t=e}(n),RED.settings.user&&!RED.settings.user.anonymous||RED.settings.remove("auth-tokens"),console.log("Node-RED: "+n.version),s(e)},error:function(t,n,o){401===t.status?(/[?&]access_token=(.*?)(?:$|&)/.test(window.location.search)&&(window.location.search=""),RED.user.login(function(){i(e)})):console.log("Unexpected error loading settings:",t.status,n)}})};function s(e){$.ajax({headers:{Accept:"application/json"},dataType:"json",cache:!1,url:"settings/user",success:function(t){a(t),e()},error:function(e,t,n){console.log("Unexpected error loading user settings:",e.status,t)}})}function r(){RED.user.hasPermission("settings.write")&&(e&&clearTimeout(e),e=setTimeout(function(){e=null,$.ajax({method:"POST",contentType:"application/json",url:"settings/user",data:JSON.stringify(n),success:function(e){},error:function(e,t,n){console.log("Unexpected error saving user settings:",e.status,t)}})},300))}return{init:function(e){var t=/[?&]access_token=(.*?)(?:$|&)/.exec(window.location.search);if(t){var n=t[1];RED.settings.set("auth-tokens",{access_token:n}),window.location.search=""}$.ajaxSetup({beforeSend:function(e,t){if(!/^\s*(https?:|\/|\.)/.test(t.url)){var n=RED.settings.get("auth-tokens");n&&e.setRequestHeader("Authorization","Bearer "+n.access_token),e.setRequestHeader("Node-RED-API-Version","v2")}}}),i(e)},load:i,loadUserSettings:s,set:function(e,t){o()&&("auth-tokens"===e?localStorage.setItem(e,JSON.stringify(t)):(n[e]=t,r()))},get:function(e){if(o())return"auth-tokens"===e?JSON.parse(localStorage.getItem(e)):n[e]},remove:function(e){o()&&("auth-tokens"===e?localStorage.removeItem(e):(delete n[e],r()))},theme:function(e,t){if(!RED.settings.editorTheme)return t;var n=e.split("."),o=RED.settings.editorTheme;try{for(var a=0;a<n.length;a++)o=o[n[a]];return void 0===o?t:o}catch(e){return t}}}}(),RED.user=function(){function e(){$("#btn-usermenu-submenu li").remove(),RED.settings.user.anonymous?RED.menu.addItem("btn-usermenu",{id:"usermenu-item-login",label:RED._("menu.label.login"),onselect:function(){RED.user.login({cancelable:!0},function(){RED.settings.load(function(){RED.notify(RED._("user.loggedInAs",{name:RED.settings.user.username}),"success"),e(),RED.events.emit("login",RED.settings.user.username)})})}}):(RED.menu.addItem("btn-usermenu",{id:"usermenu-item-username",label:"<b>"+RED.settings.user.username+"</b>"}),RED.menu.addItem("btn-usermenu",{id:"usermenu-item-logout",label:RED._("menu.label.logout"),onselect:function(){RED.user.logout()}}))}var t=/^((.+)\.)?read$/,n=/^((.+)\.)?write$/;return{init:function(){if(RED.settings.user&&(!RED.settings.editorTheme||!RED.settings.editorTheme.hasOwnProperty("userMenu"))){var t=$('<li><a id="btn-usermenu" class="button hide" data-toggle="dropdown" href="#"></a></li>').prependTo(".header-toolbar");RED.settings.user.image?$('<span class="user-profile"></span>').css({backgroundImage:"url("+RED.settings.user.image+")"}).appendTo(t.find("a")):$('<i class="fa fa-user"></i>').appendTo(t.find("a")),RED.menu.init({id:"btn-usermenu",options:[]}),e()}},login:function(t,n){"function"==typeof t&&(n=t,t={});var o=$('<div id="node-dialog-login" class="hide"><div style="display: inline-block;width: 250px; vertical-align: top; margin-right: 10px; margin-bottom: 20px;"><img id="node-dialog-login-image" src=""/></div><div style="display: inline-block; width: 250px; vertical-align: bottom; margin-left: 10px; margin-bottom: 20px;"><form id="node-dialog-login-fields" class="form-horizontal" style="margin-bottom: 0px;"></form></div></div>');o.dialog({autoOpen:!1,dialogClass:"ui-dialog-no-close",modal:!0,closeOnEscape:!!t.cancelable,width:600,resizable:!1,draggable:!1}),$("#node-dialog-login-fields").empty(),$.ajax({dataType:"json",url:"auth/login",success:function(a){var i=0;if("credentials"==a.type){for(;i<a.prompts.length;i++){var s=a.prompts[i],r=$("<div/>",{class:"form-row"});$('<label for="node-dialog-login-'+s.id+'">'+RED._(s.label)+":</label><br/>").appendTo(r);var d=$('<input style="width: 100%" id="node-dialog-login-'+s.id+'" type="'+s.type+'" tabIndex="'+(i+1)+'"/>').appendTo(r);i<a.prompts.length-1&&d.keypress(function(){var e=r;return function(t){13==t.keyCode&&(e.next("div").find("input").focus(),t.preventDefault())}}()),r.appendTo("#node-dialog-login-fields")}$('<div class="form-row" style="text-align: right; margin-top: 10px;"><span id="node-dialog-login-failed" style="line-height: 2em;float:left;" class="hide">'+RED._("user.loginFailed")+'</span><img src="red/images/spin.svg" style="height: 30px; margin-right: 10px; " class="login-spinner hide"/>'+(t.cancelable?'<a href="#" id="node-dialog-login-cancel" style="margin-right: 20px;" tabIndex="'+(i+1)+'">'+RED._("common.label.cancel")+"</a>":"")+'<input type="submit" id="node-dialog-login-submit" style="width: auto;" tabIndex="'+(i+2)+'" value="'+RED._("user.login")+'"></div>').appendTo("#node-dialog-login-fields"),$("#node-dialog-login-submit").button(),$("#node-dialog-login-fields").submit(function(o){$("#node-dialog-login-submit").button("option","disabled",!0),$("#node-dialog-login-failed").hide(),$(".login-spinner").show();for(var i={client_id:"node-red-editor",grant_type:"password",scope:""},s=0;s<a.prompts.length;s++){var r=a.prompts[s];i[r.id]=$("#node-dialog-login-"+r.id).val()}$.ajax({url:"auth/token",type:"POST",data:i}).done(function(o,a,i){RED.settings.set("auth-tokens",o),$("#node-dialog-login").dialog("destroy").remove(),t.updateMenu&&e(),n()}).fail(function(e,t,n){RED.settings.remove("auth-tokens"),$("#node-dialog-login-failed").show()}).always(function(){$("#node-dialog-login-submit").button("option","disabled",!1),$(".login-spinner").hide()}),o.preventDefault()})}else if("strategy"==a.type)for(i=0;i<a.prompts.length;i++){s=a.prompts[i],r=$("<div/>",{class:"form-row",style:"text-align: center"}).appendTo("#node-dialog-login-fields");var l=$('<a href="#"></a>',{style:"padding: 10px"}).appendTo(r).click(function(){document.location=s.url});if(s.image)$("<img>",{src:s.image}).appendTo(l);else if(s.label){var c=$("<span></span>").text(s.label);s.icon&&($("<i></i>",{class:"fa fa-2x "+s.icon,style:"vertical-align: middle"}).appendTo(l),c.css({verticalAlign:"middle",marginLeft:"8px"})),c.appendTo(l)}l.button()}t.cancelable&&$("#node-dialog-login-cancel").button().click(function(e){$("#node-dialog-login").dialog("destroy").remove()});var p=a.image||"red/images/node-red-256.png";$("#node-dialog-login-image").load(function(){o.dialog("open")}).attr("src",p)}})},logout:function(){var e=RED.settings.get("auth-tokens"),t=e?e.access_token:"";$.ajax({url:"auth/revoke",type:"POST",data:{token:t}}).done(function(e,t,n){RED.settings.remove("auth-tokens"),e&&e.redirect?document.location.href=e.redirect:document.location.reload(!0)}).fail(function(e,t,n){401===e.status?document.location.reload(!0):console.log(t)})},hasPermission:function(e){return""===e||!RED.settings.user||function e(o,a){if(""===a)return!0;var i;if(Array.isArray(a)){for(i=0;i<a.length;i++)if(!e(o,a[i]))return!1;return!0}if(Array.isArray(o)){if(0===o.length)return!1;for(i=0;i<o.length;i++)if(e(o[i],a))return!0;return!1}return"*"===o||o===a||("read"===o||"*.read"===o?t.test(a):("write"===o||"*.write"===o)&&n.test(a))}(RED.settings.user.permissions||"",e)}}}(),RED.comms=function(){var e,t=null,n=null,o=null,a=10,i={},s=!1,r=0,d=!1;return{connect:function l(){d=!0;var c=location.hostname,p=location.port;0!==p.length&&(c=c+":"+p),c=(c+=document.location.pathname)+("/"==c.slice(-1)?"":"/")+"comms",c="ws"+("https:"==document.location.protocol?"s":"")+"://"+c;var u=RED.settings.get("auth-tokens");function f(){for(var t in i)i.hasOwnProperty(t)&&e.send(JSON.stringify({subscribe:t}))}s=null!=u,(e=new WebSocket(c)).onopen=function(){r=0,t&&(n=setTimeout(function(){t.close(),t=null},1e3)),s?e.send(JSON.stringify({auth:u.access_token})):f()},e.onmessage=function(e){for(var t=JSON.parse(e.data),n=0;n<t.length;n++){var o=t[n];if(s&&o.auth)"ok"===o.auth?(s=!1,f()):"fail"===o.auth&&(d=!1,RED.user.login({updateMenu:!0},function(){l()}));else if(o.topic)for(var a in i)if(i.hasOwnProperty(a)&&new RegExp("^"+a.replace(/([\[\]\?\(\)\\\\$\^\*\.|])/g,"\\$1").replace(/\+/g,"[^/]+").replace(/\/#$/,"(/.*)?")+"$").test(o.topic)){var r=i[a];if(r)for(var c=0;c<r.length;c++)r[c](o.topic,o.data)}}},e.onclose=function(){d&&(n&&(clearTimeout(n),n=null),++r<10?(setTimeout(l,1e3),r>5&&null==t&&(t=RED.notify(RED._("notification.errors.lostConnection"),"error",!0))):r<20?setTimeout(l,2e3):(a=60,o=setInterval(function(){if(0==--a)t.update(RED._("notification.errors.lostConnection")),clearInterval(o),l();else{var e=RED._("notification.errors.lostConnectionReconnect",{time:a})+' <a href="#">'+RED._("notification.errors.lostConnectionTry")+"</a>";t.update(e),$(t).find("a").click(function(e){e.preventDefault(),t.update(RED._("notification.errors.lostConnection")),clearInterval(o),l()})}},1e3)))}},subscribe:function(t,n){null==i[t]&&(i[t]=[]),i[t].push(n),e&&1==e.readyState&&e.send(JSON.stringify({subscribe:t}))},unsubscribe:function(e,t){if(i[e]){for(var n=0;n<i[e].length;n++)if(i[e][n]===t){i[e].splice(n,1);break}0===i[e].length&&delete i[e]}}}}(),RED.text={},RED.text.bidi=function(){var e="",t="‪",n="‫",o="‬";function a(t){return"auto"==e?function(e){for(var t,n,o=e.length,a=0;a<o;a++){if((n=e.charCodeAt(a))>=1488&&n<=1535||n>=1536&&n<=1631||n>=1642&&n<=1775||n>=1786&&n<=2047||n>=64285&&n<=65023||n>=65136&&n<=65276)return!0;if((t=e.charCodeAt(a))>64&&t<91||t>96&&t<123)return!1}return!1}(t)?"rtl":"ltr":e}function i(){$(this).attr("dir",a($(this).val()))}return{setTextDirection:function(t){e=t,RED.nodes.eachNode(function(e){e.dirty=!0}),RED.view.redraw(),RED.palette.refresh(),$("#workspace").find("span.bidiAware").each(function(){$(this).attr("dir",a($(this).html()))}),$("#sidebar").find("span.bidiAware").each(function(){$(this).attr("dir",a($(this).text()))})},enforceTextDirectionWithUCC:function(e){if(e){var i=a(e);if("ltr"==i)return t+e+o;if("rtl"==i)return n+e+o}return e},resolveBaseTextDir:a,prepareInput:function(e){e.on("keyup",i).on("paste",i).on("cut",i),i.call(e)}}}(),RED.text.format=function(){var e=function(e){this.content="",this.actual="",this.textDirection="",this.localGui="",this.isVisible=!0,this.isSeparator=!1,this.isParsed=!1,this.keep=!1,this.inBounds=!1,this.inPoints=!1;var t="";for(t in e)e.hasOwnProperty(t)&&(this[t]=e[t])},t=function(){function t(e){if(!e)return!1;void 0===e.start&&(e.start=""),void 0===e.end&&(e.end=""),void 0!==e.startAfter?(e.start=e.startAfter,e.after=!0):e.after=!1,void 0!==e.endBefore?(e.end=e.endBefore,e.before=!0):e.before=!1;var t=parseInt(e.startPos,10);isNaN(t)?e.usePos=!1:e.usePos=!0;var n=parseInt(e.length,10);return isNaN(n)?e.useLength=!1:e.useLength=!0,e.loops=void 0===e.loops||!!e.loops,!0}function n(e,t){var n={};for(var o in t)t.hasOwnProperty(o)&&(n[o]=t[o]);var a=e.content,i=n.usePos&&n.startPos<a.length;i&&(n.start="",n.loops=!1),n.bStart=i?n.startPos:n.start.length>0?a.indexOf(n.start):0;var s=n.useLength&&n.length>0&&n.bStart+n.length<a.length;return s&&(n.end=""),n.bEnd=s?n.bStart+n.length:n.end.length>0?a.indexOf(n.end,n.bStart+n.start.length)+1:a.length,n.after||(n.start=""),n.before||(n.end=""),n}return{handleSubcontents:function(t,n,o,a,i){if(!o.content||"string"!=typeof o.content||0===o.content.length)return t;var s=!0;void 0!==o.loops&&(s=!!o.loops);for(var r=0;!(r>=t.length);r++)if(!(t[r].isParsed||t.keep||t[r].isSeparator)){var d=t[r].content,l=d.indexOf(o.content);if(!(l<0)){var c,p=0;if(o.continued)do{p++,c=d.indexOf(o.content,l+p*o.content.length)}while(0===c);else p=1;if(c=l+p*o.content.length,t.splice(r,1),l>0&&(t.splice(r,0,new e({content:d.substring(0,l),localGui:n.dir,keep:!0})),r++),t.splice(r,0,new e({content:d.substring(l,c),textDirection:o.subDir,localGui:n.dir})),c<d.length&&t.splice(r+1,0,new e({content:d.substring(c,d.length),localGui:n.dir,keep:!0})),!s)break}}},handleBounds:function(o,a,i,s,r){for(var d=0;d<i.length;d++)if(t(i[d]))for(var l=0;!(l>=o.length);l++)if(!(o[l].isParsed||o[l].inBounds||o.keep||o[l].isSeparator)){var c=n(o[l],i[d]),p=c.bStart,u=c.bEnd;if(!(p<0||u<0)){var f=o[l].content;if(o.splice(l,1),p>0&&(o.splice(l,0,new e({content:f.substring(0,p),localGui:a.dir,keep:!0})),l++),c.start&&(o.splice(l,0,new e({content:c.start,localGui:a.dir,isSeparator:!0})),l++),o.splice(l,0,new e({content:f.substring(p+c.start.length,u-c.end.length),textDirection:c.subDir,localGui:a.dir,inBounds:!0})),c.end&&(l++,o.splice(l,0,new e({content:c.end,localGui:a.dir,isSeparator:!0}))),u+c.end.length<f.length&&o.splice(l+1,0,new e({content:f.substring(u+c.end.length,f.length),localGui:a.dir,keep:!0})),!c.loops)break}}for(d=0;d<o.length;d++)o[d].inBounds=!1;return o},handleCases:function(e,t,n,o,a){if(0===n.length)return e;var i={};for(var s in t)t.hasOwnProperty(s)&&(i[s]=t[s]);for(var r=0;r<n.length;r++)n[r].handler&&"function"==typeof n[r].handler.handle||(n[r].handler=t.commonHandler),n[r].args?(i.cases=n[r].args.cases,i.points=n[r].args.points,i.bounds=n[r].args.bounds,i.subs=n[r].args.subs):(i.cases=[],i.points=[],i.bounds=[],i.subs={}),n[r].handler.handle(o,e,i,a);return e},handlePoints:function(t,n,o,a,i){for(var s=0;s<o.length;s++)for(var r=0;!(r>=t.length);r++)if(!(t[r].isParsed||t[r].keep||t[r].isSeparator)){var d=t[r].content,l=d.indexOf(o[s]);l>=0&&(t.splice(r,1),l>0&&(t.splice(r,0,new e({content:d.substring(0,l),textDirection:n.subDir,localGui:n.dir,inPoints:!0})),r++),t.splice(r,0,new e({content:o[s],localGui:n.dir,isSeparator:!0})),l+o[s].length+1<=d.length&&t.splice(r+1,0,new e({content:d.substring(l+o[s].length),textDirection:n.subDir,localGui:n.dir,inPoints:!0})))}for(s=0;s<t.length;s++)t[s].keep?t[s].keep=!1:t[s].inPoints&&(t[s].isParsed=!0,t[s].inPoints=!1);return t}}}(),n={handle:function(e,n,o,a){var i=[];Array.isArray(o.cases)&&(i=o.cases);var s=[];void 0!==o.points&&(Array.isArray(o.points)?s=o.points:"string"==typeof o.points&&(s=o.points.split("")));var r={};"object"==typeof o.subs&&(r=o.subs);var d=[];return Array.isArray(o.bounds)&&(d=o.bounds),t.handleBounds(n,o,d,e,a),t.handleSubcontents(n,o,r,e,a),t.handleCases(n,o,i,e,a),t.handlePoints(n,o,s,e,a),n}},o={LRE:"‪",RLE:"‫",PDF:"‬",LRM:"‎",RLM:"‏",LRO:"‭",RLO:"‮",getLocaleDetails:function(e){if(e||(e="undefined"==typeof navigator?"":navigator.language||navigator.userLanguage||""),e=e.toLowerCase(),(o=(n=e)?n.split("-")[0]:"")&&!(o.length<2)&&["iw","he","ar","fa","ur"].some(function(e){return e===o})){var t=e.split("-");return{lang:t[0],country:t[1]?t[1]:""}}var n,o;return{lang:"not-bidi"}},removeUcc:function(e){return e?e.replace(/[\u200E\u200F\u202A-\u202E]/g,""):e},removeTags:function(e){return e?e.replace(/<[^<]*>/g,""):e},getDirection:function(e,t,n,o){if("auto"!==t&&/^(rtl|ltr)$/i.test(t))return t;n=/^(rtl|ltr)$/i.test(n)?n:"ltr";var a=o?e.split("").reverse().join(""):e,i=/[A-Za-z\u05d0-\u065f\u066a-\u06ef\u06fa-\u07ff\ufb1d-\ufdff\ufe70-\ufefc]/.exec(a);return i?i[0]<="z"?"ltr":"rtl":n},hasArabicChar:function(e){return!!/[\u0600-\u065f\u066a-\u06ef\u06fa-\u07ff\ufb1d-\ufdff\ufe70-\ufefc]/.exec(e)},showMarks:function(e,t){for(var n="",o=0;o<e.length;o++){var a=""+e.charAt(o);switch(a){case"‎":n+="<LRM>";break;case"‏":n+="<RLM>";break;case"‪":n+="<LRE>";break;case"‫":n+="<RLE>";break;case"‭":n+="<LRO>";break;case"‮":n+="<RLO>";break;case"‬":n+="<PDF>";break;default:n+=a}}var i=void 0!==t&&/^(rtl|ltr)$/i.test(t)?"rtl"===t?"‮":"‭":"";return i+n+(""===i?"":"‬")},hideMarks:function(e){return e.replace(/<LRM>/g,this.LRM).replace(/<RLM>/g,this.RLM).replace(/<LRE>/g,this.LRE).replace(/<RLE>/g,this.RLE).replace(/<LRO>/g,this.LRO).replace(/<RLO>/g,this.RLO).replace(/<PDF>/g,this.PDF)},showTags:function(e){return"<xmp>"+e+"</xmp>"},hideTags:function(e){return e.replace(/<xmp>/g,"").replace(/<\/xmp>/g,"")}},a=function(){var t={};function a(e,t){var o=Array.isArray(e)?e[0]:e;return o.guiDir||(o.guiDir="ltr"),o.dir||(o.dir=o.guiDir),t?(void 0===o.points&&(o.points=[]),o.cases||(o.cases=[]),o.bounds||(o.bounds=[]),o.commonHandler=n,o):o}function i(t,o,i){if(!t||!o)return new e({content:""});var s=a(o,!0),r=[new e({content:t,actual:t,localGui:s.dir})],d=n.handle;return s.handler&&"function"==typeof s.handler&&(d=s.handler.handle),d(t,r,s,i),r}function s(e,t,n){var i=a(t,!1);return n?function(e,t,n){for(var a="",i="",s=0;s<e.length;s++)if(e[s].isVisible){var r=e[s].textDirection,d=e[s].localGui;if(""!==d&&""===i?a+="<bdi dir='"+("rtl"===d?"rtl":"ltr")+"'>":""===i||""!==d&&d===i&&!stop||(a+="</bdi>"+(s==e.length-1&&""!==d?"":"<span style='unicode-bidi: embed; direction: "+("rtl"===t.dir?"rtl":"ltr")+";'></span>"),""!==d&&(a+="<bdi dir='"+("rtl"===d?"rtl":"ltr")+"'>")),"auto"===r&&(r=o.getDirection(e[s].content,r,t.guiDir)),/^(rtl|ltr)$/i.test(r)?(a+="<bdi dir='"+("rtl"===r?"rtl":"ltr")+"'>"+e[s].content+"</bdi>",r):(a+=e[s].content,o.getDirection(e[s].content,r,t.guiDir,!0)),s<e.length-1){var l=d&&e[s+1].localGui?d:t.dir;a+="<span style='unicode-bidi: embed; direction: "+("rtl"===l?"rtl":"ltr")+";'></span>"}else""!==i&&(a+="</bdi>");i=d,stop=!1}else stop=!0;var c="auto"===t.dir?o.getDirection(e[0].actual,t.dir,t.guiDir):t.dir;c!==t.guiDir&&(a="<bdi dir='"+("rtl"===c?"rtl":"ltr")+"'>"+a+"</bdi>");return a}(e,i):function(e,t,n){for(var a="",i="",s=!1,r=0;r<e.length;r++)if(e[r].isVisible){var d=e[r].textDirection,l=e[r].localGui;if(""!==l&&""===i?a+="rtl"===l?o.RLE:o.LRE:""===i||""!==l&&l===i&&!s||(a+=o.PDF+(r==e.length-1&&""!==l?"":"rtl"===t.dir?o.RLM:o.LRM),""!==l&&(a+="rtl"===l?o.RLE:o.LRE)),"auto"===d&&(d=o.getDirection(e[r].content,d,t.guiDir)),/^(rtl|ltr)$/i.test(d)?(a+=("rtl"===d?o.RLE:o.LRE)+e[r].content+o.PDF,d):(a+=e[r].content,o.getDirection(e[r].content,d,t.guiDir,!0)),r<e.length-1){var c=l&&e[r+1].localGui?l:t.dir;a+="rtl"===c?o.RLM:o.LRM}else""!==i&&(a+=o.PDF);i=l,s=!1}else s=!0;var p="auto"===t.dir?o.getDirection(e[0].actual,t.dir,t.guiDir):t.dir;p!==t.guiDir&&(a=("rtl"===p?o.RLE:o.LRE)+a+o.PDF);return a}(e,i)}return t.parseAndDisplayStructure=function(e,t,n,o){return e&&t?s(i(e,t,o),t,n):e},t.parseStructure=i,t.displayStructure=s,t.restore=function(e,t){return e},t}(),i={format:function(e,t,n,o,i,s){var r={guiDir:n?"rtl":"ltr",dir:t.dir?t.dir:n?"rtl":"ltr",subs:{content:">",continued:!0,subDir:n?"rtl":"ltr"},cases:[{args:{subs:{content:"<",continued:!0,subDir:n?"ltr":"rtl"}}}]};return s?a.parseStructure(e,r,!!o,i):a.parseAndDisplayStructure(e,r,!!o,i)}},s={format:function(e,t,n,o,i,s){var r={guiDir:n?"rtl":"ltr",dir:"ltr",points:","};return s?a.parseStructure(e,r,!!o,i):a.parseAndDisplayStructure(e,r,!!o,i)}},r=function(){return{format:function(e,t,i,s,r,d){var l={guiDir:i?"rtl":"ltr",dir:function(e,t){if("ar"!==o.getLocaleDetails(t).lang)return"ltr";var n=e.indexOf("@");return n>0&&n<e.length-1&&o.hasArabicChar(e.substring(n+1))?"rtl":"ltr"}(e,r),points:"<>.:,;@",cases:[{handler:n,args:{bounds:[{startAfter:'"',endBefore:'"'},{startAfter:"(",endBefore:")"}],points:""}}]};return d?a.parseStructure(e,l,!!s,r):a.parseAndDisplayStructure(e,l,!!s,r)}}}(),d={format:function(e,t,n,o,i,s){var r={guiDir:n?"rtl":"ltr",dir:"ltr",points:"/\\:."};return s?a.parseStructure(e,r,!!o,i):a.parseAndDisplayStructure(e,r,!!o,i)}},l={format:function(e,t,n,o,i,s){var r={guiDir:n?"rtl":"ltr",dir:"ltr",points:" /%^&[]<>=!?~:.,|()+-*{}"};return s?a.parseStructure(e,r,!!o,i):a.parseAndDisplayStructure(e,r,!!o,i)}},c={format:function(e,t,o,i,s,r){var d={guiDir:o?"rtl":"ltr",dir:"ltr",points:"\t!#%&()*+,-./:;<=>?|[]{}",cases:[{handler:n,args:{bounds:[{startAfter:"/*",endBefore:"*/"},{startAfter:"--",end:"\n"},{startAfter:"--"}]}},{handler:n,args:{subs:{content:" ",continued:!0}}},{handler:n,args:{bounds:[{startAfter:"'",endBefore:"'"},{startAfter:'"',endBefore:'"'}]}}]};return r?a.parseStructure(e,d,!!i,s):a.parseAndDisplayStructure(e,d,!!i,s)}},p={format:function(e,t,n,o,i,s){var r={guiDir:n?"rtl":"ltr",dir:"ltr",points:"_"};return s?a.parseStructure(e,r,!!o,i):a.parseAndDisplayStructure(e,r,!!o,i)}},u={format:function(e,t,n,o,i,s){var r={guiDir:n?"rtl":"ltr",dir:"ltr",points:":?#/@.[]="};return s?a.parseStructure(e,r,!!o,i):a.parseAndDisplayStructure(e,r,!!o,i)}},f={format:function(e,t,n,o,i,s){var r={guiDir:n?"rtl":"ltr",dir:t.dir?t.dir:n?"rtl":"ltr",points:" ,.!?;:"};return s?a.parseStructure(e,r,!!o,i):a.parseAndDisplayStructure(e,r,!!o,i)}},h={format:function(e,t,o,i,s,r){var d={guiDir:o?"rtl":"ltr",dir:"ltr",points:" /[]<>=!:@.|()+-*",cases:[{handler:n,args:{bounds:[{startAfter:'"',endBefore:'"'},{startAfter:"'",endBefore:"'"}],points:""}}]};return r?a.parseStructure(e,d,!!i,s):a.parseAndDisplayStructure(e,d,!!i,s)}},g={format:function(e,t,n,o,i,s){var r={},d="",l=Array.isArray(t)?t[0]:t;for(d in l)l.hasOwnProperty(d)&&(r[d]=l[d]);return r.guiDir=n?"rtl":"ltr",r.dir=r.dir?r.dir:r.guiDir,s?a.parseStructure(e,r,!!o,i):a.parseAndDisplayStructure(e,r,!!o,i)}},v=(function(){var e={msgLang:"en",msgDir:"",phLang:"",phDir:"",phPacking:["{","}"],phStt:{type:"none",args:{}},guiDir:""},t=!1;function n(e){return"he"===e||"iw"===e||"ar"===e?"rtl":"ltr"}function o(e){0===e.msgDir.length&&(e.msgDir=n(e.msgLang)),e.msgDir="ltr"!==e.msgDir&&"rtl"!==e.msgDir&&"auto"!=e.msgDir?"ltr":e.msgDir,0===e.guiDir.length&&(e.guiDir=e.msgDir),e.guiDir="rtl"!==e.guiDir?"ltr":"rtl",0===e.phDir.length&&(e.phDir=0===e.phLang.length?e.msgDir:n(e.phLang)),e.phDir="ltr"!==e.phDir&&"rtl"!==e.phDir&&"auto"!=e.phDir?"ltr":e.phDir,"string"==typeof e.phPacking&&(e.phPacking=e.phPacking.split("")),e.phPacking.length<2&&(e.phPacking=["{","}"])}}(),null);function m(e){switch(e){case"breadcrumb":return i;case"comma":return s;case"email":return r;case"filepath":return d;case"formula":return l;case"sql":return c;case"underscore":return p;case"url":return u;case"word":return f;case"xpath":return h;default:return g}}function b(e,t,n,a,i){if(!e||1!=e.nodeType)return!1;v||(v=document.createEvent("Event")).initEvent("TF",!0,!0),e.setAttribute("data-tf-type",t);var s="undefined"===n?"{}":JSON.stringify(Array.isArray(n)?n[0]:n);e.setAttribute("data-tf-args",s);var r="ltr";if("undefined"===a&&(e.dir?r=e.dir:e.style&&e.style.direction&&(r=e.style.direction),a="rtl"===r.toLowerCase()),e.setAttribute("data-tf-dir",a),e.setAttribute("data-tf-locale",o.getLocaleDetails(i).lang),function(e){var t=window.navigator.userAgent;if(t.indexOf("MSIE")>=0||t.indexOf("Trident")>=0||t.indexOf("Edge")>=0)return!1;var n=document.createElement(e.tagName);n.contentEditable=!0;var o="oninput"in n;return o||(n.setAttribute("oninput","return;"),o="function"==typeof n.oninput),n=null,o}(e)){e.oninput;e.oninput=function(e){y(e.target)}}else e.onkeyup=function(t){y(t.target),e.dispatchEvent(v)},e.onmouseup=function(t){y(t.target),e.dispatchEvent(v)};return y(e),!0}function y(e){var t=e.textContent||"",n=document.getSelection();if(0===t.length||!n||n.rangeCount<=0)e.dispatchEvent(v);else{var o,a,i=n.getRangeAt(0),s=i.cloneRange();o=i.startContainer,a=i.startOffset;var r=0;3===o.nodeType&&(r+=a),s.setStart(e,0),s.setEndBefore(o);var d=document.createElement("div");d.appendChild(s.cloneContents()),r+=d.textContent.length,e.innerHTML=m(e.getAttribute("data-tf-type")).format(t,JSON.parse(e.getAttribute("data-tf-args")),"true"===e.getAttribute("data-tf-dir"),!0,e.getAttribute("data-tf-locale"));var l=e,c=e,p=0,u=!1;for(n.removeAllRanges(),i.setStart(e,0),i.setEnd(e,0);c;){if(3===c.nodeType){if(p+c.nodeValue.length>=r){i.setStart(c,r-p);break}p+=c.nodeValue.length,c=c.nextSibling}else{if(c.hasChildNodes()){c=(l=c).firstChild;continue}c=c.nextSibling}for(;!c;){if(l===e){u=!0;break}c=l.nextSibling,l=l.parentNode}if(u)break}n.addRange(i),e.dispatchEvent(v)}}return{getHtml:function(e,t,n,o,a){return m(t).format(e,n,o,!0,a)},attach:function(e,t,n,o,a){return b(e,t,n,o,a)}}}(),RED.state={DEFAULT:0,MOVING:1,JOINING:2,MOVING_ACTIVE:3,ADDING:4,EDITING:5,EXPORT:6,IMPORT:7,IMPORT_DRAGGING:8,QUICK_JOINING:9},RED.nodes=function(){var e,t,o=[],a={},s=[],r={},d=[],l={},c=null,p=!1;var u=function(){var e={},t=[],n={},o={},a={},i={};a.tab={defaults:{label:{value:""},disabled:{value:!1},info:{value:""}}};var s={setModulePendingUpdated:function(t,n){e[t].pending_version=n,RED.events.emit("registry:module-updated",{module:t,version:n})},getModule:function(t){return e[t]},getNodeSetForType:function(e){return s.getNodeSet(o[e])},getModuleList:function(){return e},getNodeList:function(){return t},getNodeTypes:function(){return Object.keys(a)},setNodeList:function(e){t=[];for(var n=0;n<e.length;n++){var o=e[n];s.addNodeSet(o)}},addNodeSet:function(a){a.added=!1,n[a.id]=a;for(var i=0;i<a.types.length;i++)o[a.types[i]]=a.id;t.push(a),e[a.module]=e[a.module]||{name:a.module,version:a.version,local:a.local,sets:{}},a.pending_version&&(e[a.module].pending_version=a.pending_version),e[a.module].sets[a.name]=a,RED.events.emit("registry:node-set-added",a)},removeNodeSet:function(a){for(var i=n[a],s=0;s<i.types.length;s++)delete o[i.types[s]];delete n[a];for(var r=0;r<t.length;r++)if(t[r].id===a){t.splice(r,1);break}return delete e[i.module].sets[i.name],0===Object.keys(e[i.module].sets).length&&delete e[i.module],RED.events.emit("registry:node-set-removed",i),i},getNodeSet:function(e){return n[e]},enableNodeSet:function(e){var t=n[e];t.enabled=!0,RED.events.emit("registry:node-set-enabled",t)},disableNodeSet:function(e){var t=n[e];t.enabled=!1,RED.events.emit("registry:node-set-disabled",t)},registerNodeType:function(e,t){var i;(a[e]=t,t.type=e,"subflows"!=t.category)&&(t.set=n[o[e]],n[o[e]].added=!0,n[o[e]].enabled=!0,i="node-red"===t.set.module?"node-red":t.set.id,t._=function(){var e=Array.prototype.slice.call(arguments,0),t=e[0];-1===e[0].indexOf(":")&&(e[0]=i+":"+e[0]);var n=RED._.apply(null,e);return n===e[0]&&(n=t),n});RED.events.emit("registry:node-type-added",e)},removeNodeType:function(e){if("subflow:"!=e.substring(0,8))throw new Error("this api is subflow only. called with:",e);delete a[e],RED.events.emit("registry:node-type-removed",e)},getNodeType:function(e){return a[e]},setIconSets:function(e){i=e},getIconSets:function(){return i}};return s}();function f(){return(1+4294967295*Math.random()).toString(16)}function h(e){if(0!==e.type.indexOf("subflow")?e._=e._def._:e._=RED._,"config"==e._def.category)a[e.id]=e;else{if(e.ports=[],e.wires&&e.wires.length>e.outputs&&(e.outputs=e.wires.length),e.outputs)for(var t=0;t<e.outputs;t++)e.ports.push(t);if(e.dirty=!0,j(e),"subflows"==e._def.category&&void 0===e.i){var n=0;RED.nodes.eachNode(function(e){n=Math.max(n,e.i||0)}),e.i=n+1}o.push(e)}RED.events.emit("nodes:add",e)}function g(e){s.push(e)}function v(e){if(e in a)return a[e];for(var t in o)if(o[t].id==e)return o[t];return null}function m(e){var t,i=[],r=[];if(e in a)t=a[e],delete a[e],RED.events.emit("nodes:remove",t),RED.workspaces.refresh();else if(t=v(e)){o.splice(o.indexOf(t),1),(i=s.filter(function(e){return e.source===t||e.target===t})).forEach(function(e){s.splice(s.indexOf(e),1)});var d=!1;for(var l in t._def.defaults)if(t._def.defaults.hasOwnProperty(l)){var c=t._def.defaults[l];if(c.type){var p=u.getNodeType(c.type);if(p&&"config"==p.category){var f=a[t[l]];if(f)if(d=!0,f._def.exclusive)m(t[l]),r.push(f);else{var h=f.users;h.splice(h.indexOf(t),1)}}}}d&&RED.workspaces.refresh();try{t._def.oneditdelete&&t._def.oneditdelete.call(t)}catch(e){console.log("oneditdelete",t.id,t.type,e.toString())}RED.events.emit("nodes:remove",t)}return t&&t._def.onremove&&(console.log("Deprecated API warning: node type ",t.type," has an onremove function - should be oneditremove - please report"),t._def.onremove.call(n)),{links:i,nodes:r}}function b(e){r[e.id]=e,e._def=RED.nodes.getType("tab"),d.push(e.id)}function y(e,t){if(t){var n=Object.keys(l).map(function(e){return l[e].name});n.sort();var o=1,a=e.name;n.forEach(function(t){a==t&&(o++,a=e.name+" ("+o+")")}),e.name=a}l[e.id]=e,RED.nodes.registerType("subflow:"+e.id,{defaults:{name:{value:""}},info:e.info,icon:"subflow.png",category:"subflows",inputs:e.in.length,outputs:e.out.length,color:"#da9",label:function(){return this.name||RED.nodes.subflow(e.id).name},labelStyle:function(){return this.name?"node_label_italic":""},paletteLabel:function(){return RED.nodes.subflow(e.id).name},inputLabels:function(t){return e.inputLabels?e.inputLabels[t]:null},outputLabels:function(t){return e.outputLabels?e.outputLabels[t]:null},set:{module:"node-red"}}),e._def=RED.nodes.getType("subflow:"+e.id)}function w(e){return l[e]}function D(e,t){for(var n=0;n<o.length;n++){var a=o[n];if(a.z===e){var i=/^subflow:(.+)$/.exec(a.type);if(i){if(i[1]===t)return!0;if(D(i[1],t))return!0}}}return!1}function E(e){var t={};t.id=e.id,t.type=e.type;for(var n in e._def.defaults)e._def.defaults.hasOwnProperty(n)&&(t[n]=e[n]);return t}function R(e,t){if("tab"===e.type)return E(e);t=t||!1;var n={};if(n.id=e.id,n.type=e.type,n.z=e.z,"unknown"==n.type)for(var o in e._orig)e._orig.hasOwnProperty(o)&&(n[o]=e._orig[o]);else{for(var a in e._def.defaults)e._def.defaults.hasOwnProperty(a)&&(n[a]=e[a]);if(t&&e.credentials){var i={};n.credentials={};for(var r in e._def.credentials)e._def.credentials.hasOwnProperty(r)&&("password"==e._def.credentials[r].type?(!e.credentials._||e.credentials["has_"+r]!=e.credentials._["has_"+r]||e.credentials["has_"+r]&&e.credentials[r])&&(i[r]=e.credentials[r]):null==e.credentials[r]||e.credentials._&&e.credentials[r]==e.credentials._[r]||(i[r]=e.credentials[r]));Object.keys(i).length>0&&(n.credentials=i)}}if("config"!=e._def.category){n.x=e.x,n.y=e.y,n.wires=[];for(var d=0;d<e.outputs;d++)n.wires.push([]);for(var l=s.filter(function(t){return t.source===e}),c=0;c<l.length;c++){var p=l[c];"subflow"!=p.target.type&&n.wires[p.sourcePort].push(p.target.id)}if(e.inputs>0&&e.inputLabels&&!/^\s*$/.test(e.inputLabels.join(""))&&(n.inputLabels=e.inputLabels.slice()),e.outputs>0&&e.outputLabels&&!/^\s*$/.test(e.outputLabels.join(""))&&(n.outputLabels=e.outputLabels.slice()),(!e._def.defaults||!e._def.defaults.hasOwnProperty("icon"))&&e.icon){var u=RED.utils.getDefaultNodeIcon(e._def,e);e.icon!==u.module+"/"+u.file&&(n.icon=e.icon)}}return n}function x(e){var t={};return t.id=e.id,t.type=e.type,t.name=e.name,t.info=e.info,t.in=[],t.out=[],e.in.forEach(function(e){for(var n={x:e.x,y:e.y,wires:[]},o=s.filter(function(t){return t.source===e}),a=0;a<o.length;a++){var i=o[a];"subflow"!=i.target.type&&n.wires.push({id:i.target.id})}t.in.push(n)}),e.out.forEach(function(n,o){var a={x:n.x,y:n.y,wires:[]},r=s.filter(function(e){return e.target===n});for(i=0;i<r.length;i++)"subflow"!=r[i].source.type?a.wires.push({id:r[i].source.id,port:r[i].sourcePort}):a.wires.push({id:e.id,port:0});t.out.push(a)}),t.in.length>0&&e.inputLabels&&!/^\s*$/.test(e.inputLabels.join(""))&&(t.inputLabels=e.inputLabels.slice()),t.out.length>0&&e.outputLabels&&!/^\s*$/.test(e.outputLabels.join(""))&&(t.outputLabels=e.outputLabels.slice()),t}function T(e,t,n){var o=[];n=n||{},t=t||{};for(var i=0;i<e.length;i++){var s=e[i];if("subflow:"==s.type.substring(0,8)){var r=s.type.substring(8);if(!t[r]){t[r]=!0;var d=[w(r)];RED.nodes.eachNode(function(e){e.z==r&&d.push(e)}),o=T(d,t,n).concat(o)}}if("subflow"!=s.type){var l=RED.nodes.convertNode(s);for(var c in s._def.defaults)if(s._def.defaults[c].type&&s[c]in a){var p=a[s[c]],f=u.getNodeType(s._def.defaults[c].type).exportable;null==f||f?s[c]in n||(n[s[c]]=!0,e.push(p)):l[c]=""}o.push(l)}else{var h=x(s);o.push(h)}}return o}function k(e,t){var n,o=null;try{RED.nodes.eachSubflow(function(a){if(a.name==e.name&&a.info==e.info&&a.in.length==e.in.length&&a.out.length==e.out.length){var i=RED.nodes.filterNodes({z:a.id});if(i.length==t.length){var s=[e].concat(t),r=[a].concat(i),d=JSON.stringify(s),l=JSON.stringify(T(r));for(n=0;n<i.length;n++)d=d.replace(new RegExp('"'+t[n].id+'"',"g"),'"'+i[n].id+'"');if((d=d.replace(new RegExp('"'+e.id+'"',"g"),'"'+a.id+'"'))===l)throw o=a,new Error}}})}catch(e){console.log(e.stack)}return o}function _(e,t,n){if(n&&e.id!=t.id)return!1;if(e.type!=t.type)return!1;var o=e._def;for(var a in o.defaults)if(o.defaults.hasOwnProperty(a)){var i=e[a],s=t[a];if(typeof i!=typeof s)return!1;if(null===i||"string"==typeof i||"number"==typeof i){if(i!==s)return!1}else if(JSON.stringify(i)!==JSON.stringify(s))return!1}return!0}function C(n,o,i){var s,d,l,c={};if("string"==typeof n){if(""===n)return;try{l=JSON.parse(n)}catch(C){var p=new Error(RED._("clipboard.invalidFlow",{message:C.message}));throw p.code="NODE_RED",p}}else l=n;$.isArray(l)||(l=[l]);var v=!1;t||(v=!0,t=JSON.parse(JSON.stringify(l)));var m=[];for(s=0;s<l.length;s++)"workspace"==(d=l[s]).type||"tab"==d.type||"subflow"==d.type||u.getNodeType(d.type)||"subflow:"==d.type.substring(0,8)||-1!=m.indexOf(d.type)||m.push(d.type),d.z&&(c[d.z]=c[d.z]||[],c[d.z].push(d));if(!v&&m.length>0){var E="<ul><li>"+m.join("</li><li>")+"</li></ul>";m.length;RED.notify("<strong>"+RED._("clipboard.importUnrecognised",{count:m.length})+"</strong>"+E,"error",!1,1e4)}var R=RED.workspaces.active(),x=w(R);for(s=0;s<l.length;s++){var T=/^subflow:(.+)$/.exec(l[s].type);if(T){var C,j=T[1],S=w(l[s].z||R);if(S)if(j===S.id&&(C=new Error(RED._("notification.errors.cannotAddSubflowToItself"))),D(j,S.id)&&(C=new Error(RED._("notification.errors.cannotAddCircularReference"))),C)throw C.code="NODE_RED",C}}var O,L,P,N,I=[],A={},z=[],M={},B={},J={},U=[],G=[],F=null;for(s=0;s<l.length;s++)if("workspace"===(d=l[s]).type||"tab"===d.type)"workspace"===d.type&&(d.type="tab"),null==e&&(e=d),o&&(O=f(),A[d.id]=O,d.id=O),b(d),RED.workspaces.add(d),I.push(d);else if("subflow"===d.type){var V=k(d,c[d.id]);V?B[d.id]=V:(M[d.id]=d,o&&(O=f(),d.id=O),d.in.forEach(function(e,t){e.type="subflow",e.direction="in",e.z=d.id,e.i=t,e.id=f()}),d.out.forEach(function(e,t){e.type="subflow",e.direction="out",e.z=d.id,e.i=t,e.id=f()}),z.push(d),y(d,o))}for(null==e&&(b(e={type:"tab",id:f(),disabled:!1,info:"",label:RED._("workspace.defaultName",{number:1})}),RED.workspaces.add(e),I.push(e),R=RED.workspaces.active()),s=0;s<l.length;s++)if(d=l[s],(L=u.getNodeType(d.type))&&"config"==L.category){var q=null;if(o){if(d.z){if(B[d.z])continue;M[d.z]?d.z=M[d.z].id:(d.z=A[d.z],r[d.z]||(i?(null===F&&(F=RED.workspaces.add(null,!0),I.push(F)),d.z=F.id):d.z=R))}if((q=RED.nodes.node(d.id))&&d.z&&q.z!==d.z){q=null;for(var W in a)if(a.hasOwnProperty(W)&&a[W].z===d.z&&_(a[W],d,!1)){q=a[W],J[d.id]=a[W];break}}}if(!q||q._def.exclusive){P={id:d.id,z:d.z,type:d.type,users:[],_config:{}};for(N in L.defaults)L.defaults.hasOwnProperty(N)&&(P[N]=d[N],P._config[N]=JSON.stringify(d[N]));if(L.hasOwnProperty("credentials")&&d.hasOwnProperty("credentials")){P.credentials={};for(N in L.credentials)L.credentials.hasOwnProperty(N)&&d.credentials.hasOwnProperty(N)&&(P.credentials[N]=d.credentials[N])}P.label=L.label,P._def=L,o&&(P.id=f()),J[d.id]=P,U.push(P),RED.nodes.add(P)}}for(s=0;s<l.length;s++)if("workspace"!==(d=l[s]).type&&"tab"!==d.type&&"subflow"!==d.type&&(!(L=u.getNodeType(d.type))||"config"!=L.category)){var H={x:d.x,y:d.y,z:d.z,type:0,wires:d.wires,inputLabels:d.inputLabels,outputLabels:d.outputLabels,icon:d.icon,changed:!1,_config:{}};if(o){if(B[d.z])continue;M[H.z]?H.z=M[H.z].id:(H.z=A[H.z],r[H.z]||(i?(null===F&&(F=RED.workspaces.add(null,!0),I.push(F)),H.z=F.id):H.z=R)),H.id=f()}else H.id=d.id,null!=H.z&&(r[H.z]||M[H.z])||(i?(null===F&&(F=RED.workspaces.add(null,!0),I.push(F)),H.z=F.id):H.z=R);if(H.type=d.type,H._def=L,"subflow"===d.type.substring(0,7)){var K=d.type.split(":")[1],Y=B[K]||M[K]||w(K);o&&(K=Y.id,H.type="subflow:"+K,H._def=u.getNodeType(H.type),delete H.i),H.name=d.name,H.outputs=Y.out.length,H.inputs=Y.in.length}else{if(!H._def){H.x&&H.y?H._def={color:"#fee",defaults:{},label:"unknown: "+d.type,labelStyle:"node_label_italic",outputs:d.outputs||d.wires.length,set:u.getNodeSet("node-red/unknown")}:(H._def={category:"config",set:u.getNodeSet("node-red/unknown")},H.users=[]);var X={};for(var Z in d)d.hasOwnProperty(Z)&&"x"!=Z&&"y"!=Z&&"z"!=Z&&"id"!=Z&&"wires"!=Z&&(X[Z]=d[Z]);H._orig=X,H.name=d.type,H.type="unknown"}if("config"!=H._def.category){H.inputs=d.inputs||H._def.inputs,H.outputs=d.outputs||H._def.outputs;for(N in H._def.defaults)H._def.defaults.hasOwnProperty(N)&&(H[N]=d[N],H._config[N]=JSON.stringify(d[N]));if(H._config.x=H.x,H._config.y=H.y,H._def.hasOwnProperty("credentials")&&d.hasOwnProperty("credentials")){H.credentials={};for(N in H._def.credentials)H._def.credentials.hasOwnProperty(N)&&d.credentials.hasOwnProperty(N)&&(H.credentials[N]=d.credentials[N])}}}h(H),RED.editor.validateNode(H),J[d.id]=H,"config"!=H._def.category&&U.push(H)}var Q={catch:"scope",status:"scope","link in":"links","link out":"links"};for(s=0;s<U.length;s++){if((d=U[s]).wires){for(var ee=0;ee<d.wires.length;ee++)for(var te=d.wires[ee]instanceof Array?d.wires[ee]:[d.wires[ee]],ne=0;ne<te.length;ne++)if(J.hasOwnProperty(te[ne]))if(d.z===J[te[ne]].z){var oe={source:d,sourcePort:ee,target:J[te[ne]]};g(oe),G.push(oe)}else console.log("Warning: dropping link that crosses tabs:",d.id,"->",J[te[ne]].id);delete d.wires}for(var ae in d._def.defaults)if(d._def.defaults.hasOwnProperty(ae))if(d._def.defaults[ae].type&&J[d[ae]])d[ae]=J[d[ae]].id,(P=RED.nodes.node(d[ae]))&&-1===P.users.indexOf(d)&&P.users.push(d);else if(Q.hasOwnProperty(d.type)&&Q[d.type]===ae&&void 0!==d[ae]&&null!==d[ae])for(var ie=0;ie<d[ae].length;ie++)J[d[ae][ie]]&&(d[ae][ie]=J[d[ae][ie]].id);x&&/^link /.test(d.type)&&d.links&&(d.links=d.links.filter(function(e){var t=RED.nodes.node(e);return t&&t.z===R})),RED.editor.validateNode(d)}for(s=0;s<z.length;s++)(d=z[s]).in.forEach(function(e){e.wires.forEach(function(t){var n={source:e,sourcePort:0,target:J[t.id]};g(n),G.push(n)}),delete e.wires}),d.out.forEach(function(e){e.wires.forEach(function(t){var n;g(n=M[t.id]&&M[t.id].id==d.id?{source:d.in[t.port],sourcePort:t.port,target:e}:{source:J[t.id]||M[t.id],sourcePort:t.port,target:e}),G.push(n)}),delete e.wires});return RED.workspaces.refresh(),[U,G,I,z,F]}function j(e){for(var t in e._def.defaults)if(e._def.defaults.hasOwnProperty(t)){var n=e._def.defaults[t];if(n.type){var o=u.getNodeType(n.type);if(o&&"config"==o.category){var i=a[e[t]];i&&-1===i.users.indexOf(e)&&i.users.push(e)}}}}return{init:function(){RED.events.on("registry:node-type-added",function(e){u.getNodeType(e);var t=[];if(RED.nodes.eachNode(function(n){"unknown"===n.type&&n.name===e&&t.push(n)}),RED.nodes.eachConfig(function(n){"unknown"===n.type&&n.name===e&&t.push(n)}),t.length>0){var n=[];t.forEach(function(e){a.hasOwnProperty(e.id)?delete a[e.id]:o.splice(o.indexOf(e),1),n.push(R(e))}),RED.view.redraw(!0);var i={};C(n,!1)[0].forEach(function(e){i[e.id]=e}),RED.nodes.eachLink(function(e){i.hasOwnProperty(e.source.id)&&(e.source=i[e.source.id]),i.hasOwnProperty(e.target.id)&&(e.target=i[e.target.id])}),RED.view.redraw(!0)}})},registry:u,setNodeList:u.setNodeList,getNodeSet:u.getNodeSet,addNodeSet:u.addNodeSet,removeNodeSet:u.removeNodeSet,enableNodeSet:u.enableNodeSet,disableNodeSet:u.disableNodeSet,setIconSets:u.setIconSets,getIconSets:u.getIconSets,registerType:u.registerNodeType,getType:u.getNodeType,convertNode:R,add:h,remove:m,clear:function(){o=[],s=[],a={},d=[],Object.keys(l).forEach(function(e){RED.subflow.removeSubflow(e)}),Object.keys(r).forEach(function(e){RED.workspaces.remove(r[e])}),e=null,t=null,RED.nodes.dirty(!1),RED.view.redraw(!0),RED.palette.refresh(),RED.workspaces.refresh(),RED.sidebar.config.refresh(),RED.sidebar.info.refresh()},addLink:g,removeLink:function(e){var t=s.indexOf(e);-1!=t&&s.splice(t,1)},addWorkspace:b,removeWorkspace:function(e){delete r[e],d.splice(d.indexOf(e),1);var t,n,i=[],s=[];for(t=0;t<o.length;t++)(n=o[t]).z==e&&i.push(n);for(t in a)a.hasOwnProperty(t)&&(n=a[t]).z==e&&i.push(n);for(t=0;t<i.length;t++){var l=m(i[t].id);s=s.concat(l.links)}return{nodes:i,links:s}},getWorkspaceOrder:function(){return d},setWorkspaceOrder:function(e){d=e},workspace:function(e){return r[e]},addSubflow:y,removeSubflow:function(e){delete l[e.id],u.removeNodeType("subflow:"+e.id)},subflow:w,subflowContains:D,eachNode:function(e){for(var t=0;t<o.length;t++)e(o[t])},eachLink:function(e){for(var t=0;t<s.length;t++)e(s[t])},eachConfig:function(e){for(var t in a)a.hasOwnProperty(t)&&e(a[t])},eachSubflow:function(e){for(var t in l)l.hasOwnProperty(t)&&e(l[t])},eachWorkspace:function(e){for(var t=0;t<d.length;t++)e(r[d[t]])},node:v,version:function(e){if(void 0===e)return c;c=e},originalFlow:function(e){if(void 0===e)return t;t=e},filterNodes:function(e){for(var t=[],n=0;n<o.length;n++){var a=o[n];e.hasOwnProperty("z")&&a.z!==e.z||e.hasOwnProperty("type")&&a.type!==e.type||t.push(a)}return t},filterLinks:function(e){for(var t=[],n=0;n<s.length;n++){var o=s[n];if(e.source){if(e.source.hasOwnProperty("id")&&o.source.id!==e.source.id)continue;if(e.source.hasOwnProperty("z")&&o.source.z!==e.source.z)continue}if(e.target){if(e.target.hasOwnProperty("id")&&o.target.id!==e.target.id)continue;if(e.target.hasOwnProperty("z")&&o.target.z!==e.target.z)continue}e.hasOwnProperty("sourcePort")&&o.sourcePort!==e.sourcePort||t.push(o)}return t},import:C,getAllFlowNodes:function(e){var t={};t[e.id]=!0;for(var n=[e],o=[e];0!==o.length;)for(var a=o.shift(),i=s.filter(function(e){return e.source===a||e.target===a}),r=0;r<i.length;r++){var d=i[r].source===a?i[r].target:i[r].source,l=d.id;l||(l=d.direction+":"+d.i),t[l]||(t[l]=!0,n.push(d),o.push(d))}return n},createExportableNodeSet:T,createCompleteNodeSet:function(e){void 0===e&&(e=!0);var t,n=[];for(t=0;t<d.length;t++)"tab"==r[d[t]].type&&n.push(E(r[d[t]]));for(t in l)l.hasOwnProperty(t)&&n.push(x(l[t]));for(t in a)a.hasOwnProperty(t)&&n.push(R(a[t],e));for(t=0;t<o.length;t++){var i=o[t];n.push(R(i,e))}return n},updateConfigNodeUsers:j,id:f,dirty:function(e){if(null==e)return p;p=e,RED.events.emit("nodes:change",{dirty:p})}}}(),RED.history=function(){var e=[];return{markAllDirty:function(){for(var t=0;t<e.length;t++)e[t].dirty=!0},list:function(){return e},depth:function(){return e.length},push:function(t){e.push(t)},pop:function(){!function e(t){var n,o,a,i={};if(t){if("multi"==t.t)for(n=t.events.length-1;n>=0;n--)e(t.events[n]);else if("replace"==t.t)RED.nodes.clear(),RED.nodes.import(t.config)[0].forEach(function(e){t.changed[e.id]&&(e.changed=!0)}),RED.nodes.version(t.rev);else if("add"==t.t){if(t.nodes)for(n=0;n<t.nodes.length;n++)(o=RED.nodes.node(t.nodes[n])).z&&(i[o.z]=!0),RED.nodes.remove(t.nodes[n]);if(t.links)for(n=0;n<t.links.length;n++)RED.nodes.removeLink(t.links[n]);if(t.workspaces)for(n=0;n<t.workspaces.length;n++)RED.nodes.removeWorkspace(t.workspaces[n].id),RED.workspaces.remove(t.workspaces[n]);if(t.subflows)for(n=0;n<t.subflows.length;n++)RED.nodes.removeSubflow(t.subflows[n]),RED.workspaces.remove(t.subflows[n]);if(t.subflow&&(t.subflow.instances&&t.subflow.instances.forEach(function(e){var t=RED.nodes.node(e.id);t&&(t.changed=e.changed,t.dirty=!0)}),t.subflow.hasOwnProperty("changed")&&(a=RED.nodes.subflow(t.subflow.id))&&(a.changed=t.subflow.changed)),t.removedLinks)for(n=0;n<t.removedLinks.length;n++)RED.nodes.addLink(t.removedLinks[n])}else if("delete"==t.t){if(t.workspaces)for(n=0;n<t.workspaces.length;n++)RED.nodes.addWorkspace(t.workspaces[n]),RED.workspaces.add(t.workspaces[n]);if(t.subflow&&t.subflow.subflow&&RED.nodes.addSubflow(t.subflow.subflow),t.subflowInputs&&t.subflowInputs.length>0&&((a=RED.nodes.subflow(t.subflowInputs[0].z)).in.push(t.subflowInputs[0]),a.in[0].dirty=!0),t.subflowOutputs&&t.subflowOutputs.length>0)for(a=RED.nodes.subflow(t.subflowOutputs[0].z),t.subflowOutputs.sort(function(e,t){return e.i-t.i}),n=0;n<t.subflowOutputs.length;n++){var s=t.subflowOutputs[n];a.out.splice(s.i,0,s);for(var r=s.i+1;r<a.out.length;r++)a.out[r].i++,a.out[r].dirty=!0;RED.nodes.eachLink(function(e){e.source.type=="subflow:"+a.id&&e.sourcePort>=s.i&&e.sourcePort++})}if(t.subflow&&t.subflow.hasOwnProperty("instances")&&t.subflow.instances.forEach(function(e){var t=RED.nodes.node(e.id);t&&(t.changed=e.changed,t.dirty=!0)}),a&&RED.nodes.filterNodes({type:"subflow:"+a.id}).forEach(function(e){for(e.inputs=a.in.length,e.outputs=a.out.length;e.outputs>e.ports.length;)e.ports.push(e.ports.length);e.resize=!0,e.dirty=!0}),t.nodes)for(n=0;n<t.nodes.length;n++)RED.nodes.add(t.nodes[n]),i[t.nodes[n].z]=!0;if(t.links)for(n=0;n<t.links.length;n++)RED.nodes.addLink(t.links[n]);if(t.changes)for(n in t.changes)if(t.changes.hasOwnProperty(n)&&(o=RED.nodes.node(n))){for(var d in t.changes[n])t.changes[n].hasOwnProperty(d)&&(o[d]=t.changes[n][d]);o.dirty=!0}}else if("move"==t.t){for(n=0;n<t.nodes.length;n++){var l=t.nodes[n];l.n.x=l.ox,l.n.y=l.oy,l.n.dirty=!0,l.n.moved=l.moved}if(t.links)for(n=0;n<t.links.length;n++)RED.nodes.removeLink(t.links[n]);if(t.removedLinks)for(n=0;n<t.removedLinks.length;n++)RED.nodes.addLink(t.removedLinks[n])}else if("edit"==t.t){for(n in t.changes)if(t.changes.hasOwnProperty(n)){if(t.node._def.defaults&&t.node._def.defaults[n]&&t.node._def.defaults[n].type){var c=RED.nodes.node(t.node[n]);c&&c.users.splice(c.users.indexOf(t.node),1);var p=RED.nodes.node(t.changes[n]);p&&p.users.push(t.node)}t.node[n]=t.changes[n]}if(t.subflow)t.subflow.hasOwnProperty("inputCount")&&(t.node.in.length>t.subflow.inputCount?t.node.in.splice(t.subflow.inputCount):t.subflow.inputs.length>0&&(t.node.in=t.node.in.concat(t.subflow.inputs))),t.subflow.hasOwnProperty("outputCount")&&(t.node.out.length>t.subflow.outputCount?t.node.out.splice(t.subflow.outputCount):t.subflow.outputs.length>0&&(t.node.out=t.node.out.concat(t.subflow.outputs))),t.subflow.hasOwnProperty("instances")&&t.subflow.instances.forEach(function(e){var t=RED.nodes.node(e.id);t&&(t.changed=e.changed,t.dirty=!0)}),RED.nodes.filterNodes({type:"subflow:"+t.node.id}).forEach(function(e){e.inputs=t.node.in.length,e.outputs=t.node.out.length,RED.editor.updateNodeProperties(e)});else{var u;if(t.outputMap){u={};for(var f in t.outputMap)t.outputMap.hasOwnProperty(f)&&"-1"!==t.outputMap[f]&&(u[t.outputMap[f]]=f)}RED.editor.updateNodeProperties(t.node,u),RED.editor.validateNode(t.node)}if(t.links)for(n=0;n<t.links.length;n++)RED.nodes.addLink(t.links[n]);t.node.dirty=!0,t.node.changed=t.changed}else if("createSubflow"==t.t){if(t.nodes)for(RED.nodes.filterNodes({z:t.subflow.subflow.id}).forEach(function(e){e.z=t.activeWorkspace,e.dirty=!0}),n=0;n<t.nodes.length;n++)RED.nodes.remove(t.nodes[n]);if(t.links)for(n=0;n<t.links.length;n++)RED.nodes.removeLink(t.links[n]);if(RED.nodes.removeSubflow(t.subflow.subflow),RED.workspaces.remove(t.subflow.subflow),t.removedLinks)for(n=0;n<t.removedLinks.length;n++)RED.nodes.addLink(t.removedLinks[n])}else"reorder"==t.t&&t.order&&RED.workspaces.order(t.order);Object.keys(i).forEach(function(e){var t=RED.nodes.subflow(e);t&&RED.editor.validateNode(t)}),RED.nodes.dirty(t.dirty),RED.view.redraw(!0),RED.palette.refresh(),RED.workspaces.refresh(),RED.sidebar.config.refresh()}}(e.pop())},peek:function(){return e[e.length-1]},clear:function(){e=[]}}}(),RED.validators={number:function(e){return function(t){return e&&(""===t||void 0===t)||""!==t&&!isNaN(t)}},regex:function(e){return function(t){return e.test(t)}},typedInput:function(e,t){return function(n){var o=$("#node-"+(t?"config-":"")+"input-"+e).val()||this[e];if("json"===o)try{return JSON.parse(n),!0}catch(e){return!1}else{if("msg"===o||"flow"===o||"global"===o)return RED.utils.validatePropertyExpression(n);if("num"===o)return/^[+-]?[0-9]*\.?[0-9]*([eE][-+]?[0-9]+)?$/.test(n)}return!0}}},RED.utils=function(){function e(e){return e.replace(/\r?\n/g,"&crarr;").replace(/\t/g,"&rarr;")}function t(e){return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}function n(n){var o;if(Array.isArray(n))o=$('<span class="debug-message-object-value debug-message-type-meta"></span>').html("array["+n.length+"]");else if(null===n)o=$('<span class="debug-message-object-value debug-message-type-null">null</span>');else if("object"==typeof n)o=n.hasOwnProperty("type")&&"Buffer"===n.type&&n.hasOwnProperty("data")?$('<span class="debug-message-object-value debug-message-type-meta"></span>').html("buffer["+n.length+"]"):n.hasOwnProperty("type")&&"array"===n.type&&n.hasOwnProperty("data")?$('<span class="debug-message-object-value debug-message-type-meta"></span>').html("array["+n.length+"]"):$('<span class="debug-message-object-value debug-message-type-meta">object</span>');else if("string"==typeof n){var a;a=n.length>30?t(n.substring(0,30))+"&hellip;":t(n),o=$('<span class="debug-message-object-value debug-message-type-string"></span>').html('"'+e(a)+'"')}else o=$('<span class="debug-message-object-value debug-message-type-other"></span>').text(""+n);return o}function o(e,t,n,o){e.addClass("debug-message-expandable"),e.prop("toggle",function(){return function(n){var o=e.parent();if(o.hasClass("collapsed")){if(n)return t&&!o.hasClass("built")&&(t(),o.addClass("built")),o.removeClass("collapsed"),!0}else if(!n)return o.addClass("collapsed"),!0;return!1}}),e.click(function(e){var t=!$(this).parent().hasClass("collapsed");$(this).prop("toggle")(!t)&&n&&n(!t),e.preventDefault()}),o&&e.click()}var a={},i={};function s(e,t,n,o){if(t&&t.length>0){if(""===e&&void 0===n)return!0;for(var a=0;a<t.length;a++){var i=t[a];if(0===i.indexOf(e)&&("."===i[e.length]||"["===i[e.length])){if(void 0===n||"["!==i[e.length])return!0;var s=i.substring(e.length),r=/\[(\d+)\]/.exec(s);if(r){var d=parseInt(r[1]);return n<=d&&d<=o}}}}return!1}function r(e,t,n,o,a,s){var r=i[n]&&i[n][o]&&i[n][o].number||s||"dec";a?(r="dec"===r?13===t.toString().length&&t<=2147483647e3?"dateMS":10===t.toString().length&&t<=2147483647?"dateS":"hex":"dateMS"===r||"dateS"==r?"hex":"dec",i[n]=i[n]||{},i[n][o]=i[n][o]||{},i[n][o].number=r):void 0!==s&&(i[n]=i[n]||{},i[n][o]=i[n][o]||{},i[n][o].number=r),"dec"===r?e.text(""+t):"dateMS"===r?e.text(new Date(t).toISOString()):"dateS"===r?e.text(new Date(1e3*t).toISOString()):"hex"===r&&e.text("0x"+t.toString(16))}function d(e,t,n,o,a){var s=i[n]&&i[n][o]&&i[n][o].buffer||"raw";a&&(s="raw"===s?"string":"raw",i[n]=i[n]||{},i[n][o]=i[n][o]||{},i[n][o].buffer=s),"raw"===s?(t.text("raw"),e.removeClass("debug-message-buffer-string").addClass("debug-message-buffer-raw")):"string"===s&&(t.text("string"),e.addClass("debug-message-buffer-string").removeClass("debug-message-buffer-raw"))}function l(e){var t=e.length;if(0===t)throw new Error("Invalid property expression: zero-length");for(var n,o,a=[],i=0,s=!1,r=!1,d=0;d<t;d++){var l=e[d];if(s){if(l===n){if(d-i==0)throw new Error("Invalid property expression: zero-length string at position "+i);if(a.push(e.substring(i,d)),r&&!/\]/.test(e[d+1]))throw new Error("Invalid property expression: unexpected array expression at position "+i);if(!r&&d+1!==t&&!/[\[\.]/.test(e[d+1]))throw new Error("Invalid property expression: unexpected "+e[d+1]+" expression at position "+(d+1));i=d+1,s=!1}}else if("'"===l||'"'===l){if(d!=i)throw new Error("Invalid property expression: unexpected "+l+" at position "+d);s=!0,n=l,i=d+1}else if("."===l){if(0===d)throw new Error("Invalid property expression: unexpected . at position 0");if(i!=d&&(o=e.substring(i,d),/^\d+$/.test(o)?a.push(parseInt(o)):a.push(o)),d===t-1)throw new Error("Invalid property expression: unterminated expression");if(!/[a-z0-9\$\_]/i.test(e[d+1]))throw new Error("Invalid property expression: unexpected "+e[d+1]+" at position "+(d+1));i=d+1}else if("["===l){if(0===d)throw new Error("Invalid property expression: unexpected "+l+" at position "+d);if(i!=d&&a.push(e.substring(i,d)),d===t-1)throw new Error("Invalid property expression: unterminated expression");if(!/["'\d]/.test(e[d+1]))throw new Error("Invalid property expression: unexpected "+e[d+1]+" at position "+(d+1));i=d+1,r=!0}else if("]"===l){if(!r)throw new Error("Invalid property expression: unexpected "+l+" at position "+d);if(i!=d){if(o=e.substring(i,d),!/^\d+$/.test(o))throw new Error("Invalid property expression: unexpected array expression at position "+i);a.push(parseInt(o))}i=d+1,r=!1}else if(" "===l)throw new Error("Invalid property expression: unexpected ' ' at position "+d)}if(r||s)throw new Error("Invalid property expression: unterminated expression");return i<t&&a.push(e.substring(i)),a}function c(e,t){var n,o=null;return"string"==typeof t?(0===t.indexOf("msg.")&&(t=t.substring(4)),n=l(t)):n=t,n.reduce(function(e,t){return void 0===(o=void 0!==e[t]?e[t]:void 0)&&e.hasOwnProperty("type")&&e.hasOwnProperty("data")&&e.hasOwnProperty("length")&&(o=void 0!==e.data[t]?e.data[t]:void 0),o},e),o}function p(e){var t={module:"",file:""};if(e){var n=e.indexOf("/");-1!==n?(t.module=e.slice(0,n),t.file=e.slice(n+1)):t.file=e}return t}function u(e,t){var n;if("function"==typeof e.icon)try{n=e.icon.call(t)}catch(t){console.log("Definition error: "+e.type+".icon",t),n="arrow-in.png"}else n=e.icon;var o=p(n);return o.module||(e.set?o.module=e.set.module:o.module="node-red"),o}return{createObjectElement:function i(p,u){var f,h,g,v,m,b,y=(u=u||{}).key,w=u.typeHint,D=u.hideKey,E=u.path,R=u.sourceId,x=u.rootPath,T=u.expandPaths,k=u.ontoggle,_=u.exposeApi,C={};void 0!==E&&void 0!==x&&(b=E.substring(x.length+("."===E[x.length]?1:0)));var j=$('<span class="debug-message-element"></span>');if(j.collapse=function(){j.find(".debug-message-expandable").parent().addClass("collapsed")},v=$('<span class="debug-message-row"></span>').appendTo(j),R&&function(e,t,n,o,i,s){a.hasOwnProperty(t)||(a[t]={});var r=$('<span class="debug-message-tools"></span>').appendTo(e),d=$('<span class="debug-message-tools-copy button-group"></span>').appendTo(r);if(n)var c=$('<button class="editor-button editor-button-small"><i class="fa fa-terminal"></i></button>').appendTo(d).click(function(e){e.preventDefault(),e.stopPropagation(),RED.clipboard.copyText(n,c,"clipboard.copyMessagePath")});var p=$('<button class="editor-button editor-button-small"><i class="fa fa-clipboard"></i></button>').appendTo(d).click(function(e){e.preventDefault(),e.stopPropagation(),RED.clipboard.copyText(o,p,"clipboard.copyMessageValue")});if(""!==s){var u=a[t].hasOwnProperty(s);$('<button class="editor-button editor-button-small debug-message-tools-pin"><i class="fa fa-map-pin"></i></button>').appendTo(r).click(function(n){if(n.preventDefault(),n.stopPropagation(),a[t].hasOwnProperty(s))delete a[t][s],$(this).removeClass("selected"),e.removeClass("debug-message-row-pinned");else{var o="$"+("["===s[0]?"":".")+s;a[t][s]=l(o),$(this).addClass("selected"),e.addClass("debug-message-row-pinned")}}).toggleClass("selected",u),e.toggleClass("debug-message-row-pinned",u)}}(v,R,E,p,0,b),y)D||($('<span class="debug-message-object-key"></span>').text(y).appendTo(v),$("<span>: </span>").appendTo(v));else if(j.addClass("debug-message-top-level"),R){var S=a[R];if(T=[],S){for(var O in S)if(S.hasOwnProperty(O))try{void 0!==c({$:p},S[O])&&T.push(O)}catch(e){}T.sort()}j.clearPinned=function(){j.find(".debug-message-row-pinned").removeClass("debug-message-row-pinned"),a[R]={}}}g=$('<span class="debug-message-object-value"></span>').appendTo(v);var L=Array.isArray(p),P=!1;if(p&&"object"==typeof p&&p.hasOwnProperty("type")&&p.hasOwnProperty("data")&&(p.__encoded__&&"array"===p.type||"Buffer"===p.type)&&(L=!0,P=!0),null===p||void 0===p)$('<span class="debug-message-type-null">'+p+"</span>").appendTo(g);else if("string"==typeof p)/[\t\n\r]/.test(p)&&(j.addClass("collapsed"),$('<i class="fa fa-caret-right debug-message-object-handle"></i> ').prependTo(v),o(v,function(){$('<span class="debug-message-type-meta debug-message-object-type-header"></span>').html(w||"string").appendTo(v);var e=$('<div class="debug-message-object-entry collapsed"></div>').appendTo(j);$('<pre class="debug-message-type-string"></pre>').text(p).appendTo(e)},function(e){k&&k(E,e)},s(b,T))),h=$('<span class="debug-message-type-string debug-message-object-header"></span>').html('"'+e(t(p))+'"').appendTo(g),/^#[0-9a-f]{6}$/i.test(p)&&$('<span class="debug-message-type-string-swatch"></span>').css("backgroundColor",p).appendTo(h);else if("number"==typeof p)h=$('<span class="debug-message-type-number"></span>').appendTo(g),Number.isInteger(p)&&p>=0&&(h.addClass("debug-message-type-number-toggle"),h.click(function(e){e.preventDefault(),r($(this),p,R,E,!0)})),r(h,p,R,E,!1,"hex"===w?"hex":void 0);else if(L){j.addClass("collapsed");var N=p.length;if(w){var I=/\[(\d+)\]/.exec(w);I&&(N=parseInt(I[1]))}var A=p,z="array";P?(A=p.data,void 0===N&&(N=A.length),A.__encoded__&&(A=A.data),z=p.type.toLowerCase()):/buffer/.test(w)&&(z="buffer");var M=A.length;if(N>0){$('<i class="fa fa-caret-right debug-message-object-handle"></i> ').prependTo(v);var B=$('<div class="debug-message-array-rows"></div>').appendTo(j);j.addClass("debug-message-buffer-raw")}if(y)m=$('<span class="debug-message-type-meta"></span>').html(w||z+"["+N+"]").appendTo(g);else{m=$('<span class="debug-message-object-header"></span>').appendTo(g),$("<span>[ </span>").appendTo(m);var J=Math.min(N,10);for(f=0;f<J;f++)n(A[f]).appendTo(m),f<J-1&&$("<span>, </span>").appendTo(m);N>J&&$("<span> &hellip;</span>").appendTo(m),0===J&&$('<span class="debug-message-type-meta">empty</span>').appendTo(m),$("<span> ]</span>").appendTo(m)}N>0&&o(v,function(){if(y||(m=$('<span class="debug-message-type-meta debug-message-object-type-header"></span>').html(w||z+"["+N+"]").appendTo(v)),"buffer"===z){var e=$('<div class="debug-message-string-rows"></div>').appendTo(j),t=$('<div class="debug-message-object-entry collapsed"></div>').appendTo(e),n="";try{n=String.fromCharCode.apply(null,new Uint16Array(A))}catch(e){console.log(e)}$('<pre class="debug-message-type-string"></pre>').text(n).appendTo(t);var a=$('<span class="debug-message-buffer-opts"></span>').appendTo(m),r=$('<a href="#"></a>').addClass("selected").html("raw").appendTo(a).click(function(e){e.preventDefault(),e.stopPropagation(),d(j,$(this),R,E,!0)});d(j,r,R,E,!1)}var l;if(M<=10)for(f=0;f<M;f++)l=$('<div class="debug-message-object-entry collapsed"></div>').appendTo(B),C[E+"["+f+"]"]=i(A[f],{key:""+f,typeHint:"buffer"===z&&"hex",hideKey:!1,path:E+"["+f+"]",sourceId:R,rootPath:x,expandPaths:T,ontoggle:k,exposeApi:_}).appendTo(l);else{for(f=0;f<M;f+=10){var c=f;l=$('<div class="debug-message-object-entry collapsed"></div>').appendTo(B),v=$("<span></span>").appendTo(l),$('<i class="fa fa-caret-right debug-message-object-handle"></i> ').appendTo(v),o(v,function(){var e=c,t=Math.min(M-1,c+9),n=l;return function(){for(var o=e;o<=t;o++){var a=$('<div class="debug-message-object-entry collapsed"></div>').appendTo(n);C[E+"["+o+"]"]=i(A[o],{key:""+o,typeHint:"buffer"===z&&"hex",hideKey:!1,path:E+"["+o+"]",sourceId:R,rootPath:x,expandPaths:T,ontoggle:k,exposeApi:_}).appendTo(a)}}}(),function(){var e=e+"["+f+"]";return function(t){k&&k(e,t)}}(),s(b,T,c,Math.min(M-1,c+9))),$('<span class="debug-message-object-key"></span>').html("["+c+" &hellip; "+Math.min(M-1,c+9)+"]").appendTo(v)}M<N&&$('<div class="debug-message-object-entry collapsed"><span class="debug-message-object-key">['+M+" &hellip; "+N+"]</span></div>").appendTo(B)}},function(e){k&&k(E,e)},s(b,T))}else if("object"==typeof p){j.addClass("collapsed");var U=Object.keys(p);if((y||U.length>0)&&($('<i class="fa fa-caret-right debug-message-object-handle"></i> ').prependTo(v),o(v,function(){for(y||$('<span class="debug-message-type-meta debug-message-object-type-header"></span>').html("object").appendTo(v),f=0;f<U.length;f++){var e=$('<div class="debug-message-object-entry collapsed"></div>').appendTo(j),t=E;void 0!==t&&(/^[a-zA-Z_$][0-9a-zA-Z_$]*$/.test(U[f])?t+=(t.length>0?".":"")+U[f]:t+='["'+U[f].replace(/"/,'\\"')+'"]'),C[t]=i(p[U[f]],{key:U[f],typeHint:!1,hideKey:!1,path:t,sourceId:R,rootPath:x,expandPaths:T,ontoggle:k,exposeApi:_}).appendTo(e)}0===U.length&&$('<div class="debug-message-object-entry debug-message-type-meta collapsed"></div>').text("empty").appendTo(j)},function(e){k&&k(E,e)},s(b,T))),y)$('<span class="debug-message-type-meta"></span>').html("object").appendTo(g);else{m=$('<span class="debug-message-object-header"></span>').appendTo(g),$("<span>{ </span>").appendTo(m);var G=Math.min(U.length,5);for(f=0;f<G;f++)$('<span class="debug-message-object-key"></span>').text(U[f]).appendTo(m),$("<span>: </span>").appendTo(m),n(p[U[f]]).appendTo(m),f<G-1&&$("<span>, </span>").appendTo(m);U.length>G&&$("<span> &hellip;</span>").appendTo(m),0===G&&$('<span class="debug-message-type-meta">empty</span>').appendTo(m),$("<span> }</span>").appendTo(m)}}else $('<span class="debug-message-type-other"></span>').text(""+p).appendTo(g);return _&&j.prop("expand",function(){return function(e,t){if(E===e)v.prop("toggle")&&v.prop("toggle")(t);else if(C[e]&&C[e].prop("expand"))C[e].prop("expand")(e,t);else for(var n in C)if(C.hasOwnProperty(n)&&0===e.indexOf(n)){C[n].prop("expand")&&C[n].prop("expand")(e,t);break}}}),j},getMessageProperty:c,normalisePropertyExpression:l,validatePropertyExpression:function(e){try{return l(e),!0}catch(e){return!1}},separateIconPath:p,getDefaultNodeIcon:u,getNodeIcon:function(e,t){if("config"===e.category)return"icons/node-red/cog.png";if(t&&"tab"===t.type)return"icons/node-red/subflow.png";if(t&&"unknown"===t.type)return"icons/node-red/alert.png";if(t&&"subflow"===t.type)return"icons/node-red/subflow.png";if(t&&t.icon){var n=p(t.icon),o=RED.nodes.getIconSets()[n.module];if(o&&-1!==o.indexOf(n.file))return"icons/"+t.icon}return"icons/"+(n=u(e,t)).module+"/"+n.file},getNodeLabel:function(e,t){var n;if(t=t||"","tab"===e.type)n=e.label||t;else{n=e._def.label;try{n=("function"==typeof n?n.call(e):n)||t}catch(o){console.log("Definition error: "+e.type+".label",o),n=t}}return RED.text.bidi.enforceTextDirectionWithUCC(n)},addSpinnerOverlay:function(e,t){var n=$('<div class="projects-dialog-spinner "><img src="red/images/spin.svg"/></div>').appendTo(e);return t&&n.addClass("projects-dialog-spinner-contain"),n}}}(),function(e){e.widget("nodered.editableList",{_create:function(){var t,n=this;(this.element.addClass("red-ui-editableList-list"),this.uiWidth=this.element.width(),this.uiContainer=this.element.wrap("<div>").parent(),this.options.header?(this.options.header.addClass("red-ui-editableList-header"),this.borderContainer=this.uiContainer.wrap("<div>").parent(),this.borderContainer.prepend(this.options.header),this.topContainer=this.borderContainer.wrap("<div>").parent()):this.topContainer=this.uiContainer.wrap("<div>").parent(),this.topContainer.addClass("red-ui-editableList"),this.options.class&&this.topContainer.addClass(this.options.class),!1!==this.options.addButton)&&(t="string"==typeof this.options.addButton?this.options.addButton:RED&&RED._?RED._("editableList.add"):"add",e('<a href="#" class="editor-button editor-button-small red-ui-editableList-addButton" style="margin-top: 4px;"><i class="fa fa-plus"></i> '+t+"</a>").appendTo(this.topContainer).click(function(e){e.preventDefault(),n.addItem({})}));"absolute"===this.element.css("position")&&(["top","left","bottom","right"].forEach(function(e){var t=n.element.css(e);"auto"!==t&&""!==t&&(n.topContainer.css(e,t),n.uiContainer.css(e,"0"),n.element.css(e,"auto"))}),this.element.css("position","static"),this.topContainer.css("position","absolute"),this.uiContainer.css("position","absolute")),this.options.header?this.borderContainer.addClass("red-ui-editableList-border"):this.uiContainer.addClass("red-ui-editableList-border"),this.uiContainer.addClass("red-ui-editableList-container"),this.uiHeight=this.element.height(),this.activeFilter=this.options.filter||null,this.activeSort=this.options.sort||null,this.scrollOnAdd=this.options.scrollOnAdd,void 0===this.scrollOnAdd&&(this.scrollOnAdd=!0);var o=this.element.css("minHeight");"0px"!==o&&(this.uiContainer.css("minHeight",o),this.element.css("minHeight",0));var a=this.element.css("maxHeight");"0px"!==a&&(this.uiContainer.css("maxHeight",a),this.element.css("maxHeight",null)),"auto"!==this.options.height&&(this.uiContainer.css("overflow-y","scroll"),isNaN(this.options.height)||(this.uiHeight=this.options.height)),this.element.height("auto");var i,s=this.element.attr("style");if(null!==(i=/width\s*:\s*(\d+%)/i.exec(s))&&(this.element.width("100%"),this.uiContainer.width(i[1])),this.options.sortable){var r={axis:"y",update:function(e,t){n.options.sortItems&&n.options.sortItems(n.items())},handle:"string"==typeof this.options.sortable?this.options.sortable:".red-ui-editableList-item-handle",cursor:"move",tolerance:"pointer",forcePlaceholderSize:!0,placeholder:"red-ui-editabelList-item-placeholder",start:function(e,t){t.placeholder.height(t.item.height()-4)}};this.options.connectWith&&(r.connectWith=this.options.connectWith),this.element.sortable(r)}this._resize()},_resize:function(){var t=this.topContainer.height()-this.uiContainer.height();if(0!==this.uiHeight&&this.uiContainer.height(this.uiHeight-t),this.options.resize&&this.options.resize(),this.options.resizeItem){var n=this;this.element.children().each(function(t){n.options.resizeItem(e(this).find(".red-ui-editableList-item-content"),t)})}},_destroy:function(){},_refreshFilter:function(){var e=this,t=0;return this.activeFilter?(this.items().each(function(n,o){var a=o.data("data");try{e.activeFilter(a)?(o.parent().show(),t++):o.parent().hide()}catch(e){console.log(e),o.parent().show(),t++}}),t):this.element.children().show()},_refreshSort:function(){if(this.activeSort){var t=this.element.children(),n=this;t.sort(function(t,o){return n.activeSort(e(t).find(".red-ui-editableList-item-content").data("data"),e(o).find(".red-ui-editableList-item-content").data("data"))}),e.each(t,function(e,t){n.element.append(t)})}},width:function(e){this.uiWidth=e,this._resize()},height:function(e){this.uiHeight=e,this._resize()},addItem:function(t){var n=this;t=t||{};var o=e("<li>"),a=!1;if(this.activeSort){this.items().each(function(e,i){if(!a){var s=i.data("data");n.activeSort(t,s)<0&&(o.insertBefore(i.closest("li")),a=!0)}})}a||o.appendTo(this.element);var i=e("<div/>").addClass("red-ui-editableList-item-content").appendTo(o);if(i.data("data",t),!0===this.options.sortable&&(e('<i class="red-ui-editableList-item-handle fa fa-bars"></i>').appendTo(o),o.addClass("red-ui-editableList-item-sortable")),this.options.removable){var s=e("<a/>",{href:"#",class:"red-ui-editableList-item-remove editor-button editor-button-small"}).appendTo(o);e("<i/>",{class:"fa fa-remove"}).appendTo(s),o.addClass("red-ui-editableList-item-removable"),s.click(function(t){t.preventDefault();var a=i.data("data");o.addClass("red-ui-editableList-item-deleting"),o.fadeOut(300,function(){e(this).remove(),n.options.removeItem&&n.options.removeItem(a)})})}if(this.options.addItem){var r=n.element.children().length-1;setTimeout(function(){if(n.options.addItem(i,r,t),n.activeFilter)try{n.activeFilter(t)||o.hide()}catch(e){}!n.activeSort&&n.scrollOnAdd&&setTimeout(function(){n.uiContainer.scrollTop(n.element.height())},0)},0)}},addItems:function(e){for(var t=0;t<e.length;t++)this.addItem(e[t])},removeItem:function(t){this.element.children().filter(function(n){return t===e(this).find(".red-ui-editableList-item-content").data("data")}).remove(),this.options.removeItem&&this.options.removeItem(t)},items:function(){return this.element.children().map(function(t){return e(this).find(".red-ui-editableList-item-content")})},empty:function(){this.element.empty()},filter:function(e){return void 0!==e&&(this.activeFilter=e),this._refreshFilter()},sort:function(e){return void 0!==e&&(this.activeSort=e),this._refreshSort()},length:function(){return this.element.children().length}})}(jQuery),function(e){e.widget("nodered.checkboxSet",{_create:function(){var t=this;this.uiElement=this.element.wrap("<span>").parent(),this.uiElement.addClass("red-ui-checkboxSet"),this.options.parent&&(this.parent=this.options.parent,this.parent.checkboxSet("addChild",this.element)),this.children=[],this.partialFlag=!1,this.stateValue=0;var n=this.element.prop("checked");this.options=[e('<span class="red-ui-checkboxSet-option hide"><i class="fa fa-square-o"></i></span>').appendTo(this.uiElement),e('<span class="red-ui-checkboxSet-option hide"><i class="fa fa-check-square-o"></i></span>').appendTo(this.uiElement),e('<span class="red-ui-checkboxSet-option hide"><i class="fa fa-minus-square-o"></i></span>').appendTo(this.uiElement)],n?this.options[1].show():this.options[0].show(),this.element.change(function(){this.checked?(t.options[0].hide(),t.options[1].show(),t.options[2].hide()):(t.options[1].hide(),t.options[0].show(),t.options[2].hide());var e=this.checked;t.children.forEach(function(t){t.checkboxSet("state",e,!1,!0)})}),this.uiElement.click(function(e){e.stopPropagation(),t.state(!1===t.state())}),this.parent&&this.parent.checkboxSet("updateChild",this)},_destroy:function(){this.parent&&this.parent.checkboxSet("removeChild",this.element)},addChild:function(e){this.children.push(e)},removeChild:function(e){var t=this.children.indexOf(e);t>-1&&this.children.splice(t,1)},updateChild:function(e){var t=0;this.children.forEach(function(e,n){!0===e.checkboxSet("state")&&t++}),0===t?this.state(!1,!0):t===this.children.length?this.state(!0,!0):this.state(null,!0)},disable:function(){this.uiElement.addClass("disabled")},state:function(e,t,n){if(0===arguments.length)return this.partialFlag?null:this.element.is(":checked");this.partialFlag=null===e;var o=this.partialFlag||e;this.element.prop("checked",o),!0===e?(this.options[0].hide(),this.options[1].show(),this.options[2].hide()):!1===e?(this.options[2].hide(),this.options[1].hide(),this.options[0].show()):null===e&&(this.options[0].hide(),this.options[1].hide(),this.options[2].show()),t||this.element.trigger("change",null),!n&&this.parent&&this.parent.checkboxSet("updateChild",this)}})}(jQuery),RED.menu=function(){var e={};function t(i){var s,r;if(null!==i&&i.id&&!1===RED.settings.theme("menu."+i.id))return null;if(null===i)s=$('<li class="divider"></li>');else{s=$("<li></li>"),i.group&&s.addClass("menu-group-"+i.group);var d="<a "+(i.id?'id="'+i.id+'" ':"")+'tabindex="-1" href="#">';i.toggle&&(d+='<i class="fa fa-square pull-left"></i>',d+='<i class="fa fa-check-square pull-left"></i>'),void 0!==i.icon&&(/\.png/.test(i.icon)?d+='<img src="'+i.icon+'"/> ':d+='<i class="'+(i.icon?i.icon:'" style="display: inline-block;"')+'"></i> '),i.sublabel?d+='<span class="menu-label-container"><span class="menu-label">'+i.label+'</span><span class="menu-sublabel">'+i.sublabel+"</span></span>":d+='<span class="menu-label">'+i.label+"</span>",d+="</a>";var l=$(d).appendTo(s);if(e[i.id]=i,i.onselect?(l.click(function(t){if(t.preventDefault(),!$(this).parent().hasClass("disabled"))if(i.toggle){var s=o(i.id);if("string"==typeof i.toggle){if(!s){for(var r in e)if(e.hasOwnProperty(r)){var d=e[r];d.id!=i.id&&i.toggle==d.toggle&&a(d.id,!1)}a(i.id,!0)}}else a(i.id,!s)}else n(i.id)}),i.toggle&&(r=RED.settings.get("menu-"+i.id),i.setting&&(null!==r?(RED.settings.set(i.setting,r),RED.settings.remove("menu-"+i.id)):r=RED.settings.get(i.setting)),r?(l.addClass("active"),n(i.id,!0)):!1===r?(l.removeClass("active"),n(i.id,!1)):i.hasOwnProperty("selected")&&(i.selected?l.addClass("active"):l.removeClass("active"),n(i.id,i.selected)))):i.href?l.attr("target","_blank").attr("href",i.href):i.options||(s.addClass("disabled"),l.click(function(e){e.preventDefault()})),i.options){s.addClass("dropdown-submenu pull-left");for(var c=$('<ul id="'+i.id+'-submenu" class="dropdown-menu"></ul>').appendTo(s),p=0;p<i.options.length;p++){var u=t(i.options[p]);u&&u.appendTo(c)}}i.disabled&&s.addClass("disabled")}return s}function n(t,n){var o=e[t],a=o.onselect;"string"==typeof o.onselect&&(a=RED.actions.get(o.onselect)),a?a.call(o,n):console.log("No callback for",t,o.onselect)}function o(e){return $("#"+e).hasClass("active")}function a(t,a){if(o(t)!=a){var i=e[t];a?$("#"+t).addClass("active"):$("#"+t).removeClass("active"),i&&i.onselect&&n(i.id,a),RED.settings.set(i.setting||"menu-"+i.id,a)}}return{init:function(e){var n=$("#"+e.id),o=$("<ul/>",{id:e.id+"-submenu",class:"dropdown-menu pull-right"});1===n.length&&o.insertAfter(n);for(var a=!1,i=0;i<e.options.length;i++){var s=e.options[i];if(null!==s||!a){var r=t(s);r&&(r.appendTo(o),a=null===s)}}return o},setSelected:a,isSelected:o,toggleSelected:function(e){a(e,!o(e))},setDisabled:function(e,t){t?$("#"+e).parent().addClass("disabled"):$("#"+e).parent().removeClass("disabled")},addItem:function(e,n){var o=t(n);if(n.group){var a=$("#"+e+"-submenu").children(".menu-group-"+n.group);if(0===a.length)o.appendTo("#"+e+"-submenu");else{for(var i=0;i<a.length;i++){var s=a[i],r=$(s).find(".menu-label").html();if(n.label<r){$(s).before(o);break}}i===a.length&&o.appendTo("#"+e+"-submenu")}}else o.appendTo("#"+e+"-submenu")},removeItem:function(e){$("#"+e).parent().remove()},setAction:function(t,n){var o=e[t];o&&(o.onselect=n)}}}(),RED.panels=function(){return{create:function(e){var t=e.container||$("#"+e.id),n=t.children();if(2!==n.length)throw new Error("Container must have exactly two children");t.addClass("red-ui-panels");var o,a,i=[],s=!1;return $('<div class="red-ui-panels-separator"></div>').insertAfter(n[0]).draggable({axis:"y",containment:t,scroll:!1,start:function(e,a){t.height(),o=a.position.top,i=[$(n[0]).height(),$(n[1]).height()]},drag:function(s,r){var d=t.height(),l=r.position.top-o,c=[i[0]+l,i[1]-l];$(n[0]).height(c[0]),$(n[1]).height(c[1]),e.resize&&e.resize(c[0],c[1]),r.position.top-=l,a=c[0]/d},stop:function(e,t){s=!0}}),{resize:function(o){var i=[$(n[0]).height(),$(n[1]).height()];if(t.height(o),s){var r=a*o;i=[r,o-r-48],$(n[0]).height(i[0]),$(n[1]).height(i[1])}e.resize&&e.resize(i[0],i[1])}}}}}(),RED.popover=function(){var e={default:{top:10,leftRight:17,leftLeft:25},small:{top:5,leftRight:17,leftLeft:16}};return{create:function(t){var n=t.target,o=t.direction||"right",a=t.trigger,i=t.content,s=t.delay,r=t.autoClose,d=t.width||"auto",l=t.size||"default";if(!e[l])throw new Error("Invalid RED.popover size value:",l);var c,p,u=null,f=function(t){if(c){p=$('<div class="red-ui-popover red-ui-popover-'+o+'"></div>').appendTo("body"),"default"!==l&&p.addClass("red-ui-popover-size-"+l),"function"==typeof i?i.call(g).appendTo(p):p.html(i),"auto"!==d&&p.width(d);var a=n.offset(),s=n.width(),r=n.height(),u=p.height(),f=p.width();"right"===o?p.css({top:a.top+r/2-u/2-e[l].top,left:a.left+s+e[l].leftRight}):"left"===o&&p.css({top:a.top+r/2-u/2-e[l].top,left:a.left-e[l].leftLeft-f}),t?p.show():p.fadeIn("fast")}},h=function(e){c||p&&(e?$(this).remove():p.fadeOut("fast",function(){$(this).remove()}),p=null)};"hover"===a?(n.on("mouseenter",function(e){clearTimeout(u),c=!0,u=setTimeout(f,s.show)}),n.on("mouseleave",function(e){u&&clearTimeout(u),c=!1,setTimeout(h,s.hide)})):"click"===a?n.click(function(e){e.preventDefault(),e.stopPropagation(),(c=!c)?f():h()}):r&&setTimeout(function(){c=!1,h()},r);var g={setContent:function(e){return i=e,g},open:function(e){return c=!0,f(e),g},close:function(e){return c=!1,h(e),g}};return g}}}(),function(e){e.widget("nodered.searchBox",{_create:function(){var t=this;this.currentTimeout=null,this.lastSent="",this.element.val(""),this.uiContainer=this.element.wrap("<div>").parent(),this.uiContainer.addClass("red-ui-searchBox-container"),e('<i class="fa fa-search"></i>').prependTo(this.uiContainer),this.clearButton=e('<a href="#"><i class="fa fa-times"></i></a>').appendTo(this.uiContainer),this.clearButton.on("click",function(e){e.preventDefault(),t.element.val(""),t._change("",!0),t.element.focus()}),this.resultCount=e("<span>",{class:"red-ui-searchBox-resultCount hide"}).appendTo(this.uiContainer),this.element.val(""),this.element.on("keydown",function(e){27===e.keyCode&&t.element.val("")}),this.element.on("keyup",function(n){t._change(e(this).val())}),this.element.on("focus",function(){e("body").one("mousedown",function(){t.element.blur()})})},_change:function(e,t){var n=!1;""===e?(this.clearButton.hide(),n=!0):(this.clearButton.show(),n=e.length>=(this.options.minimumLength||0));var o=this.element.val();if(n=n&&o!==this.lastSent)if(!t&&this.options.delay>0){clearTimeout(this.currentTimeout);var a=this;this.currentTimeout=setTimeout(function(){a.lastSent=a.element.val(),a._trigger("change")},this.options.delay)}else this._trigger("change")},value:function(e){if(void 0===e)return this.element.val();this.element.val(e),this._change(e)},count:function(e){void 0===e||null===e||""===e?this.resultCount.text("").hide():this.resultCount.text(e).show()},change:function(){this._trigger("change")}})}(jQuery),RED.tabs=function(){return{create:function(e){var t,n,o,a={},i=0,s=e.element||$("#"+e.id),r=s.wrap("<div>").parent(),d=s.wrap("<div>").parent();function l(e,t){if(e.preventDefault(),!$(this).hasClass("disabled")){var n=d.scrollLeft();d.animate({scrollLeft:t},100);var o=setInterval(function(){var e=d.scrollLeft();e!==n?(n=e,d.animate({scrollLeft:t},100)):clearInterval(o)},100);$(this).one("mouseup",function(){clearInterval(o)})}}function c(){return e.onclick&&e.onclick(a[$(this).attr("href").slice(1)]),f($(this)),!1}function p(){if(0!==s.children().length){var e=d.scrollLeft(),t=d.width(),a=s.width();0===e?n.hide():n.show(),e===a-t?o.hide():o.show()}}function u(){return e.ondblclick&&e.ondblclick(a[$(this).attr("href").slice(1)]),!1}function f(t){if("string"==typeof t&&(t=s.find("a[href='#"+t+"']")),0!==t.length&&!t.parent().hasClass("active")){if(s.children().removeClass("active"),s.children().css({transition:"width 100ms"}),t.parent().addClass("active"),e.scrollable){var n=t.parent().position().left;n-21<0?d.animate({scrollLeft:"+="+(n-50)},300):n+120>d.width()&&d.animate({scrollLeft:"+="+(n+140-d.width())},300)}e.onchange&&e.onchange(a[t.attr("href").slice(1)]),h(),setTimeout(function(){s.children().css({transition:""})},100)}}function h(){if(!e.vertical){var n=s.find("li.red-ui-tab"),o=r.width(),a=n.size(),d=(o-12-6*a)/a;if(i=(t=100*d/o+"%")+"%",e.scrollable){d=Math.max(d,140),t=d+"px",i=0;var l=Math.max(r.width(),12+(d+6)*a);s.width(l),p()}else e.hasOwnProperty("minimumActiveTabWidth")&&(d<e.minimumActiveTabWidth?(a-=1,d=(o-12-e.minimumActiveTabWidth-6*a)/a,t=100*d/o+"%",i=e.minimumActiveTabWidth+"px"):i=0);n.css({width:t}),d<50?(s.find(".red-ui-tab-close").hide(),s.find(".red-ui-tab-icon").hide(),s.find(".red-ui-tab-label").css({paddingLeft:Math.min(12,Math.max(0,d-38))+"px"})):(s.find(".red-ui-tab-close").show(),s.find(".red-ui-tab-icon").show(),s.find(".red-ui-tab-label").css({paddingLeft:""})),0!==i&&(s.find("li.red-ui-tab.active").css({width:e.minimumActiveTabWidth}),s.find("li.red-ui-tab.active .red-ui-tab-close").show(),s.find("li.red-ui-tab.active .red-ui-tab-icon").show(),s.find("li.red-ui-tab.active .red-ui-tab-label").css({paddingLeft:""}))}}function g(t){var n=s.find("a[href='#"+t+"']").parent();if(n.hasClass("active")){var o=n.prev();0===o.size()&&(o=n.next()),f(o.find("a"))}n.remove(),e.onremove&&e.onremove(a[t]),delete a[t],h()}return r.addClass("red-ui-tabs"),e.vertical&&r.addClass("red-ui-tabs-vertical"),e.addButton&&"function"==typeof e.addButton&&(r.addClass("red-ui-tabs-add"),$('<div class="red-ui-tab-button"><a href="#"><i class="fa fa-plus"></i></a></div>').appendTo(r).find("a").click(function(t){t.preventDefault(),e.addButton()})),e.scrollable&&(r.addClass("red-ui-tabs-scrollable"),d.addClass("red-ui-tabs-scroll-container"),d.scroll(p),(n=$('<div class="red-ui-tab-button red-ui-tab-scroll red-ui-tab-scroll-left"><a href="#" style="display:none;"><i class="fa fa-caret-left"></i></a></div>').appendTo(r).find("a")).on("mousedown",function(e){l(e,"-=150")}).on("click",function(e){e.preventDefault()}),(o=$('<div class="red-ui-tab-button red-ui-tab-scroll red-ui-tab-scroll-right"><a href="#" style="display:none;"><i class="fa fa-caret-right"></i></a></div>').appendTo(r).find("a")).on("mousedown",function(e){l(e,"+=150")}).on("click",function(e){e.preventDefault()})),s.children().first().addClass("active"),s.children().addClass("red-ui-tab"),s.find("li.red-ui-tab a").on("click",c).on("dblclick",u),setTimeout(function(){h()},0),{addTab:function(t){a[t.id]=t;var n=$("<li/>",{class:"red-ui-tab"}).appendTo(s);n.attr("id","red-ui-tab-"+t.id.replace(".","-")),n.data("tabId",t.id);var o=$("<a/>",{href:"#"+t.id,class:"red-ui-tab-label"}).appendTo(n);if(t.icon&&$('<img src="'+t.icon+'" class="red-ui-tab-icon"/>').appendTo(o),$("<span/>",{class:"bidiAware"}).text(t.label).appendTo(o).attr("dir",RED.text.bidi.resolveBaseTextDir(t.label)),o.on("click",c),o.on("dblclick",u),t.closeable){var i=$("<a/>",{href:"#",class:"red-ui-tab-close"}).appendTo(n);i.append('<i class="fa fa-times" />'),i.on("click",function(e){e.preventDefault(),g(t.id)})}if(h(),e.onadd&&e.onadd(t),o.attr("title",t.label),1==s.find("li.red-ui-tab").size()&&f(o),e.onreorder){var r,l,p,v=[];n.draggable({axis:"x",distance:20,start:function(e,t){r=[],v=[],s.children().each(function(e){v[e]={el:$(this),text:$(this).text(),left:$(this).position().left,width:$(this).width()},$(this).is(n)&&(l=e,p=e),r.push($(this).data("tabId"))}),s.children().each(function(e){e!==l&&$(this).css({position:"absolute",left:v[e].left+"px",width:v[e].width+2,transition:"left 0.3s"})}),n.hasClass("active")||n.css({zIndex:1})},drag:function(e,t){t.position.left+=v[l].left+d.scrollLeft();for(var n=t.position.left+v[l].width/2-d.scrollLeft(),o=0;o<v.length;o++)if(o!==l&&n>v[o].left&&n<v[o].left+v[o].width){o<l?(v[o].left+=v[l].width+8,v[l].el.detach().insertBefore(v[o].el)):(v[o].left-=v[l].width+8,v[l].el.detach().insertAfter(v[o].el)),v[o].el.css({left:v[o].left+"px"}),v.splice(o,0,v.splice(l,1)[0]),l=o;break}},stop:function(t,o){s.children().css({position:"relative",left:"",transition:""}),n.hasClass("active")||n.css({zIndex:""}),h(),p!==l&&e.onreorder(r,$.makeArray(s.children().map(function(){return $(this).data("tabId")}))),f(v[l].el.data("tabId"))}})}},removeTab:g,activateTab:f,nextTab:function(){var e=s.find("li.active").next();e.length>0&&f(e.find("a"))},previousTab:function(){var e=s.find("li.active").prev();e.length>0&&f(e.find("a"))},resize:h,count:function(){return s.find("li.red-ui-tab").size()},contains:function(e){return s.find("a[href='#"+e+"']").length>0},renameTab:function(e,t){a[e].label=t;var n=s.find("a[href='#"+e+"']");n.attr("title",t),n.find("span.bidiAware").text(t).attr("dir",RED.text.bidi.resolveBaseTextDir(t)),h()},order:function(e){var t=$.makeArray(s.children().map(function(){return $(this).data("tabId")}));if(t.length===e.length){var n,o=!0;for(n=0;n<e.length;n++)if(e[n]!==t[n]){o=!1;break}if(!o){var a={};for(s.children().detach().each(function(){a[$(this).data("tabId")]=$(this)}),n=0;n<e.length;n++)a[e[n]].appendTo(s)}}}}}}}(),RED.stack=function(){return{create:function(e){var t=e.container;t.addClass("red-ui-stack");var n=0,o=[],a=!0,i=function(){if(o.length>0){var e=0;o.forEach(function(t){e+=t.header.outerHeight()});var a=t.innerHeight();n=a-e-(o.length-1),o.forEach(function(e){e.contentWrap.height(n)})}};return e.fill&&e.singleExpanded&&($(window).resize(i),$(window).focus(i)),{add:function(s){o.push(s),s.container=$('<div class="palette-category">').appendTo(t),a||s.container.hide();var r=$('<div class="palette-header"></div>').appendTo(s.container);if(s.header=r,s.contentWrap=$("<div></div>",{style:"position:relative"}).appendTo(s.container),e.fill&&s.contentWrap.css("height",n),s.content=$("<div></div>").appendTo(s.contentWrap),!1!==s.collapsible){r.click(function(){if(e.singleExpanded){if(!s.isExpanded()){for(var t=0;t<o.length;t++)o[t].isExpanded()&&o[t].collapse();s.expand()}}else s.toggle()});var d=$('<i class="fa fa-angle-down"></i>').appendTo(r);s.expanded?(s.container.addClass("palette-category-expanded"),d.addClass("expanded")):s.contentWrap.hide()}else $('<i style="opacity: 0.5;" class="fa fa-angle-down expanded"></i>').appendTo(r),r.css("cursor","default");return s.title=$("<span></span>").html(s.title).appendTo(r),s.toggle=function(){return s.isExpanded()?(s.collapse(),!1):(s.expand(),!0)},s.expand=function(){if(!s.isExpanded())return s.onexpand&&s.onexpand.call(s),e.singleExpanded&&o.forEach(function(e){e!==s&&e.collapse()}),d.addClass("expanded"),s.container.addClass("palette-category-expanded"),s.contentWrap.slideDown(200),!0},s.collapse=function(){if(s.isExpanded())return d.removeClass("expanded"),s.container.removeClass("palette-category-expanded"),s.contentWrap.slideUp(200),!0},s.isExpanded=function(){return s.container.hasClass("palette-category-expanded")},e.fill&&e.singleExpanded&&i(),s},hide:function(){return a=!1,o.forEach(function(e){e.container.hide()}),this},show:function(){return a=!0,o.forEach(function(e){e.container.show()}),this},resize:function(){i&&i()}}}}}(),function(e){var t={msg:{value:"msg",label:"msg.",validate:RED.utils.validatePropertyExpression},flow:{value:"flow",label:"flow.",validate:RED.utils.validatePropertyExpression},global:{value:"global",label:"global.",validate:RED.utils.validatePropertyExpression},str:{value:"str",label:"string",icon:"red/images/typedInput/az.png"},num:{value:"num",label:"number",icon:"red/images/typedInput/09.png",validate:/^[+-]?[0-9]*\.?[0-9]*([eE][-+]?[0-9]+)?$/},bool:{value:"bool",label:"boolean",icon:"red/images/typedInput/bool.png",options:["true","false"]},json:{value:"json",label:"JSON",icon:"red/images/typedInput/json.png",validate:function(e){try{return JSON.parse(e),!0}catch(e){return!1}},expand:function(){var e=this,t=this.value();try{t=JSON.stringify(JSON.parse(t),null,4)}catch(e){}RED.editor.editJSON({value:t,complete:function(t){var n=t;try{n=JSON.stringify(JSON.parse(t))}catch(e){}e.value(n)}})}},re:{value:"re",label:"regular expression",icon:"red/images/typedInput/re.png"},date:{value:"date",label:"timestamp",hasValue:!1},jsonata:{value:"jsonata",label:"expression",icon:"red/images/typedInput/expr.png",validate:function(e){try{return jsonata(e),!0}catch(e){return!1}},expand:function(){var e=this;RED.editor.editExpression({value:this.value().replace(/\t/g,"\n"),complete:function(t){e.value(t.replace(/\n/g,"\t"))}})}},bin:{value:"bin",label:"buffer",icon:"red/images/typedInput/bin.png",expand:function(){var e=this;RED.editor.editBuffer({value:this.value(),complete:function(t){e.value(t)}})}}},n=!1;e.widget("nodered.typedInput",{_create:function(){if(!n&&RED&&RED._)for(var o in t)t.hasOwnProperty(o)&&(t[o].label=RED._("typedInput.type."+o,{defaultValue:t[o].label}));n=!0;var a=this;this.disarmClick=!1,this.element.addClass("red-ui-typedInput"),this.uiWidth=this.element.outerWidth(),this.elementDiv=this.element.wrap("<div>").parent().addClass("red-ui-typedInput-input"),this.uiSelect=this.elementDiv.wrap("<div>").parent();var i,s=this.element.attr("style");if(null!==(i=/width\s*:\s*(calc\s*\(.*\)|\d+(%|px))/i.exec(s))?(this.element.css("width","100%"),this.uiSelect.width(i[1]),this.uiWidth=null):this.uiSelect.width(this.uiWidth),["Right","Left"].forEach(function(e){var t=a.element.css("margin"+e);a.uiSelect.css("margin"+e,t),a.element.css("margin"+e,0)}),this.uiSelect.addClass("red-ui-typedInput-container"),this.options.types=this.options.types||Object.keys(t),this.selectTrigger=e('<button tabindex="0"></button>').prependTo(this.uiSelect),e('<i class="fa fa-sort-desc"></i>').appendTo(this.selectTrigger),this.selectLabel=e("<span></span>").appendTo(this.selectTrigger),this.types(this.options.types),this.options.typeField){this.typeField=e(this.options.typeField).hide();var r=this.typeField.val();r&&this.typeMap[r]&&(this.options.default=r)}else this.typeField=e("<input>",{type:"hidden"}).appendTo(this.uiSelect);this.element.on("focus",function(){a.uiSelect.addClass("red-ui-typedInput-focus")}),this.element.on("blur",function(){a.uiSelect.removeClass("red-ui-typedInput-focus")}),this.element.on("change",function(){a.validate()}),this.selectTrigger.click(function(e){e.preventDefault(),a._showTypeMenu()}),this.selectTrigger.on("keydown",function(e){40===e.keyCode&&a._showTypeMenu()}).on("focus",function(){a.uiSelect.addClass("red-ui-typedInput-focus")}),this.optionSelectTrigger=e('<button tabindex="0" class="red-ui-typedInput-option-trigger" style="display:inline-block"><span class="red-ui-typedInput-option-caret"><i class="fa fa-sort-desc"></i></span></button>').appendTo(this.uiSelect),this.optionSelectLabel=e('<span class="red-ui-typedInput-option-label"></span>').prependTo(this.optionSelectTrigger),this.optionSelectTrigger.click(function(e){e.preventDefault(),a._showOptionSelectMenu()}).on("keydown",function(e){40===e.keyCode&&a._showOptionSelectMenu()}).on("blur",function(){a.uiSelect.removeClass("red-ui-typedInput-focus")}).on("focus",function(){a.uiSelect.addClass("red-ui-typedInput-focus")}),this.optionExpandButton=e('<button tabindex="0" class="red-ui-typedInput-option-expand" style="display:inline-block"><i class="fa fa-ellipsis-h"></i></button>').appendTo(this.uiSelect),this.type(this.options.default||this.typeList[0].value)},_showTypeMenu:function(){this.typeList.length>1?(this._showMenu(this.menu,this.selectTrigger),this.menu.find("[value='"+this.propertyType+"']").focus()):this.element.focus()},_showOptionSelectMenu:function(){if(this.optionMenu){this.optionMenu.css({minWidth:this.optionSelectLabel.width()}),this._showMenu(this.optionMenu,this.optionSelectLabel);var e=this.optionMenu.find("[value='"+this.value()+"']");0===e.length&&(e=this.optionMenu.children(":first")),e.focus()}},_hideMenu:function(t){e(document).off("mousedown.close-property-select"),t.hide(),this.elementDiv.is(":visible")?this.element.focus():this.optionSelectTrigger.is(":visible")?this.optionSelectTrigger.focus():this.selectTrigger.focus()},_createMenu:function(t,n){var o=this,a=e("<div>").addClass("red-ui-typedInput-options");return t.forEach(function(t){"string"==typeof t&&(t={value:t,label:t});var i=e('<a href="#"></a>').attr("value",t.value).appendTo(a);t.label&&i.text(t.label),t.icon?e("<img>",{src:t.icon,style:"margin-right: 4px; height: 18px;"}).prependTo(i):i.css({paddingLeft:"18px"}),i.click(function(e){e.preventDefault(),n(t.value),o._hideMenu(a)})}),a.css({display:"none"}),a.appendTo(document.body),a.on("keydown",function(t){40===t.keyCode?e(this).children(":focus").next().focus():38===t.keyCode?e(this).children(":focus").prev().focus():27===t.keyCode&&o._hideMenu(a)}),a},_showMenu:function(t,n){if(this.disarmClick)this.disarmClick=!1;else{var o=this,a=n.offset(),i=n.height(),s=t.height(),r=i+a.top-3;r+s>e(window).height()&&(r-=r+s-e(window).height()+5),t.css({top:r+"px",left:2+a.left+"px"}),t.slideDown(100),this._delay(function(){o.uiSelect.addClass("red-ui-typedInput-focus"),e(document).on("mousedown.close-property-select",function(a){e(a.target).closest(t).length||o._hideMenu(t),e(a.target).closest(n).length&&(o.disarmClick=!0,a.preventDefault())})})}},_getLabelWidth:function(t){var n=t.outerWidth();if(0===n){var o=e('<div class="red-ui-typedInput-container"></div>').css({position:"absolute",top:0,left:-1e3}).appendTo(document.body);n=t.clone().appendTo(o).outerWidth(),o.remove()}return n},_resize:function(){if(null!==this.uiWidth&&this.uiSelect.width(this.uiWidth),this.typeMap[this.propertyType]&&!1===this.typeMap[this.propertyType].hasValue)this.selectTrigger.addClass("red-ui-typedInput-full-width");else{this.selectTrigger.removeClass("red-ui-typedInput-full-width");var e=this._getLabelWidth(this.selectTrigger);this.elementDiv.css("left",e+"px"),this.optionExpandButton.is(":visible")?this.elementDiv.css("right","22px"):this.elementDiv.css("right","0"),this.optionSelectTrigger&&this.optionSelectTrigger.css({left:e+"px",width:"calc( 100% - "+e+"px )"})}},_destroy:function(){this.menu.remove()},types:function(e){var n=this,o=this.type();this.typeMap={},this.typeList=e.map(function(e){var o;return o="string"==typeof e?t[e]:e,n.typeMap[o.value]=o,o}),this.selectTrigger.toggleClass("disabled",1===this.typeList.length),this.menu&&this.menu.remove(),this.menu=this._createMenu(this.typeList,function(e){n.type(e)}),o&&!this.typeMap.hasOwnProperty(o)&&this.type(this.typeList[0].value)},width:function(e){this.uiWidth=e,this._resize()},value:function(e){if(!arguments.length)return this.element.val();if(this.typeMap[this.propertyType].options){for(var t,n=!1,o=0;o<this.typeMap[this.propertyType].options.length;o++){var a=this.typeMap[this.propertyType].options[o];if("string"==typeof a){if(a===e){t=e,n=!0;break}}else if(a.value===e){t=a.label||a.value,n=!0;break}}n||(e="",t=""),this.optionSelectLabel.text(t)}this.element.val(e),this.element.trigger("change",this.type(),e)},type:function(t){if(!arguments.length)return this.propertyType;var n=this,o=this.typeMap[t];if(o&&this.propertyType!==t){var a;if(this.propertyType=t,this.typeField.val(t),this.selectLabel.empty(),o.icon?((a=new Image).name=o.icon,a.src=o.icon,e("<img>",{src:o.icon,style:"margin-right: 4px;height: 18px;"}).prependTo(this.selectLabel)):this.selectLabel.text(o.label),o.options){if(this.optionExpandButton&&this.optionExpandButton.hide(),this.optionSelectTrigger){this.optionSelectTrigger.show(),this.elementDiv.hide(),this.optionMenu=this._createMenu(o.options,function(e){n.optionSelectLabel.text(e),n.value(e)});for(var i,s=this.element.val(),r=!1,d=0;d<o.options.length;d++)if("string"==typeof(i=o.options[d])){if(i===s){this.optionSelectLabel.text(s),r=!0;break}}else if(i.value===s){this.optionSelectLabel.text(i.label||i.value),r=!0;break}r||("string"==typeof(i=o.options[0])?this.value(i):this.value(i.value)),console.log(r)}}else this.optionMenu&&(this.optionMenu.remove(),this.optionMenu=null),this.optionSelectTrigger&&this.optionSelectTrigger.hide(),!1===o.hasValue?(this.oldValue=this.element.val(),this.element.val(""),this.elementDiv.hide()):(void 0!==this.oldValue&&(this.element.val(this.oldValue),delete this.oldValue),this.elementDiv.show()),o.expand&&"function"==typeof o.expand?(this.optionExpandButton.show(),this.optionExpandButton.off("click"),this.optionExpandButton.on("click",function(e){e.preventDefault(),o.expand.call(n)})):this.optionExpandButton.hide(),this.element.trigger("change",this.propertyType,this.value());a?(a.onload=function(){n._resize()},a.onerror=function(){n._resize()}):this._resize()}},validate:function(){var e,t=this.value(),n=this.type();if(this.typeMap[n]&&this.typeMap[n].validate){var o=this.typeMap[n].validate;e="function"==typeof o?o(t):o.test(t)}else e=!0;return e?this.uiSelect.removeClass("input-error"):this.uiSelect.addClass("input-error"),e},show:function(){this.uiSelect.show(),this._resize()},hide:function(){this.uiSelect.hide()}})}(jQuery),RED.actions=function(){var e={};return{add:function(t,n){e[t]=n},remove:function(t){delete e[t]},get:function(t){return e[t]},invoke:function(t){e.hasOwnProperty(t)&&e[t]()},list:function(){var t=[];return Object.keys(e).forEach(function(e){var n=RED.keyboard.getShortcut(e);t.push({id:e,scope:n?n.scope:void 0,key:n?n.key:void 0,user:n?n.user:void 0})}),t}}}(),RED.deploy=function(){var e={full:{img:"red/images/deploy-full-o.png"},nodes:{img:"red/images/deploy-nodes-o.png"},flows:{img:"red/images/deploy-flows-o.png"}},t={unknown:!1,unusedConfig:!1,invalid:!1},n="full",o=!1,a=null;function i(t){n=t,$("#btn-deploy-icon").attr("src",e[t].img)}function s(e){var t="";if(e.z){var n=RED.nodes.workspace(e.z);t=n?n.label:(n=RED.nodes.subflow(e.z)).name}var o=RED.utils.getNodeLabel(e,e.id);return{tab:t,type:e.type,label:o}}function r(e,t){return e.tab<t.tab?-1:e.tab>t.tab?1:e.type<t.type?-1:e.type>t.type?1:e.name<t.name?-1:e.name>t.name?1:0}function d(e,t){var n=$("<div>");$('<p data-i18n="deploy.confirm.conflict"></p>').appendTo(n);var o=$('<div id="node-dialog-confirm-deploy-conflict-checking" class="node-dialog-confirm-conflict-row"><img src="red/images/spin.svg"/><div data-i18n="deploy.confirm.conflictChecking"></div></div>').appendTo(n),i=$('<div class="node-dialog-confirm-conflict-row"><i style="color: #3a3;" class="fa fa-check"></i><div data-i18n="deploy.confirm.conflictAutoMerge"></div></div>').hide().appendTo(n),s=$('<div id="node-dialog-confirm-deploy-conflict-manual-merge" class="node-dialog-confirm-conflict-row"><i style="color: #999;" class="fa fa-exclamation"></i><div data-i18n="deploy.confirm.conflictManualMerge"></div></div>').hide().appendTo(n);n.i18n(),a=null;var r=[{text:RED._("common.label.cancel"),click:function(){d.close()}},{id:"node-dialog-confirm-deploy-review",text:RED._("deploy.confirm.button.review"),class:"primary disabled",click:function(){$("#node-dialog-confirm-deploy-review").hasClass("disabled")||(RED.diff.showRemoteDiff(),d.close())}},{id:"node-dialog-confirm-deploy-merge",text:RED._("deploy.confirm.button.merge"),class:"primary disabled",click:function(){$("#node-dialog-confirm-deploy-merge").hasClass("disabled")||(RED.diff.mergeDiff(a),d.close())}}];t&&r.push({id:"node-dialog-confirm-deploy-overwrite",text:RED._("deploy.confirm.button.overwrite"),class:"primary",click:function(){c(!0,t),d.close()}});var d=RED.notify(n,{modal:!0,fixed:!0,width:600,buttons:r}),l=Date.now();RED.diff.getRemoteDiff(function(e){var t=Math.max(1e3-(Date.now()-l),0);a=e,setTimeout(function(){o.hide(),0===Object.keys(e.conflicts).length?(i.show(),$("#node-dialog-confirm-deploy-merge").removeClass("disabled")):s.show(),$("#node-dialog-confirm-deploy-review").removeClass("disabled")},t)})}function l(e){if(e.length>5){var t=e.length-5;(e=e.slice(0,5)).push(RED._("deploy.confirm.plusNMore",{count:t}))}return e}function c(e,a){if(!$("#btn-deploy").hasClass("disabled")){if(!RED.user.hasPermission("flows.write"))return void RED.notify(RED._("user.errors.deploy"),"error");if(!e){var i,p=!1,u=!1,f=[],h=[];RED.nodes.eachNode(function(e){p=p||!e.valid,e.valid||h.push(s(e)),"unknown"===e.type&&-1==f.indexOf(e.name)&&f.push(e.name)}),i=f.length>0;var g=[];RED.nodes.eachConfig(function(e){0===e.users.length&&!1!==e._def.hasUsers&&(g.push(s(e)),u=!0)});var v,m,b=!1,y=[];if(i&&!t.unknown?(b=!0,v="<p>"+RED._("deploy.confirm.unknown")+'</p><ul class="node-dialog-configm-deploy-list"><li>'+l(f).join("</li><li>")+"</li></ul><p>"+RED._("deploy.confirm.confirm")+"</p>",y=[{id:"node-dialog-confirm-deploy-deploy",text:RED._("deploy.confirm.button.confirm"),class:"primary",click:function(){c(!0),m.close()}}]):p&&!t.invalid&&(b=!0,h.sort(r),v="<p>"+RED._("deploy.confirm.improperlyConfigured")+'</p><ul class="node-dialog-configm-deploy-list"><li>'+l(h.map(function(e){return(e.tab?"["+e.tab+"] ":"")+e.label+" ("+e.type+")"})).join("</li><li>")+"</li></ul><p>"+RED._("deploy.confirm.confirm")+"</p>",y=[{id:"node-dialog-confirm-deploy-deploy",text:RED._("deploy.confirm.button.confirm"),class:"primary",click:function(){c(!0),m.close()}}]),b)return y.unshift({text:RED._("common.label.cancel"),click:function(){m.close()}}),void(m=RED.notify(v,{modal:!0,fixed:!0,buttons:y}))}var w=RED.nodes.createCompleteNodeSet(),D=Date.now();$(".deploy-button-content").css("opacity",0),$(".deploy-button-spinner").show(),$("#btn-deploy").addClass("disabled");var E={flows:w};a||(E.rev=RED.nodes.version()),o=!0,$("#header-shade").show(),$("#editor-shade").show(),$("#palette-shade").show(),$("#sidebar-shade").show(),$.ajax({url:"flows",type:"POST",data:JSON.stringify(E),contentType:"application/json; charset=utf-8",headers:{"Node-RED-Deployment-Type":n}}).done(function(e,t,n){RED.nodes.dirty(!1),RED.nodes.version(e.rev),RED.nodes.originalFlow(w),u?RED.notify("<p>"+RED._("deploy.successfulDeploy")+"</p><p>"+RED._("deploy.unusedConfigNodes")+' <a href="#" onclick="RED.sidebar.config.show(true); return false;">'+RED._("deploy.unusedConfigNodesLink")+"</a></p>","success",!1,6e3):RED.notify("<p>"+RED._("deploy.successfulDeploy")+"</p>","success"),RED.nodes.eachNode(function(e){e.changed&&(e.dirty=!0,e.changed=!1),e.moved&&(e.dirty=!0,e.moved=!1),e.credentials&&delete e.credentials}),RED.nodes.eachConfig(function(e){e.changed=!1,e.credentials&&delete e.credentials}),RED.nodes.eachWorkspace(function(e){e.changed=!1}),RED.history.markAllDirty(),RED.view.redraw(),RED.events.emit("deploy")}).fail(function(e,t,n){RED.nodes.dirty(!0),$("#btn-deploy").removeClass("disabled"),401===e.status?RED.notify(RED._("deploy.deployFailed",{message:RED._("user.notAuthorized")}),"error"):409===e.status?d(0,!0):e.responseText?RED.notify(RED._("deploy.deployFailed",{message:e.responseText}),"error"):RED.notify(RED._("deploy.deployFailed",{message:RED._("deploy.errors.noResponse")}),"error")}).always(function(){o=!1;var e=Math.max(0,300-(Date.now()-D));setTimeout(function(){$(".deploy-button-content").css("opacity",1),$(".deploy-button-spinner").hide(),$("#header-shade").hide(),$("#editor-shade").hide(),$("#palette-shade").hide(),$("#sidebar-shade").hide()},e)})}}return{init:function(e){var t,n=(e=e||{}).type||"default";if("default"==n)$('<li><span class="deploy-button-group button-group"><a id="btn-deploy" class="deploy-button disabled" href="#"><span class="deploy-button-content"><img id="btn-deploy-icon" src="red/images/deploy-full-o.png"> <span>'+RED._("deploy.deploy")+'</span></span><span class="deploy-button-spinner hide"><img src="red/images/spin.svg"/></span></a><a id="btn-deploy-options" data-toggle="dropdown" class="deploy-button" href="#"><i class="fa fa-caret-down"></i></a></span></li>').prependTo(".header-toolbar"),RED.menu.init({id:"btn-deploy-options",options:[{id:"deploymenu-item-full",toggle:"deploy-type",icon:"red/images/deploy-full.png",label:RED._("deploy.full"),sublabel:RED._("deploy.fullDesc"),selected:!0,onselect:function(e){e&&i("full")}},{id:"deploymenu-item-flow",toggle:"deploy-type",icon:"red/images/deploy-flows.png",label:RED._("deploy.modifiedFlows"),sublabel:RED._("deploy.modifiedFlowsDesc"),onselect:function(e){e&&i("flows")}},{id:"deploymenu-item-node",toggle:"deploy-type",icon:"red/images/deploy-nodes.png",label:RED._("deploy.modifiedNodes"),sublabel:RED._("deploy.modifiedNodesDesc"),onselect:function(e){e&&i("nodes")}}]});else if("simple"==n){var a=e.label||RED._("deploy.deploy"),s="red/images/deploy-full-o.png";e.hasOwnProperty("icon")&&(s=e.icon),$('<li><span class="deploy-button-group button-group"><a id="btn-deploy" class="deploy-button disabled" href="#"><span class="deploy-button-content">'+(s?'<img id="btn-deploy-icon" src="'+s+'"> ':"")+"<span>"+a+'</span></span><span class="deploy-button-spinner hide"><img src="red/images/spin.svg"/></span></a></span></li>').prependTo(".header-toolbar")}$("#btn-deploy").click(function(e){e.preventDefault(),c()}),RED.actions.add("core:deploy-flows",c),RED.events.on("nodes:change",function(e){e.dirty?(window.onbeforeunload=function(){return RED._("deploy.confirm.undeployedChanges")},$("#btn-deploy").removeClass("disabled")):(window.onbeforeunload=null,$("#btn-deploy").addClass("disabled"))}),RED.comms.subscribe("notification/runtime-deploy",function(e,n){if(!t){var a=RED.nodes.version();if(null===a||o||a===n.revision)return;var i=$("<p>").text(RED._("deploy.confirm.backgroundUpdate"));t=RED.notify(i,{modal:!0,fixed:!0,buttons:[{text:RED._("deploy.confirm.button.ignore"),click:function(){t.close(),t=null}},{text:RED._("deploy.confirm.button.review"),class:"primary",click:function(){t.close(),d(RED.nodes.createCompleteNodeSet(),!1),t=null}}]})}})},setDeployInflight:function(e){o=e}}}(),RED.diff=function(){var e=!1;function t(e,t,n){var a=$('<div class="node-dialog-view-diff-panel"></div>').appendTo(e),d=$('<div class="node-dialog-view-diff-headers"></div>').appendTo(a);"merge"===n.mode&&a.addClass("node-dialog-view-diff-panel-merge");var l,c,p,u=(l=a,c=t,(p=$('<ol class="node-dialog-view-diff-diff"></ol>').appendTo(l)).editableList({addButton:!1,height:"auto",scrollOnAdd:!1,addItem:function(e,t,n){var a=n.diff,d=n.remoteDiff,l=n.tab.n,p=n.def,u=c.conflicts,f=$("<div>",{class:"node-diff-tab"}).appendTo(e);f.addClass("collapsed");var h,g,v=$("<div>",{class:"node-diff-tab-title"}).appendTo(f),m=$("<div>").appendTo(f),b=$("<div>",{class:"node-diff-node-entry-cell"}).appendTo(v),y=$("<div>",{class:"node-diff-node-entry-cell node-diff-node-local"}).appendTo(v);d&&(h=$("<div>",{class:"node-diff-node-entry-cell node-diff-node-remote"}).appendTo(v)),$('<span class="node-diff-chevron"><i class="fa fa-angle-down"></i></span>').appendTo(b),o(l,p).appendTo(b);var w=(n.newTab||n.tab).n,D=$("<span>",{class:"node-diff-tab-title-meta"}).appendTo(b);"tab"===w.type?D.html(w.label||w.id):"subflow"===l.type?D.html(w.name||w.id):D.html(RED._("diff.globalNodes"));var E={local:{addedCount:0,deletedCount:0,changedCount:0,unchangedCount:0},remote:{addedCount:0,deletedCount:0,changedCount:0,unchangedCount:0},conflicts:0};if(n.newTab||n.remoteTab){var R,x={node:a.newConfig.all[l.id],all:a.newConfig.all,diff:a};if(d&&(R={node:d.newConfig.all[l.id]||null,all:d.newConfig.all,diff:d}),void 0!==l.type){var T,k=$("<div>",{class:"node-diff-node-entry node-diff-node-props collapsed"}).appendTo(m),_=$("<div>",{class:"node-diff-node-entry-header"}).appendTo(k),C=$("<div>",{class:"node-diff-node-entry-cell"}).appendTo(_),j=$("<div>",{class:"node-diff-node-entry-cell node-diff-node-local"}).appendTo(_);a.newConfig.all[l.id]?a.added[l.id]?(j.addClass("node-diff-node-added"),$('<span class="node-diff-status"><i class="fa fa-plus-square"></i> <span data-i18n="diff.type.added"></span></span>').appendTo(j)):a.changed[l.id]?(j.addClass("node-diff-node-changed"),$('<span class="node-diff-status"><i class="fa fa-square"></i> <span data-i18n="diff.type.changed"></span></span>').appendTo(j)):(j.addClass("node-diff-node-unchanged"),$('<span class="node-diff-status"><i class="fa fa-square-o"></i> <span data-i18n="diff.type.unchanged"></span></span>').appendTo(j)):j.addClass("node-diff-empty"),d&&(T=$("<div>",{class:"node-diff-node-entry-cell node-diff-node-remote"}).appendTo(_),d.newConfig.all[l.id]?d.added[l.id]?(T.addClass("node-diff-node-added"),$('<span class="node-diff-status"><i class="fa fa-plus-square"></i> <span data-i18n="diff.type.added"></span></span>').appendTo(T)):d.changed[l.id]?(T.addClass("node-diff-node-changed"),$('<span class="node-diff-status"><i class="fa fa-square"></i> <span data-i18n="diff.type.changed"></span></span>').appendTo(T)):(T.addClass("node-diff-node-unchanged"),$('<span class="node-diff-status"><i class="fa fa-square-o"></i> <span data-i18n="diff.type.unchanged"></span></span>').appendTo(T)):(T.addClass("node-diff-empty"),d.deleted[l.id])),$('<span class="node-diff-chevron"><i class="fa fa-angle-down"></i></span>').appendTo(C),$("<span>").html(RED._("diff.flowProperties")).appendTo(C),_.click(function(e){e.preventDefault(),$(this).parent().toggleClass("collapsed")}),s(p,l,x,R).appendTo(k),g="",u[l.id]?(E.conflicts++,j.hasClass("node-diff-empty")||$('<span class="node-diff-node-conflict"><span class="node-diff-status"><i class="fa fa-exclamation"></i></span></span>').prependTo(j),T.hasClass("node-diff-empty")||$('<span class="node-diff-node-conflict"><span class="node-diff-status"><i class="fa fa-exclamation"></i></span></span>').prependTo(T),k.addClass("node-diff-node-entry-conflict")):g=c.resolutions[l.id],r(l,k,j,T,!0,!u[l.id],g,c)}}var S=0,O=0,L={};if(n.tab.nodes.forEach(function(e){L[e.id]=!0,i(e,E,c).appendTo(m)}),n.newTab&&(S=n.newTab.nodes.length,n.newTab.nodes.forEach(function(e){L[e.id]||(L[e.id]=!0,i(e,E,c).appendTo(m))})),n.remoteTab&&(O=n.remoteTab.nodes.length,n.remoteTab.nodes.forEach(function(e){L[e.id]||i(e,E,c).appendTo(m)})),v.click(function(e){v.parent().toggleClass("collapsed"),$(this).parent().hasClass("collapsed")&&($(this).parent().find(".node-diff-node-entry").addClass("collapsed"),$(this).parent().find(".debug-message-element").addClass("collapsed"))}),a.deleted[l.id])$('<span class="node-diff-node-deleted"><span class="node-diff-status"><i class="fa fa-minus-square"></i> <span data-i18n="diff.type.flowDeleted"></span></span></span>').appendTo(y);else if(n.newTab)if(a.added[l.id])$('<span class="node-diff-node-added"><span class="node-diff-status"><i class="fa fa-plus-square"></i> <span data-i18n="diff.type.flowAdded"></span></span></span>').appendTo(y);else{l.id&&(a.changed[l.id]?E.local.changedCount++:E.local.unchangedCount++);var P=$("<span>",{class:"node-diff-tab-stats"}).appendTo(y);$('<span class="node-diff-status"></span>').html(RED._("diff.nodeCount",{count:S})).appendTo(P),E.conflicts+E.local.addedCount+E.local.changedCount+E.local.deletedCount>0&&($('<span class="node-diff-status"> [ </span>').appendTo(P),E.conflicts>0&&$('<span class="node-diff-node-conflict"><span class="node-diff-status"><i class="fa fa-exclamation"></i> '+E.conflicts+"</span></span>").appendTo(P),E.local.addedCount>0&&$('<span class="node-diff-node-added"><span class="node-diff-status"><i class="fa fa-plus-square"></i> '+E.local.addedCount+"</span></span>").appendTo(P),E.local.changedCount>0&&$('<span class="node-diff-node-changed"><span class="node-diff-status"><i class="fa fa-square"></i> '+E.local.changedCount+"</span></span>").appendTo(P),E.local.deletedCount>0&&$('<span class="node-diff-node-deleted"><span class="node-diff-status"><i class="fa fa-minus-square"></i> '+E.local.deletedCount+"</span></span>").appendTo(P),$('<span class="node-diff-status"> ] </span>').appendTo(P))}else y.addClass("node-diff-empty");if(d){if(d.deleted[l.id])$('<span class="node-diff-node-deleted"><span class="node-diff-status"><i class="fa fa-minus-square"></i> <span data-i18n="diff.type.flowDeleted"></span></span></span>').appendTo(h);else if(n.remoteTab)if(d.added[l.id])$('<span class="node-diff-node-added"><span class="node-diff-status"><i class="fa fa-plus-square"></i> <span data-i18n="diff.type.flowAdded"></span></span></span>').appendTo(h);else{l.id&&(d.changed[l.id]?E.remote.changedCount++:E.remote.unchangedCount++);var N=$("<span>",{class:"node-diff-tab-stats"}).appendTo(h);$('<span class="node-diff-status"></span>').html(RED._("diff.nodeCount",{count:O})).appendTo(N),E.conflicts+E.remote.addedCount+E.remote.changedCount+E.remote.deletedCount>0&&($('<span class="node-diff-status"> [ </span>').appendTo(N),E.conflicts>0&&$('<span class="node-diff-node-conflict"><span class="node-diff-status"><i class="fa fa-exclamation"></i> '+E.conflicts+"</span></span>").appendTo(N),E.remote.addedCount>0&&$('<span class="node-diff-node-added"><span class="node-diff-status"><i class="fa fa-plus-square"></i> '+E.remote.addedCount+"</span></span>").appendTo(N),E.remote.changedCount>0&&$('<span class="node-diff-node-changed"><span class="node-diff-status"><i class="fa fa-square"></i> '+E.remote.changedCount+"</span></span>").appendTo(N),E.remote.deletedCount>0&&$('<span class="node-diff-node-deleted"><span class="node-diff-status"><i class="fa fa-minus-square"></i> '+E.remote.deletedCount+"</span></span>").appendTo(N),$('<span class="node-diff-status"> ] </span>').appendTo(N))}else h.addClass("node-diff-empty");if(g="",E.conflicts>0?v.addClass("node-diff-node-entry-conflict"):g=c.resolutions[l.id],l.id){var I=!(E.conflicts>0&&(a.deleted[l.id]||d.deleted[l.id]));r(l,v,y,h,!1,I,g,c)}}0===f.find(".node-diff-node-entry").length&&f.addClass("node-diff-tab-empty"),e.i18n()}}),p),f=t.localDiff,h=t.remoteDiff,g=(t.conflicts,f.currentConfig),v=f.newConfig;if(void 0!==h){a.addClass("node-diff-three-way");var m=n.oldRevTitle||RED._("diff.local"),b=n.newRevTitle||RED._("diff.remote");$("<div></div>").text(m).appendTo(d),$("<div></div>").text(b).appendTo(d)}else a.removeClass("node-diff-three-way");return{list:u,finish:function(){var e={diff:f,def:{category:"config",color:"#f0f0f0"},tab:{n:{},nodes:g.globals},newTab:{n:{},nodes:v.globals}};void 0!==h&&(e.remoteTab={n:{},nodes:h.newConfig.globals},e.remoteDiff=h),u.editableList("addItem",e);var t,n={};g.tabOrder.forEach(function(e){var t=g.tabs[e],o={diff:f,def:RED.nodes.getType("tab"),tab:t};v.tabs.hasOwnProperty(e)&&(o.newTab=v.tabs[e]),void 0!==h&&(o.remoteTab=h.newConfig.tabs[e],o.remoteDiff=h),n[e]=!0,u.editableList("addItem",o)}),v.tabOrder.forEach(function(e){if(!n[e]){n[e]=!0;var t=v.tabs[e],o={diff:f,def:RED.nodes.getType("tab"),tab:t,newTab:t};void 0!==h&&(o.remoteDiff=h),u.editableList("addItem",o)}}),void 0!==h&&h.newConfig.tabOrder.forEach(function(e){if(!n[e]){var t=h.newConfig.tabs[e],o={diff:f,remoteDiff:h,def:RED.nodes.getType("tab"),tab:t,remoteTab:t};u.editableList("addItem",o)}});for(t in g.subflows)g.subflows.hasOwnProperty(t)&&(n[t]=!0,e={diff:f,def:{defaults:{},icon:"subflow.png",category:"subflows",color:"#da9"},tab:g.subflows[t]},v.subflows.hasOwnProperty(t)&&(e.newTab=v.subflows[t]),void 0!==h&&(e.remoteTab=h.newConfig.subflows[t],e.remoteDiff=h),u.editableList("addItem",e));for(t in v.subflows)v.subflows.hasOwnProperty(t)&&!n[t]&&(n[t]=!0,e={diff:f,def:{defaults:{},icon:"subflow.png",category:"subflows",color:"#da9"},tab:v.subflows[t],newTab:v.subflows[t]},void 0!==h&&(e.remoteDiff=h),u.editableList("addItem",e));if(void 0!==h)for(t in h.newConfig.subflows)h.newConfig.subflows.hasOwnProperty(t)&&!n[t]&&(e={diff:f,remoteDiff:h,def:{defaults:{},icon:"subflow.png",category:"subflows",color:"#da9"},tab:h.newConfig.subflows[t],remoteTab:h.newConfig.subflows[t]},u.editableList("addItem",e))}}}function n(e,t){var n=$("<div>",{class:"node-diff-property-wires"}),o=$("<ol></ol>"),i=0;return e.forEach(function(e,n){var s=$("<li>").appendTo(o);if(e&&e.length>0){$("<span>").html(n+1).appendTo(s);var r=$("<ul>").appendTo(s);e.forEach(function(e){i++;var n=$("<li>").appendTo(r),o=t[e];o?a(o,RED.nodes.getType(o.type)||{}).appendTo(n):n.html(e)})}else s.html("none")}),0===i?n.html("none"):o.appendTo(n),n}function o(e,t){var n=$("<div>",{class:"node-diff-node-entry-node"}),o=t.color,a=RED.utils.getNodeIcon(t,e);"tab"===e.type&&(o="#C0DEED"),n.css("backgroundColor",o);var i=$("<div/>",{class:"palette_icon_container"}).appendTo(n);return $("<div/>",{class:"palette_icon",style:"background-image: url("+a+")"}).appendTo(i),n}function a(e,t){var n=$("<div>",{class:"node-diff-node-entry-title"});o(e,t).appendTo(n);var a=$("<div>",{class:"node-diff-node-description"}).appendTo(n),i=e.label||e.name||e.id;return $("<span>",{class:"node-diff-node-label"}).html(i).appendTo(a),n}function i(e,t,n){var o=n.localDiff,i=n.remoteDiff,d=n.conflicts[e.id],l=!0;o.added[e.id]&&(t.local.addedCount++,l=!1),i&&i.added[e.id]&&(t.remote.addedCount++,l=!1),o.deleted[e.id]&&(t.local.deletedCount++,l=!1),i&&i.deleted[e.id]&&(t.remote.deletedCount++,l=!1),o.changed[e.id]&&(t.local.changedCount++,!0,l=!1),i&&i.changed[e.id]&&(t.remote.changedCount++,!0,l=!1);var c=RED.nodes.getType(e.type);void 0===c&&(c=/^subflow:/.test(e.type)?{icon:"subflow.png",category:"subflows",color:"#da9",defaults:{name:{value:""}}}:{});var p,u=$("<div>",{class:"node-diff-node-entry collapsed"}),f=$("<div>",{class:"node-diff-node-entry-header"}).appendTo(u),h=$("<div>",{class:"node-diff-node-entry-cell"}).appendTo(f),g=$("<div>",{class:"node-diff-node-entry-cell node-diff-node-local"}).appendTo(f);if(i&&(p=$("<div>",{class:"node-diff-node-entry-cell node-diff-node-remote"}).appendTo(f)),$('<span class="node-diff-chevron"><i class="fa fa-angle-down"></i></span>').appendTo(h),l)t.local.unchangedCount++,a(e,c).appendTo(h),g.addClass("node-diff-node-unchanged"),$('<span class="node-diff-status"><i class="fa fa-square-o"></i> <span data-i18n="diff.type.unchanged"></span></span>').appendTo(g),i&&(t.remote.unchangedCount++,p.addClass("node-diff-node-unchanged"),$('<span class="node-diff-status"><i class="fa fa-square-o"></i> <span data-i18n="diff.type.unchanged"></span></span>').appendTo(p)),u.addClass("node-diff-node-unchanged");else if(o.added[e.id])g.addClass("node-diff-node-added"),p&&p.addClass("node-diff-empty"),$('<span class="node-diff-status"><i class="fa fa-plus-square"></i> <span data-i18n="diff.type.added"></span></span>').appendTo(g),a(e,c).appendTo(h);else if(i&&i.added[e.id])g.addClass("node-diff-empty"),p.addClass("node-diff-node-added"),$('<span class="node-diff-status"><i class="fa fa-plus-square"></i> <span data-i18n="diff.type.added"></span></span>').appendTo(p),a(e,c).appendTo(h);else{if(a(e,c).appendTo(h),o.moved[e.id]){var v=o.newConfig.all[e.id];if(o.deleted[e.z]||e.z===v.z||""===e.z||o.newConfig.all[e.z]){g.addClass("node-diff-node-moved");var m="";m=e.z===v.z?RED._("diff.type.movedFrom",{id:o.currentConfig.all[e.id].z||"global"}):RED._("diff.type.movedTo",{id:v.z||"global"}),$('<span class="node-diff-status"><i class="fa fa-caret-square-o-right"></i> '+m+"</span>").appendTo(g)}else g.addClass("node-diff-empty");!0}else o.deleted[e.z]?(g.addClass("node-diff-empty"),!0):o.deleted[e.id]?(g.addClass("node-diff-node-deleted"),$('<span class="node-diff-status"><i class="fa fa-minus-square"></i> <span data-i18n="diff.type.deleted"></span></span>').appendTo(g),!0):o.changed[e.id]?o.newConfig.all[e.id].z!==e.z?g.addClass("node-diff-empty"):(g.addClass("node-diff-node-changed"),$('<span class="node-diff-status"><i class="fa fa-square"></i> <span data-i18n="diff.type.changed"></span></span>').appendTo(g),!0):o.newConfig.all[e.id].z!==e.z?g.addClass("node-diff-empty"):(t.local.unchangedCount++,g.addClass("node-diff-node-unchanged"),$('<span class="node-diff-status"><i class="fa fa-square-o"></i> <span data-i18n="diff.type.unchanged"></span></span>').appendTo(g));if(i)if(i.moved[e.id]){var b=i.newConfig.all[e.id];if(i.deleted[e.z]||e.z===b.z||""===e.z||i.newConfig.all[e.z]){p.addClass("node-diff-node-moved");var y="";y=e.z===b.z?RED._("diff.type.movedFrom",{id:i.currentConfig.all[e.id].z||"global"}):RED._("diff.type.movedTo",{id:b.z||"global"}),$('<span class="node-diff-status"><i class="fa fa-caret-square-o-right"></i> '+y+"</span>").appendTo(p)}else p.addClass("node-diff-empty")}else i.deleted[e.z]?p.addClass("node-diff-empty"):i.deleted[e.id]?(p.addClass("node-diff-node-deleted"),$('<span class="node-diff-status"><i class="fa fa-minus-square"></i> <span data-i18n="diff.type.deleted"></span></span>').appendTo(p)):i.changed[e.id]?i.newConfig.all[e.id].z!==e.z?p.addClass("node-diff-empty"):(p.addClass("node-diff-node-changed"),$('<span class="node-diff-status"><i class="fa fa-square"></i> <span data-i18n="diff.type.changed"></span></span>').appendTo(p)):i.newConfig.all[e.id].z!==e.z?p.addClass("node-diff-empty"):(t.remote.unchangedCount++,p.addClass("node-diff-node-unchanged"),$('<span class="node-diff-status"><i class="fa fa-square-o"></i> <span data-i18n="diff.type.unchanged"></span></span>').appendTo(p))}var w,D={node:o.newConfig.all[e.id],all:o.newConfig.all,diff:o};i&&(w={node:i.newConfig.all[e.id]||null,all:i.newConfig.all,diff:i}),s(c,e,D,w).appendTo(u);var E="";return d?(t.conflicts++,g.hasClass("node-diff-empty")||$('<span class="node-diff-node-conflict"><span class="node-diff-status"><i class="fa fa-exclamation"></i></span></span>').prependTo(g),p.hasClass("node-diff-empty")||$('<span class="node-diff-node-conflict"><span class="node-diff-status"><i class="fa fa-exclamation"></i></span></span>').prependTo(p),u.addClass("node-diff-node-entry-conflict")):E=n.resolutions[e.id],r(e,u,g,p,!1,!d,E,n),f.click(function(e){$(this).parent().toggleClass("collapsed")}),u}function s(e,t,o,a){var i,s={},r=o.node;a&&(i=a.node);var d=$("<div>",{class:"node-diff-node-entry-properties"}),l=$("<table>").appendTo(d),c=$("<colgroup><col/><col/></colgroup>").appendTo(l);void 0!==i&&$("<col/>").appendTo(c);var p,u,f,h,g,m,b,y=$("<tbody>").appendTo(l),w=!1,D=!1,E=!1;p=$("<tr>").appendTo(y),$("<td>",{class:"node-diff-property-cell-label"}).html("id").appendTo(p),u=$("<td>",{class:"node-diff-property-cell node-diff-node-local"}).appendTo(p),r?(u.addClass("node-diff-node-unchanged"),$('<span class="node-diff-status"></span>').appendTo(u),h=$('<span class="node-diff-element"></span>').appendTo(u),s["local.id"]=RED.utils.createObjectElement(r.id).appendTo(h)):u.addClass("node-diff-empty"),void 0!==i&&((f=$("<td>",{class:"node-diff-property-cell node-diff-node-remote"}).appendTo(p)).addClass("node-diff-node-unchanged"),i?($('<span class="node-diff-status"></span>').appendTo(f),h=$('<span class="node-diff-element"></span>').appendTo(f),s["remote.id"]=RED.utils.createObjectElement(i.id).appendTo(h)):f.addClass("node-diff-empty")),t.hasOwnProperty("x")&&(r&&(r.x===t.x&&r.y===t.y||(w=!0,0)),i&&(i.x===t.x&&i.y===t.y||(D=!0,0)),(D&&w&&(r.x!==i.x||r.y!==i.y)||!w&&D&&o.diff.deleted[t.id]||w&&!D&&a.diff.deleted[t.id])&&(E=!0),p=$("<tr>").appendTo(y),$("<td>",{class:"node-diff-property-cell-label"}).html("position").appendTo(p),u=$("<td>",{class:"node-diff-property-cell node-diff-node-local"}).appendTo(p),r?(u.addClass("node-diff-node-"+(w?"changed":"unchanged")),$('<span class="node-diff-status">'+(w?'<i class="fa fa-square"></i>':"")+"</span>").appendTo(u),h=$('<span class="node-diff-element"></span>').appendTo(u),s["local.position"]=RED.utils.createObjectElement({x:r.x,y:r.y},{path:"position",exposeApi:!0,ontoggle:function(e,t){s["remote."+e]&&s["remote."+e].prop("expand")(e,t)}}).appendTo(h)):u.addClass("node-diff-empty"),void 0!==i&&((f=$("<td>",{class:"node-diff-property-cell node-diff-node-remote"}).appendTo(p)).addClass("node-diff-node-"+(D?"changed":"unchanged")),i?($('<span class="node-diff-status">'+(D?'<i class="fa fa-square"></i>':"")+"</span>").appendTo(f),h=$('<span class="node-diff-element"></span>').appendTo(f),s["remote.position"]=RED.utils.createObjectElement({x:i.x,y:i.y},{path:"position",exposeApi:!0,ontoggle:function(e,t){s["local."+e]&&s["local."+e].prop("expand")(e,t)}}).appendTo(h)):f.addClass("node-diff-empty"))),w=D=E=!1,t.hasOwnProperty("wires")&&(g=JSON.stringify(t.wires),r&&(m=JSON.stringify(r.wires),g!==m&&(w=!0,0)),i&&(b=JSON.stringify(i.wires),g!==b&&(D=!0,0)),(D&&w&&m!==b||!w&&D&&o.diff.deleted[t.id]||w&&!D&&a.diff.deleted[t.id])&&(E=!0),p=$("<tr>").appendTo(y),$("<td>",{class:"node-diff-property-cell-label"}).html("wires").appendTo(p),u=$("<td>",{class:"node-diff-property-cell node-diff-node-local"}).appendTo(p),r?(E?(u.addClass("node-diff-node-conflict"),$('<span class="node-diff-status"><i class="fa fa-exclamation"></i></span>').appendTo(u)):(u.addClass("node-diff-node-"+(w?"changed":"unchanged")),$('<span class="node-diff-status">'+(w?'<i class="fa fa-square"></i>':"")+"</span>").appendTo(u)),n(r.wires,o.all).appendTo(u)):u.addClass("node-diff-empty"),void 0!==i&&(f=$("<td>",{class:"node-diff-property-cell node-diff-node-remote"}).appendTo(p),i?(E?(f.addClass("node-diff-node-conflict"),$('<span class="node-diff-status"><i class="fa fa-exclamation"></i></span>').appendTo(f)):(f.addClass("node-diff-node-"+(D?"changed":"unchanged")),$('<span class="node-diff-status">'+(D?'<i class="fa fa-square"></i>':"")+"</span>").appendTo(f)),n(i.wires,a.all).appendTo(f)):f.addClass("node-diff-empty")));var R=Object.keys(t).filter(function(t){return!("inputLabels"==t||"outputLabels"==t||"z"==t||"wires"==t||"x"===t||"y"===t||"id"===t||"type"===t||e.defaults&&e.defaults.hasOwnProperty(t))});return e.defaults&&(R=R.concat(Object.keys(e.defaults))),"tab"!==t.type&&(R=R.concat(["inputLabels","outputLabels"])),R.forEach(function(e){w=!1,D=!1,E=!1,g=JSON.stringify(t[e]),r&&(m=JSON.stringify(r[e]),g!==m&&(w=!0,0)),i&&(b=JSON.stringify(i[e]),g!==b&&(D=!0,0)),(D&&w&&m!==b||!w&&D&&o.diff.deleted[t.id]||w&&!D&&a.diff.deleted[t.id])&&(E=!0),p=$("<tr>").appendTo(y);var n=$("<td>",{class:"node-diff-property-cell-label"}).html(e).appendTo(p);u=$("<td>",{class:"node-diff-property-cell node-diff-node-local"}).appendTo(p),r?(E?(u.addClass("node-diff-node-conflict"),$('<span class="node-diff-status"><i class="fa fa-exclamation"></i></span>').appendTo(u)):(u.addClass("node-diff-node-"+(w?"changed":"unchanged")),$('<span class="node-diff-status">'+(w?'<i class="fa fa-square"></i>':"")+"</span>").appendTo(u)),h=$('<span class="node-diff-element"></span>').appendTo(u),s["local."+e]=RED.utils.createObjectElement(r[e],{path:e,exposeApi:!0,ontoggle:function(t,n){s["remote."+e]&&s["remote."+e].prop("expand")(t,n)}}).appendTo(h)):u.addClass("node-diff-empty"),void 0!==i&&(f=$("<td>",{class:"node-diff-property-cell node-diff-node-remote"}).appendTo(p),i?(E?(f.addClass("node-diff-node-conflict"),$('<span class="node-diff-status"><i class="fa fa-exclamation"></i></span>').appendTo(f)):(f.addClass("node-diff-node-"+(D?"changed":"unchanged")),$('<span class="node-diff-status">'+(D?'<i class="fa fa-square"></i>':"")+"</span>").appendTo(f)),h=$('<span class="node-diff-element"></span>').appendTo(f),s["remote."+e]=RED.utils.createObjectElement(i[e],{path:e,exposeApi:!0,ontoggle:function(t,n){s["local."+e]&&s["local."+e].prop("expand")(t,n)}}).appendTo(h)):f.addClass("node-diff-empty")),r&&i&&"string"==typeof r[e]&&(/\n/.test(r[e])||/\n/.test(i[e]))&&$('<button class="editor-button editor-button-small node-diff-text-diff-button"><i class="fa fa-file-o"> <i class="fa fa-caret-left"></i> <i class="fa fa-caret-right"></i> <i class="fa fa-file-o"></i></button>').click(function(){v(r[e],i[e])}).appendTo(n)}),d}function r(e,t,n,o,a,i,s,r){var l="node-diff-selectbox-"+e.id.replace(/\./g,"-")+(a?"-props":""),c="";(e.z||a)&&(c="node-diff-selectbox-tab-"+(a?e.id:e.z).replace(/\./g,"-"));var p=!a&&("tab"===e.type||"subflow"===e.type),u=function(n){var o;if(void 0===e.type);else if(p)o="node-diff-selectbox-tab-"+e.id.replace(/\./g,"-"),$("."+o+"-"+this.value).prop("checked",!0),"local"===this.value?($("."+o+"-"+this.value).closest(".node-diff-node-entry").addClass("node-diff-select-local"),$("."+o+"-"+this.value).closest(".node-diff-node-entry").removeClass("node-diff-select-remote")):($("."+o+"-"+this.value).closest(".node-diff-node-entry").removeClass("node-diff-select-local"),$("."+o+"-"+this.value).closest(".node-diff-node-entry").addClass("node-diff-select-remote"));else{var i="node-diff-selectbox-"+(a?e.id:e.z).replace(/\./g,"-");$("#"+i+"-local").prop("checked",!1),$("#"+i+"-remote").prop("checked",!1);var s=$("#"+i+"-local").closest(".node-diff-tab").find(".node-diff-tab-title");s.removeClass("node-diff-select-local"),s.removeClass("node-diff-select-remote")}"local"===this.value?(t.removeClass("node-diff-select-remote"),t.addClass("node-diff-select-local")):"remote"===this.value&&(t.addClass("node-diff-select-remote"),t.removeClass("node-diff-select-local")),d(r)},f=$("<label>",{class:"node-diff-selectbox",for:l+"-local"}).click(function(e){e.stopPropagation()}).appendTo(n),h=$("<input>",{id:l+"-local",type:"radio",value:"local",name:l,class:c+"-local"+(p?"":" node-diff-select-node")}).data("node-id",e.id).change(u).appendTo(f),g=$("<label>",{class:"node-diff-selectbox",for:l+"-remote"}).click(function(e){e.stopPropagation()}).appendTo(o),v=$("<input>",{id:l+"-remote",type:"radio",value:"remote",name:l,class:c+"-remote"+(p?"":" node-diff-select-node")}).data("node-id",e.id).change(u).appendTo(g);"local"===s?h.prop("checked",!0):"remote"===s&&v.prop("checked",!0),(i||n.hasClass("node-diff-empty")||o.hasClass("node-diff-empty"))&&(f.hide(),g.hide())}function d(e){var t=0;$(".node-diff-selectbox>input:checked").each(function(){e.conflicts[$(this).data("node-id")]&&t++,e.resolutions[$(this).data("node-id")]=$(this).val()});var n=Object.keys(e.conflicts).length;n-t==0?$("#node-diff-toolbar-resolved-conflicts").html('<span class="node-diff-node-added"><span class="node-diff-status"><i class="fa fa-check"></i></span></span> '+RED._("diff.unresolvedCount",{count:n-t})):$("#node-diff-toolbar-resolved-conflicts").html('<span class="node-diff-node-conflict"><span class="node-diff-status"><i class="fa fa-exclamation"></i></span></span> '+RED._("diff.unresolvedCount",{count:n-t})),n===t&&($("#node-diff-view-diff-merge").removeClass("disabled"),$("#node-diff-view-resolve-diff").removeClass("disabled"))}function l(e){$.ajax({headers:{Accept:"application/json"},cache:!1,url:"flows",success:function(t){var n=RED.nodes.createCompleteNodeSet(),o=RED.nodes.originalFlow(),a=t.flows,i=u(o,n),s=u(o,a);s.rev=t.rev,e(f(i,s))}})}function c(n){void 0===n?l(c):function(n,o){if(e)return;(o=o||{}).mode,n.localDiff;var a=n.remoteDiff,i=n.conflicts,s={title:o.title||"Review Changes",width:1/0,overlay:!0,buttons:[{text:RED._("merge"===o.mode?"common.label.cancel":"common.label.close"),click:function(){RED.tray.close()}}],resize:function(e){},open:function(e){var s=e.find(".editor-tray-body"),r=($('<div class="node-diff-toolbar"><span><span id="node-diff-toolbar-resolved-conflicts"></span></span> </div>').prependTo(s),$('<div class="node-diff-container"></div>').appendTo(s)),l=t(r,n,o);l.list.hide(),a?($("#node-diff-view-diff-merge").show(),0===Object.keys(i).length?$("#node-diff-view-diff-merge").removeClass("disabled"):$("#node-diff-view-diff-merge").addClass("disabled")):$("#node-diff-view-diff-merge").hide(),d(n),setTimeout(function(){l.finish(),l.list.show()},300),$("#sidebar-shade").show()},close:function(){e=!1,$("#sidebar-shade").hide()},show:function(){}};"merge"===o.mode&&s.buttons.push({id:"node-diff-view-diff-merge",text:RED._("deploy.confirm.button.merge"),class:"primary disabled",click:function(){$("#node-diff-view-diff-merge").hasClass("disabled")||(d(n),g(n),RED.tray.close())}});RED.tray.show(s)}(n,{mode:"merge"})}function p(e){var t=[],n={},o={},a=[],i={};return e.forEach(function(e){i[e.id]=e,"tab"===e.type?(t.push(e.id),n[e.id]={n:e,nodes:[]}):"subflow"===e.type&&(o[e.id]={n:e,nodes:[]})}),e.forEach(function(e){"tab"!==e.type&&"subflow"!==e.type&&(n[e.z]?n[e.z].nodes.push(e):o[e.z]?o[e.z].nodes.push(e):a.push(e))}),{all:i,tabOrder:t,tabs:n,subflows:o,globals:a}}function u(e,t){var n=p(e),o=p(t),a={},i={},s={},r={};return Object.keys(n.all).forEach(function(e){RED.nodes.workspace(e)||RED.nodes.subflow(e)||RED.nodes.node(e);o.all.hasOwnProperty(e)?JSON.stringify(n.all[e])!==JSON.stringify(o.all[e])&&(s[e]=!0,n.all[e].z!==o.all[e].z&&(r[e]=!0)):i[e]=!0}),Object.keys(o.all).forEach(function(e){n.all.hasOwnProperty(e)||(a[e]=!0)}),{currentConfig:n,newConfig:o,added:a,deleted:i,changed:s,moved:r}}function f(e,t){var n,o,a={},i={},s={localDiff:e,remoteDiff:t,conflicts:a,resolutions:i},r={};for(n in e.currentConfig.all)if(e.currentConfig.all.hasOwnProperty(n)){r[n]=!0;var d=e.newConfig.all[n];if(e.changed[n]&&t.deleted[n])a[n]=!0;else if(e.deleted[n]&&t.changed[n])a[n]=!0;else if(e.changed[n]&&t.changed[n]){var l=t.newConfig.all[n];JSON.stringify(d)!==JSON.stringify(l)&&(a[n]=!0)}a[n]||(t.added[n]||t.changed[n]||t.deleted[n]?i[n]="remote":i[n]="local")}for(n in e.added)e.added.hasOwnProperty(n)&&(o=e.newConfig.all[n],t.deleted[o.z]?a[n]=!0:i[n]="local");for(n in t.added)t.added.hasOwnProperty(n)&&(o=t.newConfig.all[n],e.deleted[o.z]?a[n]=!0:i[n]="remote");return s}function h(e){e.localDiff.currentConfig;var t,n=e.localDiff,o=e.remoteDiff,a=e.conflicts,i=e.resolutions;for(t in a)if(a.hasOwnProperty(t)&&!i.hasOwnProperty(t))throw console.log(e),new Error("No resolution for conflict on node",t);var s,r=[],d={},l={};for(t in n.newConfig.all)n.newConfig.all.hasOwnProperty(t)&&(s=RED.nodes.node(t),"local"===i[t]?(s&&(d[t]=s.changed),r.push(n.newConfig.all[t])):"remote"===i[t]?!o.deleted[t]&&o.newConfig.all.hasOwnProperty(t)&&(s&&(d[t]=s.changed),l[t]=!0,r.push(o.newConfig.all[t])):console.log("Unresolved",t));for(t in o.added)o.added.hasOwnProperty(t)&&((s=RED.nodes.node(t))&&(d[t]=s.changed),n.added.hasOwnProperty(t)||(l[t]=!0,r.push(o.newConfig.all[t])));return{config:r,nodeChangedStates:d,localChangedStates:l}}function g(e){var t=h(e),n=t.config,o=t.nodeChangedStates,a=t.localChangedStates,i={t:"replace",config:RED.nodes.createCompleteNodeSet(),changed:o,dirty:RED.nodes.dirty(),rev:RED.nodes.version()};RED.history.push(i),RED.nodes.clear(),RED.nodes.import(n)[0].forEach(function(e){(o[e.id]||a[e.id])&&(e.changed=!0)}),RED.nodes.version(e.remoteDiff.rev),RED.view.redraw(!0),RED.palette.refresh(),RED.workspaces.refresh(),RED.sidebar.config.refresh()}function v(t,n){var o={title:"Compare Changes",width:1/0,overlay:!0,buttons:[{text:RED._("common.label.close"),click:function(){RED.tray.close()}}],resize:function(e){},open:function(e){var o=e.find(".editor-tray-body"),a=$('<div class="node-text-diff"></div>').appendTo(o),i=$("<table>",{class:"node-text-diff-content"}).appendTo(a);$('<colgroup><col width="50"><col width="50%"><col width="50"><col width="50%"></colgroup>').appendTo(i);for(var s,r=$("<tbody>").appendTo(i),d=function(e,t,n){var o,a,i=e.split(/\r?\n/),s=t.split(/\r?\n/),r=i.length,d=s.length,l={a:[],b:[]},c=[];for(o=0;o<r+1;o++)for(c[o]=[],a=0;a<d+1;a++)c[o][a]=0;for(o=r-1;o>=0;o--)for(a=d-1;a>=0;a--)0,1!==y(i[o],s[a],n)?c[o][a]=c[o+1][a+1]+1:c[o][a]=Math.max(c[o+1][a],c[o][a+1]);o=0,a=0;for(;o<r&&a<d;){var p=y(i[o],s[a],n);if(1!==p){var u=0;0===p?u=0:2==p&&(u=3),l.a.push({i:o+1,j:a+1,line:i[o],type:u}),l.b.push({i:a+1,j:o+1,line:s[a],type:u}),o++,a++}else c[o+1][a]>=c[o][a+1]?(l.a.push({i:o+1,line:i[o],type:1}),o++):(l.b.push({i:a+1,line:s[a],type:4}),a++)}for(;o<r||a<d;)o==r?(l.b.push({i:a+1,line:s[a],type:4}),a++):a==d&&(l.a.push({i:o+1,line:i[o],type:1}),o++);return l}(t||"",n||""),l=0,c=0,p=Math.max(d.a.length,d.b.length),u=[],f=[],h=0,g=0,v=0;v<p;v++){d[v];var w=l<d.a.length?d.a[l]:{type:2,line:""},D=c<d.b.length?d.b[c]:{type:2,line:""};0===w.type&&0!==D.type?(w={type:2,line:""},c++):0===D.type&&0!==w.type?(D={type:2,line:""},l++):(l++,c++),u.push({a:w,b:D}),void 0===s?(s={start:v,end:v},h=0,g=0===w.type&&0===D.type?0:1):0===w.type&&0===D.type?0===g?(s.end=v,h++):1===g?(s.end=v,g=2,h=0):2===g&&(s.end=v,8===++h&&(s.end-=5,f.push(s),s={start:v-5,end:v-5},g=0,h=0)):(s.end=v,h++,0===g?(s.end>3&&(s.end-=3,s.empty=!0,f.push(s),s={start:v-3,end:v-3}),g=1):2===g&&(g=1))}0===g&&(s.empty=!0),s.end=p,f.push(s);for(var E=0;E<f.length;E++)if((s=f[E]).empty)m(s.start,s.end,u).appendTo(r);else for(v=s.start;v<s.end;v++){var R=b(u[v]).appendTo(r);v===s.start?R.addClass("start-block"):v===s.end-1&&R.addClass("end-block")}},close:function(){e=!1},show:function(){}};RED.tray.show(o)}function m(e,t,n){diffRow=$('<tr class="node-text-diff-header node-text-diff-expand">');var o=$('<td colspan="4"> <i class="fa fa-arrows-v"></i> </td>').appendTo(diffRow),a=$("<span></span>").appendTo(o);return t<n.length-1&&a.text("@@ -"+(n[t-1].a.i+1)+" +"+(n[t-1].b.i+1)),diffRow.click(function(o){if(t-e>20){var i=$(this).offset();if(e>0){for(var s=e;s<e+10;s++)b(n[s]).addClass("unchanged").insertBefore($(this));e+=10}if(t<n.length-1){for(s=t-1;s>t-11;s--)b(n[s]).addClass("unchanged").insertAfter($(this));t-=10}t<n.length-1&&a.text("@@ -"+(n[t-1].a.i+1)+" +"+(n[t-1].b.i+1));var r=$(this).offset().top-i.top;$(".node-text-diff").scrollTop($(".node-text-diff").scrollTop()+r)}else{for(s=e;s<t;s++)b(n[s]).addClass("unchanged").insertBefore($(this));$(this).remove()}}),diffRow}function b(e){var t=$("<tr>"),n=e.a,o=e.b,a=$('<td class="lineno">').text(2===n.type?"":n.i).appendTo(t),i=$('<td class="linetext">').text(n.line).appendTo(t);return 2===n.type?(a.addClass("blank"),i.addClass("blank")):4===n.type?(a.addClass("added"),i.addClass("added")):1===n.type&&(a.addClass("removed"),i.addClass("removed")),a=$('<td class="lineno">').text(2===o.type?"":o.i).appendTo(t),i=$('<td class="linetext">').text(o.line).appendTo(t),2===o.type?(a.addClass("blank"),i.addClass("blank")):4===o.type?(a.addClass("added"),i.addClass("added")):1===o.type&&(a.addClass("removed"),i.addClass("removed")),t}function y(e,t,n){return n?e===t?0:e.trim()===t.trime()?2:1:e===t?0:1}function w(e,n){var o=$("<div></div>");return e.forEach(function(e){var a=e.hunks,i=e.binary,s=$("<table>",{class:"node-text-diff-content"}).appendTo(o);$('<colgroup><col width="50"><col width="50"><col width="100%"></colgroup>').appendTo(s);var r=$("<tbody>").appendTo(s),l=$('<tr class="node-text-diff-file-header">').appendTo(r),c=$('<td colspan="3"></td>').appendTo(l);$('<i class="node-diff-chevron fa fa-angle-down"></i>').appendTo(c);l.click(function(e){l.toggleClass("collapsed");var t=l.hasClass("collapsed");l.nextUntil(".node-text-diff-file-header").toggle(!t)});$('<span class="filename"></span>').text(e.file).appendTo(c);var p,h=0,g=0,v={};if(n.project.files&&n.project.files.flow===e.file){n.unmerged&&$('<span style="float: right;"><span id="node-diff-toolbar-resolved-conflicts"></span></span>').appendTo(c);var m=$('<tr class="node-text-diff-header">').appendTo(r),b=$('<td class="flow-diff" colspan="3"></td>').appendTo(m),y=n.project.name,w=n.project.files.flow,D="projects/"+y+"/files/"+n.commonRev+"/"+w,E="projects/"+y+"/files/"+n.oldRev+"/"+w,R="projects/"+y+"/files/"+n.newRev+"/"+w,x=[$.Deferred(),$.Deferred(),$.Deferred()];if(n.commonRev){D="projects/"+y+"/files/"+n.commonRev+"/"+w;$.ajax({dataType:"json",url:D}).then(function(e){x[0].resolve(e)}).fail(function(){x[0].resolve(null)})}else x[0].resolve(null);$.ajax({dataType:"json",url:E}).then(function(e){x[1].resolve(e)}).fail(function(){x[1].resolve({content:"[]"})}),$.ajax({dataType:"json",url:R}).then(function(e){x[2].resolve(e)}).fail(function(){x[2].resolve({content:"[]"})}),$.when.apply($,x).always(function(e,o,a){var i,s,r;if(e)try{i=JSON.parse(e.content||"[]")}catch(e){return console.log("Common Version doesn't contain valid JSON:",D),void console.log(e)}try{s=JSON.parse(o.content||"[]")}catch(e){return console.log("Old Version doesn't contain valid JSON:",E),void console.log(e)}i||(i=s);try{r=JSON.parse(a.content||"[]")}catch(e){return console.log("New Version doesn't contain valid JSON:",r),void console.log(e)}var l=u(i,s),c=u(i,r);n.currentDiff=f(l,c);var p=t(b,n.currentDiff,{title:w,mode:n.commonRev?"merge":"view",oldRevTitle:n.oldRevTitle,newRevTitle:n.newRevTitle});p.list.hide(),d(n.currentDiff),setTimeout(function(){p.finish(),p.list.show()},300)})}else if(i){var T=$('<tr class="node-text-diff-header">').appendTo(r),k=$('<td colspan="3"></td>').appendTo(T);$("<span></span>").text("Cannot show binary file contents").appendTo(k)}else n.unmerged&&(p=$('<span style="float: right;"><span>'+g+"</span> of <span>"+h+"</span> conflicts resolved</span>").appendTo(c)),a.forEach(function(t){var o=$('<tr class="node-text-diff-header">').appendTo(r),a=$('<td colspan="3"></td>').appendTo(o),i=($("<span></span>").text(t.header).appendTo(a),t.conflict),s=t.localStartLine,d=t.remoteStartLine;i&&h++,t.lines.forEach(function(o,a){var l,c=t.diffStart+a,u=i&&/^\+\+(<<<<<<<|=======$|>>>>>>>)/.test(o),f=$("<tr>").appendTo(r),m=$('<td class="lineno">').appendTo(f);u?m.attr("colspan",2):l=$('<td class="lineno">').appendTo(f);var b=$('<td class="linetext">').appendTo(f),y=1;if(i&&(y=2),u){if(f.addClass("mergeHeader"),/^\+\+=======$/.test(o))t.changeSeparator=c,f.addClass("mergeHeader-separator");else{var w=/^..<<<<<<</.test(o);w?($("<span>").text("<<<<<<< Local Changes").appendTo(b),t.localChangeStart=c):(t.remoteChangeEnd=c,$("<span>").text(">>>>>>> Remote Changes").appendTo(b)),f.addClass("mergeHeader-"+(w?"ours":"theirs")),$('<button class="editor-button editor-button-small" style="float: right; margin-right: 20px;"><i class="fa fa-angle-double-'+(w?"down":"up")+'"></i> use '+(w?"local":"remote")+" changes</button>").appendTo(b).click(function(o){var a,i;o.preventDefault(),g++,w?((i=(a=f.nextUntil(".mergeHeader-separator")).last().next()).nextUntil(".mergeHeader").remove(),i.next().remove()):((i=(a=f.prevUntil(".mergeHeader-separator")).last().prev()).prevUntil(".mergeHeader").remove(),i.prev().remove()),i.remove(),f.remove(),a.find(".linetext").addClass("added"),p.empty(),$("<span><span>"+g+"</span> of <span>"+h+"</span> conflicts resolved</span>").appendTo(p),v[e.file]=v[e.file]||{},v[e.file][t.localChangeStart]={changeStart:t.localChangeStart,separator:t.changeSeparator,changeEnd:t.remoteChangeEnd,selection:w?"A":"B"},n.resolveConflict&&n.resolveConflict({conflicts:h,resolved:g,resolutions:v})})}}else{var D=o[0];i&&!n.unmerged&&" "===D&&(D=o[1]),$('<span class="prefix">').text(D).appendTo(b);var E=!1;i&&n.unmerged?($('<span class="prefix">').text(o[1]).appendTo(b),"+"===o[0]&&(m.text(s++),E=!0),"+"===o[1]&&(l.text(d++),E=!0)):"+"===o[0]||i&&"+"===o[1]?(m.addClass("added"),l.addClass("added"),b.addClass("added"),l.text(d++),E=!0):("-"===o[0]||i&&"-"===o[1])&&(m.addClass("removed"),l.addClass("removed"),b.addClass("removed"),m.text(s++),E=!0),E||(b.addClass("unchanged"),s>0&&"\\"!==o[0]&&""!==o&&m.text(s++),d>0&&"\\"!==o[0]&&""!==o&&l.text(d++)),$("<span>").text(o.substring(y)).appendTo(b)}})})}),o}function D(e){var t;t=Array.isArray(e)?e:e.split("\n");for(var n,o,a=/^diff (?:(?:--git a\/(.*) b\/(.*))|(?:--cc (.*)))$/,i=/^\+\+\+ b\/(.*)\t?/,s=/^Binary files /,r=/^@@ -((\d+)(,(\d+))?) \+((\d+)(,(\d+))?) @@ ?(.*)$/,d=/^@+ -((\d+)(,(\d+))?) -((\d+)(,(\d+))?) \+((\d+)(,(\d+))?) @+/,l=[],c=0;c<t.length;c++){var p=t[c],u=a.exec(p);if(u)o&&(n.hunks.push(o),l.push(n)),o=null,n={file:u[1]||u[3],hunks:[]};else if(s.test(p))n&&(n.binary=!0);else{var f=i.exec(p);if(f)n.file=f[1];else{var h=r.exec(p);if(h){o&&n.hunks.push(o),o={header:p,localStartLine:h[2],localLength:h[4]||1,remoteStartLine:h[6],remoteLength:h[8]||1,lines:[],conflict:!1};continue}if(h=d.exec(p)){o&&n.hunks.push(o),o={header:p,localStartLine:h[2],localLength:h[4]||1,remoteStartLine:h[6],remoteLength:h[8]||1,diffStart:parseInt(h[10]),lines:[],conflict:!0};continue}o&&o.lines.push(p)}}}return o&&n.hunks.push(o),l.push(n),l}return{init:function(){RED.actions.add("core:show-remote-diff",c)},getRemoteDiff:l,showRemoteDiff:c,showUnifiedDiff:function(t){var n,o=t.diff,a=t.title,i=D(o);t.unmerged&&(t.resolveConflict=function(e){n=e,e.conflicts===e.resolved&&$("#node-diff-view-resolve-diff").removeClass("disabled")});var s={title:a||"Compare Changes",width:1/0,overlay:!0,buttons:[{text:RED._(t.unmerged?"common.label.cancel":"common.label.close"),click:function(){t.oncancel&&t.oncancel(),RED.tray.close()}}],resize:function(e){},open:function(e){var n=e.find(".editor-tray-body"),o=$('<div class="node-text-diff"></div>').appendTo(n);w(i,t).appendTo(o)},close:function(){e=!1},show:function(){}};t.unmerged&&s.buttons.push({id:"node-diff-view-resolve-diff",text:"Save conflict resolution",class:"primary disabled",click:function(){if(!$("#node-diff-view-resolve-diff").hasClass("disabled")){if(t.currentDiff){var e=h(t.currentDiff);(n={resolutions:{}}).resolutions[t.project.files.flow]=JSON.stringify(e.config,"",4)}t.onresolve&&t.onresolve(n),RED.tray.close()}}}),RED.tray.show(s)},showCommitDiff:function(t){var n=function(e){for(var t={},n=e.split("\n"),o=[],a=0;a<n.length;a++)if(/^commit /.test(n[a]))t.sha=n[a].substring(7);else if(/^Author: /.test(n[a])){t.author=n[a].substring(8);var i=/^(.*) <(.*)>$/.exec(t.author);i&&(t.authorName=i[1],t.authorEmail=i[2])}else if(/^Date: /.test(n[a]))t.date=n[a].substring(8);else if(/^    /.test(n[a]))t.title?(4!==n[a].length||o.length>0)&&o.push(n[a].substring(4)):t.title=n[a].substring(4);else if(/^diff /.test(n[a])){t.files=D(n.slice(a));break}return t.comment=o.join("\n"),t}(t.commit),o={title:"View Commit Changes",width:1/0,overlay:!0,buttons:[{text:RED._("common.label.close"),click:function(){RED.tray.close()}}],resize:function(e){},open:function(e){var o=e.find(".editor-tray-body"),a=$('<div class="node-text-diff"></div>').appendTo(o),i=$("<table>",{class:"node-text-diff-content"}).appendTo(a);$('<colgroup><col width="50"><col width="50"><col width="100%"></colgroup>').appendTo(i);var s=$("<tbody>").appendTo(i),r=$('<tr class="node-text-diff-commit-header">').appendTo(s),d=$('<td colspan="3"></td>').appendTo(r);$("<h3>").text(n.title).appendTo(d),$('<div class="commit-body"></div>').text(n.comment).appendTo(d);var l=$('<div class="commit-summary"></div>').appendTo(d);$('<div style="float: right">').text("Commit "+n.sha).appendTo(l),$("<div>").text((n.authorName||n.author)+" - "+t.date).appendTo(l),n.files&&w(n.files,t).appendTo(a)},close:function(){e=!1},show:function(){}};RED.tray.show(o)},mergeDiff:g}}(),RED.keyboard=function(){var e,t=/Mac/i.test(window.navigator.platform),n={},o={left:37,up:38,right:39,down:40,escape:27,enter:13,backspace:8,delete:46,space:32,";":186,"=":187,",":188,"-":189,".":190,"/":191,"\\":220,"'":222,"?":191},a={16:!0,17:!0,18:!0,91:!0,93:!0},s={},r={},d={59:186,61:187,173:189};function l(e){for(var t,n=e.toLowerCase().split("-"),a={},i=0;i<n.length;i++)switch(n[i]){case"ctrl":case"cmd":a.ctrl=!0,a.meta=!0;break;case"alt":a.alt=!0;break;case"shift":a.shift=!0;break;case"":0,t=o["-"];break;default:if(o.hasOwnProperty(n[i]))t=o[n[i]];else{if(n[i].length>1)return null;t=n[i].toUpperCase().charCodeAt(0)}}return[t,a]}function c(e,t,o,a){var i=o,r=a;"function"!=typeof o&&"string"!=typeof o||(i={},r=o);var d=[],c=0;if("string"==typeof t){"string"==typeof r&&(s[r]={scope:e,key:t},"boolean"==typeof a&&(s[r].user=a));var p=t.split(" ");for(c=0;c<p.length;c++){var u=l(p[c]);if(!u)return;d.push(u)}}else d.push([t,i]);var f=n;for(c=0;c<d.length;c++)t=d[c][0],(i=d[c][1]).ctrl&&(f.ctrl=f.ctrl||{},f=f.ctrl),i.shift&&(f.shift=f.shift||{},f=f.shift),i.alt&&(f.alt=f.alt||{},f=f.alt),f[t]=f[t]||{},f=f[t];f.scope=e,f.ondown=r}function p(e,t){var o=t||{},a=[],i=0;if("string"==typeof e){var r=e.split(" ");for(i=0;i<r.length;i++){var d=l(r[i]);if(!d)return void console.log("Unrecognised key specifier:",e);a.push(d)}}else a.push([e,o]);var c=n;for(i=0;i<a.length;i++){if(e=a[i][0],(o=a[i][1]).ctrl&&(c=c.ctrl),c&&o.shift&&(c=c.shift),c&&o.alt&&(c=c.alt),!c[e])return;c=c[e]}"string"==typeof c.ondown&&("boolean"==typeof t&&t?s[c.ondown]={user:t}:delete s[c.ondown]),delete c.scope,delete c.ondown}d3.select(window).on("keydown",function(){if(!a[d3.event.keyCode]){var t=function t(o){var a=e||n;(o.ctrlKey||o.metaKey)&&(a=a.ctrl),a&&o.shiftKey&&(a=a.shift),a&&o.altKey&&(a=a.alt);var i=d[o.keyCode]||o.keyCode;if(a&&a[i]){var s=a[i];if(!s.scope)return e?(e=null,t(o)):Object.keys(s).length>0?(e=s,o.preventDefault(),null):null;if(s.scope&&"*"!==s.scope){for(var r=o.target;"BODY"!==r.nodeName&&r.id!==s.scope;)r=r.parentElement;"BODY"===r.nodeName&&(s=null)}return e=null,s}if(e)return e=null,t(o)}(d3.event);t&&t.ondown&&("string"==typeof t.ondown?RED.actions.invoke(t.ondown):t.ondown(),d3.event.preventDefault())}});function u(e){e.preventDefault();var t=$(this),n=t.data("data");if(!t.hasClass("keyboard-shortcut-entry-expanded")){f();var o=t.find(".keyboard-shortcut-entry-key"),a=t.find(".keyboard-shortcut-entry-scope");t.addClass("keyboard-shortcut-entry-expanded");var i=$('<input type="text">').attr("placeholder",RED._("keyboard.unassigned")).val(n.key||"").appendTo(o);i.on("keyup",function(e){if(13===e.keyCode)return f();var t=$(this).val(),n=""===(t=t.trim())||RED.keyboard.validateKey(t);$(this).toggleClass("input-error",!n)});var s=$('<select><option value="*" data-i18n="keyboard.global"></option><option value="workspace" data-i18n="keyboard.workspace"></option></select>').appendTo(a);s.i18n(),s.val(n.scope||"*");var r=$('<div class="keyboard-shortcut-edit button-group-vertical"></div>').appendTo(a),d=$('<button class="editor-button editor-button-small"><i class="fa fa-check"></i></button>').appendTo(r),l=$('<button class="editor-button editor-button-small"><i class="fa fa-reply"></i></button>').appendTo(r);d.click(function(e){e.stopPropagation(),f()}),l.click(function(e){e.stopPropagation(),RED.keyboard.revertToDefault(n.id),t.empty(),t.removeClass("keyboard-shortcut-entry-expanded");var o=RED.keyboard.getShortcut(n.id),a=(RED.settings.get("keymap"),RED.settings.get("editor")||{});(a.keymap||{})[n.id]=null,RED.settings.set("editor",a);var i={id:n.id,scope:o?o.scope:void 0,key:o?o.key:void 0,user:o?o.user:void 0};h(t,i)}),i.focus()}}function f(e){var t=$(".keyboard-shortcut-entry-expanded");if(1===t.length){var n=t.data("data"),o=t.find(".keyboard-shortcut-entry-key input"),a=t.find(".keyboard-shortcut-entry-scope select");if(!e){var i=o.val().trim(),s=a.val();if(""===i||RED.keyboard.validateKey(i)){var r=RED.keyboard.getShortcut(n.id);if(!r&&i||r&&(r.scope!==s||r.key!==i)){var d=t.find(".keyboard-shortcut-entry-key"),l=t.find(".keyboard-shortcut-entry-scope");d.empty(),l.empty(),n.key&&RED.keyboard.remove(n.key,!0),t.find(".keyboard-shortcut-entry-text i").css("opacity",1),""===i?(d.parent().addClass("keyboard-shortcut-entry-unassigned"),d.append($("<span>").text(RED._("keyboard.unassigned"))),delete n.key,delete n.scope):(d.parent().removeClass("keyboard-shortcut-entry-unassigned"),d.append(RED.keyboard.formatKey(i)),$("<span>").text(s).appendTo(l),n.key=i,n.scope=s,RED.keyboard.add(n.scope,n.key,n.id,!0));var c=RED.settings.get("editor")||{};(c.keymap||{})[n.id]=RED.keyboard.getShortcut(n.id),RED.settings.set("editor",c)}}}o.remove(),a.remove(),$(".keyboard-shortcut-edit").remove(),t.removeClass("keyboard-shortcut-entry-expanded")}}function h(e,t){var n=$('<div class="keyboard-shortcut-entry">').appendTo(e);e.data("data",t);var o=t.id.replace(/(^.+:([a-z]))|(-([a-z]))/g,function(){return 0===arguments[5]?arguments[2].toUpperCase():" "+arguments[4].toUpperCase()}),a=$("<div>").addClass("keyboard-shortcut-entry-text").text(o).appendTo(n),i=$('<i class="fa fa-user"></i>').prependTo(a);t.user||i.css("opacity",0);var s=$('<div class="keyboard-shortcut-entry-key">').appendTo(n);t.key?s.append(RED.keyboard.formatKey(t.key)):(n.addClass("keyboard-shortcut-entry-unassigned"),s.append($("<span>").text(RED._("keyboard.unassigned"))));var r=$('<div class="keyboard-shortcut-entry-scope">').appendTo(n);$("<span>").text("*"===t.scope?"global":t.scope||"").appendTo(r),e.click(u)}function g(){var e=$('<div id="user-settings-tab-keyboard"></div>');$('<div class="keyboard-shortcut-entry keyboard-shortcut-list-header"><div class="keyboard-shortcut-entry-key keyboard-shortcut-entry-text"><input id="user-settings-tab-keyboard-filter" type="text" data-i18n="[placeholder]keyboard.filterActions"></div><div class="keyboard-shortcut-entry-key" data-i18n="keyboard.shortcut"></div><div class="keyboard-shortcut-entry-scope" data-i18n="keyboard.scope"></div></div>').appendTo(e),e.find("input").searchBox({delay:100,change:function(){var e=$(this).val().trim();""===e?t.editableList("filter",null):(e=e.replace(/\s/g,""),t.editableList("filter",function(t){return t.id.toLowerCase().replace(/^.*:/,"").replace("-","").indexOf(e)>-1}))}});var t=$('<ol class="keyboard-shortcut-list"></ol>').css({position:"absolute",top:"32px",bottom:"0",left:"0",right:"0"}).appendTo(e).editableList({addButton:!1,scrollOnAdd:!1,addItem:function(e,t,n){h(e,n)}}),n=RED.actions.list();return n.sort(function(e,t){var n=e.id.replace(/^.*:/,"").replace(/[ -]/g,"").toLowerCase(),o=t.id.replace(/^.*:/,"").replace(/[ -]/g,"").toLowerCase();return n.localeCompare(o)}),n.forEach(function(e){t.editableList("addItem",e)}),e}return{init:function(){!function(){if("localStorage"in window&&null!==window.localStorage){var e=localStorage.getItem("keymap");if(null!==e){localStorage.removeItem("keymap");var t=RED.settings.get("editor")||{};t.keymap=JSON.parse(e),RED.settings.set("editor",t)}}}();var e=(RED.settings.get("editor")||{}).keymap||{};$.getJSON("red/keymap.json",function(t){for(var n in t)if(t.hasOwnProperty(n)){var o=t[n];for(var a in o)o.hasOwnProperty(a)&&(e.hasOwnProperty(o[a])||c(n,a,o[a],!1),r[o[a]]={scope:n,key:a,user:!1})}for(var i in e)if(e.hasOwnProperty(i)){var s=e[i];s.hasOwnProperty("key")&&c(s.scope,s.key,i,!0)}}),RED.userSettings.add({id:"keyboard",title:RED._("keyboard.keyboard"),get:g,focus:function(){setTimeout(function(){$("#user-settings-tab-keyboard-filter").focus()},200)}})},add:c,remove:p,getShortcut:function(e){return s[e]},revertToDefault:function(e){var t=s[e];if(t&&p(t.key),r.hasOwnProperty(e)){var n=r[e];c(n.scope,n.key,e,!1)}},formatKey:function(e){var n=t?e.replace(/ctrl-?/,"&#8984;"):e;return'<span class="help-key-block"><span class="help-key">'+(n=(n=(n=(n=(n=(n=t?n.replace(/alt-?/,"&#8997;"):e).replace(/shift-?/,"&#8679;")).replace(/left/,"&#x2190;")).replace(/up/,"&#x2191;")).replace(/right/,"&#x2192;")).replace(/down/,"&#x2193;")).split(" ").join('</span> <span class="help-key">')+"</span></span>"},validateKey:function(e){var t=(e=e.trim()).split(" ");for(i=0;i<t.length;i++)if(!l(t[i]))return!1;return!0}}}(),RED.workspaces=function(){var e,t=0,n=0;function o(t,o){if(t)e.addTab(t),e.resize();else{var a=RED.nodes.id();do{n+=1}while(0!==$("#workspace-tabs a[title='"+RED._("workspace.defaultName",{number:n})+"']").size());t={type:"tab",id:a,disabled:!1,info:"",label:RED._("workspace.defaultName",{number:n})},RED.nodes.addWorkspace(t),e.addTab(t),e.activateTab(a),o||(RED.history.push({t:"add",workspaces:[t],dirty:RED.nodes.dirty()}),RED.nodes.dirty(!0))}return RED.view.focus(),t}function a(e){if(1!==s){c(e);var t=RED.nodes.removeWorkspace(e.id);t.t="delete",t.dirty=RED.nodes.dirty(),t.workspaces=[e],RED.history.push(t),RED.nodes.dirty(!0),RED.sidebar.config.refresh()}}function i(t){var n,o=RED.nodes.workspace(t);RED.view.state(RED.state.EDITING);var i={title:RED._("workspace.editFlow",{name:o.label}),buttons:[{id:"node-dialog-delete",class:"leftButton"+(1===s?" disabled":""),text:RED._("common.label.delete"),click:function(){a(o),RED.tray.close()}},{id:"node-dialog-cancel",text:RED._("common.label.cancel"),click:function(){RED.tray.close()}},{id:"node-dialog-ok",class:"primary",text:RED._("common.label.done"),click:function(){var t=$("#node-input-name").val(),a=!1,i={};o.label!=t&&(i.label=o.label,a=!0,o.label=t,e.renameTab(o.id,t));var s=$("#node-input-disabled").prop("checked");o.disabled!==s&&(i.disabled=o.disabled,a=!0,o.disabled=s);var r=n.getValue();if(o.info!==r&&(i.info=o.info,a=!0,o.info=r),$("#red-ui-tab-"+o.id.replace(".","-")).toggleClass("workspace-disabled",o.disabled),a){var d={t:"edit",changes:i,node:o,dirty:RED.nodes.dirty()};o.changed=!0,RED.history.push(d),RED.nodes.dirty(!0),RED.sidebar.config.refresh();var l=RED.view.selection();l.nodes||l.links||RED.sidebar.info.refresh(o)}RED.tray.close()}}],resize:function(e){for(var t=$("#dialog-form>div:not(.node-text-editor-row)"),o=($("#dialog-form>div.node-text-editor-row"),$("#dialog-form").height()),a=0;a<t.size();a++)o-=$(t[a]).outerHeight(!0);o-=parseInt($("#dialog-form").css("marginTop"))+parseInt($("#dialog-form").css("marginBottom")),o-=28,$(".node-text-editor").css("height",o+"px"),n.resize()},open:function(e){var t=e.find(".editor-tray-body"),a=$('<form id="dialog-form" class="form-horizontal"></form>').appendTo(t);$('<div class="form-row"><label for="node-input-name" data-i18n="[append]editor:common.label.name"><i class="fa fa-tag"></i> </label><input type="text" id="node-input-name"></div>').appendTo(a),$('<div class="form-row"><label for="node-input-disabled-btn" data-i18n="editor:workspace.status"></label><button id="node-input-disabled-btn" class="editor-button"><i class="fa fa-toggle-on"></i> <span id="node-input-disabled-label"></span></button> <input type="checkbox" id="node-input-disabled" style="display: none;"/></div>').appendTo(a),$('<div class="form-row node-text-editor-row"><label for="node-input-info" data-i18n="editor:workspace.info" style="width:300px;"></label><div style="height:250px;" class="node-text-editor" id="node-input-info"></div></div>').appendTo(a),n=RED.editor.createEditor({id:"node-input-info",mode:"ace/mode/markdown",value:""}),$('<div class="form-tips" data-i18n="editor:workspace.tip"></div>').appendTo(a),a.find("#node-input-disabled-btn").on("click",function(e){var t=$(this).find("i");t.hasClass("fa-toggle-off")?(t.addClass("fa-toggle-on"),t.removeClass("fa-toggle-off"),$("#node-input-disabled").prop("checked",!1),$("#node-input-disabled-label").html(RED._("editor:workspace.enabled"))):(t.addClass("fa-toggle-off"),t.removeClass("fa-toggle-on"),$("#node-input-disabled").prop("checked",!0),$("#node-input-disabled-label").html(RED._("editor:workspace.disabled")))}),o.hasOwnProperty("disabled")?($("#node-input-disabled").prop("checked",o.disabled),o.disabled?(a.find("#node-input-disabled-btn i").removeClass("fa-toggle-on").addClass("fa-toggle-off"),$("#node-input-disabled-label").html(RED._("editor:workspace.disabled"))):$("#node-input-disabled-label").html(RED._("editor:workspace.enabled"))):(o.disabled=!1,$("#node-input-disabled-label").html(RED._("editor:workspace.enabled"))),$('<input type="text" style="display: none;" />').prependTo(a),a.submit(function(e){e.preventDefault()}),$("#node-input-name").val(o.label),RED.text.bidi.prepareInput($("#node-input-name")),n.getSession().setValue(o.info||"",-1),a.i18n()},close:function(){RED.view.state()!=RED.state.IMPORT_DRAGGING&&RED.view.state(RED.state.DEFAULT),RED.sidebar.info.refresh(o),n.destroy()}};RED.tray.show(i)}var s=0;function r(){e=RED.tabs.create({id:"workspace-tabs",onchange:function(e){var n={old:t};t=e.id,n.workspace=t,RED.events.emit("workspace:change",n),window.location.hash="flow/"+e.id,RED.sidebar.config.refresh(),RED.view.focus()},onclick:function(e){RED.view.focus()},ondblclick:function(e){"subflow"!=e.type?i(e.id):RED.editor.editSubflow(RED.nodes.subflow(e.id))},onadd:function(e){"tab"===e.type&&s++,$('<span class="workspace-disabled-icon"><i class="fa fa-ban"></i> </span>').prependTo("#red-ui-tab-"+e.id.replace(".","-")+" .red-ui-tab-label"),e.disabled&&$("#red-ui-tab-"+e.id.replace(".","-")).addClass("workspace-disabled"),RED.menu.setDisabled("menu-item-workspace-delete",s<=1),1===s&&($("#workspace .red-ui-tabs").show(),$("#chart").show(),$("#workspace-footer").children().show())},onremove:function(e){"tab"===e.type&&s--,RED.menu.setDisabled("menu-item-workspace-delete",s<=1),0===s&&d()},onreorder:function(e,t){RED.history.push({t:"reorder",order:e,dirty:RED.nodes.dirty()}),RED.nodes.dirty(!0),p(t)},minimumActiveTabWidth:150,scrollable:!0,addButton:function(){o()}}),s=0}function d(){$("#workspace .red-ui-tabs").hide(),$("#chart").hide(),$("#workspace-footer").children().hide()}function l(e){i(e||t)}function c(n){n?e.contains(n.id)&&e.removeTab(n.id):a(RED.nodes.workspace(t)),n.id===t&&(t=0)}function p(t){RED.nodes.setWorkspaceOrder(t.filter(function(e){return void 0!==RED.nodes.workspace(e)})),e.order(t)}return{init:function(){r(),RED.events.on("sidebar:resize",e.resize),RED.actions.add("core:show-next-tab",e.nextTab),RED.actions.add("core:show-previous-tab",e.previousTab),RED.menu.setAction("menu-item-workspace-delete",function(){a(RED.nodes.workspace(t))}),$(window).resize(function(){e.resize()}),RED.actions.add("core:add-flow",o),RED.actions.add("core:edit-flow",l),RED.actions.add("core:remove-flow",c),d()},add:o,remove:c,order:p,edit:l,contains:function(t){return e.contains(t)},count:function(){return s},active:function(){return t},show:function(t){if(!e.contains(t)){var n=RED.nodes.subflow(t);if(!n)return;o({type:"subflow",id:t,icon:"red/images/subflow_tab.png",label:n.name,closeable:!0})}e.activateTab(t)},refresh:function(){RED.nodes.eachWorkspace(function(t){e.renameTab(t.id,t.label)}),RED.nodes.eachSubflow(function(t){e.contains(t.id)&&e.renameTab(t.id,t.name)}),RED.sidebar.config.refresh()},resize:function(){e.resize()}}}(),RED.view=function(){var e,t,n=5e3,o=5e3,a=.75,i=1,s=100,r=30,d=1e3,l=0,c=[],p=0,u={},f=20,h=!1,g=!1,v=null,m=[],b=[],y=[],w=null,D=null,E=null,R=null,x=0,T=null,k=[0,0],_=null,C=0,j=[],S=null,O=!1,L=null,P=null,N=0,I=0,A="",z={red:"#c00",green:"#5a8",yellow:"#F9DF31",blue:"#53A3F3",grey:"#d3d3d3"},M=1,B=0,J=d3.select("#chart").append("svg:svg").attr("width",n).attr("height",o).attr("pointer-events","all").style("cursor","crosshair").on("mousedown",function(){Ce()}).on("contextmenu",function(){d3.event.preventDefault()}),U=J.append("svg:g").on("dblclick.zoom",null).append("svg:g").attr("class","innerCanvas").on("mousemove",Z).on("mousedown",function(){var e;E||D||(w=null,se());0===C&&S&&(S.remove(),S=null);if((0===C||C===RED.state.QUICK_JOINING)&&(d3.event.metaKey||d3.event.ctrlKey)){e=d3.mouse(this),d3.event.stopPropagation();var t=$("#main-container").position();C!==RED.state.QUICK_JOINING&&(C=RED.state.QUICK_JOINING,$(window).on("keyup",ve)),RED.typeSearch.show({x:d3.event.clientX-t.left-s/2,y:d3.event.clientY-t.top-r/2,cancel:function(){ge()},add:function(t){var n=X(t);if(n){var o=n.node,a=n.historyEvent;if(o.x=e[0],o.y=e[1],C===RED.state.QUICK_JOINING)if(W.length>0){var i,s,r=W[0],d=null;if(r.portType===B&&o.inputs>0?(d=r.node,s=r.port,i=o):r.portType===M&&o.outputs>0&&(d=o,i=r.node,s=0),null!==d){var l={source:d,sourcePort:s,target:i};RED.nodes.addLink(l),a.links=[l],K(),r.portType===B&&o.outputs>0?H([{node:o,port:0,portType:B}]):r.portType===M&&o.inputs>0?H([{node:o,port:0,portType:M}]):ge()}else K(),ge()}else o.outputs>0?H([{node:o,port:0,portType:B}]):o.inputs>0?H([{node:o,port:0,portType:M}]):ge();RED.history.push(a),RED.nodes.add(o),RED.editor.validateNode(o),RED.nodes.dirty(!0),ae(),o.selected=!0,j.push({n:o}),Y(),se(),_e()}}}),Y(),se(),_e()}0!==C||d3.event.metaKey||d3.event.ctrlKey||p||(e=d3.mouse(this),S=U.append("rect").attr("ox",e[0]).attr("oy",e[1]).attr("rx",1).attr("ry",1).attr("x",e[0]).attr("y",e[1]).attr("width",0).attr("height",0).attr("class","lasso"),d3.event.preventDefault())}).on("mouseup",Q).on("touchend",function(){clearTimeout(p),p=null,RED.touch.radialMenu.active()||(S&&G.attr("fill","#fff"),Q.call(this))}).on("touchcancel",Q).on("touchstart",function(){var e;if(d3.event.touches.length>1){clearTimeout(p),p=null,d3.event.preventDefault(),e=d3.event.touches.item(0);var t=d3.event.touches.item(1),n=e.pageY-t.pageY,o=e.pageX-t.pageX,a=$("#chart").offset(),s=[$("#chart").scrollLeft(),$("#chart").scrollTop()];c=[(t.pageX+o/2-a.left+s[0])/i,(t.pageY+n/2-a.top+s[1])/i],[t.pageX+o/2,t.pageY+n/2],l=Math.sqrt(n*n+o*o)}else{var r=d3.select(document.body),u=[(e=d3.event.touches.item(0)).pageX,e.pageY];c=[e.pageX,e.pageY],l=0;d3.touches(this)[0];p=setTimeout(function(){p=null,ke(r,u)},d)}}).on("touchmove",function(){var e;if(RED.touch.radialMenu.active())d3.event.preventDefault();else if(d3.event.touches.length<2){if(p){var t=(e=d3.event.touches.item(0)).pageX-c[0],n=e.pageY-c[1];Math.abs(t*t+n*n)>64&&(clearTimeout(p),p=null)}else S&&d3.event.preventDefault();Z.call(this)}else{e=d3.event.touches.item(0);var o=d3.event.touches.item(1),a=e.pageY-o.pageY,s=e.pageX-o.pageX,r=($("#chart").offset(),[$("#chart").scrollLeft(),$("#chart").scrollTop()]),d=Math.sqrt(a*a+s*s),u=[o.pageX+s/2,o.pageY+a/2];if(!isNaN(d)){oldScaleFactor=i,i=Math.min(2,Math.max(.3,i+Math.floor(100*d-100*l)/1e4));var f=[c[0]*(i-oldScaleFactor),c[1]*(i-oldScaleFactor)];l=d,u,$("#chart").scrollLeft(r[0]+f[0]),$("#chart").scrollTop(r[1]+f[1]),_e()}}}),G=U.append("svg:rect").attr("width",n).attr("height",o).attr("fill","#fff"),F=U.append("g");function V(){for(var e=[],t=0;t<n;t+=+f)e.push(t);F.selectAll("line.horizontal").remove(),F.selectAll("line.horizontal").data(e).enter().append("line").attr({class:"horizontal",x1:0,x2:n,y1:function(e){return e},y2:function(e){return e},fill:"none","shape-rendering":"crispEdges",stroke:"#eee","stroke-width":"1px"}),F.selectAll("line.vertical").remove(),F.selectAll("line.vertical").data(e).enter().append("line").attr({class:"vertical",y1:0,y2:n,x1:function(e){return e},x2:function(e){return e},fill:"none","shape-rendering":"crispEdges",stroke:"#eee","stroke-width":"1px"})}V();var q=U.append("g"),W=[];function H(e){for(var t=0;t<e.length;t++){var n=e[t];n.el=q.append("svg:path").attr("class","drag_line"),W.push(n)}}function K(){for(;W.length;){var e=W.pop();e.el&&e.el.remove()}}function Y(){var e=RED.workspaces.active();m=RED.nodes.filterNodes({z:e}),b=RED.nodes.filterLinks({source:{z:e},target:{z:e}})}function X(e,t,n){var o=/^subflow:(.+)$/.exec(e);if(v&&o){if(o[1]===v.id)return void RED.notify(RED._("notification.error",{message:RED._("notification.errors.cannotAddSubflowToItself")}),"error");if(RED.nodes.subflowContains(o[1],v.id))return void RED.notify(RED._("notification.error",{message:RED._("notification.errors.cannotAddCircularReference")}),"error")}var a={id:RED.nodes.id(),z:RED.workspaces.active()};if(a.type=e,a._def=RED.nodes.getType(a.type),o){var i=RED.nodes.subflow(o[1]);a.inputs=i.in.length,a.outputs=i.out.length}else{a.inputs=a._def.inputs||0,a.outputs=a._def.outputs;for(var d in a._def.defaults)a._def.defaults.hasOwnProperty(d)&&void 0!==a._def.defaults[d].value&&(a[d]=JSON.parse(JSON.stringify(a._def.defaults[d].value)));if(a._def.onadd)try{a._def.onadd.call(a)}catch(e){console.log("Definition error: "+a.type+".onadd:",e)}}a.changed=!0,a.moved=!0,a.w=s,a.h=Math.max(r,15*(a.outputs||0));var l={t:"add",nodes:[a.id],dirty:RED.nodes.dirty()};if(v){var c=RED.subflow.refresh(!0);c&&(l.subflow={id:v.id,changed:v.changed,instances:c.instances})}return{node:a,historyEvent:l}}function Z(){var i,d;if(_=d3.touches(this)[0]||d3.mouse(this),S){var l,c,p=parseInt(S.attr("ox")),u=parseInt(S.attr("oy")),v=parseInt(S.attr("x")),m=parseInt(S.attr("y"));return l=_[0]<p?p-(v=_[0]):_[0]-v,c=_[1]<u?u-(m=_[1]):_[1]-m,void S.attr("x",v).attr("y",m).attr("width",l).attr("height",c)}if(C==RED.state.QUICK_JOINING||C==RED.state.IMPORT_DRAGGING||E||null!=w){var b;if(C==RED.state.JOINING||C===RED.state.QUICK_JOINING){if(0===W.length&&null!==R){if(d3.event.shiftKey){var y,D=[],$=[];if(w&&(R===B&&w.source===E&&w.sourcePort===x||R===M&&w.target===E))$=[w];else y=R===B?{source:E,sourcePort:x}:{target:E},$=RED.nodes.filterLinks(y);for(i=0;i<$.length;i++){var T=$[i];RED.nodes.removeLink(T),D.push({link:T,node:R===B?T.target:T.source,port:R===B?0:T.sourcePort,portType:R===B?M:B})}0===D.length?(ge(),_e()):(H(D),C=0,Y(),_e(),C=RED.state.JOINING)}else E&&H([{node:E,port:x,portType:R}]);w=null}for(b=_,i=0;i<W.length;i++){var O=W[i],L=-((O.portType===B&&O.node.outputs||1)-1)/2*13+13*O.port,P=O.portType===B?1:-1,N=b[1]-(O.node.y+L),A=b[0]-(O.node.x+P*O.node.w/2),z=Math.sqrt(N*N+A*A),U=a,G=0;z<s&&(U=.75-(s-z)/s*.75),A*P<0&&(U+=Math.min(5*s,Math.abs(A))/(5*s)*2,Math.abs(N)<3*r&&(G=(N>0?.5:-.5)*((3*r-Math.abs(N))/(3*r))*(Math.min(s,Math.abs(A))/s))),O.el.attr("d","M "+(O.node.x+P*O.node.w/2)+" "+(O.node.y+L)+" C "+(O.node.x+P*(O.node.w/2+s*U))+" "+(O.node.y+L+G*r)+" "+(b[0]-P*U*s)+" "+(b[1]-G*r)+" "+b[0]+" "+b[1])}d3.event.preventDefault()}else if(C==RED.state.MOVING){b=d3.mouse(document.body),isNaN(b[0])&&(b=d3.touches(document.body)[0]),(k[0]-b[0])*(k[0]-b[0])+(k[1]-b[1])*(k[1]-b[1])>3&&(C=RED.state.MOVING_ACTIVE,I=0,g=!1,1===j.length&&(d=j[0],g=d.n.hasOwnProperty("_def")&&d.n._def.inputs>0&&d.n._def.outputs>0&&0===RED.nodes.filterLinks({source:d.n}).length&&0===RED.nodes.filterLinks({target:d.n}).length))}else if(C==RED.state.MOVING_ACTIVE||C==RED.state.IMPORT_DRAGGING){b=_;for(var F=0,V=0,q=n,K=o,X=0;X<j.length;X++)d=j[X],d3.event.shiftKey&&(d.n.ox=d.n.x,d.n.oy=d.n.y),d.n.x=b[0]+d.dx,d.n.y=b[1]+d.dy,d.n.dirty=!0,F=Math.min(d.n.x-d.n.w/2-5,F),V=Math.min(d.n.y-d.n.h/2-5,V),q=Math.max(d.n.x+d.n.w/2+5,q),K=Math.max(d.n.y+d.n.h/2+5,K);if(0!==F||0!==V)for(i=0;i<j.length;i++)(d=j[i]).n.x-=F,d.n.y-=V;if(q!==n||K!==o)for(i=0;i<j.length;i++)(d=j[i]).n.x-=q-n,d.n.y-=K-o;if(h!=d3.event.shiftKey&&j.length>0){var Z=[0,0];if(d=j[0],Z[0]=d.n.x-(f*Math.floor((d.n.x-d.n.w/2)/f)+d.n.w/2),Z[1]=d.n.y-f*Math.floor(d.n.y/f),0!==Z[0]||0!==Z[1])for(i=0;i<j.length;i++)(d=j[i]).n.x-=Z[0],d.n.y-=Z[1],d.n.x==d.n.ox&&d.n.y==d.n.oy&&(d.dirty=!1)}C!=RED.state.MOVING_ACTIVE&&C!=RED.state.IMPORT_DRAGGING||1!==j.length||(d=j[0],g&&(t||(t=setTimeout(function(){var n=[],o=1/0,a=null,i=d.n.x,s=d.n.y;if(J[0][0].getIntersectionList){var r=J[0][0].createSVGRect();r.x=i,r.y=s,r.width=1,r.height=1,n=J[0][0].getIntersectionList(r,J[0][0])}else n=RED.view.getLinksAtPoint(i,s);for(var l=0;l<n.length;l++)if(d3.select(n[l]).classed("link_background"))for(var c=n[l].getTotalLength(),p=0;p<c;p+=10){var u=n[l].getPointAtLength(p),f=(u.x-i)*(u.x-i)+(u.y-s)*(u.y-s);f<200&&f<o&&(o=f,a=n[l])}e&&e!==a&&d3.select(e.parentNode).classed("link_splice",!1),a?d3.select(a.parentNode).classed("link_splice",!0):d3.select(".link_splice").classed("link_splice",!1),e=a,t=null},100))))}0!==C&&_e()}}function Q(){var t,n;if(C!==RED.state.QUICK_JOINING){if(E&&C==RED.state.JOINING){var o=[];for(t=0;t<W.length;t++)W[t].link&&o.push(W[t].link);n={t:"delete",links:o,dirty:RED.nodes.dirty()},RED.history.push(n),K()}if(S){var a=parseInt(S.attr("x")),i=parseInt(S.attr("y")),s=a+parseInt(S.attr("width")),r=i+parseInt(S.attr("height"));d3.event.ctrlKey||ae(),RED.nodes.eachNode(function(e){e.z!=RED.workspaces.active()||e.selected||(e.selected=e.x>a&&e.x<s&&e.y>i&&e.y<r,e.selected&&(e.dirty=!0,j.push({n:e})))}),v&&(v.in.forEach(function(e){e.selected=e.x>a&&e.x<s&&e.y>i&&e.y<r,e.selected&&(e.dirty=!0,j.push({n:e}))}),v.out.forEach(function(e){e.selected=e.x>a&&e.x<s&&e.y>i&&e.y<r,e.selected&&(e.dirty=!0,j.push({n:e}))})),se(),S.remove(),S=null}else C!=RED.state.DEFAULT||null!=D||d3.event.ctrlKey||d3.event.metaKey||(ae(),se());if(C==RED.state.MOVING_ACTIVE&&j.length>0){for(var d=[],l=0;l<j.length;l++){var c=j[l];c.ox===c.n.x&&c.oy===c.n.y||(d.push({n:c.n,ox:c.ox,oy:c.oy,moved:c.n.moved}),c.n.dirty=!0,c.n.moved=!0)}if(d.length>0){if(n={t:"move",nodes:d,dirty:RED.nodes.dirty()},e){var p=d3.select(e).data()[0];RED.nodes.removeLink(p);var u={source:p.source,sourcePort:p.sourcePort,target:j[0].n},f={source:j[0].n,sourcePort:0,target:p.target};RED.nodes.addLink(u),RED.nodes.addLink(f),n.links=[u,f],n.removedLinks=[p],Y()}RED.nodes.dirty(!0),RED.history.push(n)}}if(C==RED.state.MOVING||C==RED.state.MOVING_ACTIVE)for(t=0;t<j.length;t++)delete j[t].ox,delete j[t].oy;C==RED.state.IMPORT_DRAGGING&&(RED.keyboard.remove("escape"),Y(),RED.nodes.dirty(!0)),ge(),_e()}}function ee(){i<2&&(i+=.1,_e())}function te(){i>.3&&(i-=.1,_e())}function ne(){i=1,_e()}function oe(){RED.nodes.eachNode(function(e){e.z==RED.workspaces.active()&&(e.selected||(e.selected=!0,e.dirty=!0,j.push({n:e})))}),v&&(v.in.forEach(function(e){e.selected||(e.selected=!0,e.dirty=!0,j.push({n:e}))}),v.out.forEach(function(e){e.selected||(e.selected=!0,e.dirty=!0,j.push({n:e}))})),w=null,se(),_e()}function ae(){for(var e=0;e<j.length;e++){var t=j[e];t.n.dirty=!0,t.n.selected=!1}j=[],w=null}var ie=null;function se(){var e={};j.length>0&&(e.nodes=j.map(function(e){return e.n})),null!=w&&(e.link=w);var t=RED.workspaces.active();b=RED.nodes.filterLinks({source:{z:t},target:{z:t}});RED.nodes.getWorkspaceOrder();var n={};y=[];for(var o=0;o<j.length;o++)if("link out"===j[o].n.type||"link in"===j[o].n.type){var a=j[o].n,i={};a.links.forEach(function(e){var t=RED.nodes.node(e);t&&("link out"===a.type?t.z===a.z?n[a.id+":"+t.id]||(b.push({source:a,sourcePort:0,target:t,link:!0}),n[a.id+":"+t.id]=!0):(i[t.z]=i[t.z]||[],i[t.z].push(t)):t.z===a.z?n[t.id+":"+a.id]||(b.push({source:t,sourcePort:0,target:a,link:!0}),n[t.id+":"+a.id]=!0):(i[t.z]=i[t.z]||[],i[t.z].push(t)))}),Object.keys(i).length>0&&y.push({refresh:Math.floor(1e4*Math.random()),node:a,links:i})}var s=t+":"+JSON.stringify(e,function(e,t){return"nodes"===e?t.map(function(e){return e.id}):"link"===e?t.source.id+":"+t.sourcePort+":"+t.target.id:t});s!==ie&&(ie=s,RED.events.emit("view:selection-changed",e))}function re(){if(de=!1,j.length>0){for(var e=[],t=0;t<j.length;t++)e.push({n:j[t].n,ox:j[t].ox,oy:j[t].oy,moved:j[t].n.moved}),j[t].n.moved=!0,j[t].n.dirty=!0,delete j[t].ox,delete j[t].oy;_e(),RED.history.push({t:"move",nodes:e,dirty:RED.nodes.dirty()}),RED.nodes.dirty(!0)}}var de=!1;function le(e,t){if(j.length>0){de||($(document).one("keyup",re),de=!0);for(var n,o=0,a=0,i=0;i<j.length;i++)(n=j[i]).n.moved=!0,n.n.dirty=!0,null==n.ox&&null==n.oy&&(n.ox=n.n.x,n.oy=n.n.y),n.n.x+=e,n.n.y+=t,n.n.dirty=!0,o=Math.min(n.n.x-n.n.w/2-5,o),a=Math.min(n.n.y-n.n.h/2-5,a);if(0!==o||0!==a)for(var s=0;s<j.length;s++)(n=j[s]).n.x-=o,n.n.y-=a;_e()}}function ce(){if(j.length>0){var e=j[0].n;"subflow"===e.type?RED.editor.editSubflow(v):RED.editor.edit(e)}}function pe(){if(j.length>0||null!=w){var e,t=[],n=[],o=[],a=[],i=[],s=RED.nodes.dirty();if(j.length>0){for(var r=0;r<j.length;r++){var d=j[r].n;if(d.selected=!1,"subflow"!=d.type){d.x<0&&(d.x=25);var l=RED.nodes.remove(d.id);t.push(d),t=t.concat(l.nodes),n=n.concat(l.links)}else"out"===d.direction?o.push(d):"in"===d.direction&&a.push(d),d.dirty=!0}o.length>0&&(e=RED.subflow.removeOutput(o))&&(n=n.concat(e.links)),1==a.length&&(e=RED.subflow.removeInput())&&(n=n.concat(e.links));var c=RED.subflow.refresh(!0);c&&(i=c.instances),j=[],(t.length>0||o.length>0||a.length>0)&&RED.nodes.dirty(!0)}w&&(RED.nodes.removeLink(w),n.push(w),RED.nodes.dirty(!0));var p={t:"delete",nodes:t,links:n,subflowOutputs:o,subflowInputs:a,subflow:{instances:i},dirty:s};RED.history.push(p),w=null,Y(),se(),_e()}}function ue(){if(j.length>0){for(var e=[],t=0;t<j.length;t++){var n=j[t].n;if("subflow"!=n.type){for(var o in n._def.defaults)if(n._def.defaults.hasOwnProperty(o)&&n._def.defaults[o].type){var a=RED.nodes.node(n[o]);a&&a._def.exclusive&&e.push(RED.nodes.convertNode(a))}e.push(RED.nodes.convertNode(n))}}A=JSON.stringify(e),RED.notify(RED._("clipboard.nodeCopied",{count:e.length}))}}function fe(e,t,n){return he(e,t,n,0)[0]}function he(e,t,n,o){var a=document.createElement("span");a.className=t,a.style.position="absolute",a.style.top="-1000px",a.textContent=e||"",document.body.appendChild(a);var i=a.offsetWidth,s=a.offsetHeight;return document.body.removeChild(a),[n+i,o+s]}function ge(){E=null,T=null,D=null,C=0,R=null,e=null,g=!1,d3.select(".link_splice").classed("link_splice",!1),t&&(clearTimeout(t),t=null)}function ve(e){17!==e.keyCode&&"Meta"!==e.key&&91!==e.keyCode||(ge(),K(),_e(),$(window).off("keyup",ve))}function me(e,t,n){E=e,R=t,x=n||0,C!==RED.state.QUICK_JOINING&&(C=RED.state.JOINING,document.body.style.cursor="crosshair",(d3.event.ctrlKey||d3.event.metaKey)&&(C=RED.state.QUICK_JOINING,H([{node:E,port:x,portType:R}]),$(window).on("keyup",ve))),d3.event.stopPropagation(),d3.event.preventDefault()}function be(e,t,n){var o;if(!(C===RED.state.QUICK_JOINING&&W.length>0&&W[0].node===e)&&(document.body.style.cursor="",C==RED.state.JOINING||C==RED.state.QUICK_JOINING)){"undefined"!=typeof TouchEvent&&d3.event instanceof TouchEvent?RED.nodes.eachNode(function(e){if(e.z==RED.workspaces.active()){var o=e.w/2,a=e.h/2;e.x-o<_[0]&&e.x+o>_[0]&&e.y-a<_[1]&&e.y+a>_[1]&&(t=(T=e).inputs>0?M:B,n=0)}}):T=e;var a=[],i=[];for(o=0;o<W.length;o++)W[o].link&&i.push(W[o].link);for(o=0;o<W.length;o++)if(t!=W[o].portType&&T!==W[o].node){var s,r,d,l=W[o];if(l.portType===B?(s=l.node,d=l.port,r=T):l.portType===M&&(s=T,r=l.node,d=n),!(0!==RED.nodes.filterLinks({source:s,target:r,sourcePort:d}).length)){var c={source:s,sourcePort:d,target:r};RED.nodes.addLink(c),a.push(c)}}if(a.length>0||i.length>0){var p={t:"add",links:a,removedLinks:i,dirty:RED.nodes.dirty()};if(v){var u=RED.subflow.refresh(!0);u&&(p.subflow={id:v.id,changed:v.changed,instances:u.instances})}RED.history.push(p),Y(),RED.nodes.dirty(!0)}if(C===RED.state.QUICK_JOINING)return a.length>0&&(K(),t===M&&e.outputs>0?H([{node:e,port:0,portType:B}]):t===B&&e.inputs>0?H([{node:e,port:0,portType:M}]):ge()),void _e();ge(),K(),w=null,_e()}}var ye=null,we=null;function De(e,t,n,o){clearTimeout(ye);var a=C!=RED.state.JOINING||W.length>0&&W[0].portType!==n;a&&(n===M&&(t._def&&t._def.inputLabels||t.inputLabels)||n===B&&(t._def&&t._def.outputLabels||t.outputLabels))&&(ye=setTimeout(function(){var a=function(e,t,n){var o,a=t===M?e.inputLabels:e.outputLabels;if(a&&a[n])return a[n];var i=t===M?e._def.inputLabels:e._def.outputLabels;if("string"==typeof i)o=i;else if("function"==typeof i)try{o=i.call(e,n)}catch(n){console.log("Definition error: "+e.type+"."+(t===M?"inputLabels":"outputLabels"),n),o=null}else $.isArray(i)&&(o=i[n]);return o}(t,n,o);if(a){var i=function e(t){var n=d3.select(t);if("innerCanvas"===n.attr("class"))return[0,0];var o=[0,0];if("g"===t.nodeName.toLowerCase()){var a=n.attr("transform");a&&(o=d3.transform(a).translate)}else o=[n.attr("x")||0,n.attr("y")||0];var i=e(t.parentNode);return[o[0]+i[0],o[1]+i[1]]}(e.node());ye=null,we=U.append("g").attr("transform","translate("+(i[0]+(n===M?-2:12))+","+(i[1]+5)+")").attr("class","port_tooltip");var s=a.split("\n"),r=0,d=4,l=[];s.forEach(function(e){var t=he(e,"port_tooltip_label",8,0);r=Math.max(r,t[0]),l.push(.8*t[1]),d+=.8*t[1]});var c=d/2-5-2,p=d-4;we.append("path").attr("d",n===M?"M0 0 l -5 -5 v -"+c+" q 0 -2 -2 -2 h -"+r+" q -2 0 -2 2 v "+p+" q 0 2 2 2 h "+r+" q 2 0 2 -2 v -"+c+" l 5 -5":"M0 0 l 5 -5 v -"+c+" q 0 -2 2 -2 h "+r+" q 2 0 2 2 v "+p+" q 0 2 -2 2 h -"+r+" q -2 0 -2 -2 v -"+c+" l -5 -5");var u=-d/2-2;s.forEach(function(e,t){u+=l[t],we.append("svg:text").attr("class","port_tooltip_label").attr("x",n===M?-10:10).attr("y",u).attr("text-anchor",n===M?"end":"start").text(e)})}},500)),e.classed("port_hovered",a)}function Ee(e,t,n,o){clearTimeout(ye),we&&(we.remove(),we=null),e.classed("port_hovered",!1)}function $e(e){if(P&&E==e&&I>0&&I<750)return C=RED.state.DEFAULT,"subflow"!=e.type?RED.editor.edit(e):RED.editor.editSubflow(v),I=0,void d3.event.stopPropagation();be(e,e._def?e.inputs>0?1:0:"in"==e.direction?0:1,0)}function Re(t){if(Ce(),C==RED.state.IMPORT_DRAGGING){if(RED.keyboard.remove("escape"),e){var n=d3.select(e).data()[0];RED.nodes.removeLink(n);var o={source:n.source,sourcePort:n.sourcePort,target:j[0].n},a={source:j[0].n,sourcePort:0,target:n.target};RED.nodes.addLink(o),RED.nodes.addLink(a);var i=RED.history.peek();i.links=[o,a],i.removedLinks=[n],Y()}return se(),RED.nodes.dirty(!0),_e(),ge(),void d3.event.stopPropagation()}if(C!=RED.state.QUICK_JOINING){E=t;var s,r=Date.now();if(I=r-N,N=r,P=L==E,L=E,t.selected&&(d3.event.ctrlKey||d3.event.metaKey)){for(E.selected=!1,s=0;s<j.length;s+=1)if(j[s].n===E){j.splice(s,1);break}}else{if(d3.event.shiftKey){ae();for(var d=RED.nodes.getAllFlowNodes(E),l=0;l<d.length;l++)d[l].selected=!0,d[l].dirty=!0,j.push({n:d[l]})}else t.selected||(d3.event.ctrlKey||d3.event.metaKey||ae(),E.selected=!0,j.push({n:E}));if(w=null,2!=d3.event.button){C=RED.state.MOVING;var c=d3.touches(this)[0]||d3.mouse(this);for(c[0]+=t.x-t.w/2,c[1]+=t.y-t.h/2,s=0;s<j.length;s++)j[s].ox=j[s].n.x,j[s].oy=j[s].n.y,j[s].dx=j[s].n.x-c[0],j[s].dy=j[s].n.y-c[1];k=d3.mouse(document.body),isNaN(k[0])&&(k=d3.touches(document.body)[0])}}t.dirty=!0,se(),_e(),d3.event.stopPropagation()}else d3.event.stopPropagation()}function xe(e){var t=!0;return e._def.button.hasOwnProperty("enabled")&&(t="function"==typeof e._def.button.enabled?e._def.button.enabled.call(e):e._def.button.enabled),t}function Te(e){if(v)RED.notify(RED._("notification.warning",{message:RED._("notification.warnings.nodeActionDisabled")}),"warning");else{if(e._def.button.toggle&&(e[e._def.button.toggle]=!e[e._def.button.toggle],e.dirty=!0),e._def.button.onclick)try{e._def.button.onclick.call(e)}catch(t){console.log("Definition error: "+e.type+".onclick",t)}e.dirty&&_e()}d3.event.preventDefault()}function ke(e,t){var n=E,o=[];o.push({name:"delete",disabled:0===j.length&&null===w,onselect:function(){pe()}}),o.push({name:"cut",disabled:0===j.length,onselect:function(){ue(),pe()}}),o.push({name:"copy",disabled:0===j.length,onselect:function(){ue()}}),o.push({name:"paste",disabled:0===A.length,onselect:function(){je(A,!1,!0)}}),o.push({name:"edit",disabled:1!=j.length,onselect:function(){RED.editor.edit(n)}}),o.push({name:"select",onselect:function(){oe()}}),o.push({name:"undo",disabled:0===RED.history.depth(),onselect:function(){RED.history.pop()}}),RED.touch.radialMenu.show(e,t,o),ge()}function _e(){if(U.attr("transform","scale("+i+")"),J.attr("width",n*i).attr("height",o*i),C!=RED.state.JOINING){var e={};if(v){var t=U.selectAll(".subflowoutput").data(v.out,function(e,t){return e.id});t.exit().remove();var u=t.enter().insert("svg:g").attr("class","node subflowoutput").attr("transform",function(e){return"translate("+(e.x-20)+","+(e.y-20)+")"});u.each(function(e,t){e.w=40,e.h=40}),u.append("rect").attr("class","subflowport").attr("rx",8).attr("ry",8).attr("width",40).attr("height",40).on("mouseup",$e).on("mousedown",Re).on("touchstart",function(e){var t=d3.select(this),n=d3.event.touches.item(0),o=[n.pageX,n.pageY];c=[n.pageX,n.pageY],l=0,p=setTimeout(function(){ke(t,o)},d),Re.call(this,e)}).on("touchend",function(e){clearTimeout(p),p=null,RED.touch.radialMenu.active()?d3.event.stopPropagation():$e.call(this,e)}),u.append("g").attr("transform","translate(-5,15)").append("rect").attr("class","port").attr("rx",3).attr("ry",3).attr("width",10).attr("height",10).on("mousedown",function(e,t){me(e,M,0)}).on("touchstart",function(e,t){me(e,M,0)}).on("mouseup",function(e,t){be(e,M,0)}).on("touchend",function(e,t){be(e,M,0)}).on("mouseover",function(e){De(d3.select(this),e,M,0)}).on("mouseout",function(e){Ee(d3.select(this))}),u.append("svg:text").attr("class","port_label").attr("x",20).attr("y",8).style("font-size","10px").text("output"),u.append("svg:text").attr("class","port_label port_index").attr("x",20).attr("y",24).text(function(e,t){return t+1});var f=U.selectAll(".subflowinput").data(v.in,function(e,t){return e.id});f.exit().remove();var h=f.enter().insert("svg:g").attr("class","node subflowinput").attr("transform",function(e){return"translate("+(e.x-20)+","+(e.y-20)+")"});h.each(function(e,t){e.w=40,e.h=40}),h.append("rect").attr("class","subflowport").attr("rx",8).attr("ry",8).attr("width",40).attr("height",40).on("mouseup",$e).on("mousedown",Re).on("touchstart",function(e){var t=d3.select(this),n=d3.event.touches.item(0),o=[n.pageX,n.pageY];c=[n.pageX,n.pageY],l=0,p=setTimeout(function(){ke(t,o)},d),Re.call(this,e)}).on("touchend",function(e){clearTimeout(p),p=null,RED.touch.radialMenu.active()?d3.event.stopPropagation():$e.call(this,e)}),h.append("g").attr("transform","translate(35,15)").append("rect").attr("class","port").attr("rx",3).attr("ry",3).attr("width",10).attr("height",10).on("mousedown",function(e,t){me(e,B,t)}).on("touchstart",function(e,t){me(e,B,t)}).on("mouseup",function(e,t){be(e,B,t)}).on("touchend",function(e,t){be(e,B,t)}).on("mouseover",function(e){De(d3.select(this),e,B,0)}).on("mouseout",function(e){Ee(d3.select(this))}),h.append("svg:text").attr("class","port_label").attr("x",18).attr("y",20).style("font-size","10px").text("input"),t.each(function(t,n){if(t.dirty){var o=d3.select(this);o.selectAll(".subflowport").classed("node_selected",function(e){return e.selected}),o.selectAll(".port_index").text(function(e){return e.i+1}),o.attr("transform",function(e){return"translate("+(e.x-e.w/2)+","+(e.y-e.h/2)+")"}),e[t.id]=t,t.dirty=!1}}),f.each(function(t,n){if(t.dirty){var o=d3.select(this);o.selectAll(".subflowport").classed("node_selected",function(e){return e.selected}),o.attr("transform",function(e){return"translate("+(e.x-e.w/2)+","+(e.y-e.h/2)+")"}),e[t.id]=t,t.dirty=!1}})}else U.selectAll(".subflowoutput").remove(),U.selectAll(".subflowinput").remove();var g=U.selectAll(".nodegroup").data(m,function(e){return e.id});g.exit().remove(),g.enter().insert("svg:g").attr("class","node nodegroup").classed("node_subflow",function(e){return null!=v}).classed("node_link",function(e){return"link in"===e.type||"link out"===e.type}).each(function(e,t){var n=d3.select(this),o="link in"===e.type||"link out"===e.type;n.attr("id",e.id);var a=RED.utils.getNodeLabel(e);if(e.w=o?r:Math.max(s,20*Math.ceil((fe(a,"node_label",50)+(e._def.inputs>0?7:0))/20)),e.h=Math.max(r,15*(e.outputs||0)),e._def.badge){var i=n.append("svg:g").attr("class","node_badge_group"),u=i.append("rect").attr("class","node_badge").attr("rx",5).attr("ry",5).attr("width",40).attr("height",15);i.append("svg:text").attr("class","node_badge_label").attr("x",35).attr("y",11).attr("text-anchor","end").text(e._def.badge()),e._def.onbadgeclick&&u.attr("cursor","pointer").on("click",function(e){e._def.onbadgeclick.call(e),d3.event.preventDefault()})}if(e._def.button){var f=n.append("svg:g").attr("transform",function(e){return"translate("+("right"==e._def.align?94:-25)+",2)"}).attr("class",function(e){return"node_button "+("right"==e._def.align?"node_right_button":"node_left_button")});f.append("rect").attr("rx",5).attr("ry",5).attr("width",32).attr("height",r-4).attr("fill","#eee"),f.append("rect").attr("class","node_button_button").attr("x",function(e){return"right"==e._def.align?11:5}).attr("y",4).attr("rx",4).attr("ry",4).attr("width",16).attr("height",r-12).attr("fill",function(e){return e._def.color}).attr("cursor","pointer").on("mousedown",function(e){!S&&xe(e)&&(Ce(),d3.select(this).attr("fill-opacity",.2),d3.event.preventDefault(),d3.event.stopPropagation())}).on("mouseup",function(e){!S&&xe(e)&&(d3.select(this).attr("fill-opacity",.4),d3.event.preventDefault(),d3.event.stopPropagation())}).on("mouseover",function(e){!S&&xe(e)&&d3.select(this).attr("fill-opacity",.4)}).on("mouseout",function(e){if(!S&&xe(e)){var t=1;e._def.button.toggle&&(t=e[e._def.button.toggle]?1:.2),d3.select(this).attr("fill-opacity",t)}}).on("click",Te).on("touchstart",Te)}n.append("rect").attr("class","node").classed("node_unknown",function(e){return"unknown"==e.type}).attr("rx",5).attr("ry",5).attr("fill",function(e){return e._def.color}).on("mouseup",$e).on("mousedown",Re).on("touchstart",function(e){var t=d3.select(this),n=d3.event.touches.item(0),o=[n.pageX,n.pageY];c=[n.pageX,n.pageY],l=0,p=setTimeout(function(){ke(t,o)},d),Re.call(this,e)}).on("touchend",function(e){clearTimeout(p),p=null,RED.touch.radialMenu.active()?d3.event.stopPropagation():$e.call(this,e)}).on("mouseover",function(e){0===C&&d3.select(this).classed("node_hovered",!0)}).on("mouseout",function(e){d3.select(this).classed("node_hovered",!1)});if(e._def.icon){var h=RED.utils.getNodeIcon(e._def,e),g=n.append("g").attr("class","node_icon_group").attr("x",0).attr("y",0),v=(g.append("rect").attr("x",0).attr("y",0).attr("class","node_icon_shade").attr("width","30").attr("stroke","none").attr("fill","#000").attr("fill-opacity","0.05").attr("height",function(e){return Math.min(50,e.h-4)}),g.append("image").attr("xlink:href",h).attr("class","node_icon").attr("x",0).attr("width","30").attr("height","30")),m=g.append("path").attr("d",function(e){return"M 30 1 l 0 "+(e.h-2)}).attr("class","node_icon_shade_border").attr("stroke-opacity","0.1").attr("stroke","#000").attr("stroke-width","1");"right"==e._def.align&&(g.attr("class","node_icon_group node_icon_group_"+e._def.align),m.attr("d",function(e){return"M 0 1 l 0 "+(e.h-2)}));var b=new Image;b.src=h,b.onload=function(){v.attr("width",Math.min(b.width,30)),v.attr("height",Math.min(b.height,30)),v.attr("x",15-Math.min(b.width,30)/2)},g.style("pointer-events","none")}if(!o){var y=n.append("svg:text").attr("class","node_label").attr("x",38).attr("dy",".35em").attr("text-anchor","start");e._def.align&&(y.attr("class","node_label node_label_"+e._def.align),"right"===e._def.align&&y.attr("text-anchor","end"));var w=n.append("svg:g").attr("class","node_status_group").style("display","none");w.append("rect").attr("class","node_status").attr("x",6).attr("y",1).attr("width",9).attr("height",9).attr("rx",2).attr("ry",2).attr("stroke-width","3"),w.append("svg:text").attr("class","node_status_label").attr("x",20).attr("y",9)}n.append("image").attr("class","node_error hidden").attr("xlink:href","icons/node-red/node-error.png").attr("x",0).attr("y",-6).attr("width",10).attr("height",9),n.append("image").attr("class","node_changed hidden").attr("xlink:href","icons/node-red/node-changed.png").attr("x",12).attr("y",-6).attr("width",10).attr("height",10)}),g.each(function(t,n){if(t.dirty){var o="link in"===t.type||"link out"===t.type;if(e[t.id]=t,!o&&t.resize){var a=RED.utils.getNodeLabel(t),i=t.w;t.w=Math.max(s,20*Math.ceil((fe(a,"node_label",50)+(t._def.inputs>0?7:0))/20)),t.h=Math.max(r,15*(t.outputs||0)),t.x+=(t.w-i)/2,t.resize=!1}var d=d3.select(this);if(d.attr("transform",function(e){return"translate("+(e.x-e.w/2)+","+(e.y-e.h/2)+")"}),C!=RED.state.MOVING_ACTIVE){d.selectAll(".node").attr("width",function(e){return e.w}).attr("height",function(e){return e.h}).classed("node_selected",function(e){return e.selected}).classed("node_highlighted",function(e){return e.highlighted}),d.selectAll(".node_icon_group_right").attr("transform",function(e){return"translate("+(e.w-30)+",0)"}),d.selectAll(".node_label_right").attr("x",function(e){return e.w-38});var l=d.selectAll(".port_input");if(0!==t.inputs||l.empty()){if(1===t.inputs&&l.empty()){d.append("g").attr("class","port_input").append("rect").attr("class","port").attr("rx",3).attr("ry",3).attr("width",10).attr("height",10).on("mousedown",function(e){me(e,M,0)}).on("touchstart",function(e){me(e,M,0)}).on("mouseup",function(e){be(e,M,0)}).on("touchend",function(e){be(e,M,0)}).on("mouseover",function(e){De(d3.select(this),e,M,0)}).on("mouseout",function(e){Ee(d3.select(this))})}}else l.remove();var c=t.outputs,p=t.h/2-(c-1)/2*13;if(t.ports=t.ports||d3.range(c),t._ports=d.selectAll(".port_output").data(t.ports),t._ports.enter().append("g").attr("class","port_output").append("rect").attr("class","port").attr("rx",3).attr("ry",3).attr("width",10).attr("height",10).on("mousedown",($=t,function(e,t){me($,B,t)})).on("touchstart",(E=t,function(e,t){me(E,B,t)})).on("mouseup",(D=t,function(e,t){be(D,B,t)})).on("touchend",(w=t,function(e,t){be(w,B,t)})).on("mouseover",(y=t,function(e,t){De(d3.select(this),y,B,t)})).on("mouseout",function(e,t){Ee(d3.select(this))}),t._ports.exit().remove(),t._ports){c=t.outputs||1,p=t.h/2-(c-1)/2*13;var u=t.w-5;t._ports.each(function(e,t){d3.select(this).attr("transform",function(e){return"translate("+u+","+(p+13*t-5)+")"})})}if(d.selectAll("text.node_label").text(function(e,t){var n="";if(e._def.label){n=e._def.label;try{n=("function"==typeof n?n.call(e):n)||"",n=RED.text.bidi.enforceTextDirectionWithUCC(n)}catch(t){console.log("Definition error: "+e.type+".label",t),n=e.type}}return n}).attr("y",function(e){return e.h/2-1}).attr("class",function(e){var t="";if(e._def.labelStyle){t=e._def.labelStyle;try{t=("function"==typeof t?t.call(e):t)||""}catch(n){console.log("Definition error: "+e.type+".labelStyle",n),t=""}t=" "+t}return"node_label"+(e._def.align?" node_label_"+e._def.align:"")+t}),t._def.icon){icon=d.select(".node_icon");var f=icon.attr("xlink:href"),h=RED.utils.getNodeIcon(t._def,t);if(h!==f){icon.attr("xlink:href",h);var g=new Image;g.src=h,g.onload=function(){icon.attr("width",Math.min(g.width,30)),icon.attr("height",Math.min(g.height,30)),icon.attr("x",15-Math.min(g.width,30)/2)}}}d.selectAll(".node_tools").attr("x",function(e){return e.w-35}).attr("y",function(e){return e.h-20}),d.selectAll(".node_changed").attr("x",function(e){return e.w-10}).classed("hidden",function(e){return!(e.changed||e.moved)}),d.selectAll(".node_error").attr("x",function(e){return e.w-10-(e.changed||e.moved?13:0)}).classed("hidden",function(e){return e.valid}),d.selectAll(".port_input").each(function(e,t){d3.select(this).attr("transform",function(e){return"translate(-5,"+(e.h/2-5)+")"})}),d.selectAll(".node_icon").attr("y",function(e){return(e.h-d3.select(this).attr("height"))/2}),d.selectAll(".node_icon_shade").attr("height",function(e){return e.h}),d.selectAll(".node_icon_shade_border").attr("d",function(e){return"M "+("right"==e._def.align?0:30)+" 1 l 0 "+(e.h-2)}),d.selectAll(".node_button").attr("opacity",function(e){return v||!xe(e)?.4:1}),d.selectAll(".node_button_button").attr("cursor",function(e){return v||!xe(e)?"":"pointer"}),d.selectAll(".node_right_button").attr("transform",function(e){var t=e.w-6;return e._def.button.toggle&&!e[e._def.button.toggle]&&(t-=8),"translate("+t+",2)"}),d.selectAll(".node_right_button rect").attr("fill-opacity",function(e){return e._def.button.toggle?e[e._def.button.toggle]?1:.2:1}),d.selectAll(".node_badge_group").attr("transform",function(e){return"translate("+(e.w-40)+","+(e.h+3)+")"}),d.selectAll("text.node_badge_label").text(function(e,t){if(e._def.badge){if("function"!=typeof e._def.badge)return e._def.badge;try{return e._def.badge.call(e)}catch(t){return console.log("Definition error: "+e.type+".badge",t),""}}return""})}if(O&&t.status){d.selectAll(".node_status_group").style("display","inline").attr("transform","translate(3,"+(t.h+3)+")");var m,b=z[t.status.fill];if(null==t.status.shape&&null==b)d.selectAll(".node_status").style("display","none");else null==t.status.shape||"dot"==t.status.shape?m={display:"inline",fill:b,stroke:b}:"ring"==t.status.shape&&(m={display:"inline",fill:"#fff",stroke:b}),d.selectAll(".node_status").style(m);t.status.text?d.selectAll(".node_status_label").text(t.status.text):d.selectAll(".node_status_label").text("")}else d.selectAll(".node_status_group").style("display","none");t.dirty=!1}var y,w,D,E,$});var E=U.selectAll(".link").data(b,function(e){return e.source.id+":"+e.sourcePort+":"+e.target.id+":"+e.target.i});E.enter().insert("g",".node").attr("class","link").each(function(e,t){var n=d3.select(this);e.added=!0,n.append("svg:path").attr("class","link_background link_path").on("mousedown",function(e){D=e,ae(),w=D,se(),_e(),Ce(),d3.event.stopPropagation()}).on("touchstart",function(e){D=e,ae(),w=D,se(),_e(),Ce(),d3.event.stopPropagation();var t=d3.select(document.body),n=d3.event.touches.item(0),o=[n.pageX,n.pageY];p=setTimeout(function(){p=null,ke(t,o)},d)}),n.append("svg:path").attr("class","link_outline link_path"),n.append("svg:path").attr("class","link_line link_path").classed("link_link",function(e){return e.link}).classed("link_subflow",function(e){return!e.link&&v})}),E.exit().remove(),U.selectAll(".link_path").each(function(t){var n=d3.select(this);(t.added||t===w||t.selected||e[t.source.id]||e[t.target.id])&&n.attr("d",function(e){var t=-((e.source.outputs||1)-1)/2*13+13*(e.sourcePort||0),n=e.target.y-(e.source.y+t),o=e.target.x-e.target.w/2-(e.source.x+e.source.w/2),i=Math.sqrt(n*n+o*o),d=a,l=0;return i<s&&(d=.75-(s-i)/s*.75),o<0&&(d+=Math.min(5*s,Math.abs(o))/(5*s)*2,Math.abs(n)<3*r&&(l=(n>0?.5:-.5)*((3*r-Math.abs(n))/(3*r))*(Math.min(s,Math.abs(o))/s))),e.x1=e.source.x+e.source.w/2,e.y1=e.source.y+t,e.x2=e.target.x-e.target.w/2,e.y2=e.target.y,"M "+e.x1+" "+e.y1+" C "+(e.x1+d*s)+" "+(e.y1+l*r)+" "+(e.x2-d*s)+" "+(e.y2-l*r)+" "+e.x2+" "+e.y2})}),E.classed("link_selected",function(e){return e===w||e.selected}),E.classed("link_unknown",function(e){return delete e.added,"unknown"==e.target.type||"unknown"==e.source.type});var $=U.selectAll(".link_flow_link_g").data(y,function(e){return e.node.id+":"+e.refresh});$.enter().insert("g",".node").attr("class","link_flow_link_g").each(function(e,t){var n=d3.select(this),o=1,a="start";"link in"===e.node.type&&(o=-1,a="end");var i=30*o,d=20*o,l=(n.append("svg:path").attr("class","link_flow_link").attr("class","link_link").attr("d","M 0 0 h "+i),e.links),c=Object.keys(l),p=RED.nodes.getWorkspaceOrder();c.sort(function(e,t){return p.indexOf(e)-p.indexOf(t)});var u=r,f=-(c.length-1)*u/2,h=n.selectAll(".link_group").data(c);h.enter().append("g").attr("class","link_group").on("mouseover",function(){d3.select(this).classed("link_group_active",!0)}).on("mouseout",function(){d3.select(this).classed("link_group_active",!1)}).on("mousedown",function(){d3.event.preventDefault(),d3.event.stopPropagation()}).on("mouseup",function(t){d3.event.stopPropagation();var n=e.links[t];RED.workspaces.show(t),n.forEach(function(e){e.selected=!0,e.dirty=!0,j.push({n:e})}),se(),_e()}).each(function(e){var t=d3.select(this);t.append("svg:path").attr("class","link_flow_link").attr("class","link_link").attr("d","M "+i+" 0 C "+(i+1.7*d)+" 0 "+(i+.1*d)+" "+f+" "+(i+1.5*d)+" "+f+" "),t.append("svg:path").attr("class","link_port").attr("d","M "+(i+1.5*d+17*o)+" "+(f-12)+" h "+10*-o+" a 3 3 45 0 "+(1===o?"0":"1")+" "+-3*o+" 3 v 18 a 3 3 45 0 "+(1===o?"0":"1")+" "+3*o+" 3 h "+10*o),t.append("svg:path").attr("class","link_port").attr("d","M "+(i+1.5*d+20*o)+" "+(f-12)+" h "+30*o+" M "+(i+1.5*d+20*o)+" "+(f+12)+" h "+30*o).style("stroke-dasharray","12 3 8 4 3"),t.append("rect").attr("class","port link_port").attr("x",i+1.5*d-4+4*o).attr("y",f-4).attr("rx",2).attr("ry",2).attr("width",8).attr("height",8),t.append("rect").attr("x",i+1.5*d-(-1===o?s:0)).attr("y",f-12).attr("width",s).attr("height",24).style("stroke","none").style("fill","transparent");var n,r=RED.nodes.workspace(e);r&&(n=r.label||r.id),t.append("svg:text").attr("class","port_label").attr("x",i+1.5*d+15*o).attr("y",f+1).style("font-size","10px").style("text-anchor",a).text(n),f+=u}),h.exit().remove()}),$.exit().remove(),($=U.selectAll(".link_flow_link_g")).each(function(e){var t=1;"link in"===e.node.type&&(t=-1),d3.select(this).attr("transform",function(e){return"translate("+(e.node.x+t*e.node.w/2)+","+e.node.y+")"})})}else U.selectAll(".link_selected").data(b,function(e){return e.source.id+":"+e.sourcePort+":"+e.target.id+":"+e.target.i}).classed("link_selected",!1);d3.event&&d3.event.preventDefault()}function Ce(){try{var e=window.parent.window.scrollX,t=window.parent.window.scrollY;$("#chart").focus(),window.parent.window.scrollTo(e,t)}catch(e){$("#chart").focus()}}function je(e,t,n){try{var o;v&&(o=v.changed);var a=RED.nodes.import(e,!0,t);if(a){var i=a[0],d=a[1],l=a[2],c=a[3],p=a[4];t&&p&&RED.workspaces.show(p.id);var u=i.filter(function(e){return e.hasOwnProperty("x")&&e.hasOwnProperty("y")&&e.z==RED.workspaces.active()}).map(function(e){return{n:e}}),f=i.map(function(e){return e.id});if(u.length>0){var h=u[0].n,m=h.x,b=h.y;null==_&&(_=[0,0]);var y,w,D=0,E=0;for(y=0;y<u.length;y++)(w=u[y]).n.selected=!0,w.n.changed=!0,w.n.moved=!0,w.n.x-=m-_[0],w.n.y-=b-_[1],w.dx=w.n.x-_[0],w.dy=w.n.y-_[1],D=Math.min(w.n.x-s/2-5,D),E=Math.min(w.n.y-r/2-5,E);for(y=0;y<u.length;y++)if((w=u[y]).n.x-=D,w.n.y-=E,w.dx-=D,w.dy-=E,w.n._def.onadd)try{w.n._def.onadd.call(w.n)}catch(e){console.log("Definition error: "+w.n.type+".onadd:",e)}n||(C=RED.state.IMPORT_DRAGGING,g=!1,1===u.length&&(w=u[0],g=w.n.hasOwnProperty("_def")&&w.n._def.inputs>0&&w.n._def.outputs>0)),RED.keyboard.add("*","escape",function(){RED.keyboard.remove("escape"),ae(),RED.history.pop(),C=0}),ae(),j=u}var $={t:"add",nodes:f,links:d,workspaces:l,subflows:c,dirty:RED.nodes.dirty()};if(0===u.length&&RED.nodes.dirty(!0),v){var R=RED.subflow.refresh(!0);R&&($.subflow={id:v.id,changed:o,instances:R.instances})}RED.history.push($),Y(),_e()}}catch(e){"NODE_RED"!=e.code?(console.log(e.stack),RED.notify(RED._("notification.error",{message:e.toString()}),"error")):RED.notify(RED._("notification.error",{message:e.message}),"error")}}return{init:function(){RED.events.on("workspace:change",function(e){var t=$("#chart");0!==e.old&&(u[e.old]={left:t.scrollLeft(),top:t.scrollTop()});var n=t.scrollLeft(),o=t.scrollTop();v=RED.nodes.subflow(e.workspace),RED.menu.setDisabled("menu-item-workspace-edit",v),RED.menu.setDisabled("menu-item-workspace-delete",1==RED.workspaces.count()||v),u[e.workspace]?(t.scrollLeft(u[e.workspace].left),t.scrollTop(u[e.workspace].top)):(t.scrollLeft(0),t.scrollTop(0));var a=t.scrollLeft()-n,i=t.scrollTop()-o;null!=_&&(_[0]+=a,_[1]+=i),ae(),RED.nodes.eachNode(function(e){e.dirty=!0}),se(),Y(),_e()}),$("#btn-zoom-out").click(function(){te()}),$("#btn-zoom-zero").click(function(){ne()}),$("#btn-zoom-in").click(function(){ee()}),$("#chart").on("DOMMouseScroll mousewheel",function(e){e.altKey&&(e.preventDefault(),e.stopPropagation(),(-e.originalEvent.detail||e.originalEvent.wheelDelta)<=0?te():ee())}),$("#chart").droppable({accept:".palette_node",drop:function(e,t){d3.event=e;var n=X(t.draggable[0].type);if(n){var o=n.historyEvent,a=n.node,s=d3.touches(t.helper.get(0))[0]||d3.mouse(t.helper.get(0)),r=d3.touches(this)[0]||d3.mouse(this);r[1]+=this.scrollTop+(a.h/2-s[1]),r[0]+=this.scrollLeft+(a.w/2-s[0]),r[1]/=i,r[0]/=i,h&&(r[0]=f*Math.ceil(r[0]/f),r[1]=f*Math.ceil(r[1]/f)),a.x=r[0],a.y=r[1];var d=$(t.helper).data("splice");if(d){RED.nodes.removeLink(d);var l={source:d.source,sourcePort:d.sourcePort,target:a},c={source:a,sourcePort:0,target:d.target};RED.nodes.addLink(l),RED.nodes.addLink(c),o.links=[l,c],o.removedLinks=[d]}RED.history.push(o),RED.nodes.add(a),RED.editor.validateNode(a),RED.nodes.dirty(!0),ae(),a.selected=!0,j.push({n:a}),Y(),se(),_e(),a._def.autoedit&&RED.editor.edit(a)}}}),$("#chart").focus(function(){$("#workspace-tabs").addClass("workspace-focussed")}),$("#chart").blur(function(){$("#workspace-tabs").removeClass("workspace-focussed")}),RED.actions.add("core:copy-selection-to-internal-clipboard",ue),RED.actions.add("core:cut-selection-to-internal-clipboard",function(){ue(),pe()}),RED.actions.add("core:paste-from-internal-clipboard",function(){je(A)}),RED.actions.add("core:delete-selection",pe),RED.actions.add("core:edit-selected-node",ce),RED.actions.add("core:undo",RED.history.pop),RED.actions.add("core:select-all-nodes",oe),RED.actions.add("core:zoom-in",ee),RED.actions.add("core:zoom-out",te),RED.actions.add("core:zoom-reset",ne),RED.actions.add("core:toggle-show-grid",function(e){void 0===e?RED.userSettings.toggle("view-show-grid"):e?F.style("visibility","visible"):F.style("visibility","hidden")}),RED.actions.add("core:toggle-snap-grid",function(e){void 0===e?RED.userSettings.toggle("view-snap-grid"):(h=e,_e())}),RED.actions.add("core:toggle-status",function(e){void 0===e?RED.userSettings.toggle("view-node-status"):(O=e,RED.nodes.eachNode(function(e){e.dirty=!0}),_e())}),RED.actions.add("core:move-selection-up",function(){le(0,-1)}),RED.actions.add("core:step-selection-up",function(){le(0,-20)}),RED.actions.add("core:move-selection-right",function(){le(1,0)}),RED.actions.add("core:step-selection-right",function(){le(20,0)}),RED.actions.add("core:move-selection-down",function(){le(0,1)}),RED.actions.add("core:step-selection-down",function(){le(0,20)}),RED.actions.add("core:move-selection-left",function(){le(-1,0)}),RED.actions.add("core:step-selection-left",function(){le(-20,0)})},state:function(e){if(null==e)return C;C=e},redraw:function(e){e&&(Y(),se()),_e()},focus:Ce,importNodes:je,calculateTextWidth:fe,select:function(e){if(void 0!==e&&(ae(),"string"==typeof e)){var t=RED.nodes.node(e);t&&(t.selected=!0,t.dirty=!0,j=[{n:t}])}se(),_e()},selection:function(){var e={};return j.length>0&&(e.nodes=j.map(function(e){return e.n})),null!=w&&(e.link=w),e},scale:function(){return i},getLinksAtPoint:function(e,t){for(var n=[],o=J.selectAll(".link_background")[0],a=0;a<o.length;a++){var i=o[a].getBBox();e>=i.x&&t>=i.y&&e<=i.x+i.width&&t<=i.y+i.height&&n.push(o[a])}return n},reveal:function(e){if(RED.nodes.workspace(e)||RED.nodes.subflow(e))RED.workspaces.show(e);else{var t=RED.nodes.node(e);if("config"!==t._def.category&&t.z){t.highlighted=!0,t.dirty=!0,RED.workspaces.show(t.z);var n=[$("#chart").width(),$("#chart").height()],o=[$("#chart").scrollLeft(),$("#chart").scrollTop()];if(t.x<o[0]||t.y<o[1]||t.x>n[0]+o[0]||t.y>n[1]+o[1]){var a="-="+(o[0]-t.x+n[0]/2),i="-="+(o[1]-t.y+n[1]/2);$("#chart").animate({scrollLeft:a,scrollTop:i},200)}if(!t._flashing){t._flashing=!0;var s=22,r=function(){s--,t.dirty=!0,s>=0?(t.highlighted=!t.highlighted,setTimeout(r,100)):(t.highlighted=!1,delete t._flashing),RED.view.redraw()};r()}}else"config"===t._def.category&&RED.sidebar.config.show(e)}},gridSize:function(e){if(void 0===e)return f;f=Math.max(5,e),V()}}}(),RED.sidebar=function(){var e=RED.tabs.create({id:"sidebar-tabs",onchange:function(e){$("#sidebar-content").children().hide(),$("#sidebar-footer").children().hide(),e.onchange&&e.onchange.call(e),$(e.wrapper).show(),e.toolbar&&$(e.toolbar).show()},onremove:function(e){$(e.wrapper).hide(),e.onremove&&e.onremove.call(e)},minimumActiveTabWidth:70}),t={};var n={};function o(t){t?($("#main-container").removeClass("sidebar-closed"),e.resize()):$("#main-container").addClass("sidebar-closed"),RED.events.emit("sidebar:resize")}function a(n){n&&(i(n)||e.addTab(t[n]),e.activateTab(n),RED.menu.isSelected("menu-item-sidebar")||RED.menu.setSelected("menu-item-sidebar",!0))}function i(t){return e.contains(t)}return $("#sidebar-separator").draggable({axis:"x",start:function(e,t){n.closing=!1,n.opening=!1;var o=$(window).width();if(n.start=t.position.left,n.chartWidth=$("#workspace").width(),n.chartRight=o-$("#workspace").width()-$("#workspace").offset().left-2,!RED.menu.isSelected("menu-item-sidebar")){n.opening=!0;$("#sidebar").addClass("closing"),$("#workspace").css("right",7),$("#editor-stack").css("right",8),$("#sidebar").width(0),RED.menu.setSelected("menu-item-sidebar",!0),RED.events.emit("sidebar:resize")}n.width=$("#sidebar").width()},drag:function(t,o){var a=o.position.left-n.start,i=n.width-a;n.opening&&(i-=3),i>150&&n.chartWidth+a<200&&(o.position.left=200+n.start-n.chartWidth,a=o.position.left-n.start,i=n.width-a),i<150?(n.closing||($("#sidebar").addClass("closing"),n.closing=!0),n.opening||(i=150,o.position.left=n.width-(150-n.start),a=o.position.left-n.start)):i>150&&(n.closing||n.opening)&&(n.closing=!1,$("#sidebar").removeClass("closing"));var s=n.chartRight-a;$("#workspace").css("right",s),$("#editor-stack").css("right",s+1),$("#sidebar").width(i),e.resize(),RED.events.emit("sidebar:resize")},stop:function(e,t){n.closing&&($("#sidebar").removeClass("closing"),RED.menu.setSelected("menu-item-sidebar",!1),$("#sidebar").width()<180&&($("#sidebar").width(180),$("#workspace").css("right",187),$("#editor-stack").css("right",188))),$("#sidebar-separator").css("left","auto"),$("#sidebar-separator").css("right",$("#sidebar").width()+2+"px"),RED.events.emit("sidebar:resize")}}),{init:function(){RED.actions.add("core:toggle-sidebar",function(e){void 0===e?RED.menu.toggleSelected("menu-item-sidebar"):o(e)}),a(),RED.sidebar.info.init(),RED.sidebar.config.init(),$(window).width()<600&&RED.menu.setSelected("menu-item-sidebar",!1)},addTab:function(n,o,i,s){var r;"string"==typeof n?r={id:o.id,label:n,name:n,content:o,closeable:i,visible:s}:"object"==typeof n&&(r=n),r.wrapper=$("<div>",{style:"height:100%"}).appendTo("#sidebar-content"),r.wrapper.append(r.content),r.wrapper.hide(),r.enableOnEdit||(r.shade=$("<div>",{class:"sidebar-shade hide"}).appendTo(r.wrapper)),r.toolbar&&($("#sidebar-footer").append(r.toolbar),$(r.toolbar).hide()),r.id,RED.menu.addItem("menu-item-view-menu",{id:"menu-item-view-menu-"+r.id,label:r.name,onselect:function(){a(r.id)},group:"sidebar-tabs"}),t[r.id]=r,!1!==r.visible&&e.addTab(t[r.id])},removeTab:function(n){e.removeTab(n),$(t[n].wrapper).remove(),t[n].footer&&t[n].footer.remove(),delete t[n],RED.menu.removeItem("menu-item-view-menu-"+n)},show:a,containsTab:i,toggleSidebar:o}}(),RED.palette=function(){var e=["config","unknown","deprecated"],t=["subflows","input","output","function","social","mobile","storage","analysis","advanced"],n={};function o(e,t){t=(t||e).replace(/_/g," ");var o=$('<div id="palette-container-'+e+'" class="palette-category palette-close hide"><div id="palette-header-'+e+'" class="palette-header"><i class="expanded fa fa-angle-down"></i><span>'+t+'</span></div><div class="palette-content" id="palette-base-category-'+e+'"><div id="palette-'+e+'-input"></div><div id="palette-'+e+'-output"></div><div id="palette-'+e+'-function"></div></div></div>').appendTo("#palette-container");n[e]={container:o,close:function(){o.removeClass("palette-open"),o.addClass("palette-closed"),$("#palette-base-category-"+e).slideUp(),$("#palette-header-"+e+" i").removeClass("expanded")},open:function(){o.addClass("palette-open"),o.removeClass("palette-closed"),$("#palette-base-category-"+e).slideDown(),$("#palette-header-"+e+" i").addClass("expanded")},toggle:function(){o.hasClass("palette-open")?n[e].close():n[e].open()}},$("#palette-header-"+e).on("click",function(t){n[e].toggle()})}function a(e,t,n,o){for(var a=n.split(/[ -]/),i=[],s=a[0],r=(RED.view.calculateTextWidth(s,"palette_label",0),1);r<a.length;r++){var d=RED.view.calculateTextWidth(s+" "+a[r],"palette_label",0);d<82?(s+=" "+a[r],d):(i.push(s),s=a[r],RED.view.calculateTextWidth(s,"palette_label",0))}i.push(s);var l,c=i.join("<br/>"),p=8+20*i.length;t.css({height:p+"px"}),t.find(".palette_label").html(c).attr("dir",RED.text.bidi.resolveBaseTextDir(c)),t.find(".palette_port").css({top:p/2-5+"px"});try{var u="<p><b>"+RED.text.bidi.enforceTextDirectionWithUCC(n)+"</b></p>";n!=e&&(u="<p><b>"+RED.text.bidi.enforceTextDirectionWithUCC(n)+"</b><br/><i>"+e+"</i></p>"),l=$(u+(o||($("script[data-help-name='"+e+"']").html()||"<p>"+RED._("palette.noInfo")+"</p>")).trim()).filter(function(e){return 1==this.nodeType&&"P"==this.nodeName||3==this.nodeType&&this.textContent.trim().length>0}).slice(0,2)}catch(t){console.log("Error generating pop-over label for ",e),console.log(t.toString()),l="<p><b>"+n+"</b></p><p>"+RED._("palette.noInfo")+"</p>"}t.data("popover").setContent(l)}function i(e){return e.replace(" ","_").replace(".","_").replace(":","_")}function s(s,r){var d=i(s);if(!$("#palette_node_"+d).length&&-1===e.indexOf(r.category)){var l=r.category.replace(/ /g,"_"),c=l.split("-")[0],p=document.createElement("div");p.id="palette_node_"+d,p.type=s;var u=/^(.*?)([ -]in|[ -]out)?$/.exec(s)[1];if(void 0!==r.paletteLabel)try{u=("function"==typeof r.paletteLabel?r.paletteLabel.call(r):r.paletteLabel)||""}catch(e){console.log("Definition error: "+s+".paletteLabel",e)}if($("<div/>",{class:"palette_label"+("right"==r.align?" palette_label_right":"")}).appendTo(p),p.className="palette_node",r.icon){var f=RED.utils.getNodeIcon(r),h=$("<div/>",{class:"palette_icon_container"+("right"==r.align?" palette_icon_container_right":"")}).appendTo(p);$("<div/>",{class:"palette_icon",style:"background-image: url("+f+")"}).appendTo(h)}if(p.style.backgroundColor=r.color,r.outputs>0){var g=document.createElement("div");g.className="palette_port palette_port_output",p.appendChild(g)}if(r.inputs>0){var v=document.createElement("div");v.className="palette_port palette_port_input",p.appendChild(v)}if(0===$("#palette-base-category-"+c).length)if(-1!==t.indexOf(c))o(c,RED._("node-red:palette.label."+c,{defaultValue:c}));else{var m=r.set.id;o(c,RED._(m+":palette.label."+c,{defaultValue:c}))}$("#palette-container-"+c).show(),0===$("#palette-"+l).length&&$("#palette-base-category-"+c).append('<div id="palette-'+l+'"></div>'),$("#palette-"+l).append(p),p.onmousedown=function(e){e.preventDefault()};var b=RED.popover.create({target:$(p),trigger:"hover",width:"300px",content:"hi",delay:{show:750,hide:50}});$(p).data("popover",b),$(p).click(function(){var e;RED.view.focus(),e=0===s.indexOf("subflow:")?marked(RED.nodes.subflow(s.substring(8)).info||"")||'<span class="node-info-none">'+RED._("sidebar.info.none")+"</span>":$("script[data-help-name='"+p.type+"']").html()||'<span class="node-info-none">'+RED._("sidebar.info.none")+"</span>",RED.sidebar.info.set(e,RED._("sidebar.info.nodeHelp"))});var y,w,D,E,R,x,T=$("#chart"),k=T.offset(),_=$("#chart>svg").get(0);$(p).draggable({helper:"clone",appendTo:"body",revert:!0,revertDuration:50,containment:"#main-container",start:function(){R=$("#palette").width(),x=$("#palette").parent().position().top+$("#palette-container").position().top,RED.view.focus()},stop:function(){d3.select(".link_splice").classed("link_splice",!1),E&&(clearTimeout(E),E=null)},drag:function(e,t){t.position.left+=17.5,r.inputs>0&&r.outputs>0&&(w=t.position.left-R+t.helper.width()/2-k.left+T.scrollLeft(),D=t.position.top-x+t.helper.height()/2-k.top+T.scrollTop(),E||(E=setTimeout(function(){var e=[],n=1/0,o=null;if(_.getIntersectionList){var a=_.createSVGRect();a.x=w,a.y=D,a.width=1,a.height=1,e=_.getIntersectionList(a,_),w/=RED.view.scale(),D/=RED.view.scale()}else w/=RED.view.scale(),D/=RED.view.scale(),e=RED.view.getLinksAtPoint(w,D);for(var i=0;i<e.length;i++)if(d3.select(e[i]).classed("link_background"))for(var s=e[i].getTotalLength(),r=0;r<s;r+=10){var d=e[i].getPointAtLength(r),l=(d.x-w)*(d.x-w)+(d.y-D)*(d.y-D);l<200&&l<n&&(n=l,o=e[i])}y&&y!==o&&d3.select(y.parentNode).classed("link_splice",!1),o?d3.select(o.parentNode).classed("link_splice",!0):d3.select(".link_splice").classed("link_splice",!1),y!==o&&(o?$(t.helper).data("splice",d3.select(o).data()[0]):$(t.helper).removeData("splice")),y=o,E=null},200)))}});var C=null;"subflows"==r.category&&($(p).dblclick(function(e){RED.workspaces.show(s.substring(8)),e.preventDefault()}),C=marked(r.info||"")),a(s,$(p),u,C),1===$("#palette-container-"+l).find(".palette_node").length&&n[l].open()}}function r(e){var t=i(e),n=$("#palette_node_"+t),o=n.closest(".palette-category");n.remove(),0===o.find(".palette_node").length&&o.find("i").hasClass("expanded")&&(o.find(".palette-content").slideToggle(),o.find("i").toggleClass("expanded"))}function d(e){var t=i(e),n=$("#palette_node_"+t);n.hide();for(var o=n.closest(".palette-category"),a=o.find(".palette_node"),s=0,r=0;r<a.length;r++)"none"===$(a[r]).css("display")&&(s+=1);s===a.length&&o.hide()}function l(e){var t=i(e),n=$("#palette_node_"+t);n.closest(".palette-category").show(),n.show()}return{init:function(){RED.events.on("registry:node-type-added",function(e){var t=RED.nodes.getType(e);s(e,t),t.onpaletteadd&&"function"==typeof t.onpaletteadd&&t.onpaletteadd.call(t)}),RED.events.on("registry:node-type-removed",function(e){r(e)}),RED.events.on("registry:node-set-enabled",function(e){for(var t=0;t<e.types.length;t++){l(e.types[t]);var n=RED.nodes.getType(e.types[t]);n&&n.onpaletteadd&&"function"==typeof n.onpaletteadd&&n.onpaletteadd.call(n)}}),RED.events.on("registry:node-set-disabled",function(e){console.log(e);for(var t=0;t<e.types.length;t++){d(e.types[t]);var n=RED.nodes.getType(e.types[t]);n&&n.onpaletteremove&&"function"==typeof n.onpaletteremove&&n.onpaletteremove.call(n)}}),RED.events.on("registry:node-set-removed",function(e){if(e.added)for(var t=0;t<e.types.length;t++){r(e.types[t]);var n=RED.nodes.getType(e.types[t]);n&&n.onpaletteremove&&"function"==typeof n.onpaletteremove&&n.onpaletteremove.call(n)}}),$("#palette > .palette-spinner").show(),$("#palette-search input").searchBox({delay:100,change:function(){!function(e){var t=new RegExp(e.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&"),"i");$("#palette-container .palette_node").each(function(n,o){var a=$(o).find(".palette_label").text();""===e||t.test(o.id)||t.test(a)?$(this).show():$(this).hide()});for(var o in n)n.hasOwnProperty(o)&&(0===n[o].container.find(".palette_node").filter(function(){return"none"!==$(this).css("display")}).length?n[o].close():n[o].open())}($(this).val())}});var e=t;RED.settings.paletteCategories?e=RED.settings.paletteCategories:RED.settings.theme("palette.categories")&&(e=RED.settings.theme("palette.categories")),Array.isArray(e)||(e=t),e.forEach(function(e){o(e,RED._("palette.label."+e,{defaultValue:e}))}),$("#palette-collapse-all").on("click",function(e){e.preventDefault();for(var t in n)n.hasOwnProperty(t)&&n[t].close()}),$("#palette-expand-all").on("click",function(e){e.preventDefault();for(var t in n)n.hasOwnProperty(t)&&n[t].open()})},add:s,remove:r,hide:d,show:l,refresh:function(){RED.nodes.eachSubflow(function(e){var t=$("#palette_node_subflow_"+e.id.replace(".","_")),n=t.find(".palette_port_input"),o=t.find(".palette_port_output");if(0===n.length&&e.in.length>0){var i=document.createElement("div");i.className="palette_port palette_port_input",t.append(i)}else 0!==n.length&&0===e.in.length&&n.remove();if(0===o.length&&e.out.length>0){var s=document.createElement("div");s.className="palette_port palette_port_output",t.append(s)}else 0!==o.length&&0===e.out.length&&o.remove();a(e.type+":"+e.id,t,e.name,marked(e.info||""))})}}}(),RED.sidebar.info=function(){var e,t,n,o,a;marked.setOptions({renderer:new marked.Renderer,gfm:!0,tables:!0,breaks:!1,pedantic:!1,sanitize:!0,smartLists:!0,smartypants:!1});var i={property:!1};function s(){RED.sidebar.show("info")}function r(e){if(void 0!==e){var a;t.show(),$(n.content).empty(),$(o.content).empty();var s,r,l=$('<table class="node-info"></table>').appendTo(n.content),p=$("<tbody>").appendTo(l),u=RED.projects.getActiveProject();if(u&&(a=$('<tr class="node-info-node-row"><td>Project</td><td></td></tr>').appendTo(p),$(a.children()[1]).text(u.name||""),$('<tr class="node-info-property-expand blank"><td colspan="2"></td></tr>').appendTo(p),$('<button class="editor-button editor-button-small" style="position:absolute;right:2px;"><i class="fa fa-ellipsis-h"></i></button>').appendTo(a.children()[1]).click(function(e){e.preventDefault(),RED.projects.editProject()})),o.container.show(),null!==e)if(Array.isArray(e))o.container.hide(),a=$('<tr class="node-info-node-row"><td>'+RED._("sidebar.info.selection")+"</td><td></td></tr>").appendTo(p),$(a.children()[1]).text(RED._("sidebar.info.nodes",{count:e.length}));else{var f=/^subflow(:(.+))?$/.exec(e.type);if(f){s=f[2]?RED.nodes.subflow(f[2]):e,r=0;var h="subflow:"+s.id;RED.nodes.eachNode(function(e){e.type===h&&r++})}if("tab"===e.type||"subflow"===e.type)a=$('<tr class="node-info-node-row"><td>'+RED._("sidebar.info."+("tab"===e.type?"flow":"subflow"))+"</td><td></td></tr>").appendTo(p),RED.utils.createObjectElement(e.id).appendTo(a.children()[1]),a=$('<tr class="node-info-node-row"><td>'+RED._("sidebar.info.tabName")+"</td><td></td></tr>").appendTo(p),$(a.children()[1]).text(e.label||e.name||""),"tab"===e.type&&(a=$('<tr class="node-info-node-row"><td>'+RED._("sidebar.info.status")+"</td><td></td></tr>").appendTo(p),$(a.children()[1]).html(e.disabled?RED._("sidebar.info.disabled"):RED._("sidebar.info.enabled")));else{if(a=$('<tr class="node-info-node-row"><td>'+RED._("sidebar.info.node")+"</td><td></td></tr>").appendTo(p),RED.utils.createObjectElement(e.id).appendTo(a.children()[1]),"subflow"!==e.type&&e.name&&$('<tr class="node-info-node-row"><td>'+RED._("common.label.name")+'</td><td><span class="bidiAware" dir="'+RED.text.bidi.resolveBaseTextDir(e.name)+'">'+e.name+"</span></td></tr>").appendTo(p),f||$('<tr class="node-info-node-row"><td>'+RED._("sidebar.info.type")+"</td><td>"+e.type+"</td></tr>").appendTo(p),!f&&"subflow"!=e.type&&"comment"!=e.type&&e._def){var g=0,v=e._def.defaults;for(var m in v)if("name"!=m&&v.hasOwnProperty(m)){var b=e[m];if(g++,a=$('<tr class="node-info-property-row'+(i.property?"":" hide")+'"><td>'+m+"</td><td></td></tr>").appendTo(p),v[m].type){var y=RED.nodes.node(b);if(y){var w=RED.utils.getNodeLabel(y,b),D=a.children()[1],E=$("<span>",{class:""}).appendTo(D),R=$("<div>",{class:"palette_node palette_node_small"}).appendTo(E),x=y._def.color,T=RED.utils.getNodeIcon(y._def);R.css({backgroundColor:x,cursor:"pointer"});var k=$("<div/>",{class:"palette_icon_container"}).appendTo(R);$("<div/>",{class:"palette_icon",style:"background-image: url("+T+")"}).appendTo(k);$("<span></span>").css({verticalAlign:"top",marginLeft:"6px"}).html(w).appendTo(D);R.on("dblclick",function(){RED.editor.editConfig("",y.type,y.id)})}else RED.utils.createObjectElement(void 0).appendTo(a.children()[1])}else RED.utils.createObjectElement(b).appendTo(a.children()[1])}g>0&&$('<tr class="node-info-property-expand blank"><td colspan="2"><a href="#" class=" node-info-property-header'+(i.property?" expanded":"")+'"><span class="node-info-property-show-more">'+RED._("sidebar.info.showMore")+'</span><span class="node-info-property-show-less">'+RED._("sidebar.info.showLess")+'</span> <i class="fa fa-caret-down"></i></a></td></tr>').appendTo(p)}"tab"!==e.type&&f&&($('<tr class="blank"><th colspan="2">'+RED._("sidebar.info.subflow")+"</th></tr>").appendTo(p),$('<tr class="node-info-subflow-row"><td>'+RED._("common.label.name")+'</td><td><span class="bidiAware" dir="'+RED.text.bidi.resolveBaseTextDir(s.name)+'">'+s.name+"</span></td></tr>").appendTo(p))}f&&$('<tr class="node-info-subflow-row"><td>'+RED._("sidebar.info.instances")+"</td><td>"+r+"</td></tr>").appendTo(p);var _="";if(s||"comment"===e.type||"tab"===e.type)"tab"===e.type&&(o.title.html(RED._("sidebar.info.flowDesc")),_=marked(e.info||"")||'<span class="node-info-none">'+RED._("sidebar.info.none")+"</span>");else o.title.html(RED._("sidebar.info.nodeHelp")),_=$("script[data-help-name='"+e.type+"']").html()||'<span class="node-info-none">'+RED._("sidebar.info.none")+"</span>";if(s)_+=marked(s.info||"")||'<span class="node-info-none">'+RED._("sidebar.info.none")+"</span>",o.title.html(RED._("sidebar.info.subflowDesc"));else if(e._def&&e._def.info){o.title.html(RED._("sidebar.info.nodeHelp"));var C=e._def.info,j="function"==typeof C?C.call(e):C;_+=marked(j)}_&&d(_),$(".node-info-property-header").click(function(e){e.preventDefault(),i.property=!i.property,$(this).toggleClass("expanded",i.property),$(".node-info-property-row").toggle(i.property)})}}else c()}function d(e){var t,n=(t=$('<div class="node-help"><span class="bidiAware" dir="'+RED.text.bidi.resolveBaseTextDir(e)+'">'+e+"</span></div>"),$(t).find("a").each(function(e){var t=$(this).attr("href");/^https?:/.test(t)&&$(this).attr("target","_blank")}),t).appendTo(o.content);n.find(".bidiAware").contents().filter(function(){return 3===this.nodeType&&""!==this.textContent.trim()}).wrap("<span></span>");n.find("H3").wrapInner('<a class="node-info-header expanded" href="#"></a>').find("a").prepend('<i class="fa fa-angle-right">').click(function(e){e.preventDefault();for(var t=$(this).hasClass("expanded"),n=$(this).parent().next();1===n.length&&"H3"!==n[0].nodeName;)n.toggle(!t),n=n.next();$(this).toggleClass("expanded",!t)})}var l=function(){var e,t,n=!0,o=1e3,i=15e3,s=-1;function r(){for(var n,o=Math.floor(Math.random()*s),r=RED._("infotips:info.tip"+o);n=/({{(.*?)}})/.exec(r);){var l=RED.keyboard.getShortcut(n[2]);if(!l)return;r=r.replace(n[1],RED.keyboard.formatKey(l.key))}for(;n=/(\[(.*?)\])/.exec(r);)r=r.replace(n[1],RED.keyboard.formatKey(n[2]));a.html(r).fadeIn(200),e&&(e=null,t=setInterval(d,i))}function d(){a.fadeOut(300,function(){r()})}function l(){if($(".sidebar-node-info").addClass("show-tips"),n&&!e&&!t){if(-1===s)do{s++}while(RED._("infotips:info.tip"+s)!=="infotips:info.tip"+s);e=setTimeout(r,o)}}function c(){$(".sidebar-node-info").removeClass("show-tips"),clearInterval(t),clearTimeout(e),t=null,e=null}return RED.actions.add("core:toggle-show-tips",function(e){void 0===e?RED.userSettings.toggle("view-show-tips"):(n=e)?l():c()}),{start:l,stop:c,next:function(){clearInterval(t),e=!0,r()},enabled:function(){return n}}}();function c(e){if(void 0===e&&(e=RED.view.selection()),e.nodes)if(1==e.nodes.length){var t=e.nodes[0];"subflow"===t.type&&t.direction?r(RED.nodes.subflow(t.z)):r(t)}else r(e.nodes);else{var n=RED.workspaces.active(),o=RED.nodes.workspace(n)||RED.nodes.subflow(n);if(o)r(o);else{var a=RED.nodes.workspace(RED.workspaces.active());a&&a.info?r(a):r(null)}}}return RED.events.on("view:selection-changed",c),{init:function(){(e=document.createElement("div")).className="sidebar-node-info",RED.actions.add("core:show-info-tab",s);var i=$("<div>",{class:"sidebar-node-info-stack"}).appendTo(e);t=RED.stack.create({container:i}).hide(),(n=t.add({title:RED._("sidebar.info.info"),collapsible:!0})).expand(),(o=t.add({title:RED._("sidebar.info.nodeHelp"),collapsible:!0})).expand(),o.content.css("padding","6px"),o.container.css("border-bottom","none");var r=$('<div class="node-info-tips"></div>').appendTo(e);a=$('<div class="node-info-tip"></div>').appendTo(r);var d=$('<div class="node-info-tips-buttons"></div>').appendTo(r);$('<a href="#" class="workspace-footer-button"><i class="fa fa-refresh"></a>').appendTo(d).click(function(e){e.preventDefault(),l.next()}),$('<a href="#" class="workspace-footer-button"><i class="fa fa-times"></a>').appendTo(d).click(function(e){e.preventDefault(),RED.actions.invoke("core:toggle-show-tips"),RED.notify(RED._("sidebar.info.showTips"))}),RED.sidebar.addTab({id:"info",label:RED._("sidebar.info.label"),name:RED._("sidebar.info.name"),content:e,enableOnEdit:!0}),l.enabled()?l.start():l.stop()},show:s,refresh:r,clear:function(){r(null)},set:function(e,t){o.title.text(t||""),r(null),$(o.content).empty(),d(e),$(".sidebar-node-info-stack").scrollTop(0)}}}(),RED.sidebar.config=function(){var e=document.createElement("div");e.className="sidebar-node-config",$('<div class="button-group sidebar-header"><a class="sidebar-header-button-toggle selected" id="workspace-config-node-filter-all" href="#"><span data-i18n="sidebar.config.filterAll"></span></a><a class="sidebar-header-button-toggle" id="workspace-config-node-filter-unused" href="#"><span data-i18n="sidebar.config.filterUnused"></span></a> </div>').appendTo(e);var t=$('<div><a class="sidebar-footer-button" id="workspace-config-node-collapse-all" href="#"><i class="fa fa-angle-double-up"></i></a> <a class="sidebar-footer-button" id="workspace-config-node-expand-all" href="#"><i class="fa fa-angle-double-down"></i></a></div>'),n=$("<div>").appendTo(e),o=$("<div>").appendTo(e),a=$("<div>").appendTo(e),i=!1,s={};function r(e,t,n){if(e=e.replace(/\./i,"-"),s[e])s[e].label!==n&&(s[e].list.parent().find(".config-node-label").text(n),s[e].label=n);else{var o=$('<div class="palette-category workspace-config-node-category" id="workspace-config-node-category-'+e+'"></div>').appendTo(t),a=$('<div class="workspace-config-node-tray-header palette-header"><i class="fa fa-angle-down expanded"></i></div>').appendTo(o);n?$('<span class="config-node-label"/>').text(n).appendTo(a):$('<span class="config-node-label" data-i18n="sidebar.config.'+e+'">').appendTo(a),$('<span class="config-node-filter-info"></span>').appendTo(a),category=$('<ul class="palette-content config-node-list"></ul>').appendTo(o),o.i18n();var i=a.find("i"),r={label:n,list:category,size:function(){return r.list.find("li:not(.config_node_none)").length},open:function(e){i.hasClass("expanded")||(i.addClass("expanded"),e?r.list.show():r.list.slideDown())},close:function(e){i.hasClass("expanded")&&(i.removeClass("expanded"),e?r.list.hide():r.list.slideUp())},isOpen:function(){return i.hasClass("expanded")}};a.on("click",function(e){r.isOpen()?r.close():r.open()}),s[e]=r}return s[e]}function d(e,t){var n=r(e.replace(/\./i,"-")),o=n.list;if(t.sort(function(e,t){return e.type<t.type?-1:e.type>t.type?1:0}),i){var a=t.length;(a-=(t=t.filter(function(e){return!1!==e._def.hasUsers&&0===e.users.length})).length)>0?o.parent().find(".config-node-filter-info").text(RED._("sidebar.config.filtered",{count:a})).show():o.parent().find(".config-node-filter-info").hide()}else o.parent().find(".config-node-filter-info").hide();if(o.empty(),0===t.length)$('<li class="config_node_none" data-i18n="sidebar.config.none">NONE</li>').i18n().appendTo(o),n.close(!0);else{var s="";t.forEach(function(e){var t=RED.utils.getNodeLabel(e,e.id);e.type!=s&&($('<li class="config_node_type">'+e.type+"</li>").appendTo(o),s=e.type);var n=$('<li class="palette_node config_node palette_node_id_'+e.id.replace(/\./g,"-")+'"></li>').appendTo(o);if($('<div class="palette_label"></div>').text(t).appendTo(n),!1!==e._def.hasUsers){$("<div/>",{class:"palette_icon_container  palette_icon_container_right"}).text(e.users.length).appendTo(n);0===e.users.length&&n.addClass("config_node_unused")}n.on("click",function(t){RED.sidebar.info.refresh(e)}),n.on("dblclick",function(t){RED.editor.editConfig("",e.type,e.id)});var a=e.users.map(function(e){return e.id});n.on("mouseover",function(e){RED.nodes.eachNode(function(e){-1!=a.indexOf(e.id)&&(e.highlighted=!0,e.dirty=!0)}),RED.view.redraw()}),n.on("mouseout",function(e){RED.nodes.eachNode(function(e){e.highlighted&&(e.highlighted=!1,e.dirty=!0)}),RED.view.redraw()})}),n.open(!0)}}function l(){var e={global:!0};r("global",n),RED.nodes.eachWorkspace(function(t){e[t.id.replace(/\./g,"-")]=!0,r(t.id,o,t.label)}),RED.nodes.eachSubflow(function(t){e[t.id.replace(/\./g,"-")]=!0,r(t.id,a,t.name)}),$(".workspace-config-node-category").each(function(){var t=$(this).attr("id").substring("workspace-config-node-category-".length);e[t]||($(this).remove(),delete s[t])});var t=[],i={};RED.nodes.eachConfig(function(e){e.z?(i[e.z.replace(/\./g,"-")]=i[e.z.replace(/\./g,"-")]||[],i[e.z.replace(/\./g,"-")].push(e)):e.z||t.push(e)});for(var l in e)e.hasOwnProperty(l)&&d(l,i[l]||[]);d("global",t)}return{init:function(){RED.sidebar.addTab({id:"config",label:RED._("sidebar.config.label"),name:RED._("sidebar.config.name"),content:e,toolbar:t,closeable:!0,visible:!1,onchange:function(){l()}}),RED.actions.add("core:show-config-tab",function(){RED.sidebar.show("config")}),$("#workspace-config-node-collapse-all").on("click",function(e){e.preventDefault();for(var t in s)s.hasOwnProperty(t)&&s[t].close()}),$("#workspace-config-node-expand-all").on("click",function(e){e.preventDefault();for(var t in s)s.hasOwnProperty(t)&&s[t].size()>0&&s[t].open()}),$("#workspace-config-node-filter-all").on("click",function(e){e.preventDefault(),i&&($(this).addClass("selected"),$("#workspace-config-node-filter-unused").removeClass("selected"),i=!i,l())}),$("#workspace-config-node-filter-unused").on("click",function(e){e.preventDefault(),i||($(this).addClass("selected"),$("#workspace-config-node-filter-all").removeClass("selected"),i=!i,l())})},show:function(e){"boolean"==typeof e&&(e?$("#workspace-config-node-filter-unused").click():$("#workspace-config-node-filter-all").click()),l(),"string"==typeof e&&($("#workspace-config-node-filter-all").click(),e=e.replace(/\./g,"-"),setTimeout(function(){var t=$(".palette_node_id_"+e),n=t.position().top,o=t.height(),a=$(".sidebar-node-config"),i=a.height();n+o>i?a.animate({scrollTop:"-="+(i-(n+o)-30)},150):n<0&&a.animate({scrollTop:"+="+(n-10)},150);var s=21,r=function(){s%2==0?t.removeClass("node_highlighted"):t.addClass("node_highlighted"),--s>=0&&setTimeout(r,100)};r()},100)),RED.sidebar.show("config")},refresh:l}}(),RED.palette.editor=function(){var e,t,n,o,a,i,s=[],r=[],d={},l={},c={},p={},u="";function f(e,t){var n=Date.now()-e;n=n<300?300:0,setTimeout(function(){t()},n)}function h(e,t,n,o){n.show();var a=Date.now();$.ajax({url:"nodes/"+e,type:"PUT",data:JSON.stringify({enabled:t}),contentType:"application/json; charset=utf-8"}).done(function(e,t,i){f(a,function(){n.hide(),o()})}).fail(function(e,t,i){f(a,function(){n.hide(),o(e)})})}function g(e,t,n){var o={module:e};t&&(o.version=t),$.ajax({url:"nodes",type:"POST",data:JSON.stringify(o),contentType:"application/json; charset=utf-8"}).done(function(e,t,o){n()}).fail(function(e,t,o){n(e)})}function v(e){p.hasOwnProperty(e)||(p[e]=setTimeout(function(){delete p[e],b(e)},100))}function m(e){var t=/^rgba?\(\s*(\d+),\s*(\d+),\s*(\d+)[,)]/.exec(e);if(t){var n=parseInt(t[1]),o=parseInt(t[2]),a=parseInt(t[3]);if((299*n+587*o+114*a)/1e3>160)return"rgb("+(n=Math.floor(.8*n))+","+(o=Math.floor(.8*o))+","+(a=Math.floor(.8*a))+")"}return e}function b(e){if(c.hasOwnProperty(e)){var t=c[e].info,n=c[e].elements;if(n){var a=0,i=0;c[e].totalUseCount=0,c[e].setUseCount={};for(var s in t.sets)if(t.sets.hasOwnProperty(s)){var r=0,p=t.sets[s],u=n.sets[s];p.enabled&&(a+=p.types.length),i+=p.types.length;for(var f=0;f<t.sets[s].types.length;f++){var h=t.sets[s].types[f];r+=l[h]||0;var g=u.swatches[h];if(p.enabled){var v=RED.nodes.getType(h);v&&v.color?(g.css({background:v.color}),g.css({border:"1px solid "+m(g.css("backgroundColor"))})):g.css({background:"#eee",border:"1px dashed #999"})}else g.css({background:"#eee",border:"1px dashed #999"})}c[e].setUseCount[s]=r,c[e].totalUseCount+=r,r>0?(u.enableButton.html(RED._("palette.editor.inuse")),u.enableButton.addClass("disabled")):(u.enableButton.removeClass("disabled"),p.enabled?u.enableButton.html(RED._("palette.editor.disable")):u.enableButton.html(RED._("palette.editor.enable"))),u.setRow.toggleClass("palette-module-set-disabled",!p.enabled)}var b=a===i?i:a+" / "+i;n.setCount.html(RED._("palette.editor.nodeCount",{count:i,label:b})),c[e].totalUseCount>0?(n.enableButton.html(RED._("palette.editor.inuse")),n.enableButton.addClass("disabled"),n.removeButton.hide()):(n.enableButton.removeClass("disabled"),t.local&&n.removeButton.css("display","inline-block"),0===a?n.enableButton.html(RED._("palette.editor.enableall")):n.enableButton.html(RED._("palette.editor.disableall")),n.container.toggleClass("disabled",0===a))}t.pending_version?(n.versionSpan.html(t.version+' <i class="fa fa-long-arrow-right"></i> '+t.pending_version).appendTo(n.metaRow),n.updateButton.html(RED._("palette.editor.updated")).addClass("disabled").show()):d.hasOwnProperty(e)&&1===function(e,t){for(var n=e.split(".").map(function(e){return parseInt(e)}),o=t.split(".").map(function(e){return parseInt(e)}),a=0;a<3;a++){var i=n[a]-o[a];if(i<0)return-1;if(i>0)return 1}return 0}(d[e].version,t.version)?(n.updateButton.show(),n.updateButton.html(RED._("palette.editor.update",{version:d[e].version}))):n.updateButton.hide()}else{c[e]={info:RED.nodes.registry.getModule(e)};var y=[e];for(var w in c[e].info.sets)c[e].info.sets.hasOwnProperty(w)&&(y.push(w),y=y.concat(c[e].info.sets[w].types));c[e].index=y.join(",").toLowerCase(),o.editableList("addItem",c[e])}}var y,w,D=[],E=!1,R=_;function x(e,t,o,a){if(D.push(e||a),e?E=!0:(a.modules&&(a.modules.forEach(function(e){d[e.id]=e,e.index=[e.id],e.keywords&&(e.index=e.index.concat(e.keywords)),e.updated_at?e.timestamp=new Date(e.updated_at).getTime():e.timestamp=0,e.index=e.index.join(",").toLowerCase()}),s=s.concat(a.modules)),n.searchBox("count",s.length)),i>1&&$(".palette-module-shade-status").html(RED._("palette.editor.loading")+"<br>"+D.length+"/"+i),D.length===i){E&&RED.notify(RED._("palette.editor.errors.catalogLoadFailed",{url:t}),"error",!1,8e3);var r=250-(Date.now()-y);setTimeout(function(){$("#palette-module-install-shade").hide()},Math.max(r,0))}}function T(){if(0===s.length){s=[],d={},a.editableList("empty"),$(".palette-module-shade-status").html(RED._("palette.editor.loading"));var e=RED.settings.theme("palette.catalogues")||["https://catalogue.nodered.org/catalogue.json"];D=[],E=!1,i=e.length,e.length>1&&$(".palette-module-shade-status").html(RED._("palette.editor.loading")+"<br>0/"+e.length),$("#palette-module-install-shade").show(),y=Date.now();var t=0;e.forEach(function(e,o){$.getJSON(e,{_:(new Date).getTime()},function(t){x(null,e,0,t),function(){for(var e in c)c.hasOwnProperty(e)&&b(e)}()}).fail(function(t,n,o){x(t,e)}).always(function(){++t===i&&n.searchBox("change")})})}}function k(){if(a.editableList("empty"),""!==n.searchBox("value").trim()){r.sort(R);for(var e=0;e<Math.min(10,r.length);e++)a.editableList("addItem",r[e]);0===r.length&&a.editableList("addItem",{}),r.length>10&&a.editableList("addItem",{start:10,more:r.length-10})}else a.editableList("addItem",{count:s.length})}function _(e,t){return e.info.id.localeCompare(t.info.id)}function C(e,t){return-1*(e.info.timestamp-t.info.timestamp)}function j(){return T(),e.activateTab("nodes"),w}function S(e,t,n){if(!1!==RED.settings.theme("palette.editable")){var o=[{text:RED._("common.label.cancel"),click:function(){a.close()}}];e.url&&o.push({text:RED._("palette.editor.confirm.button.review"),class:"primary palette-module-install-confirm-button-install",click:function(){var t=e.url||"";window.open(t)}}),o.push({text:RED._("palette.editor.confirm.button.install"),class:"primary palette-module-install-confirm-button-install",click:function(){var o=RED.utils.addSpinnerOverlay(t,!0);g(e.id,e.version,function(t){o.remove(),t&&t.responseJSON&&RED.notify(RED._("palette.editor.errors.installFailed",{module:e.id,message:t.responseJSON.message})),n(t)}),a.close()}});var a=RED.notify(RED._("palette.editor.confirm.install.body",{module:e.id}),{modal:!0,fixed:!0,buttons:o})}else n(new Error("Palette not editable"))}return{init:function(){!1!==RED.settings.theme("palette.editable")&&(function(){w=$('<div id="user-settings-tab-palette"></div>');var i=$('<div id="palette-editor"><ul id="palette-editor-tabs"></ul></div>').appendTo(w);e=RED.tabs.create({element:w.find("#palette-editor-tabs"),onchange:function(e){i.find(".palette-editor-tab").hide(),e.content.show(),t&&t.searchBox("value",""),n&&n.searchBox("value",""),"install"===e.id?n&&n.focus():t&&t.focus()},minimumActiveTabWidth:110});var l=$("<div>",{class:"palette-editor-tab"}).appendTo(i);e.addTab({id:"nodes",label:RED._("palette.editor.tab-nodes"),content:l});var p=$("<div>",{class:"palette-search"}).appendTo(l);t=$('<input type="text" data-i18n="[placeholder]palette.filter"></input>').appendTo(p).searchBox({delay:200,change:function(){!function(e){u=e.toLowerCase();var n=o.editableList("filter"),a=o.editableList("length");""===e?t.searchBox("count"):t.searchBox("count",n+" / "+a)}($(this).val())}}),o=$("<ol>",{id:"palette-module-list",style:"position: absolute;top: 35px;bottom: 0;left: 0;right: 0px;"}).appendTo(l).editableList({addButton:!1,scrollOnAdd:!1,sort:function(e,t){return e.info.name.localeCompare(t.info.name)},filter:function(e){return""===u||""===u||e.index.indexOf(u)>-1},addItem:function(e,t,n){var o=n.info;if(o){var a=$("<div>",{class:"palette-module-header"}).appendTo(e),i=$('<div class="palette-module-meta palette-module-name"><i class="fa fa-cube"></i></div>').appendTo(a);$("<span>").html(o.name).appendTo(i);var s=$('<div class="palette-module-meta palette-module-version"><i class="fa fa-tag"></i></div>').appendTo(a),r=$("<span>").html(o.version).appendTo(s),l=$("<div>",{class:"palette-module-meta"}).appendTo(a),c=$('<a href="#" class="editor-button editor-button-small palette-module-set-button"><i class="fa fa-angle-right palette-module-node-chevron"></i> </a>').appendTo(l),p=$("<span>").appendTo(c),u=$("<div>",{class:"palette-module-button-group"}).appendTo(l),f=$('<a href="#" class="editor-button editor-button-small"></a>').html(RED._("palette.editor.update")).appendTo(u);f.attr("id","up_"+Math.floor(1e9*Math.random())),f.click(function(t){t.preventDefault(),$(this).hasClass("disabled")||function(e,t,n,o){if(!1!==RED.settings.theme("palette.editable"))var a=RED.notify(RED._("palette.editor.confirm.update.body",{module:e.name}),{modal:!0,fixed:!0,buttons:[{text:RED._("common.label.cancel"),click:function(){a.close()}},{text:RED._("palette.editor.confirm.button.update"),class:"primary palette-module-install-confirm-button-update",click:function(){var i=RED.utils.addSpinnerOverlay(n,!0);g(e.name,t,function(t){i.remove(),t&&t.responseJSON&&RED.notify(RED._("palette.editor.errors.updateFailed",{module:e.name,message:t.responseJSON.message})),o(t)}),a.close()}}]});else o(new Error("Palette not editable"))}(o,d[o.name].version,e,function(e){})});var m=$('<a href="#" class="editor-button editor-button-small"></a>').html(RED._("palette.editor.remove")).appendTo(u);m.attr("id","up_"+Math.floor(1e9*Math.random())),m.click(function(t){t.preventDefault(),function(e,t,n){if(!1!==RED.settings.theme("palette.editable"))var o=RED.notify(RED._("palette.editor.confirm.remove.body",{module:e.name}),{modal:!0,fixed:!0,buttons:[{text:RED._("common.label.cancel"),click:function(){o.close()}},{text:RED._("palette.editor.confirm.button.remove"),class:"primary palette-module-install-confirm-button-remove",click:function(){var n,a,i=RED.utils.addSpinnerOverlay(t,!0);n=e.name,a=function(t){i.remove(),t&&t.responseJSON&&RED.notify(RED._("palette.editor.errors.removeFailed",{module:e.name,message:t.responseJSON.message}))},$.ajax({url:"nodes/"+n,type:"DELETE"}).done(function(e,t,n){a()}).fail(function(e,t,n){a(e)}),o.close()}}]});else n(new Error("Palette not editable"))}(o,e,function(e){})}),o.local||m.hide();var b=$('<a href="#" class="editor-button editor-button-small"></a>').html(RED._("palette.editor.disableall")).appendTo(u),y=$("<div>",{class:"palette-module-content"}).appendTo(e),w=$('<div class="palette-module-shade hide"><img src="red/images/spin.svg" class="palette-spinner"/></div>').appendTo(e);n.elements={updateButton:f,removeButton:m,enableButton:b,setCount:p,container:e,shade:w,versionSpan:r,sets:{}},c.click(function(t){t.preventDefault(),e.hasClass("expanded")?(e.removeClass("expanded"),y.slideUp()):(e.addClass("expanded"),y.slideDown())});var D=Object.keys(o.sets);D.sort(function(e,t){return e.toLowerCase().localeCompare(t.toLowerCase())}),D.forEach(function(e){var t=o.sets[e],a=$("<div>",{class:"palette-module-set"}).appendTo(y),i=$("<div>",{class:"palette-module-set-button-group"}).appendTo(a),s={};t.types.forEach(function(e){var t=$("<div>",{class:"palette-module-type"}).appendTo(a);s[e]=$("<span>",{class:"palette-module-type-swatch"}).appendTo(t),$("<span>",{class:"palette-module-type-node"}).html(e).appendTo(t)});var r=$('<a href="#" class="editor-button editor-button-small"></a>').appendTo(i);r.click(function(o){if(o.preventDefault(),0===n.setUseCount[e]){var a=RED.nodes.registry.getNodeSet(t.id);w.show();var i=!a.enabled;h(t.id,i,w,function(e){e&&e.responseJSON&&RED.notify(RED._("palette.editor.errors."+(i?"enable":"disable")+"Failed",{module:id,message:e.responseJSON.message}))})}}),n.elements.sets[t.name]={setRow:a,enableButton:r,swatches:s}}),b.click(function(t){t.preventDefault(),0===n.totalUseCount&&h(o.name,e.hasClass("disabled"),w,function(e){e&&e.responseJSON&&RED.notify(RED._("palette.editor.errors.installFailed",{module:id,message:e.responseJSON.message}))})}),v(o.name)}else $("<div>",{class:"red-ui-search-empty"}).html(RED._("search.empty")).appendTo(e)}});var f=$("<div>",{class:"palette-editor-tab hide"}).appendTo(i);e.addTab({id:"install",label:RED._("palette.editor.tab-install"),content:f});var m=$("<div>",{class:"palette-editor-toolbar"}).appendTo(f),b=$("<div>",{class:"palette-search"}).appendTo(f);n=$('<input type="text" data-i18n="[placeholder]palette.search"></input>').appendTo(b).searchBox({delay:300,change:function(){var e=$(this).val().trim().toLowerCase();e.length>0?(r=s.filter(function(t){return t.index.indexOf(e)>-1}).map(function(e){return{info:e}}),k(),n.searchBox("count",r.length+" / "+s.length)):(n.searchBox("count",s.length),a.editableList("empty"),a.editableList("addItem",{count:s.length}))}}),$("<span>").html(RED._("palette.editor.sort")+" ").appendTo(m);var y=$('<span class="button-group"></span>').appendTo(m),D=$('<a href="#" class="sidebar-header-button-toggle selected" data-i18n="palette.editor.sortAZ"></a>').appendTo(y),E=$('<a href="#" class="sidebar-header-button-toggle" data-i18n="palette.editor.sortRecent"></a>').appendTo(y);D.click(function(e){e.preventDefault(),$(this).hasClass("selected")||($(this).addClass("selected"),E.removeClass("selected"),R=_,k())}),E.click(function(e){e.preventDefault(),$(this).hasClass("selected")||($(this).addClass("selected"),D.removeClass("selected"),R=C,k())});var x=$("<span>").appendTo(m);$('<a href="#" class="sidebar-header-button"><i class="fa fa-refresh"></i></a>').appendTo(x).click(function(e){e.preventDefault(),s=[],d={},T()}),a=$("<ol>",{style:"position: absolute;top: 78px;bottom: 0;left: 0;right: 0px;"}).appendTo(f).editableList({addButton:!1,scrollOnAdd:!1,addItem:function(e,t,n){if(n.count)$("<div>",{class:"red-ui-search-empty"}).html(RED._("palette.editor.moduleCount",{count:n.count})).appendTo(e);else if(n.more){e.addClass("palette-module-more");var o=$("<div>",{class:"palette-module-header palette-module"}).appendTo(e),i=$('<a href="#"></a>').html(RED._("palette.editor.more",{count:n.more})).appendTo(o);i.click(function(e){e.preventDefault(),a.editableList("removeItem",n);for(var t=n.start;t<Math.min(n.start+10,n.start+n.more);t++)a.editableList("addItem",r[t]);n.more>10&&a.editableList("addItem",{start:n.start+10,more:n.more-10})})}else if(n.info){var s=n.info,d=$("<div>",{class:"palette-module-header"}).appendTo(e),l=$('<div class="palette-module-meta"><i class="fa fa-cube"></i></div>').appendTo(d);$("<span>",{class:"palette-module-name"}).html(s.name||s.id).appendTo(l),$('<a target="_blank" class="palette-module-link"><i class="fa fa-external-link"></i></a>').attr("href",s.url).appendTo(l);var p=$('<div class="palette-module-meta"></div>').appendTo(d);$("<div>",{class:"palette-module-description"}).html(s.description).appendTo(p);var u=$('<div class="palette-module-meta"></div>').appendTo(d);$('<span class="palette-module-version"><i class="fa fa-tag"></i> '+s.version+"</span>").appendTo(u),$('<span class="palette-module-updated"><i class="fa fa-calendar"></i> '+function(e){new Date,new Date(e);var t=(Date.now()-new Date(e).getTime())/1e3;if(t<60)return RED._("palette.editor.times.seconds");if((t=Math.floor(t/60))<10)return RED._("palette.editor.times.minutes");if(t<60)return RED._("palette.editor.times.minutesV",{count:t});if((t=Math.floor(t/60))<24)return RED._("palette.editor.times.hoursV",{count:t});if((t=Math.floor(t/24))<7)return RED._("palette.editor.times.daysV",{count:t});var n=Math.floor(t/7);if(n<4)return RED._("palette.editor.times.weeksV",{count:n});var o=Math.floor(n/4);if(n%=4,o<12)return RED._("palette.editor.times.monthsV",{count:o});var a=Math.floor(o/12);return 0==(o%=12)?RED._("palette.editor.times.yearsV",{count:a}):RED._("palette.editor.times.year"+(a>1?"s":"")+"MonthsV",{y:a,count:o})}(s.updated_at)+"</span>").appendTo(u);var f=$("<div>",{class:"palette-module-meta"}).appendTo(d),h=$("<div>",{class:"palette-module-button-group"}).appendTo(f),g=$('<a href="#" class="editor-button editor-button-small"></a>').html(RED._("palette.editor.install")).appendTo(h);g.click(function(t){t.preventDefault(),$(this).hasClass("disabled")||S(s,e,function(e){})}),c.hasOwnProperty(s.id)&&(g.addClass("disabled"),g.html(RED._("palette.editor.installed"))),n.elements={installButton:g}}else $("<div>",{class:"red-ui-search-empty"}).html(RED._("search.empty")).appendTo(e)}}),$('<div id="palette-module-install-shade" class="palette-module-shade hide"><div class="palette-module-shade-status"></div><img src="red/images/spin.svg" class="palette-spinner"/></div>').appendTo(f)}(),RED.userSettings.add({id:"palette",title:RED._("palette.editor.palette"),get:j,close:function(){w.detach()},focus:function(){e.resize(),setTimeout(function(){t.focus()},200)}}),RED.actions.add("core:manage-palette",function(){RED.userSettings.show("palette")}),RED.events.on("registry:module-updated",function(e){v(e.module)}),RED.events.on("registry:node-set-enabled",function(e){v(e.module)}),RED.events.on("registry:node-set-disabled",function(e){v(e.module)}),RED.events.on("registry:node-type-added",function(e){/^subflow:/.test(e)||v(RED.nodes.registry.getNodeSetForType(e).module)}),RED.events.on("registry:node-type-removed",function(e){/^subflow:/.test(e)||v(RED.nodes.registry.getNodeSetForType(e).module)}),RED.events.on("registry:node-set-added",function(e){v(e.module);for(var t=0;t<r.length;t++)if(r[t].info.id===e.module){var n=r[t].elements.installButton;n.addClass("disabled"),n.html(RED._("palette.editor.installed"));break}}),RED.events.on("registry:node-set-removed",function(e){if(!RED.nodes.registry.getModule(e.module)){var t=c[e.module];if(t){o.editableList("removeItem",t),delete c[e.module];for(var n=0;n<r.length;n++)if(r[n].info.id===e.module){var a=r[n].elements.installButton;a.removeClass("disabled"),a.html(RED._("palette.editor.install"));break}}}}),RED.events.on("nodes:add",function(e){/^subflow:/.test(e.type)||(l[e.type]=(l[e.type]||0)+1,1===l[e.type]&&v(RED.nodes.registry.getNodeSetForType(e.type).module))}),RED.events.on("nodes:remove",function(e){l.hasOwnProperty(e.type)&&(l[e.type]--,0===l[e.type]&&(delete l[e.type],v(RED.nodes.registry.getNodeSetForType(e.type).module)))}))},install:S}}(),RED.editor=function(){var e=[],t={};function n(e){var t,a,i,s=e.valid,r=e.changed;if(e.valid=!0,0===e.type.indexOf("subflow:"))a=(t=RED.nodes.subflow(e.type.substring(8))).valid,i=t.changed,void 0===a&&(a=n(t),i=t.changed),e.valid=a,e.changed=e.changed||i;else if(e._def)e.valid=o(e,e._def.defaults,e),e._def._creds&&(e.valid=e.valid&&o(e,e._def.credentials,e._def._creds));else if("subflow"==e.type){for(var d=RED.nodes.filterNodes({z:e.id}),l=0;l<d.length;l++)a=d[l].valid,i=d[l].changed,void 0===a&&(a=n(d[l]),i=d[l].changed),e.valid=e.valid&&a,e.changed=e.changed||i;var c=RED.nodes.filterNodes({type:"subflow:"+e.id}),p={};for(l=0;l<c.length;l++)c[l].valid=e.valid,c[l].changed=c[l].changed||e.changed,c[l].dirty=!0,p[c[l].z]=!0;Object.keys(p).forEach(function(e){var t=RED.nodes.subflow(e);t&&n(t)})}return s===e.valid&&r===e.changed||(e.dirty=!0,(t=RED.nodes.subflow(e.z))&&n(t)),e.valid}function o(e,t,n){var o=!0;for(var i in t)t.hasOwnProperty(i)&&(a(e,t,i,n[i])||(o=!1));if(e.icon){var s=RED.utils.separateIconPath(e.icon);if(!s.module)return o;var r=RED.nodes.getIconSets()[s.module];r&&-1!==r.indexOf(s.file)||(o=!1)}return o}function a(e,t,n,o){var a=!0;if(/^\$\([a-zA-Z_][a-zA-Z0-9_]*\)$/.test(o))return!0;if("required"in t[n]&&t[n].required&&(a=""!==o),a&&"validate"in t[n])try{a=t[n].validate.call(e,o)}catch(t){console.log("Validation error:",e.type,e.id,"property: "+n,"value:",o,t)}if(a&&t[n].type&&RED.nodes.getType(t[n].type)&&!("validate"in t[n]))if(o&&"_ADD_"!=o){var i=RED.nodes.node(o);a=null!==i&&(null==i.valid||i.valid)}else a=t[n].hasOwnProperty("required")&&!t[n].required;return a}function i(e,t){for(var n in e._def.defaults)e._def.defaults.hasOwnProperty(n)&&s(e,e._def.defaults,n,t);if(e._def.credentials)for(n in e._def.credentials)e._def.credentials.hasOwnProperty(n)&&s(e,e._def.credentials,n,t);if(e._def.hasOwnProperty("defaults")&&!e._def.defaults.hasOwnProperty("icon")&&e.icon){var o=RED.utils.separateIconPath(e.icon),a=RED.nodes.getIconSets()[o.module],i=$("#node-settings-icon-module"),r=$("#node-settings-icon-file");a?-1===a.indexOf(o.file)?(i.removeClass("input-error"),r.addClass("input-error")):(i.removeClass("input-error"),r.removeClass("input-error")):(i.addClass("input-error"),r.removeClass("input-error"))}}function s(e,t,n,o){var i=$("#"+o+"-"+n);if(i.length>0){var s=i.val();t[n].hasOwnProperty("format")&&""!==t[n].format&&"DIV"===i[0].nodeName&&(s=i.text()),a(e,t,n,s)?i.removeClass("input-error"):i.addClass("input-error")}}function r(e,t){e.resize=!0,e.dirty=!0;var n=[];if(e.ports)if(t&&RED.nodes.eachLink(function(o){o.source===e&&t.hasOwnProperty(o.sourcePort)&&("-1"===t[o.sourcePort]?n.push(o):o.sourcePort=t[o.sourcePort])}),e.outputs<e.ports.length){for(;e.outputs<e.ports.length;)e.ports.pop();RED.nodes.eachLink(function(t){t.source===e&&t.sourcePort>=e.outputs&&-1===n.indexOf(t)&&n.push(t)})}else if(e.outputs>e.ports.length)for(;e.outputs>e.ports.length;)e.ports.push(e.ports.length);0===e.inputs&&n.concat(RED.nodes.filterLinks({target:e}));for(var o=0;o<n.length;o++)RED.nodes.removeLink(n[o]);return n}function d(e,t,n,o){var a=$("#"+o+"-"+t);if(0!==a.length){var i,s=a.width(),r=a.attr("style");s=null!==(i=/width\s*:\s*(\d+(%|[a-z]+))/i.exec(r))?i[1]:"70%";var d=$("<div></div>").css({display:"inline-block",position:"relative"}),l=$("<div></div>").css({position:"absolute",left:0,right:"40px"}).appendTo(d),c=$('<select id="'+o+"-"+t+'"></select>').appendTo(l);d.width(s).height(a.height()),0===d.width()&&d.width("70%"),a.replaceWith(d),c.attr("style","width:100%"),E(t,n,e[t],o),$('<a id="'+o+"-lookup-"+t+'" class="editor-button"><i class="fa fa-pencil"></i></a>').css({position:"absolute",right:0,top:0}).appendTo(d),$("#"+o+"-lookup-"+t).click(function(e){w(t,n,c.find(":selected").val(),o),e.preventDefault()});var p="",u=RED.nodes.node(e[t]);RED.nodes.getType(n);u&&(p=RED.utils.getNodeLabel(u,u.id)),a.val(p)}}function l(e,t,n,o){var a=$("#"+o+"-"+t);a.val(e[t]),a.attr("type","hidden");var i=$("<a>",{id:o+"-edit-"+t,class:"editor-button"});a.after(i),e[t]?i.text(RED._("editor.configEdit")):i.text(RED._("editor.configAdd")),i.click(function(e){w(t,n,a.val()||"_ADD_",o),e.preventDefault()})}function c(e,t,n,o){var a=$("#"+n+"-"+t);if(0!==a.length)if("checkbox"===a.attr("type"))a.prop("checked",e[t]);else{var i=e[t];null==i&&(i=""),void 0!==o&&o[t].hasOwnProperty("format")&&""!==o[t].format&&"DIV"===a[0].nodeName?(a.html(RED.text.format.getHtml(i,o[t].format,{},!1,"en")),RED.text.format.attach(a[0],o[t].format,{},!1,"en")):(a.val(i),"INPUT"!==a[0].nodeName&&"TEXTAREA"!==a[0].nodeName||RED.text.bidi.prepareInput(a))}}function p(e,t,n,o){var a=$("#"+o+"-"+n);void 0!==t&&"format"in t[n]&&""!==t[n].format&&"DIV"===a[0].nodeName?$("#"+o+"-"+n).on("change keyup",function(t,n){n||i(e,o)}):$("#"+o+"-"+n).change(function(t,n){n||i(e,o)})}function u(e,t,n,o){var a;for(a in t)t.hasOwnProperty(a)&&("password"==t[a].type?n[a]?$("#"+o+"-"+a).val(n[a]):n["has_"+a]?$("#"+o+"-"+a).val("__PWRD__"):$("#"+o+"-"+a).val(""):c(n,a,o,t),p(e,t,a,o))}function f(e,t,n){var o=!1;e.credentials||(e.credentials={_:{}});for(var a in t)if(t.hasOwnProperty(a)){var i=$("#"+n+"-"+a).val();if("password"==t[a].type){if(e.credentials["has_"+a]=""!==i,"__PWRD__"==i)continue;o=!0}e.credentials[a]=i,i!=e.credentials._[a]&&(o=!0)}return o}function h(e,t,n,o){for(var a in t.defaults)if(t.defaults.hasOwnProperty(a)){if(t.defaults[a].type){var s=RED.nodes.getType(t.defaults[a].type);s?s.exclusive?l(e,a,t.defaults[a].type,n):d(e,a,t.defaults[a].type,n):(console.log("Unknown type:",t.defaults[a].type),c(e,a,n,t.defaults))}else c(e,a,n,t.defaults);p(e,t.defaults,a,n)}var r,f,h=function(){if(t.oneditprepare)try{t.oneditprepare.call(e)}catch(t){console.log("oneditprepare",e.id,e.type,t.toString())}for(var a in t.defaults)t.defaults.hasOwnProperty(a)&&$("#"+n+"-"+a).trigger("change",[!0]);if(t.credentials)for(a in t.credentials)t.credentials.hasOwnProperty(a)&&$("#"+n+"-"+a).trigger("change",[!0]);i(e,n),o&&o()};t.credentials?e.credentials?(u(e,t.credentials,e.credentials,n),h()):$.getJSON((r=e.type,f=e.id,"credentials/"+r.replace(/\s+/g,"-")+"/"+f),function(o){e.credentials=o,e.credentials._=$.extend(!0,{},o),u(e,t.credentials,e.credentials,n),h()}):h()}function g(){for(var t,n=e.length-1;n<e.length;n++){var o=e[n];if(t=o.type,"_expression"===o.type)t=RED._("expressionEditor.title");else if("_json"===o.type)t=RED._("jsonEditor.title");else if("_markdown"===o.type)t=RED._("markdownEditor.title");else if("_buffer"===o.type)t=RED._("bufferEditor.title");else if("subflow"===o.type)t=RED._("subflow.editSubflow",{name:o.name});else if(0===o.type.indexOf("subflow:")){var a=RED.nodes.subflow(o.type.substring(8));t=RED._("subflow.editSubflow",{name:a.name})}else{if(void 0!==o._def.paletteLabel)try{t=("function"==typeof o._def.paletteLabel?o._def.paletteLabel.call(o._def):o._def.paletteLabel)||""}catch(e){console.log("Definition error: "+o.type+".paletteLabel",e)}n===e.length-1&&(t=RED.nodes.node(o.id)?RED._("editor.editNode",{type:t}):RED._("editor.addNewConfig",{type:t}))}"<li>"+t+"</li>"}return"</ul>",t}function v(e,t,n,o){var a=$('<form id="'+t+'" class="form-horizontal" autocomplete="off"></form>').appendTo(e);return a.html($("script[data-template-name='"+n+"']").html()),o=o||"node-red",a.find("[data-i18n]").each(function(){for(var e=$(this).attr("data-i18n").split(";"),t=0;t<e.length;t++){var n=e[t];if(-1===n.indexOf(":")){var a="";if(0===n.indexOf("[")){var i=n.split("]");a=i[0]+"]",n=i[1]}e[t]=a+o+":"+n}}$(this).attr("data-i18n",e.join(";"))}),$('<input type="password" style="display: none;" />').prependTo(a),$('<input type="text" style="display: none;" />').prependTo(a),a.submit(function(e){e.preventDefault()}),a}function m(e,t,n,o){var a=$("<div>",{class:"node-label-form-row"});if(void 0===e)$("<span>").html(RED._("editor.noDefaultLabel")).appendTo(a),a.addClass("node-label-form-none");else{a.addClass("");var i="node-label-form-"+e+"-"+t;$("<label>",{for:i}).html(t+1+".").appendTo(a);var s=$("<input>",{type:"text",id:i,placeholder:o}).val(n).appendTo(a);$('<button class="editor-button editor-button-small"><i class="fa fa-times"></i></button>').appendTo(a).click(function(e){e.preventDefault(),s.val("")})}return a}function b(e,t){var n=$('<form class="dialog-form form-horizontal" autocomplete="off"></form>').appendTo(e),o=t.inputs||t._def.inputs||0,a=t.outputs||t._def.outputs||0;"subflow"===t.type&&(o=t.in.length,a=t.out.length);var i,s=t.inputLabels||[],r=t.outputLabels||[],d=t._def.inputLabels?RED._("editor.defaultLabel"):RED._("editor.noDefaultLabel"),l=t._def.outputLabels?RED._("editor.defaultLabel"):RED._("editor.noDefaultLabel");$('<div class="form-row"><span data-i18n="editor.labelInputs"></span><div id="node-label-form-inputs"></div></div>').appendTo(n);var c=$("#node-label-form-inputs");if(o>0)for(i=0;i<o;i++)m("input",i,s[i],d).appendTo(c);else m().appendTo(c);$('<div class="form-row"><span data-i18n="editor.labelOutputs"></span><div id="node-label-form-outputs"></div></div>').appendTo(n);var p=$("#node-label-form-outputs");if(a>0)for(i=0;i<a;i++)m("output",i,r[i],l).appendTo(p);else m().appendTo(p);if(!(t._def.defaults&&t._def.defaults.hasOwnProperty("icon")||"subflow"===t.type)){$('<div class="form-row"><div id="node-settings-icon"></div></div>').appendTo(n);var u=$("#node-settings-icon");$('<label data-i18n="editor.settingIcon">').appendTo(u);var f=$("<div>",{class:"node-label-form-row"});f.appendTo(u),$("<label>").appendTo(f);var h,g=$('<select id="node-settings-icon-module"><option value=""></option></select>').appendTo(f);h=t.icon?RED.utils.separateIconPath(t.icon):RED.utils.getDefaultNodeIcon(t._def,t);var v=RED.nodes.getIconSets();Object.keys(v).forEach(function(e){g.append($("<option></option>").val(e).text(e))}),h.module&&!v[h.module]&&g.append($("<option disabled></option>").val(h.module).text(h.module)),g.val(h.module);var b=$('<input type="hidden" id="node-settings-icon-module-hidden"></input>').appendTo(f);b.val(h.module);var w=$('<select id="node-settings-icon-file"><option value=""></option></select>').appendTo(f);g.change(function(){y(g,w,b,D,v,!0)});var D=$('<input type="hidden" id="node-settings-icon-file-hidden"></input>').appendTo(f);D.val(h.file),w.change(function(){w.removeClass("input-error");var e=w.val();D.val(e)}),$('<button class="editor-button editor-button-small"><i class="fa fa-times"></i></button>').appendTo(f).click(function(e){e.preventDefault();var n=RED.utils.getDefaultNodeIcon(t._def,t);g.val(n.module),y(g,w,b,D,v,!0),w.removeClass("input-error"),w.val(n.file),D.val(n.file)}),y(g,w,b,D,v,!1);var E=v[g.val()];E&&-1!==E.indexOf(h.file)||w.append($("<option disabled></option>").val(h.file).text(h.file)),w.val(h.file)}}function y(e,t,n,o,a,i){t.children().remove();var s=e.val();null!==s&&n.val(s);var r=a[s];r&&r.forEach(function(e){i&&(i=!1,o.val(e)),t.append($("<option></option>").val(e).text(e))}),t.prop("disabled",!r),e.removeClass("input-error")}function w(t,o,a,i){var s,r="_ADD_"==a,d=RED.nodes.getType(o),l=RED.nodes.node(a);s="node-red"===d.set.module?"node-red":d.set.id;var c="",p=RED.nodes.subflow(RED.workspaces.active());if(p&&(c=p.id),null==l){l={id:RED.nodes.id(),_def:d,type:o,z:c,users:[]};for(var u in d.defaults)d.defaults[u].value&&(l[u]=JSON.parse(JSON.stringify(d.defaults[u].value)));l._=d._}e.push(l),RED.view.state(RED.state.EDITING);var m={title:g(),resize:function(){if(l&&l._def.oneditresize){var e=$("#node-config-dialog-edit-form");try{l._def.oneditresize.call(l,{width:e.width(),height:e.height()})}catch(e){console.log("oneditresize",l.id,l.type,e.toString())}}},open:function(e,t){e.find(".editor-tray-header");var n=e.find(".editor-tray-footer");!1!==d.hasUsers&&n.prepend('<div id="node-config-dialog-user-count"><i class="fa fa-info-circle"></i> <span></span></div>'),n.append('<span id="node-config-dialog-scope-container"><span id="node-config-dialog-scope-warning" data-i18n="[title]editor.errors.scopeChange"><i class="fa fa-warning"></i></span><select id="node-config-dialog-scope"></select></span>');var a=v(e.find(".editor-tray-body"),"node-config-dialog-edit-form",o,s);h(l,d,"node-config-input",function(){l._def.exclusive?$("#node-config-dialog-scope").hide():$("#node-config-dialog-scope").show(),$("#node-config-dialog-scope-warning").hide();var e={};l.users.forEach(function(t){e[t.z]=!0});var n=Object.keys(e).length,o=$("#node-config-dialog-scope").empty();o.off("change"),o.append('<option value=""'+(l.z?"":" selected")+' data-i18n="sidebar.config.global"></option>'),o.append('<option disabled data-i18n="sidebar.config.flows"></option>'),RED.nodes.eachWorkspace(function(t){var n=t.label;e[t.id]&&(n="* "+n),o.append('<option value="'+t.id+'"'+(t.id==l.z?" selected":"")+">"+n+"</option>")}),o.append('<option disabled data-i18n="sidebar.config.subflows"></option>'),RED.nodes.eachSubflow(function(t){var n=t.name;e[t.id]&&(n="* "+n),o.append('<option value="'+t.id+'"'+(t.id==l.z?" selected":"")+">"+n+"</option>")}),n>0&&o.on("change",function(){var t=$(this).val();""===t?$("#node-config-dialog-scope-warning").hide():!e[t]||n>1?$("#node-config-dialog-scope-warning").show():$("#node-config-dialog-scope-warning").hide()}),o.i18n(),a.i18n(),!1!==d.hasUsers&&$("#node-config-dialog-user-count").find("span").html(RED._("editor.nodesUse",{count:l.users.length})).parent().show(),t()})},close:function(){RED.workspaces.refresh(),e.pop()},show:function(){l&&RED.sidebar.info.refresh(l)}};m.buttons=[{id:"node-config-dialog-cancel",text:RED._("common.label.cancel"),click:function(){var e=o,t=l.id,n=RED.nodes.getType(e);if(n.oneditcancel&&n.oneditcancel){var a=RED.nodes.node(t);if(a)try{n.oneditcancel.call(a,!1)}catch(e){console.log("oneditcancel",a.id,a.type,e.toString())}else try{n.oneditcancel.call({id:t},!0)}catch(n){console.log("oneditcancel",t,e,n.toString())}}RED.tray.close()}},{id:"node-config-dialog-ok",text:r?RED._("editor.configAdd"):RED._("editor.configUpdate"),class:"primary",click:function(){var e,a,s=t,d=(l.id,o),c=r,p=RED.nodes.getType(d),u=$("#node-config-dialog-scope").val();if(p.oneditsave)try{p.oneditsave.call(l)}catch(e){console.log("oneditsave",l.id,l.type,e.toString())}for(e in p.defaults){var h;if(p.defaults.hasOwnProperty(e))if(null!=(h="checkbox"===(a=$("#node-config-input-"+e)).attr("type")?a.prop("checked"):"format"in p.defaults[e]&&""!==p.defaults[e].format&&"DIV"===a[0].nodeName?a.text():a.val())&&h!==l[e]){if(l._def.defaults[e].type){"_ADD_"==h&&(h="");var g=RED.nodes.node(l[e]);if(g){var v=g.users;v.splice(v.indexOf(l),1)}(g=RED.nodes.node(h))&&g.users.push(l)}l[e]=h}}l.label=p.label,l.z=u,u&&(l.users=l.users.filter(function(e){var t=!0;for(var o in e._def.defaults)e._def.defaults.hasOwnProperty(o)&&e._def.defaults[o].type===l.type&&e[o]===l.id&&e.z!==u&&(t=!1,e[o]=null,e.dirty=!0,e.changed=!0,n(e));return t})),c&&RED.nodes.add(l),p.credentials&&f(l,p.credentials,"node-config-input"),n(l);var m={};m[l.id]=!0;for(var b=l.users.slice();b.length>0;){var y=b.pop();m[y.id]||(m[y.id]=!0,y.users&&(b=b.concat(y.users)),n(y))}RED.nodes.dirty(!0),RED.view.redraw(!0),c||RED.events.emit("editor:save",l),RED.tray.close(function(){E(s,d,l.id,i)})}}],r||m.buttons.unshift({class:"leftButton",text:RED._("editor.configDelete"),click:function(){var e=t,a=l.id,s=o,r=RED.nodes.getType(s);try{r.ondelete&&(console.log("Deprecated API warning: config node type ",s," has an ondelete function - should be oneditdelete"),r.ondelete.call(l)),r.oneditdelete&&r.oneditdelete.call(l)}catch(e){console.log("oneditdelete",l.id,l.type,e.toString())}for(var d={t:"delete",nodes:[l],changes:{},dirty:RED.nodes.dirty()},c=0;c<l.users.length;c++){var p=l.users[c];d.changes[p.id]={changed:p.changed,valid:p.valid};for(var u in p._def.defaults)p._def.defaults.hasOwnProperty(u)&&p[u]==a&&(d.changes[p.id][u]=a,p[u]="",p.changed=!0,p.dirty=!0);n(p)}RED.nodes.remove(a),RED.nodes.dirty(!0),RED.view.redraw(!0),RED.history.push(d),RED.tray.close(function(){E(e,s,"",i)})}}),RED.tray.show(m)}function D(e,t){return e.__label__<t.__label__?-1:e.__label__>t.__label__?1:0}function E(e,t,n,o){if(o){var a=$("#"+o+"-edit-"+e);if(a.length)n?a.text(RED._("editor.configEdit")):a.text(RED._("editor.configAdd")),$("#"+o+"-"+e).val(n);else{var i=$("#"+o+"-"+e),s=RED.nodes.getType(t);i.children().remove();var r=RED.nodes.workspace(RED.workspaces.active());r||(r=RED.nodes.subflow(RED.workspaces.active()));var d=[];RED.nodes.eachConfig(function(e){if(e.type==t&&(!e.z||e.z===r.id)){var n=RED.utils.getNodeLabel(e,e.id);e.__label__=n,d.push(e)}});var l=D;"function"==typeof s.sort&&(l=s.sort);try{d.sort(l)}catch(e){console.log("Definition error: "+s.type+".sort",e)}d.forEach(function(e){i.append('<option value="'+e.id+'"'+(n==e.id?" selected":"")+">"+RED.text.bidi.enforceTextDirectionWithUCC(e.__label__)+"</option>"),delete e.__label__}),i.append('<option value="_ADD_"'+(""===n?" selected":"")+">"+RED._("editor.addNewType",{type:t})+"</option>"),window.setTimeout(function(){i.change()},50)}}}var R={};return{init:function(){RED.tray.init(),RED.actions.add("core:confirm-edit-tray",function(){$("#node-dialog-ok").click(),$("#node-config-dialog-ok").click()}),RED.actions.add("core:cancel-edit-tray",function(){$("#node-dialog-cancel").click(),$("#node-config-dialog-cancel").click()})},edit:function(o){var a,i,s=o;e.push(o),RED.view.state(RED.state.EDITING);var d=o.type;"subflow:"==o.type.substring(0,8)&&(d="subflow");var l={title:g(),buttons:[{id:"node-dialog-delete",class:"leftButton",text:RED._("common.label.delete"),click:function(){var e=RED.nodes.dirty(),t=[],n=[],o=RED.nodes.remove(s.id);t.push(s);var a={t:"delete",nodes:t=t.concat(o.nodes),links:n=n.concat(o.links),changes:{},dirty:e};RED.nodes.dirty(!0),RED.view.redraw(!0),RED.history.push(a),RED.tray.close()}},{id:"node-dialog-cancel",text:RED._("common.label.cancel"),click:function(){if(s._def){if(s._def.oneditcancel)try{s._def.oneditcancel.call(s)}catch(e){console.log("oneditcancel",s.id,s.type,e.toString())}for(var e in s._def.defaults)if(s._def.defaults.hasOwnProperty(e)){var t=s._def.defaults[e];if(t.type){var n=RED.nodes.getType(t.type);if(n&&n.exclusive){var o=$("#node-input-"+e).val()||"";""===o||s[e]||RED.nodes.remove(o)}}}}RED.tray.close()}},{id:"node-dialog-ok",text:RED._("common.label.done"),class:"primary",click:function(){var e,t,o,d={},l=!1,c=RED.nodes.dirty();if(s._def.oneditsave){var p={};for(e in s._def.defaults)s._def.defaults.hasOwnProperty(e)&&("string"==typeof s[e]||"number"==typeof s[e]?p[e]=s[e]:p[e]=$.extend(!0,{},{v:s[e]}).v);try{!0===s._def.oneditsave.call(s)&&(l=!0)}catch(e){console.log("oneditsave",s.id,s.type,e.toString())}for(e in s._def.defaults)s._def.defaults.hasOwnProperty(e)&&(null===p[e]||"string"==typeof p[e]||"number"==typeof p[e]?p[e]!==s[e]&&(d[e]=p[e],l=!0):JSON.stringify(p[e])!==JSON.stringify(s[e])&&(d[e]=p[e],l=!0))}if(s._def.defaults)for(e in s._def.defaults)if(s._def.defaults.hasOwnProperty(e)){var u=$("#node-input-"+e);if(null!=(o="checkbox"===u.attr("type")?u.prop("checked"):"format"in s._def.defaults[e]&&""!==s._def.defaults[e].format&&"DIV"===u[0].nodeName?u.text():u.val())){if("outputs"===e){if(""===o.trim())continue;if(isNaN(o)){t=JSON.parse(o);var h=0,g=!1;Object.keys(t).forEach(function(e){isNaN(e)?(h++,delete t[e]):(t[e]=t[e]+"","-1"!==t[e]?(h++,t[e]!==e?g=!0:delete t[e]):g=!0)}),o=h,g&&(l=!0)}else o=parseInt(o)}if(s[e]!=o){if(s._def.defaults[e].type){"_ADD_"==o&&(o="");var v=RED.nodes.node(s[e]);if(v){var m=v.users;m.splice(m.indexOf(s),1)}(v=RED.nodes.node(o))&&v.users.push(s)}d[e]=s[e],s[e]=o,l=!0}}}if(s._def.credentials){var b=s._def.credentials,y=f(s,b,"node-input");l=l||y}var w=r(s,t),D=$("#node-label-form-inputs").children().find("input"),E=$("#node-label-form-outputs").children().find("input"),R=!1;if(o=D.map(function(){var e=$(this).val();return R=R||""!==e,e}).toArray().slice(0,s.inputs),(void 0===s.inputLabels&&R||void 0!==s.inputLabels&&JSON.stringify(o)!==JSON.stringify(s.inputLabels))&&(d.inputLabels=s.inputLabels,s.inputLabels=o,l=!0),R=!1,o=new Array(s.outputs),E.each(function(){var e=$(this).attr("id").substring(23);if(!t||!t.hasOwnProperty(e)||-1!==(e=parseInt(t[e]))){var n=$(this).val();R=R||""!==n,o[e]=n}}),(void 0===s.outputLabels&&R||void 0!==s.outputLabels&&JSON.stringify(o)!==JSON.stringify(s.outputLabels))&&(d.outputLabels=s.outputLabels,s.outputLabels=o,l=!0),!s._def.defaults||!s._def.defaults.hasOwnProperty("icon")){var x=$("#node-settings-icon-module-hidden").val(),T=$("#node-settings-icon-file-hidden").val(),k=x&&T?x+"/"+T:"";if(a)if(k!==i)d.icon=s.icon,s.icon=k,l=!0;else{var _=RED.utils.getDefaultNodeIcon(s._def,s),C=_.module+"/"+_.file;i!==C&&(d.icon=s.icon,s.icon=C,l=!0)}else k!==s.icon&&(d.icon=s.icon,s.icon=k,l=!0)}if(l){var j=s.changed;s.changed=!0,RED.nodes.dirty(!0);var S=null;RED.nodes.subflow(RED.workspaces.active())&&(S=[],RED.nodes.eachNode(function(e){e.type=="subflow:"+RED.workspaces.active()&&(S.push({id:e.id,changed:e.changed}),e.changed=!0,e.dirty=!0,r(e))}));var O={t:"edit",node:s,changes:d,links:w,dirty:c,changed:j};t&&(O.outputMap=t),S&&(O.subflow={instances:S}),RED.history.push(O)}s.dirty=!0,n(s),RED.events.emit("editor:save",s),RED.tray.close()}}],resize:function(e){t[d]=e.width,$(".editor-tray-content").height(e.height-78);var n=$(".editor-tray-content form").height(e.height-78-40);if(s&&s._def.oneditresize)try{s._def.oneditresize.call(s,{width:n.width(),height:n.height()})}catch(e){console.log("oneditresize",s.id,s.type,e.toString())}},open:function(e,t){e.find(".editor-tray-footer");var n=e.find(".editor-tray-body");n.parent().css("overflow","hidden");var r=RED.stack.create({container:n,singleExpanded:!0}),l=r.add({title:RED._("editor.nodeProperties"),expanded:!0});l.content.addClass("editor-tray-content");var c,p=r.add({title:RED._("editor.portLabels"),onexpand:function(){!function(e,t){var n,o,a=t._def.inputLabels?RED._("editor.defaultLabel"):RED._("editor.noDefaultLabel"),i=t._def.outputLabels?RED._("editor.defaultLabel"):RED._("editor.noDefaultLabel"),s=$("#node-label-form-inputs"),r=$("#node-label-form-outputs"),d=t.inputs||t._def.inputs||0,l=s.children(),c=l.length;if(1===c&&$(l[0]).hasClass("node-label-form-none")&&c--,c<d)for(0===c&&$(l[0]).remove(),o=c;o<d;o++)m("input",o,"",a).appendTo(s);else if(c>d){for(o=d;o<c;o++)$(l[o]).remove();0===n&&m().appendTo(s)}var p=$("#node-input-outputs").val();if(void 0===p)n=t.outputs||t._def.outputs||0;else if(isNaN(p)){var u=JSON.parse(p),f=Object.keys(u);l=r.children(),1===(c=l.length)&&$(l[0]).hasClass("node-label-form-none")&&c--,n=0;var h=[];f.forEach(function(e){var t=$("#node-label-form-output-"+e).parent();0===t.length&&-1!==u[e]?(0===c&&($(l[0]).remove(),c=-1),t=m("output",e,"",i)):t.detach(),-1!==u[e]&&(n++,h.push({i:parseInt(u[e]),r:t}))}),h.sort(function(e,t){return e.i-t.i}),h.forEach(function(e,t){e.r.find("label").html(t+1+"."),e.r.appendTo(r)}),0===h.length&&m("output",o,"").appendTo(r)}else n=Math.max(0,parseInt(p));if(l=r.children(),1===(c=l.length)&&$(l[0]).hasClass("node-label-form-none")&&c--,c<n)for(0===c&&$(l[0]).remove(),o=c;o<n;o++)m("output",o,"").appendTo(r);else if(c>n){for(o=n;o<c;o++)$(l[o]).remove();0===n&&m().appendTo(r)}}(this.content,o)}});p.content.addClass("editor-tray-content"),s&&RED.sidebar.info.refresh(s),c="node-red"===o._def.set.module?"node-red":o._def.set.id;var u=RED.utils.getDefaultNodeIcon(o._def,o);i=u.module+"/"+u.file,a=!o.icon||o.icon===i,v(l.content,"dialog-form",d,c),b(p.content,o),h(o,o._def,"node-input",function(){n.i18n(),t()})},close:function(){RED.view.state()!=RED.state.IMPORT_DRAGGING&&RED.view.state(RED.state.DEFAULT),s&&RED.sidebar.info.refresh(s),RED.workspaces.refresh(),RED.view.redraw(!0),e.pop()},show:function(){s&&RED.sidebar.info.refresh(s)}};if(t.hasOwnProperty(d)&&(l.width=t[d]),"subflow"===d){var c=s.type.substring(8);l.buttons.unshift({class:"leftButton",text:RED._("subflow.edit"),click:function(){RED.workspaces.show(c),$("#node-dialog-ok").click()}})}RED.tray.show(l)},editConfig:w,editSubflow:function(t){var n,o=t;e.push(t),RED.view.state(RED.state.EDITING);var a={title:g(),buttons:[{id:"node-dialog-cancel",text:RED._("common.label.cancel"),click:function(){RED.tray.close()}},{id:"node-dialog-ok",class:"primary",text:RED._("common.label.done"),click:function(){var e={},t=!1,a=RED.nodes.dirty(),i=$("#subflow-input-name").val();i!=o.name&&(e.name=o.name,o.name=i,t=!0);var s=n.getValue();s!=o.info&&(e.info=o.info,o.info=s,t=!0);var d=$("#node-label-form-inputs").children().find("input"),l=$("#node-label-form-outputs").children().find("input"),c=d.map(function(){return $(this).val()}).toArray().slice(0,o.inputs);if(JSON.stringify(c)!==JSON.stringify(o.inputLabels)&&(e.inputLabels=o.inputLabels,o.inputLabels=c,t=!0),c=l.map(function(){return $(this).val()}).toArray().slice(0,o.outputs),JSON.stringify(c)!==JSON.stringify(o.outputLabels)&&(e.outputLabels=o.outputLabels,o.outputLabels=c,t=!0),RED.palette.refresh(),t){var p=[];RED.nodes.eachNode(function(e){e.type=="subflow:"+o.id&&(p.push({id:e.id,changed:e.changed}),e.changed=!0,e.dirty=!0,r(e))});var u=o.changed;o.changed=!0,RED.nodes.dirty(!0);var f={t:"edit",node:o,changes:e,dirty:a,changed:u,subflow:{instances:p}};RED.history.push(f)}o.dirty=!0,RED.tray.close()}}],resize:function(e){$(".editor-tray-content").height(e.height-78),$(".editor-tray-content form").height(e.height-78-40);for(var t=$("#dialog-form>div:not(.node-text-editor-row)"),o=($("#dialog-form>div.node-text-editor-row"),$("#dialog-form").height()),a=0;a<t.size();a++)o-=$(t[a]).outerHeight(!0);o-=parseInt($("#dialog-form").css("marginTop"))+parseInt($("#dialog-form").css("marginBottom")),$(".node-text-editor").css("height",o+"px"),n.resize()},open:function(e){e.find(".editor-tray-footer");var a=e.find(".editor-tray-body");a.parent().css("overflow","hidden");var i=RED.stack.create({container:a,singleExpanded:!0}),s=i.add({title:RED._("editor.nodeProperties"),expanded:!0});s.content.addClass("editor-tray-content");var r=i.add({title:RED._("editor.portLabels")});r.content.addClass("editor-tray-content"),o&&RED.sidebar.info.refresh(o),v(s.content,"dialog-form","subflow-template"),n=RED.editor.createEditor({id:"subflow-input-info-editor",mode:"ace/mode/markdown",value:""}),$("#subflow-input-name").val(t.name),RED.text.bidi.prepareInput($("#subflow-input-name")),n.getSession().setValue(t.info||"",-1);var d=0,l="subflow:"+o.id;RED.nodes.eachNode(function(e){e.type===l&&d++}),$("#subflow-dialog-user-count").html(RED._("subflow.subflowInstances",{count:d})).show(),b(r.content,t),a.i18n()},close:function(){RED.view.state()!=RED.state.IMPORT_DRAGGING&&RED.view.state(RED.state.DEFAULT),RED.sidebar.info.refresh(o),RED.workspaces.refresh(),n.destroy(),e.pop(),o=null},show:function(){}};RED.tray.show(a)},editExpression:function(n){var o="_";e.length>0&&(o=e[e.length-1].id);var a,i,s,r,d=n.value,l=n.complete,c="_expression";e.push({type:c}),RED.view.state(RED.state.EDITING);var p={title:g(),width:"inherit",buttons:[{id:"node-dialog-cancel",text:RED._("common.label.cancel"),click:function(){RED.tray.close()}},{id:"node-dialog-ok",text:RED._("common.label.done"),class:"primary",click:function(){$("#node-input-expression-help").html(""),l(a.getValue()),RED.tray.close()}}],resize:function(e){e&&(t[c]=e.width);var n=$("#dialog-form").height();r&&r.resize(n)},open:function(e){e.find(".editor-tray-body").addClass("node-input-expression-editor");var t=v(e.find(".editor-tray-body"),"dialog-form","_expression","editor"),n=$("#node-input-expression-func");Object.keys(jsonata.functions).forEach(function(e){n.append($("<option></option>").val(e).text(e))}),n.change(function(e){var t=$(this).val(),n="<h5>"+t+"("+RED._("jsonata:"+t+".args",{defaultValue:""})+")</h5>",o=marked(RED._("jsonata:"+t+".desc",{defaultValue:""}));$("#node-input-expression-help").html(n+"<p>"+o+"</p>")});var l=null,c=-1;(a=RED.editor.createEditor({id:"node-input-expression",value:"",mode:"ace/mode/jsonata",options:{enableBasicAutocompletion:!0,enableSnippets:!0,enableLiveAutocompletion:!0}})).getSession().setValue(d||"",-1),a.on("changeSelection",function(){var e=a.getCursorPosition(),t=a.getSession().getTokenAt(e.row,e.column);if(t!==l||t&&/paren/.test(t.type)&&e.column!==c){var o,i;l=t;var s=null;if(t&&"keyword"===t.type)o=e.row,s=t;else{var r=0,d=!1;for(t?("paren.rparen"===t.type&&(c=e.column,r=e.column-(t.start+t.value.length)),o=e.row,i=t.index):(o=e.row-1,i=-1);null===s&&o>-1;){var p=a.getSession().getTokens(o);for(-1===i&&(i=p.length-1);i>-1;){var u=p[i].type;if(d){if("keyword"===u){s=p[i];break}d=!1}"paren.lparen"===u?r-=p[i].value.length:"paren.rparen"===u&&(r+=p[i].value.length),r<0&&(d=!0,r=0),i--}s||o--}}a.session.removeMarker(null),s&&n.val(s.value).change()}}),t.i18n(),$("#node-input-expression-func-insert").click(function(e){e.preventDefault(),a.getCursorPosition();var t=n.val(),o=jsonata.getFunctionSnippet(t);a.insertSnippet(o),a.focus()}),$("#node-input-expression-reformat").click(function(e){e.preventDefault();var t=a.getValue()||"";try{t=jsonata.format(t)}catch(e){}a.getSession().setValue(t||"",-1)});var u,f=RED.tabs.create({element:$("#node-input-expression-tabs"),onchange:function(e){$(".node-input-expression-tab-content").hide(),e.content.show(),p.resize()}});f.addTab({id:"expression-help",label:RED._("expressionEditor.functionReference"),content:$("#node-input-expression-tab-help")}),f.addTab({id:"expression-tests",label:RED._("expressionEditor.test"),content:$("#node-input-expression-tab-test")}),i=RED.editor.createEditor({id:"node-input-expression-test-data",value:R[o]||'{\n    "payload": "hello world"\n}',mode:"ace/mode/json",lineNumbers:!1}),$(".node-input-expression-legacy").click(function(e){e.preventDefault(),RED.sidebar.info.set(RED._("expressionEditor.compatModeDesc")),RED.sidebar.info.show()});var h=function(){var e,t,n=i.getValue(),o=a.getValue(),r=!1,d=/(^|[^a-zA-Z0-9_'"])msg([^a-zA-Z0-9_'"]|$)/.test(o);$(".node-input-expression-legacy").toggle(d);try{(t=jsonata(o)).assign("flowContext",function(e){return r=!0,null}),t.assign("globalContext",function(e){return r=!0,null})}catch(e){return void s.setValue(RED._("expressionEditor.errors.invalid-expr",{message:e.message}),-1)}try{e=JSON.parse(n)}catch(e){return void s.setValue(RED._("expressionEditor.errors.invalid-msg",{message:e.toString()}))}try{var l,c=t.evaluate(d?{msg:e}:e);if(r)return void s.setValue(RED._("expressionEditor.errors.context-unsupported"),-1);l=void 0!==c?JSON.stringify(c,null,4):RED._("expressionEditor.noMatch"),s.setValue(l,-1)}catch(e){s.setValue(RED._("expressionEditor.errors.eval",{message:e.message}),-1)}};i.getSession().on("change",function(){clearTimeout(u),u=setTimeout(h,200),R[o]=i.getValue()}),a.getSession().on("change",function(){clearTimeout(u),u=setTimeout(h,200)}),s=RED.editor.createEditor({id:"node-input-expression-test-result",value:"",mode:"ace/mode/json",lineNumbers:!1,readOnly:!0}),r=RED.panels.create({id:"node-input-expression-panels",resize:function(e,t){var n=$("#node-input-expression-panel-expr");e-=$(n.children()[0]).outerHeight(!0);var o=$(n.children()[1]);e-=parseInt(o.css("marginTop"))+parseInt(o.css("marginBottom")),$("#node-input-expression").css("height",e-5+"px"),a.resize(),t-=$("#node-input-expression-panel-info > .form-row > div:first-child").outerHeight(!0)+20,$(".node-input-expression-tab-content").height(t),$("#node-input-expression-test-data").css("height",t-5+"px"),i.resize(),$("#node-input-expression-test-result").css("height",t-5+"px"),s.resize()}}),$("#node-input-example-reformat").click(function(e){e.preventDefault();var t=i.getValue()||"";try{t=JSON.stringify(JSON.parse(t),null,4)}catch(e){}i.getSession().setValue(t||"",-1)}),h()},close:function(){e.pop(),a.destroy(),i.destroy()},show:function(){}};RED.tray.show(p)},editJSON:function(n){var o,a,i=n.value,s=n.complete;e.push({type:"_json"}),RED.view.state(RED.state.EDITING);var r=function(){var e=o.getValue();try{return JSON.parse(e),$("#node-dialog-ok").removeClass("disabled"),!0}catch(e){return $("#node-dialog-ok").addClass("disabled"),!1}},d={title:n.title||g(),width:"inherit",buttons:[{id:"node-dialog-cancel",text:RED._("common.label.cancel"),click:function(){RED.tray.close()}},{id:"node-dialog-ok",text:RED._("common.label.done"),class:"primary",click:function(){n.requireValid&&!r()||(s(o.getValue()),RED.tray.close())}}],resize:function(e){t._json=e.width;for(var n=$("#dialog-form>div:not(.node-text-editor-row)"),a=($("#dialog-form>div.node-text-editor-row"),$("#dialog-form").height()),i=0;i<n.size();i++)a-=$(n[i]).outerHeight(!0);a-=parseInt($("#dialog-form").css("marginTop"))+parseInt($("#dialog-form").css("marginBottom")),$(".node-text-editor").css("height",a+"px"),o.resize()},open:function(e){e.find(".editor-tray-body");var t=v(e.find(".editor-tray-body"),"dialog-form","_json","editor");(o=RED.editor.createEditor({id:"node-input-json",value:"",mode:"ace/mode/json"})).getSession().setValue(i||"",-1),n.requireValid&&(o.getSession().on("change",function(){clearTimeout(a),a=setTimeout(r,200)}),r()),$("#node-input-json-reformat").click(function(e){e.preventDefault();var t=o.getValue()||"";try{t=JSON.stringify(JSON.parse(t),null,4)}catch(e){}o.getSession().setValue(t||"",-1)}),t.i18n()},close:function(){e.pop(),o.destroy()},show:function(){}};RED.tray.show(d)},editMarkdown:function(n){var o,a=n.value,i=n.complete,s="_markdown";e.push({type:s}),RED.view.state(RED.state.EDITING);var r={title:n.title||g(),width:"inherit",buttons:[{id:"node-dialog-cancel",text:RED._("common.label.cancel"),click:function(){RED.tray.close()}},{id:"node-dialog-ok",text:RED._("common.label.done"),class:"primary",click:function(){i(o.getValue()),RED.tray.close()}}],resize:function(e){t[s]=e.width;for(var n=$("#dialog-form>div:not(.node-text-editor-row)"),a=($("#dialog-form>div.node-text-editor-row"),$("#dialog-form").height()),i=0;i<n.size();i++)a-=$(n[i]).outerHeight(!0);a-=parseInt($("#dialog-form").css("marginTop"))+parseInt($("#dialog-form").css("marginBottom")),$(".node-text-editor").css("height",a+"px"),o.resize()},open:function(e){e.find(".editor-tray-body");var t=v(e.find(".editor-tray-body"),"dialog-form",s,"editor");o=RED.editor.createEditor({id:"node-input-markdown",value:a,mode:"ace/mode/markdown"}),n.header&&n.header.appendTo(e.find("#node-input-markdown-title")),t.i18n()},close:function(){e.pop(),o.destroy()},show:function(){}};RED.tray.show(r)},editBuffer:function(n){var o=n.value,a=n.complete,i="_buffer";e.push({type:i}),RED.view.state(RED.state.EDITING);var s,r,d=[],l={title:g(),width:"inherit",buttons:[{id:"node-dialog-cancel",text:RED._("common.label.cancel"),click:function(){RED.tray.close()}},{id:"node-dialog-ok",text:RED._("common.label.done"),class:"primary",click:function(){a(JSON.stringify(s)),RED.tray.close()}}],resize:function(e){e&&(t[i]=e.width);var n=$("#dialog-form").height();r&&r.resize(n)},open:function(e){e.find(".editor-tray-body");var t,n=v(e.find(".editor-tray-body"),"dialog-form",i,"editor");(d=RED.editor.createEditor({id:"node-input-buffer-str",value:"",mode:"ace/mode/text"})).getSession().setValue(o||"",-1),bufferBinEditor=RED.editor.createEditor({id:"node-input-buffer-bin",value:"",mode:"ace/mode/text",readOnly:!0});var a=function(e){var t=!0,n="string"==typeof e,o=[],a=0,i=(s=n?function(e){var t=[],n=0,o=e.length;for(n=0;n<o;n++){var a=e.charCodeAt(n);a<128?t.push(a):a<2048?(t.push(192|a>>6),t.push(128|63&a)):a<55296||a>=57344?(t.push(224|a>>12),t.push(128|a>>6&63),t.push(128|63&a)):(n++,a=65536+((1023&a)<<10|1023&e.charAt(n)),t.push(240|a>>18),t.push(128|a>>12&63),t.push(128|a>>6&63),t.push(128|63&a))}return t}(e):e).length;for(a=0;a<i;a++){var r=parseInt(s[a]);if(!n&&(isNaN(r)||r<0||r>255)){t=!1;break}a>0&&(a%8==0?a%16==0?o.push("\n"):o.push("  "):o.push(" ")),o.push((r<16?"0":"")+r.toString(16).toUpperCase())}return t&&($("#node-input-buffer-type-string").toggle(n),$("#node-input-buffer-type-array").toggle(!n),bufferBinEditor.setValue(o.join(""),1)),t},l=function(){var e=d.getValue(),t=!1;if(/^[\s]*\[[\s\S]*\][\s]*$/.test(e)){t=!0;try{var n=JSON.parse(e);t=a(n)}catch(e){t=!1}}t||a(e)};d.getSession().on("change",function(){clearTimeout(t),t=setTimeout(l,200)}),l(),n.i18n(),r=RED.panels.create({id:"node-input-buffer-panels",resize:function(e,t){var n=$("#node-input-buffer-panel-str");e-=$(n.children()[0]).outerHeight(!0);var o=$(n.children()[1]);e-=parseInt(o.css("marginTop"))+parseInt(o.css("marginBottom")),$("#node-input-buffer-str").css("height",e-5+"px"),d.resize();var a=$("#node-input-buffer-panel-bin");o=$(a.children()[0]),t-=parseInt(o.css("marginTop"))+parseInt(o.css("marginBottom")),$("#node-input-buffer-bin").css("height",t-5+"px"),bufferBinEditor.resize()}}),$(".node-input-buffer-type").click(function(e){e.preventDefault(),RED.sidebar.info.set(RED._("bufferEditor.modeDesc")),RED.sidebar.info.show()})},close:function(){e.pop(),d.destroy(),bufferBinEditor.destroy()},show:function(){}};RED.tray.show(l)},validateNode:n,updateNodeProperties:r,createEditor:function(e){var t=ace.edit(e.id||e.element);t.setTheme("ace/theme/tomorrow");var n=t.getSession();return n.on("changeAnnotation",function(){for(var e=n.getAnnotations()||[],t=e.length,o=e.length;t--;)/doctype first\. Expected/.test(e[t].text)?e.splice(t,1):/Unexpected End of file\. Expected/.test(e[t].text)&&e.splice(t,1);o>e.length&&n.setAnnotations(e)}),e.mode&&n.setMode(e.mode),e.foldStyle?n.setFoldStyle(e.foldStyle):n.setFoldStyle("markbeginend"),e.options?t.setOptions(e.options):t.setOptions({enableBasicAutocompletion:!0,enableSnippets:!0}),e.readOnly&&(t.setOption("readOnly",e.readOnly),t.container.classList.add("ace_read-only")),e.hasOwnProperty("lineNumbers")&&t.renderer.setOption("showGutter",e.lineNumbers),t.$blockScrolling=1/0,e.value&&n.setValue(e.value,-1),e.globals&&setTimeout(function(){n.$worker&&n.$worker.send("setOptions",[{globals:e.globals,esversion:6,sub:!0,asi:!0,maxerr:1e3}])},100),t}}}(),RED.tray=function(){var e=[],t=$("#editor-stack"),n=!1;function o(o){var i=$('<div class="editor-tray"></div>'),s=$('<div class="editor-tray-header"></div>').appendTo(i),r=$('<div class="editor-tray-body-wrapper"></div>').appendTo(i),d=$('<div class="editor-tray-body"></div>').appendTo(r),l=$('<div class="editor-tray-footer"></div>').appendTo(i),c=$('<div class="editor-tray-resize-handle"></div>').appendTo(i);if(o.title){var p=e.map(function(e){return e.options.title});p.push(o.title);var u='<ul class="editor-tray-breadcrumbs"><li>'+p.join("</li><li>")+"</li></ul>";$('<div class="editor-tray-titlebar">'+u+"</div>").appendTo(s)}o.width===1/0&&(o.maximized=!0,c.addClass("editor-tray-resize-maximised"));var f,h=$('<div class="editor-tray-toolbar"></div>').appendTo(s);if(o.buttons)for(var g=0;g<o.buttons.length;g++){var v=o.buttons[g],m=$("<button>").button().appendTo(h);v.id&&m.attr("id",v.id),v.text&&m.html(v.text),v.click&&m.click(function(e){return function(t){$(this).hasClass("disabled")||e(t)}}(v.click)),v.class&&(m.addClass(v.class),"primary"===v.class&&(f=v))}i.appendTo(t);var b={tray:i,header:s,body:d,footer:l,options:o,primaryButton:f};function y(){$("#header-shade").show(),$("#editor-shade").show(),$("#palette-shade").show(),$(".sidebar-shade").show(),b.preferredWidth=Math.max(i.width(),500),o.maximized||d.css({minWidth:b.preferredWidth-40}),o.width?(o.width>$("#editor-stack").position().left-8&&(o.width=$("#editor-stack").position().left-8),i.width(o.width)):i.width(b.preferredWidth),b.width=i.width(),b.width>$("#editor-stack").position().left-8&&(b.width=Math.max(0,$("#editor-stack").position().left-8),i.width(b.width)),i.css({right:-(i.width()+10)+"px",transition:"right 0.25s ease"}),$("#workspace").scrollLeft(0),a(),n=!0,setTimeout(function(){setTimeout(function(){o.width||i.width(Math.min(b.preferredWidth,$("#editor-stack").position().left-8)),o.resize&&o.resize({width:i.width()}),o.show&&o.show(),setTimeout(function(){n=!1},200),d.find(":focusable:first").focus()},150),i.css({right:0})},0)}e.push(b),o.maximized||i.draggable({handle:c,axis:"x",start:function(e,t){i.width("auto")},drag:function(e,n){var o=t.position().left+n.position.left;o<7?n.position.left+=7-o:n.position.left>-b.preferredWidth-1&&(n.position.left=-Math.min(t.position().left-7,b.preferredWidth-1)),b.options.resize&&setTimeout(function(){b.options.resize({width:-n.position.left})},0),b.width=-n.position.left},stop:function(e,t){i.width(-t.position.left),i.css({left:""}),b.options.resize&&b.options.resize({width:-t.position.left}),b.width=-t.position.left}}),o.open?1===o.open.length?(o.open(i),y()):o.open(i,y):y()}function a(){if(e.length>0){var t=e[e.length-1],n=t.tray.height()-t.header.outerHeight()-t.footer.outerHeight();t.body.height(n),t.options.maximized||t.width>$("#editor-stack").position().left-8?(t.width=$("#editor-stack").position().left-8,t.tray.width(t.width)):t.width<t.preferredWidth&&(t.width=Math.min($("#editor-stack").position().left-8,t.preferredWidth),t.tray.width(t.width)),t.options.resize&&t.options.resize({width:t.width,height:n})}}return{init:function(){$(window).resize(a),RED.events.on("sidebar:resize",a),$("#editor-shade").click(function(){if(!n){var t=e[e.length-1];t&&t.primaryButton&&t.primaryButton.click()}})},show:function(t){if(e.length>0&&!t.overlay){var n=e[e.length-1];"inherit"===t.width&&(t.width=n.tray.width()),n.tray.css({right:-(n.tray.width()+10)+"px"}),setTimeout(function(){n.tray.detach(),o(t)},250)}else RED.events.emit("editor:open"),o(t)},close:function(t){if(e.length>0){var n=e.pop();n.tray.css({right:-(n.tray.width()+10)+"px"}),setTimeout(function(){if(n.options.close&&n.options.close(),n.tray.remove(),e.length>0){var o=e[e.length-1];o.options.overlay?(a(),o.options.show&&o.options.show()):(o.tray.appendTo("#editor-stack"),setTimeout(function(){a(),o.tray.css({right:0}),o.options.show&&o.options.show()},0))}t&&t(),0===e.length&&($("#header-shade").hide(),$("#editor-shade").hide(),$("#palette-shade").hide(),$(".sidebar-shade").hide(),RED.events.emit("editor:close"),RED.view.focus())},250)}}}}(),RED.clipboard=function(){var e,t,n,o,a=!1;function i(){var e=$("#clipboard-import"),t=e.val();t=t.substring(t.indexOf("["),t.lastIndexOf("]")+1);try{JSON.parse(t),e.removeClass("input-error"),e.val(t),$("#clipboard-dialog-ok").button("enable")}catch(n){""!==t&&e.addClass("input-error"),$("#clipboard-dialog-ok").button("disable")}}function s(){a||(t.empty(),t.append($(o)),t.i18n(),$("#clipboard-dialog-ok").show(),$("#clipboard-dialog-cancel").show(),$("#clipboard-dialog-close").hide(),$("#clipboard-dialog-copy").hide(),$("#clipboard-dialog-ok").button("disable"),$("#clipboard-import").keyup(i),$("#clipboard-import").on("paste",function(){setTimeout(i,10)}),$("#import-tab > a").click(function(e){e.preventDefault(),$(this).hasClass("disabled")||$(this).hasClass("selected")||($(this).parent().children().removeClass("selected"),$(this).addClass("selected"))}),e.dialog("option","title",RED._("clipboard.importNodes")).dialog("open"))}function r(){if(!a){t.empty(),t.append($(n)),t.i18n();var o=RED.settings.flowFilePretty?"export-format-full":"export-format-mini";$("#export-format-group > a").click(function(e){if(e.preventDefault(),$(this).hasClass("disabled")||$(this).hasClass("selected"))$("#clipboard-export").focus();else{$(this).parent().children().removeClass("selected"),$(this).addClass("selected");var t=$("#clipboard-export").val();if(t.length>0){var n=JSON.parse(t);t="export-format-full"===(o=$(this).attr("id"))?JSON.stringify(n,null,4):JSON.stringify(n),$("#clipboard-export").val(t),$("#clipboard-export").focus()}}}),$("#export-range-group > a").click(function(e){if(e.preventDefault(),$(this).hasClass("disabled")||$(this).hasClass("selected"))$("#clipboard-export").focus();else{$(this).parent().children().removeClass("selected"),$(this).addClass("selected");var t=$(this).attr("id"),n="",a=null;if("export-range-selected"===t){var i=RED.view.selection();a=RED.nodes.createExportableNodeSet(i.nodes.filter(function(e){return"subflow"!==e.type}))}else if("export-range-flow"===t){var s=RED.workspaces.active();a=RED.nodes.filterNodes({z:s});var r=RED.nodes.workspace(s)||RED.nodes.subflow(s);a.unshift(r),a=RED.nodes.createExportableNodeSet(a)}else"export-range-full"===t&&(a=RED.nodes.createCompleteNodeSet(!1));null!==a&&(n="export-format-full"===o?JSON.stringify(a,null,4):JSON.stringify(a)),n.length>0?$("#export-copy").removeClass("disabled"):$("#export-copy").addClass("disabled"),$("#clipboard-export").val(n),$("#clipboard-export").focus()}}),$("#clipboard-dialog-ok").hide(),$("#clipboard-dialog-cancel").hide(),$("#clipboard-dialog-copy").hide(),$("#clipboard-dialog-close").hide(),RED.view.selection().nodes?$("#export-range-selected").click():($("#export-range-selected").addClass("disabled").removeClass("selected"),$("#export-range-flow").click()),"export-format-full"===o?$("#export-format-full").click():$("#export-format-mini").click(),$("#clipboard-export").focus(function(){var e=$(this);e.select(),e.mouseup(function(){return e.unbind("mouseup"),!1})}),e.dialog("option","title",RED._("clipboard.exportNodes")).dialog("open"),$("#clipboard-export").focus(),document.queryCommandSupported("copy")?($("#clipboard-dialog-cancel").show(),$("#clipboard-dialog-copy").show()):($("#clipboard-dialog-cancel").hide(),$("#clipboard-dialog-close").show())}}function d(){$("#dropTarget").hide(),RED.keyboard.remove("escape")}return{init:function(){e=$('<div id="clipboard-dialog" class="hide node-red-dialog"><form class="dialog-form form-horizontal"></form></div>').appendTo("body").dialog({modal:!0,autoOpen:!1,width:500,resizable:!1,buttons:[{id:"clipboard-dialog-cancel",text:RED._("common.label.cancel"),click:function(){$(this).dialog("close")}},{id:"clipboard-dialog-close",class:"primary",text:RED._("common.label.close"),click:function(){$(this).dialog("close")}},{id:"clipboard-dialog-copy",class:"primary",text:RED._("clipboard.export.copy"),click:function(){$("#clipboard-export").select(),document.execCommand("copy"),document.getSelection().removeAllRanges(),RED.notify(RED._("clipboard.nodesExported")),$(this).dialog("close")}},{id:"clipboard-dialog-ok",class:"primary",text:RED._("common.label.import"),click:function(){RED.view.importNodes($("#clipboard-import").val(),"import-tab-new"===$("#import-tab > a.selected").attr("id")),$(this).dialog("close")}}],open:function(e){$(this).parent().find(".ui-dialog-titlebar-close").hide()},close:function(e){}}),t=e.children(".dialog-form"),n='<div class="form-row"><label style="width:auto;margin-right: 10px;" data-i18n="clipboard.export.copy"></label><span id="export-range-group" class="button-group"><a id="export-range-selected" class="editor-button toggle" href="#" data-i18n="clipboard.export.selected"></a><a id="export-range-flow" class="editor-button toggle" href="#" data-i18n="clipboard.export.current"></a><a id="export-range-full" class="editor-button toggle" href="#" data-i18n="clipboard.export.all"></a></span></div><div class="form-row"><textarea readonly style="resize: none; width: 100%; border-radius: 4px;font-family: monospace; font-size: 12px; background:#f3f3f3; padding-left: 0.5em; box-sizing:border-box;" id="clipboard-export" rows="5"></textarea></div><div class="form-row" style="text-align: right;"><span id="export-format-group" class="button-group"><a id="export-format-mini" class="editor-button editor-button-small toggle" href="#" data-i18n="clipboard.export.compact"></a><a id="export-format-full" class="editor-button editor-button-small toggle" href="#" data-i18n="clipboard.export.formatted"></a></span></div>',o='<div class="form-row"><textarea style="resize: none; width: 100%; border-radius: 0px;font-family: monospace; font-size: 12px; background:#eee; padding-left: 0.5em; box-sizing:border-box;" id="clipboard-import" rows="5" placeholder="'+RED._("clipboard.pasteNodes")+'"></textarea></div><div class="form-row"><label style="width:auto;margin-right: 10px;" data-i18n="clipboard.import.import"></label><span id="import-tab" class="button-group"><a id="import-tab-current" class="editor-button toggle selected" href="#" data-i18n="clipboard.export.current"></a><a id="import-tab-new" class="editor-button toggle" href="#" data-i18n="clipboard.import.newFlow"></a></span></div>',$('<input type="text" id="clipboard-hidden">').appendTo("body"),RED.events.on("view:selection-changed",function(e){e.nodes?(RED.menu.setDisabled("menu-item-export",!1),RED.menu.setDisabled("menu-item-export-clipboard",!1),RED.menu.setDisabled("menu-item-export-library",!1)):(RED.menu.setDisabled("menu-item-export",!0),RED.menu.setDisabled("menu-item-export-clipboard",!0),RED.menu.setDisabled("menu-item-export-library",!0))}),RED.actions.add("core:show-export-dialog",r),RED.actions.add("core:show-import-dialog",s),RED.events.on("editor:open",function(){a=!0}),RED.events.on("editor:close",function(){a=!1}),RED.events.on("search:open",function(){a=!0}),RED.events.on("search:close",function(){a=!1}),RED.events.on("type-search:open",function(){a=!0}),RED.events.on("type-search:close",function(){a=!1}),$("#chart").on("dragenter",function(e){-1==$.inArray("text/plain",e.originalEvent.dataTransfer.types)&&-1==$.inArray("Files",e.originalEvent.dataTransfer.types)||($("#dropTarget").css({display:"table"}),RED.keyboard.add("*","escape",d))}),$("#dropTarget").on("dragover",function(e){-1==$.inArray("text/plain",e.originalEvent.dataTransfer.types)&&-1==$.inArray("Files",e.originalEvent.dataTransfer.types)||e.preventDefault()}).on("dragleave",function(e){d()}).on("drop",function(e){if(-1!=$.inArray("text/plain",e.originalEvent.dataTransfer.types)){var t=e.originalEvent.dataTransfer.getData("text/plain");t=t.substring(t.indexOf("["),t.lastIndexOf("]")+1),RED.view.importNodes(t)}else if(-1!=$.inArray("Files",e.originalEvent.dataTransfer.types)){var n=e.originalEvent.dataTransfer.files;if(1===n.length){var o=n[0],a=new FileReader;a.onload=function(e){RED.view.importNodes(e.target.result)},a.readAsText(o)}}d(),e.preventDefault()})},import:s,export:r,copyText:function(e,t,n){var o=!1;"string"!=typeof e&&(e=JSON.stringify(e,function(e,t){return null!==t&&"object"==typeof t&&t.__encoded__&&t.hasOwnProperty("data")&&t.hasOwnProperty("length")?(o=t.data.length!==t.length,t.data):t})),o&&(n+="_truncated"),$("#clipboard-hidden").val(e).select();var a=document.execCommand("copy");if(a&&t){var i=RED.popover.create({target:t,direction:"left",size:"small",content:RED._(n)});setTimeout(function(){i.close()},1e3),i.open()}return a}}}(),RED.library=function(){var e,t="node-input-";function n(){$.getJSON("library/flows",function(e){var t,n=function(e,t){var o,a,i,s=document.createElement("ul");if(""===t&&(s.id="menu-item-import-library-submenu"),s.className="dropdown-menu",e.d)for(o in e.d)if(e.d.hasOwnProperty(o)){(a=document.createElement("li")).className="dropdown-submenu pull-left",(i=document.createElement("a")).href="#";var r=o.replace(/^@.*\//,"").replace(/^node-red-contrib-/,"").replace(/^node-red-node-/,"").replace(/-/," ").replace(/_/," ");i.innerHTML=r,a.appendChild(i),a.appendChild(n(e.d[o],t+(""!==t?"/":"")+o)),s.appendChild(a)}if(e.f)for(o in e.f)e.f.hasOwnProperty(o)&&(a=document.createElement("li"),(i=document.createElement("a")).href="#",i.innerHTML=e.f[o],i.flowName=t+(""!==t?"/":"")+e.f[o],i.onclick=function(){$.get("library/flows/"+this.flowName,function(e){RED.view.importNodes(e)})},a.appendChild(i),s.appendChild(a));return s};e.d&&e.d._examples_&&(t=e.d._examples_,delete e.d._examples_);var o=n(e,"");$("#menu-item-import-examples").remove(),t&&(RED.menu.addItem("menu-item-import",{id:"menu-item-import-examples",label:RED._("menu.label.examples"),options:[]}),$("#menu-item-import-examples-submenu").replaceWith(n(t,"_examples_"))),$("#menu-item-import-library-submenu").replaceWith(o)})}function o(){var t=RED.nodes.createExportableNodeSet(RED.view.selection().nodes);$("#node-input-library-filename").attr("nodes",JSON.stringify(t)),e.dialog("open")}return{init:function(){RED.actions.add("core:library-export",o),RED.events.on("view:selection-changed",function(e){e.nodes?(RED.menu.setDisabled("menu-item-export",!1),RED.menu.setDisabled("menu-item-export-clipboard",!1),RED.menu.setDisabled("menu-item-export-library",!1)):(RED.menu.setDisabled("menu-item-export",!0),RED.menu.setDisabled("menu-item-export-clipboard",!0),RED.menu.setDisabled("menu-item-export-library",!0))}),!1!==RED.settings.theme("menu.menu-item-import-library")&&n(),(e=$('<div id="library-dialog" class="hide"><form class="dialog-form form-horizontal"></form></div>').appendTo("body").dialog({modal:!0,autoOpen:!1,width:500,resizable:!1,title:RED._("library.exportToLibrary"),buttons:[{id:"library-dialog-cancel",text:RED._("common.label.cancel"),click:function(){$(this).dialog("close")}},{id:"library-dialog-ok",class:"primary",text:RED._("common.label.export"),click:function(){var e=$("#node-input-library-filename").val();/^\s*$/.test(e)||$.ajax({url:"library/flows/"+e,type:"POST",data:$("#node-input-library-filename").attr("nodes"),contentType:"application/json; charset=utf-8"}).done(function(){RED.library.loadFlowLibrary(),RED.notify(RED._("library.savedNodes"),"success")}).fail(function(e,t,n){401===e.status?RED.notify(RED._("library.saveFailed",{message:RED._("user.notAuthorized")}),"error"):RED.notify(RED._("library.saveFailed",{message:e.responseText}),"error")}),$(this).dialog("close")}}],open:function(e){$(this).parent().find(".ui-dialog-titlebar-close").hide()},close:function(e){}})).children(".dialog-form").append($('<div class="form-row"><label for="node-input-library-filename" data-i18n="[append]editor:library.filename"><i class="fa fa-file"></i> </label><input type="text" id="node-input-library-filename" data-i18n="[placeholder]editor:library.fullFilenamePlaceholder"><input type="text" style="display: none;" /></div>'))},create:function(e){var n=null,o=null;function a(e){var t=document.createElement("li");return t.onmouseover=function(e){$(this).addClass("list-hover")},t.onmouseout=function(e){$(this).removeClass("list-hover")},t}function i(t,s){for(var r,d=document.createElement("ul"),l=0;l<s.length;l++){var c=s[l];"string"==typeof c?((r=a()).onclick=function(){var n=c;return function(o){var a=$('<li class="active"><span class="divider">/</span> <a href="#">'+n+"</a></li>");$("a",a).click(function(o){$(this).parent().nextAll().remove(),$.getJSON("library/"+e.url+t+n,function(e){$("#node-select-library").children().first().replaceWith(i(t+n+"/",e))}),o.stopPropagation()});var s=$("#node-dialog-library-breadcrumbs");$(".active",s).removeClass("active"),s.append(a),$.getJSON("library/"+e.url+t+n,function(e){$("#node-select-library").children().first().replaceWith(i(t+n+"/",e))})}}(),r.innerHTML='<i class="fa fa-folder"></i> '+c+"</i>",d.appendChild(r)):((r=a()).innerHTML=c.name,r.onclick=function(){var a=c;return function(i){$(".list-selected",d).removeClass("list-selected"),$(this).addClass("list-selected"),$.get("library/"+e.url+t+a.fn,function(e){n=a,o.setValue(e,-1)})}}(),d.appendChild(r))}return d}function s(n){var o=$("#"+t+"name").val().replace(/(^\s*)|(\s*$)/g,"");""===o&&(o=RED._("library.unnamedType",{type:e.type}));var a=$("#node-dialog-library-save-filename").val().replace(/(^\s*)|(\s*$)/g,""),i=$("#node-dialog-library-save-folder").val().replace(/(^\s*)|(\s*$)/g,"");if(""!==a&&/.+\.js$/.test(a)){for(var s=i+(""===i?"":"/")+a,r={},d=0;d<e.fields.length;d++){var l=e.fields[d];"name"==l?r.name=o:r[l]=$("#"+t+l).val()}r.text=e.editor.getValue(),$.ajax({url:"library/"+e.url+"/"+s,type:"POST",data:JSON.stringify(r),contentType:"application/json; charset=utf-8"}).done(function(t,n,o){RED.notify(RED._("library.savedType",{type:e.type}),"success")}).fail(function(e,t,n){401===e.status?RED.notify(RED._("library.saveFailed",{message:RED._("user.notAuthorized")}),"error"):RED.notify(RED._("library.saveFailed",{message:e.responseText}),"error")})}else RED.notify(RED._("library.invalidFilename"),"warning")}t=e.elementPrefix||"node-input-",e.editor.setText&&(e.editor.setValue=function(t,n){e.editor.setText.call(e.editor,t)}),e.editor.getText&&(e.editor.getValue=e.editor.getText),$("#"+t+"name").css("width","calc(100% - 52px)").after('<div class="btn-group" style="margin-left:5px;"><a id="node-input-'+e.type+'-lookup" class="editor-button" data-toggle="dropdown"><i class="fa fa-book"></i> <i class="fa fa-caret-down"></i></a><ul class="dropdown-menu pull-right" role="menu"><li><a id="node-input-'+e.type+'-menu-open-library" tabindex="-1" href="#">'+RED._("library.openLibrary")+'</a></li><li><a id="node-input-'+e.type+'-menu-save-library" tabindex="-1" href="#">'+RED._("library.saveToLibrary")+"</a></li></ul></div>"),$("#node-input-"+e.type+"-menu-open-library").click(function(t){$("#node-select-library").children().remove(),$("#node-dialog-library-breadcrumbs").children().first().nextAll().remove(),o.setValue("",-1),$.getJSON("library/"+e.url,function(e){$("#node-select-library").append(i("/",e)),$("#node-dialog-library-breadcrumbs a").click(function(t){$(this).parent().nextAll().remove(),$("#node-select-library").children().first().replaceWith(i("/",e)),t.stopPropagation()}),$("#node-dialog-library-lookup").dialog("open")}),t.preventDefault()}),$("#node-input-"+e.type+"-menu-save-library").click(function(n){var o=$("#"+t+"name").val().replace(/(^\s*)|(\s*$)/g,"");$("#node-dialog-library-save-folder").attr("value","");var a=o.replace(/[^\w-]/g,"-");""===a&&(a="unnamed-"+e.type),$("#node-dialog-library-save-filename").attr("value",a+".js"),$("#node-dialog-library-save").dialog("open"),n.preventDefault()}),(o=ace.edit("node-select-library-text")).setTheme("ace/theme/tomorrow"),e.mode&&o.getSession().setMode(e.mode),o.setOptions({readOnly:!0,highlightActiveLine:!1,highlightGutterLine:!1}),o.renderer.$cursorLayer.element.style.opacity=0,o.$blockScrolling=1/0,$("#node-dialog-library-lookup").dialog({title:RED._("library.typeLibrary",{type:e.type}),modal:!0,autoOpen:!1,width:800,height:450,buttons:[{text:RED._("common.label.cancel"),click:function(){$(this).dialog("close")}},{text:RED._("common.label.load"),class:"primary",click:function(){if(n){for(var a=0;a<e.fields.length;a++){var i=e.fields[a];$("#"+t+i).val(n[i])}e.editor.setValue(o.getValue(),-1)}$(this).dialog("close")}}],open:function(e){var t=$("form",this);t.height(t.parent().height()-30),$("#node-select-library-text").height("100%"),$(".form-row:last-child",t).children().height(t.height()-60)},resize:function(e){var t=$("form",this);t.height(t.parent().height()-30),$(".form-row:last-child",t).children().height(t.height()-60)}}),$("#node-dialog-library-save-confirm").dialog({title:RED._("library.saveToLibrary"),modal:!0,autoOpen:!1,width:530,height:230,buttons:[{text:RED._("common.label.cancel"),click:function(){$(this).dialog("close")}},{text:RED._("common.label.save"),class:"primary",click:function(){s(),$(this).dialog("close")}}]}),$("#node-dialog-library-save").dialog({title:RED._("library.saveToLibrary"),modal:!0,autoOpen:!1,width:530,height:230,buttons:[{text:RED._("common.label.cancel"),click:function(){$(this).dialog("close")}},{text:RED._("common.label.save"),class:"primary",click:function(){s(),$(this).dialog("close")}}]})},loadFlowLibrary:n,export:o}}(),RED.notifications=function(){var e,t={},n=[],o=0;function a(a,i,s,r){var d={};if(null!==i&&"object"==typeof i&&(s=(d=i).fixed,r=d.timeout,i=d.type),d.modal&&$("#full-shade").show(),n.length>4)for(var l=n.length,c=0;l>4&&c<n.length;c+=1){var p=n[c];p.fixed||(window.clearTimeout(p.timeoutid),p.close(),l-=1)}var u,f,h,g,v,m=document.createElement("div");if(m.id="red-notification-"+o,m.className="notification",m.fixed=s,i&&(m.className="notification notification-"+i),d.width){var b=$("#notifications").width();if(d.width>b){var y=-(d.width-b)/2;$(m).css({width:d.width+"px",marginLeft:y+"px"})}}if(m.style.display="none","string"==typeof a?(/<p>/i.test(a)||(a="<p>"+a+"</p>"),m.innerHTML=a):$(m).append(a),d.buttons){var w=$('<div style="margin-top: 20px;" class="ui-dialog-buttonset"></div>').appendTo(m);d.buttons.forEach(function(e){var t=$("<button>").html(e.text).click(e.click).appendTo(w);e.id&&t.attr("id",e.id),e.class&&t.addClass(e.class)})}return $("#notifications").append(m),$(m).slideDown(300),m.close=(u=m,function(){u.closed||(u.closed=!0,n.splice(n.indexOf(u),1),d.id&&(delete t[d.id],0===Object.keys(t).length&&e.hide()),$(u).slideUp(300,function(){u.parentNode.removeChild(u)}),d.modal&&$("#full-shade").hide())}),m.hideNotification=(f=m,function(){f.closed||(f.hidden=!0,$(f).slideUp(300))}),m.showNotification=(h=m,function(){!h.closed&&h.hidden&&(h.hidden=!1,$(h).slideDown(300))}),m.update=(g=m,function(e,t){var n;if("string"==typeof e?(/<p>/i.test(e)||(e="<p>"+e+"</p>"),g.innerHTML=e):$(g).empty().append(e),"number"==typeof t)n=t;else if(void 0!==t&&(n=t.timeout,t.buttons)){var o=$('<div style="margin-top: 20px;" class="ui-dialog-buttonset"></div>').appendTo(g);t.buttons.forEach(function(e){var t=$("<button>").html(e.text).click(e.click).appendTo(o);e.id&&t.attr("id",e.id),e.class&&t.addClass(e.class)})}void 0!==n&&n>0?(window.clearTimeout(g.timeoutid),g.timeoutid=window.setTimeout(g.close,n)):window.clearTimeout(g.timeoutid),g.hidden&&g.showNotification()}),s||($(m).click((v=m,function(){v.close(),window.clearTimeout(v.timeoutid)})),m.timeoutid=window.setTimeout(m.close,r||5e3)),n.push(m),d.id&&(t[d.id]=m,e.show()),o+=1,m}return RED.notify=a,{init:function(){e=$('<li><a id="btn-notifications" class="button" href="#"><i class="fa fa-warning"></i></a></li>').prependTo(".header-toolbar").hide(),$("#btn-notifications").click(function(){!function(){for(var e in t)t.hasOwnProperty(e)&&t[e].showNotification()}()})},notify:a}}(),RED.search=function(){var e,t,n=!1,o=null,a=-1,i=!1,s={},r=[],d=[];function l(e){var t=RED.utils.getNodeLabel(e);t&&(t=(""+t).toLowerCase(),s[t]=s[t]||{},s[t][e.id]={node:e,label:t}),t=t||e.label||e.name||e.id||"";var n=["id","type","name","label","info"];e._def&&e._def.defaults&&(n=n.concat(Object.keys(e._def.defaults)));for(var o=0;o<n.length;o++)if(e.hasOwnProperty(n[o])){var a=e[n[o]];"string"!=typeof a&&"number"!=typeof a||(a=(""+a).toLowerCase(),s[a]=s[a]||{},s[a][e.id]={node:e,label:t})}}function c(){var e=t.find("li.selected");if(1===e.length){var n=t.parent(),o=n.height(),a=(n.scrollTop(),e.position().top),i=e.height();a+i>o?n.animate({scrollTop:"-="+(o-(a+i)-10)},50):a<0&&n.animate({scrollTop:"+="+(a-10)},50)}}function p(){o=$("<div>",{id:"red-ui-search",class:"red-ui-search"}).appendTo("#main-container");var n=$("<div>",{class:"red-ui-search-container"}).appendTo(o);(e=$('<input type="text" data-i18n="[placeholder]menu.label.searchInput">').appendTo(n).searchBox({delay:200,change:function(){!function(e){if(t.editableList("empty"),a=-1,d=[],e.length>0){var n,o;e=e.toLowerCase();var i=[],l={};for(n=0;n<r.length;n++){var c=r[n],p=r[n].indexOf(e);if(p>-1)for(o=0;o<s[c].length;o++){var u=s[c][o];l[u.node.id]=l[u.node.id]=u,l[u.node.id].index=Math.min(l[u.node.id].index||1/0,p)}}for((i=Object.keys(l)).sort(function(e,t){return l[e].index-l[t].index}),n=0;n<i.length;n++)d.push(l[i[n]]);if(d.length>0)for(n=0;n<Math.min(d.length,25);n++)t.editableList("addItem",d[n]);else t.editableList("addItem",{})}}($(this).val())}})).on("keydown",function(e){var n;d.length>0&&(40===e.keyCode?(n=t.children(),a<n.length-1&&(a>-1&&$(n[a]).removeClass("selected"),a++),$(n[a]).addClass("selected"),c(),e.preventDefault()):38===e.keyCode?(n=t.children(),a>0&&(a<n.length&&$(n[a]).removeClass("selected"),a--),$(n[a]).addClass("selected"),c(),e.preventDefault()):13===e.keyCode&&d.length>0&&u(d[Math.max(0,a)].node))}),e.i18n();var i=$("<div>",{class:"red-ui-search-results-container"}).appendTo(o);t=$("<ol>",{id:"search-result-list",style:"position: absolute;top: 5px;bottom: 5px;left: 5px;right: 5px;"}).appendTo(i).editableList({addButton:!1,addItem:function(e,t,n){var o=n.node;if(void 0===o)$("<div>",{class:"red-ui-search-empty"}).html(RED._("search.empty")).appendTo(e);else{var a=o._def,i=$("<a>",{href:"#",class:"red-ui-search-result"}).appendTo(e),s=$("<div>",{class:"red-ui-search-result-node"}).appendTo(i),r=a.color,d=RED.utils.getNodeIcon(a,o);"tab"===o.type&&(r="#C0DEED"),s.css("backgroundColor",r);var l=$("<div/>",{class:"palette_icon_container"}).appendTo(s);$("<div/>",{class:"palette_icon",style:"background-image: url("+d+")"}).appendTo(l);var c=$("<div>",{class:"red-ui-search-result-description"}).appendTo(i);if(o.z){var p=RED.nodes.workspace(o.z);p=p?"flow:"+p.label:"subflow:"+(p=RED.nodes.subflow(o.z)).name,$("<div>",{class:"red-ui-search-result-node-flow"}).html(p).appendTo(c)}$("<div>",{class:"red-ui-search-result-node-label"}).html(n.label||o.id).appendTo(c),$("<div>",{class:"red-ui-search-result-node-type"}).html(o.type).appendTo(c),$("<div>",{class:"red-ui-search-result-node-id"}).html(o.id).appendTo(c),i.click(function(e){e.preventDefault(),u(o)})}},scrollOnAdd:!1})}function u(e){h(),RED.view.reveal(e.id)}function f(){n||(i||(RED.keyboard.add("*","escape",function(){h()}),$("#header-shade").show(),$("#editor-shade").show(),$("#palette-shade").show(),$("#sidebar-shade").show(),$("#sidebar-separator").hide(),s={},RED.nodes.eachWorkspace(l),RED.nodes.eachSubflow(l),RED.nodes.eachConfig(l),RED.nodes.eachNode(l),(r=Object.keys(s)).sort(),r.forEach(function(e){s[e]=Object.keys(s[e]).map(function(t){return s[e][t]})}),null===o&&p(),o.slideDown(300),RED.events.emit("search:open"),i=!0),e.focus())}function h(){i&&(RED.keyboard.remove("escape"),i=!1,$("#header-shade").hide(),$("#editor-shade").hide(),$("#palette-shade").hide(),$("#sidebar-shade").hide(),$("#sidebar-separator").show(),null!==o&&o.slideUp(200,function(){e.searchBox("value","")}),RED.events.emit("search:close"))}return{init:function(){RED.actions.add("core:search",f),RED.events.on("editor:open",function(){n=!0}),RED.events.on("editor:close",function(){n=!1}),RED.events.on("type-search:open",function(){n=!0}),RED.events.on("type-search:close",function(){n=!1}),$("#header-shade").on("mousedown",h),$("#editor-shade").on("mousedown",h),$("#palette-shade").on("mousedown",h),$("#sidebar-shade").on("mousedown",h)},show:f,hide:h}}(),RED.typeSearch=function(){var e,t,n,o,a,i=null,s=-1,r=!1,d="",l={};function c(){var e=t.find("li.selected");if(1===e.length){var n=t.parent(),o=n.height(),a=(n.scrollTop(),e.position().top),i=e.height();a+i>o?n.animate({scrollTop:"-="+(o-(a+i)-10)},50):a<0&&n.animate({scrollTop:"+="+(a-10)},50)}}function p(){i=$("<div>",{id:"red-ui-type-search",class:"red-ui-search red-ui-type-search"}).appendTo("#main-container");var o=$("<div>",{class:"red-ui-search-container"}).appendTo(i);(e=$('<input type="text">').attr("placeholder",RED._("search.addNode")).appendTo(o).searchBox({delay:50,change:function(){var e;e=$(this).val(),d=e.toLowerCase(),t.editableList("filter"),t.editableList("sort"),setTimeout(function(){s=0,t.children().removeClass("selected"),t.children(":visible:first").addClass("selected")},100)}})).on("keydown",function(e){var n=t.children(":visible");if(n.length>0)if(40===e.keyCode)s<n.length-1&&(s>-1&&$(n[s]).removeClass("selected"),s++),$(n[s]).addClass("selected"),c(),e.preventDefault();else if(38===e.keyCode)s>0&&(s<n.length&&$(n[s]).removeClass("selected"),s--),$(n[s]).addClass("selected"),c(),e.preventDefault();else if(13===e.keyCode){var o=Math.max(0,s);o<n.length&&u($(n[o]).find(".red-ui-editableList-item-content").data("data"))}}),n=$("<div>",{class:"red-ui-search-results-container"}).appendTo(i),t=$("<ol>",{id:"search-result-list",style:"position: absolute;top: 0;bottom: 0;left: 0;right: 0;"}).appendTo(n).editableList({addButton:!1,filter:function(e){return""===d||!e.recent&&!e.common&&(""===d||e.index.indexOf(d)>-1)},sort:function(e,t){if(""===d)return e.i-t.i;var n=e.index.indexOf(d),o=t.index.indexOf(d);return-1===n?1:-1===o?-1:n===o?v(e,t):n-o},addItem:function(e,t,n){var o=n.def;n.index=n.type.toLowerCase(),n.separator&&e.addClass("red-ui-search-result-separator");var a=$("<a>",{href:"#",class:"red-ui-search-result"}).appendTo(e),i=$("<div>",{class:"red-ui-search-result-node"}).appendTo(a),s=o.color,r=RED.utils.getNodeIcon(o);i.css("backgroundColor",s);var d=$("<div/>",{class:"palette_icon_container"}).appendTo(i);$("<div/>",{class:"palette_icon",style:"background-image: url("+r+")"}).appendTo(d),o.inputs>0&&$("<div/>",{class:"red-ui-search-result-node-port"}).appendTo(i),o.outputs>0&&$("<div/>",{class:"red-ui-search-result-node-port red-ui-search-result-node-output"}).appendTo(i);var l=$("<div>",{class:"red-ui-search-result-description"}).appendTo(a),c=n.label;n.index+="|"+c.toLowerCase(),$("<div>",{class:"red-ui-search-result-node-label"}).html(c).appendTo(l),a.click(function(e){e.preventDefault(),u(n)})},scrollOnAdd:!1})}function u(e){h(),l[e.type]=Date.now(),o(e.type)}function f(e){if(r){for(var t=$(e.target);"body"!==t.prop("nodeName").toLowerCase();){if("red-ui-type-search"===t.attr("id"))return;t=t.parent()}h(!0),a&&a()}}function h(t){r&&(RED.keyboard.remove("escape"),r=!1,null!==i&&n.slideUp(t?50:200,function(){i.hide(),e.searchBox("value","")}),RED.events.emit("type-search:close"),RED.view.focus(),$(document).off("mousedown.type-search"),$(document).off("mouseup.type-search"),$(document).off("click.type-search"))}function g(e,t){var n=e;if(void 0!==t.paletteLabel)try{n=("function"==typeof t.paletteLabel?t.paletteLabel.call(t):t.paletteLabel)||"",n+=" ("+e+")"}catch(t){console.log("Definition error: "+e+".paletteLabel",t)}return n}function v(e,t){var n=e.label.toLowerCase(),o=t.label.toLowerCase();return n<o?-1:n===o?0:1}return{show:function(d){r?(i.hide(),n.hide()):(RED.keyboard.add("*","escape",function(){h(),a&&a()}),null===i&&p(),r=!0,setTimeout(function(){$(document).on("mousedown.type-search",f),$(document).on("mouseup.type-search",f),$(document).on("click.type-search",f)},200)),function(){var n;t.editableList("empty"),e.searchBox("value",""),s=-1;var o=["inject","debug","function","change","switch"],a=Object.keys(l);a.sort(function(e,t){return l[t]-l[e]}),a=a.filter(function(e){return-1===o.indexOf(e)});var i=[];RED.nodes.registry.getNodeTypes().forEach(function(e){var t=RED.nodes.getType(e);"config"!==t.category&&"unknown"!==e&&"tab"!==e&&i.push({type:e,def:t,label:g(e,t)})}),i.sort(v);var r,d=0;for(n=0;n<o.length;n++){var c=RED.nodes.getType(o[n]);c&&((r={type:o[n],common:!0,def:c,i:d++}).label=g(r.type,r.def),n===o.length-1&&(r.separator=!0),t.editableList("addItem",r))}for(n=0;n<Math.min(5,a.length);n++)(r={type:a[n],def:RED.nodes.getType(a[n]),recent:!0,i:d++}).label=g(r.type,r.def),n===a.length-1&&(r.separator=!0),t.editableList("addItem",r);for(n=0;n<i.length;n++)i[n].i=d++,t.editableList("addItem",i[n]);setTimeout(function(){s=0,t.children(":first").addClass("selected")},100)}(),o=d.add,closeCallback=d.close,RED.events.emit("type-search:open"),i.css({left:d.x+"px",top:d.y+"px"}).show(),n.slideDown(300),setTimeout(function(){n.find(".red-ui-editableList-container").scrollTop(0),e.focus()},100)},hide:h}}(),RED.subflow=function(){function e(e,t){var n={x:50,y:30};t||(n.x+=110);for(var o=0;o<e.out.length+e.in.length;o++){var a;(a=o<e.out.length?e.out[o]:e.in[o-e.out.length]).x==n.x&&a.y==n.y&&(n.x+=55,o=0)}return n}function t(){var e=RED.nodes.subflow(RED.workspaces.active());if(0!==e.in.length){var t=e.in[0],n=[];return RED.nodes.eachLink(function(o){"subflow"==o.source.type&&o.source.z==e.id&&o.source.i==t.i?n.push(o):o.target.type=="subflow:"+e.id&&n.push(o)}),n.forEach(function(e){RED.nodes.removeLink(e)}),e.in=[],$("#workspace-subflow-input-add").removeClass("active"),$("#workspace-subflow-input-remove").addClass("active"),e.changed=!0,{subflowInputs:[t],links:n}}}function n(e){var t=RED.nodes.subflow(RED.workspaces.active());if(0!==t.out.length){void 0===e&&(e=[t.out[t.out.length-1]]);var n=[];for(e.sort(function(e,t){return t.i-e.i}),i=0;i<e.length;i++){var o=e[i];t.out.splice(o.i,1);var a=[],s=[];RED.nodes.eachLink(function(e){"subflow"==e.target.type&&e.target.z==t.id&&e.target.i==o.i&&a.push(e),e.source.type=="subflow:"+t.id&&(e.sourcePort==o.i?a.push(e):e.sourcePort>o.i&&s.push(e))}),a.forEach(function(e){RED.nodes.removeLink(e)}),s.forEach(function(e){e.sourcePort--}),n=n.concat(a);for(var r=o.i;r<t.out.length;r++)t.out[r].i--,t.out[r].dirty=!0}return t.changed=!0,{subflowOutputs:e,links:n}}}function o(e){var t=RED.nodes.subflow(RED.workspaces.active());a(t);var n=[];if(t)return RED.nodes.filterNodes({type:"subflow:"+t.id}).forEach(function(o){for(n.push({id:o.id,changed:o.changed}),e&&(o.changed=!0),o.inputs=t.in.length,o.outputs=t.out.length;o.outputs<o.ports.length;)o.ports.pop();o.resize=!0,o.dirty=!0,RED.editor.updateNodeProperties(o)}),RED.editor.validateNode(t),{instances:n}}function a(e){e&&($("#workspace-subflow-input-add").toggleClass("active",0!==e.in.length),$("#workspace-subflow-input-remove").toggleClass("active",0===e.in.length),$("#workspace-subflow-output .spinner-value").html(e.out.length))}function s(i){var s=$("#workspace-toolbar");s.empty(),$('<a class="button" id="workspace-subflow-edit" href="#" data-i18n="[append]subflow.editSubflowProperties"><i class="fa fa-pencil"></i> </a>').appendTo(s),$('<span style="margin-left: 5px;" data-i18n="subflow.input"></span> <div style="display: inline-block;" class="button-group"><a id="workspace-subflow-input-remove" class="button active" href="#">0</a><a id="workspace-subflow-input-add" class="button" href="#">1</a></div>').appendTo(s),$('<span style="margin-left: 5px;" data-i18n="subflow.output"></span> <div id="workspace-subflow-output" style="display: inline-block;" class="button-group spinner-group"><a id="workspace-subflow-output-remove" class="button" href="#"><i class="fa fa-minus"></i></a><div class="spinner-value">3</div><a id="workspace-subflow-output-add" class="button" href="#"><i class="fa fa-plus"></i></a></div>').appendTo(s),$('<a class="button" id="workspace-subflow-delete" href="#" data-i18n="[append]subflow.deleteSubflow"><i class="fa fa-trash"></i> </a>').appendTo(s),s.i18n(),$("#workspace-subflow-output-remove").click(function(e){e.preventDefault();var t=RED.nodes.dirty(),a=i.changed,s=n();if(s){var r=o(!0);RED.history.push({t:"delete",links:s.links,subflowOutputs:s.subflowOutputs,changed:a,dirty:t,subflow:{instances:r.instances}}),RED.view.select(),RED.nodes.dirty(!0),RED.view.redraw(!0)}}),$("#workspace-subflow-output-add").click(function(t){t.preventDefault(),function(t){var n=RED.nodes.subflow(RED.workspaces.active()),a=e(n,!1),i={type:"subflow",direction:"out",z:n.id,i:n.out.length,x:a.x,y:a.y,id:RED.nodes.id()},s=n.out.length;n.out.push(i),n.dirty=!0;var r=RED.nodes.dirty(),d=n.changed;n.changed=!0;var l={t:"edit",node:n,dirty:r,changed:d,subflow:{outputCount:s,instances:o(!0).instances}};RED.history.push(l),RED.view.select(),RED.nodes.dirty(!0),RED.view.redraw(),$("#workspace-subflow-output .spinner-value").html(n.out.length)}()}),$("#workspace-subflow-input-add").click(function(t){t.preventDefault(),function(){var t=RED.nodes.subflow(RED.workspaces.active());if(1!==t.in.length){var n=e(t,!0),a={type:"subflow",direction:"in",z:t.id,i:t.in.length,x:n.x,y:n.y,id:RED.nodes.id()},i=t.in.length;t.in.push(a),t.dirty=!0;var s=RED.nodes.dirty(),r=t.changed;t.changed=!0;var d={t:"edit",node:t,dirty:s,changed:r,subflow:{inputCount:i,instances:o(!0).instances}};RED.history.push(d),RED.view.select(),RED.nodes.dirty(!0),RED.view.redraw(),$("#workspace-subflow-input-add").addClass("active"),$("#workspace-subflow-input-remove").removeClass("active")}}()}),$("#workspace-subflow-input-remove").click(function(e){e.preventDefault();var n=RED.nodes.dirty(),a=i.changed;i.changed=!0;var s=t();if(s){var r=o(!0);RED.history.push({t:"delete",links:s.links,changed:a,subflowInputs:s.subflowInputs,dirty:n,subflow:{instances:r.instances}}),RED.view.select(),RED.nodes.dirty(!0),RED.view.redraw(!0)}}),$("#workspace-subflow-edit").click(function(e){RED.editor.editSubflow(RED.nodes.subflow(RED.workspaces.active())),e.preventDefault()}),$("#workspace-subflow-delete").click(function(e){e.preventDefault();var t=RED.nodes.dirty(),n=r(RED.workspaces.active());n.t="delete",n.dirty=t,RED.history.push(n)}),a(i),$("#chart").css({"margin-top":"40px"}),$("#workspace-toolbar").show()}function r(e){var t=[],n=[],o=RED.nodes.subflow(e);RED.nodes.eachNode(function(e){e.type=="subflow:"+o.id&&t.push(e),e.z==o.id&&t.push(e)}),RED.nodes.eachConfig(function(e){e.z==o.id&&t.push(e)});for(var a=[],i=0;i<t.length;i++){var s=RED.nodes.remove(t[i].id);n=n.concat(s.links),a=a.concat(s.nodes)}return t=t.concat(a),RED.nodes.removeSubflow(o),RED.workspaces.remove(o),RED.nodes.dirty(!0),RED.view.redraw(),{nodes:t,links:n,subflow:{subflow:o}}}function d(){var e=0;RED.nodes.eachSubflow(function(t){var n=new RegExp("^Subflow (\\d+)$").exec(t.name);n&&(e=Math.max(e,n[1]))});var t="Subflow "+(e+1),n=RED.nodes.id(),o={type:"subflow",id:n,name:t,info:"",in:[],out:[]};RED.nodes.addSubflow(o),RED.history.push({t:"createSubflow",subflow:{subflow:o},dirty:RED.nodes.dirty()}),RED.workspaces.show(n),RED.nodes.dirty(!0)}function l(){var e=RED.view.selection();if(e.nodes){var t,n,o={},a=[],i=[],s=[],r=[],d={},l=[e.nodes[0].x,e.nodes[0].y,e.nodes[0].x,e.nodes[0].y];for(t=0;t<e.nodes.length;t++)n=e.nodes[t],o[n.id]={n:n,outputs:{}},l=[Math.min(l[0],n.x),Math.min(l[1],n.y),Math.max(l[2],n.x),Math.max(l[3],n.y)];var c=[(l[2]+l[0])/2,(l[3]+l[1])/2];RED.nodes.eachLink(function(e){o[e.source.id]&&o[e.target.id],o[e.source.id]&&!o[e.target.id]&&(r.push(e),i.push(e)),!o[e.source.id]&&o[e.target.id]&&(s.push(e),d[e.target.id]=e.target,i.push(e))});var p={};if((r=r.filter(function(e){return p[e.source.id+":"+e.sourcePort]?(p[e.source.id+":"+e.sourcePort].targets.push(e.target),!1):(e.targets=[],e.targets.push(e.target),p[e.source.id+":"+e.sourcePort]=e,!0)})).sort(function(e,t){return e.source.y-t.source.y}),Object.keys(d).length>1)RED.notify(RED._("subflow.errors.multipleInputsToSelection"),"error");else{var u=0;RED.nodes.eachSubflow(function(e){var t=new RegExp("^Subflow (\\d+)$").exec(e.name);t&&(u=Math.max(u,t[1]))});var f="Subflow "+(u+1),h=RED.nodes.id(),g={type:"subflow",id:h,name:f,info:"",in:Object.keys(d).map(function(e,t){var n=t;return{type:"subflow",direction:"in",x:d[e].x-d[e].w/2-80,y:d[e].y,z:h,i:n,id:RED.nodes.id(),wires:[{id:d[e].id}]}}),out:r.map(function(e,t){var n=t;return{type:"subflow",direction:"in",x:e.source.x+e.source.w/2+80,y:e.source.y,z:h,i:n,id:RED.nodes.id(),wires:[{id:e.source.id,port:e.sourcePort}]}})};RED.nodes.addSubflow(g);var v={id:RED.nodes.id(),type:"subflow:"+g.id,x:c[0],y:c[1],z:RED.workspaces.active(),inputs:g.in.length,outputs:g.out.length,h:Math.max(30,15*(g.out.length||0)),changed:!0};for(v._def=RED.nodes.getType(v.type),RED.editor.validateNode(v),RED.nodes.add(v),s.forEach(function(e){var t={source:e.source,sourcePort:e.sourcePort,target:v};a.push(t),RED.nodes.addLink(t)}),r.forEach(function(e,t){e.targets.forEach(function(e){var n={source:v,sourcePort:t,target:e};a.push(n),RED.nodes.addLink(n)})}),g.in.forEach(function(e){e.wires.forEach(function(t){var n={source:e,sourcePort:0,target:RED.nodes.node(t.id)};a.push(n),RED.nodes.addLink(n)})}),g.out.forEach(function(e,t){e.wires.forEach(function(t){var n={source:RED.nodes.node(t.id),sourcePort:t.port,target:e};a.push(n),RED.nodes.addLink(n)})}),t=0;t<i.length;t++)RED.nodes.removeLink(i[t]);for(t=0;t<e.nodes.length;t++)n=e.nodes[t],/^link /.test(n.type)&&(n.links=n.links.filter(function(e){var t=o.hasOwnProperty(e);if(!t){var a=RED.nodes.node(e);if(a&&a.links){var i=a.links.indexOf(n.id);i>-1&&a.links.splice(i,1)}}return t})),n.z=g.id;RED.history.push({t:"createSubflow",nodes:[v.id],links:a,subflow:{subflow:g},activeWorkspace:RED.workspaces.active(),removedLinks:i,dirty:RED.nodes.dirty()}),RED.view.select(null),RED.editor.validateNode(g),RED.nodes.dirty(!0),RED.view.redraw(!0)}}else RED.notify(RED._("subflow.errors.noNodesSelected"),"error")}return{init:function(){RED.events.on("workspace:change",function(e){var t=RED.nodes.subflow(e.workspace);t?s(t):($("#workspace-toolbar").hide().empty(),$("#chart").css({"margin-top":"0"}))}),RED.events.on("view:selection-changed",function(e){e.nodes?RED.menu.setDisabled("menu-item-subflow-convert",!1):RED.menu.setDisabled("menu-item-subflow-convert",!0)}),RED.actions.add("core:create-subflow",d),RED.actions.add("core:convert-to-subflow",l)},createSubflow:d,convertToSubflow:l,removeSubflow:r,refresh:o,removeInput:t,removeOutput:n}}(),RED.userSettings=function(){var e=700,t=!1,n=[];function o(e){n.push(e)}function a(o){if(!t)if(RED.user.hasPermission("settings.write")){t=!0;var a={title:RED._("menu.label.userSettings"),buttons:[{id:"node-dialog-ok",text:RED._("common.label.close"),class:"primary",click:function(){RED.tray.close()}}],resize:function(t){e=t.width},open:function(e){var t=e.find(".editor-tray-body"),a=$("<div></div>").appendTo(t),i=$("<div></div>",{id:"user-settings-tabs-container"}).appendTo(a);$("<ul></ul>",{id:"user-settings-tabs"}).appendTo(i);var s=RED.tabs.create({id:"user-settings-tabs",vertical:!0,onchange:function(e){setTimeout(function(){$("#user-settings-tabs-content").children().hide(),$("#"+e.id).show(),e.pane.focus&&e.pane.focus()},50)}}),r=$("<div></div>",{id:"user-settings-tabs-content"}).appendTo(a);n.forEach(function(e){s.addTab({id:"user-settings-tab-"+e.id,label:e.title,pane:e}),e.get().hide().appendTo(r)}),a.i18n(),s.activateTab("user-settings-tab-"+(o||"view")),$("#sidebar-shade").show()},close:function(){t=!1,n.forEach(function(e){e.close&&e.close()}),$("#sidebar-shade").hide()},show:function(){}};null!==e&&(a.width=e),RED.tray.show(a)}else RED.notify(RED._("user.errors.settings"),"error")}var i=[{title:"menu.label.view.grid",options:[{setting:"view-show-grid",oldSetting:"menu-menu-item-view-show-grid",label:"menu.label.view.showGrid",toggle:!0,onchange:"core:toggle-show-grid"},{setting:"view-snap-grid",oldSetting:"menu-menu-item-view-snap-grid",label:"menu.label.view.snapGrid",toggle:!0,onchange:"core:toggle-snap-grid"},{setting:"view-grid-size",label:"menu.label.view.gridSize",type:"number",default:20,onchange:RED.view.gridSize}]},{title:"menu.label.nodes",options:[{setting:"view-node-status",oldSetting:"menu-menu-item-status",label:"menu.label.displayStatus",default:!0,toggle:!0,onchange:"core:toggle-status"}]},{title:"menu.label.other",options:[{setting:"view-show-tips",oldSettings:"menu-menu-item-show-tips",label:"menu.label.showTips",toggle:!0,default:!0,onchange:"core:toggle-show-tips"}]}],s={};function r(){var e=$('<div id="user-settings-tab-view" class="node-help"></div>'),t=RED.settings.get("editor")||{};return t.view=t.view||{},i.forEach(function(n){$("<h3></h3>").text(RED._(n.title)).appendTo(e),n.options.forEach(function(n){var o=t.view[n.setting],a=$('<div class="user-settings-row"></div>').appendTo(e);n.toggle?$('<label for="user-settings-'+n.setting+'"><input id="user-settings-'+n.setting+'" type="checkbox"> '+RED._(n.label)+"</label>").appendTo(a).find("input").prop("checked",o):($('<label for="user-settings-'+n.setting+'">'+RED._(n.label)+"</label>").appendTo(a),$('<input id="user-settings-'+n.setting+'" type="'+(n.type||"text")+'">').appendTo(a).val(o))})}),e}function d(e,t){var n=s[e],o=RED.settings.get("editor")||{};o.view=o.view||{},o.view[n.setting]=t,RED.settings.set("editor",o);var a=n.onchange;"string"==typeof a&&(a=RED.actions.get(a)),a&&a.call(n,t)}return{init:function(){RED.actions.add("core:show-user-settings",a),RED.actions.add("core:show-help",function(){a("keyboard")}),o({id:"view",title:RED._("menu.label.view.view"),get:r,close:function(){i.forEach(function(e){e.options.forEach(function(e){var t=$("#user-settings-"+e.setting);e.toggle?d(e.setting,t.prop("checked")):d(e.setting,t.val())})})}});var e=RED.settings.get("editor")||{};e.view=e.view||{};var t=!1;i.forEach(function(n){n.options.forEach(function(n){if(n.oldSetting){var o=RED.settings.get(n.oldSetting);void 0!==o&&null!==o&&(e.view[n.setting]=o,t=!0,RED.settings.remove(n.oldSetting))}if(s[n.setting]=n,n.onchange){var a=e.view[n.setting];null!==a&&void 0!==a||!n.hasOwnProperty("default")||(a=n.default,e.view[n.setting]=a,t=!0);var i=n.onchange;"string"==typeof i&&(i=RED.actions.get(i)),i&&i.call(n,a)}})}),t&&RED.settings.set("editor",e)},toggle:function(e){var t=s[e],n=RED.settings.get("editor")||{};n.view=n.view||{},d(e,!n.view[t.setting])},show:a,add:o}}(),RED.projects=function(){var e,t,n;function o(e){var t;"git_missing_user"===e.error?t=RED.notify("<p>You Git client is not configured with a username/email.</p>",{fixed:!0,type:"error",buttons:[{text:"Cancel",click:function(){t.close()}},{text:"Configure Git client",click:function(){RED.userSettings.show("gitconfig"),t.close()}}]}):(console.log(e),t=RED.notify("<p>An unexpected error occurred:</p><p>"+e.message+"</p><small>code: "+e.error+"</small>",{fixed:!0,modal:!0,type:"error",buttons:[{text:"Close",click:function(){t.close()}}]}))}var a={};function i(){var t=$('<div class="projects-dialog-screen-start-hero"></div>');$('<span><i class="fa fa-files-o fa-2x"></i> &nbsp; &nbsp; <i class="fa fa-long-arrow-right fa-2x"></i> &nbsp; &nbsp; <i class="fa fa-archive fa-2x"></i></span>').appendTo(t),$("<hr>").appendTo(t);var i,r,l,c,p,u,f,h,g,v,m,b,y,w,D,E,R,x,T,k={};a={welcome:{content:function(e){var n=$('<div class="projects-dialog-screen-start"></div>');t.appendTo(n);var o=$('<div class="projects-dialog-screen-start-body"></div>').appendTo(n);return $("<p>").text("Hello! We have introduced 'projects' to Node-RED.").appendTo(o),$("<p>").text("This is a new way for you to manage your flow files and includes version control of your flows.").appendTo(o),$("<p>").text("To get started you can create your first project or clone an existing project from a git repository.").appendTo(o),$("<p>").text("If you are not sure, you can skip this for now. You will still be able to create your first project from the 'Projects' menu at any time.").appendTo(o),n},buttons:[{text:"Not right now",click:function(){k={},$(this).dialog("close")}},{text:"Create your first project",class:"primary",click:function(){s("git-config")}}]},"git-config":{content:function(e){var n=!1,o=RED.settings.get("git");o&&o.user?o=o.user:RED.settings.git&&RED.settings.git.globalUser&&(n=!0,o=RED.settings.git.globalUser);var a=function(){var e=x.val().trim(),t=T.val().trim(),n=e.length>0&&t.length>0;$("#projects-dialog-git-config").prop("disabled",!n).toggleClass("disabled ui-button-disabled ui-state-disabled",!n)},i=$('<div class="projects-dialog-screen-start"></div>');t.appendTo(i);var s=$('<div class="projects-dialog-screen-start-body"></div>').appendTo(i);$("<p>").text("Setup your version control client").appendTo(s),$("<p>").text("Node-RED uses the open source tool Git for version control. It tracks changes to your project files and lets you push them to remote repositories.").appendTo(s),$("<p>").text("When you commit a set of changes, Git records who made the changes with a username and email address. The Username can be anything you want - it does not need to be your real name.").appendTo(s),n&&$("<p>").text("Your Git client is already configured with the details below.").appendTo(s),$("<p>").text("You can change these settings later under the 'Git config' tab of the settings dialog.").appendTo(s);var r=$('<div class="form-row"></div>').appendTo(s);return $('<label for="">Username</label>').appendTo(r),(x=$('<input type="text">').val(o&&o.name||"").appendTo(r)).on("change keyup paste",a),r=$('<div class="form-row"></div>').appendTo(s),$('<label for="">Email</label>').appendTo(r),(T=$('<input type="text">').val(o&&o.email||"").appendTo(r)).on("change keyup paste",a),setTimeout(function(){x.focus(),a()},50),i},buttons:[{text:"Back",click:function(){s("welcome")}},{id:"projects-dialog-git-config",text:"Next",class:"primary",click:function(){var e=RED.settings.get("git")||{};e.user=e.user||{},e.user.name=x.val(),e.user.email=T.val(),RED.settings.set("git",e),s("project-details")}}]},"project-details":{content:function(e){var n=null,o=!1;$.getJSON("projects",function(e){n={},e.projects.forEach(function(e){n[e]=!0,o&&(o=!1,s())})});var a=$('<div class="projects-dialog-screen-start"></div>');t.appendTo(a);var i=$('<div class="projects-dialog-screen-start-body"></div>').appendTo(a);$("<p>").text("Create your project").appendTo(i),$("<p>").text("A project is maintained as a Git repository. It makes it much easier to share your flows with others and to collaborate on them.").appendTo(i),$("<p>").text("You can create multiple projects and quickly switch between them from the editor.").appendTo(i),$("<p>").text("To begin, your project needs a name and an optional description.").appendTo(i);var s=function(){var e=E.val(),t=!0;if(u){if(null===n)return void(o=!0);p.empty(),!/^[a-zA-Z0-9\-_]+$/.test(e)||n[e]?(E.addClass("input-error"),$('<i style="margin-top: 8px;" class="fa fa-exclamation-triangle"></i>').appendTo(p),l=!1,t=!1,n[e]?projectNameSublabel.text("Project already exists"):projectNameSublabel.text("Must contain only A-Z 0-9 _ -")):(E.removeClass("input-error"),$('<i style="margin-top: 8px;" class="fa fa-check"></i>').appendTo(p),projectNameSublabel.text("Must contain only A-Z 0-9 _ -"),l=!0),f=e}t=l,$("#projects-dialog-create-name").prop("disabled",!t).toggleClass("disabled ui-button-disabled ui-state-disabled",!t)},r=$('<div class="form-row"></div>').appendTo(i);$('<label for="projects-dialog-screen-create-project-name">Project name</label>').appendTo(r);var d=$('<div style="position:relative;"></div>').appendTo(r);E=$('<input id="projects-dialog-screen-create-project-name" type="text"></input>').val(k.name||"").appendTo(d);var l,c,p=$('<div class="projects-dialog-screen-input-status"></div>').appendTo(d),u=!1,f="";return E.on("change keyup paste",function(){if(u=E.val()!==f,c)clearTimeout(c);else if(u&&(p.empty(),$('<img src="red/images/spin.svg"/>').appendTo(p),""===E.val()))return void s();c=setTimeout(function(){s(),c=null},300)}),projectNameSublabel=$('<label class="projects-edit-form-sublabel"><small>Must contain only A-Z 0-9 _ -</small></label>').appendTo(r).find("small"),r=$('<div class="form-row projects-dialog-screen-create-row projects-dialog-screen-create-row-empty"></div>').appendTo(i),$('<label for="projects-dialog-screen-create-project-desc">Description</label>').appendTo(r),R=$('<input id="projects-dialog-screen-create-project-desc" type="text">').val(k.summary||"").appendTo(r),$('<label class="projects-edit-form-sublabel"><small>Optional</small></label>').appendTo(r),setTimeout(function(){E.focus(),E.change()},50),a},buttons:function(e){return[{text:"Back",click:function(){s("git-config")}},{id:"projects-dialog-create-name",disabled:!0,text:"Next",class:"primary disabled",click:function(){k.name=E.val(),k.summary=R.val(),s("default-files",e)}}]}},"default-files":{content:function(e){var n=$('<div class="projects-dialog-screen-start"></div>');t.appendTo(n);var o=$('<div class="projects-dialog-screen-start-body"></div>').appendTo(n);$("<p>").text("Create your project files").appendTo(o),$("<p>").text("A project contains your flow files, a README file and a package.json file.").appendTo(o),$("<p>").text("It can contain any other files you want to maintain in the Git repository.").appendTo(o),!e.existingProject&&RED.settings.files&&$("<p>").text("Your existing flow and credential files will be copied into the project.").appendTo(o);var a=function(){var e=!0,t=w.val();""!==t&&/\.json$/.test(t)?(w.hasClass("input-error")&&(w.removeClass("input-error"),w.next().empty()),D.hasClass("input-error")&&(D.removeClass("input-error"),D.next().empty()),D.text(t.substring(0,t.length-5)+"_cred.json")):(e=!1,w.hasClass("input-error")||(w.addClass("input-error"),w.next().empty().append('<i style="margin-top: 8px;" class="fa fa-exclamation-triangle"></i>')),D.text(""),D.hasClass("input-error")||(D.addClass("input-error"),D.next().empty().append('<i style="margin-top: 8px;" class="fa fa-exclamation-triangle"></i>'))),$("#projects-dialog-create-default-files").prop("disabled",!e).toggleClass("disabled ui-button-disabled ui-state-disabled",!e)},i=$('<div class="form-row"></div>').appendTo(o);$('<label for="projects-dialog-screen-create-project-file">Flow file</label>').appendTo(i);var s=$('<div style="position:relative;"></div>').appendTo(i),r=k.files&&k.files.flow||RED.settings.files&&RED.settings.files.flow||"flow.json";w=$('<input id="projects-dialog-screen-create-project-file" type="text">').val(r).on("change keyup paste",a).appendTo(s),$('<div class="projects-dialog-screen-input-status"></div>').appendTo(s),$('<label class="projects-edit-form-sublabel"><small>*.json</small></label>').appendTo(i);var d=k.files&&k.files.credentials||RED.settings.files&&RED.settings.files.credentials||"flow_cred.json";return i=$('<div class="form-row"></div>').appendTo(o),$('<label for="projects-dialog-screen-create-project-credfile">Credentials file</label>').appendTo(i),s=$('<div style="position:relative;"></div>').appendTo(i),D=$('<div style="width: 100%" class="uneditable-input" id="projects-dialog-screen-create-project-credentials">').text(d).appendTo(s),$('<div class="projects-dialog-screen-input-status"></div>').appendTo(s),setTimeout(function(){w.focus(),a()},50),n},buttons:function(e){return[{text:e.existingProject?"Cancel":"Back",click:function(){e.existingProject?$(this).dialog("close"):s("project-details",e)}},{id:"projects-dialog-create-default-files",text:"Next",class:"primary",click:function(){k.files={flow:w.val(),credentials:D.text()},e.existingProject||(k.migrateFiles=!0),s("encryption-config",e)}}]}},"encryption-config":{content:function(e){var n=$('<div class="projects-dialog-screen-start"></div>');t.appendTo(n);var o=$('<div class="projects-dialog-screen-start-body"></div>').appendTo(n);$("<p>").text("Setup encryption of your credentials file").appendTo(o),e.existingProject?($("<p>").text("Your flow credentials file can be encrypted to keep its contents secure.").appendTo(o),$("<p>").text("If you want to store these credentials in a public Git repository, you must encrypt them by providing a secret key phrase.").appendTo(o)):"disabled"===RED.settings.flowEncryptionType?($("<p>").text("Your flow credentials file is not currently encrypted.").appendTo(o),$("<p>").text("That means its contents, such as passwords and access tokens, can be read by anyone with access to the file.").appendTo(o),$("<p>").text("If you want to store these credentials in a public Git repository, you must encrypt them by providing a secret key phrase.").appendTo(o)):("user"===RED.settings.flowEncryptionType?$("<p>").text("Your flow credentials file is currently encrypted using the credentialSecret property from your settings file as the key.").appendTo(o):"system"===RED.settings.flowEncryptionType&&$("<p>").text("Your flow credentials file is currently encrypted using a system-generated key. You should provide a new secret key for this project.").appendTo(o),$("<p>").text("The key will be stored separately from your project files. You will need to provide the key to use this project in another instance of Node-RED.").appendTo(o));var a=function(){var e=!0;"enabled"===$("input[name=projects-encryption-type]:checked").val()&&"custom"===$("input[name=projects-encryption-key]:checked").val()&&(e=e&&""!==y.val()),$("#projects-dialog-create-encryption").prop("disabled",!e).toggleClass("disabled ui-button-disabled ui-state-disabled",!e)},i=$('<div class="form-row projects-dialog-screen-create-row projects-dialog-screen-create-row-empty"></div>').appendTo(o);$("<label>Credentials</label>").appendTo(i);var s=$('<div style="width: 550px">').appendTo(i),r=$('<div style="min-height:150px; box-sizing: border-box; float: right; vertical-align: top; width: 331px; margin-left: -1px; padding: 15px; margin-top: -15px; border: 1px solid #ccc; border-radius: 3px;  display: inline-block">').appendTo(s),d=$('<div style="vertical-align: top; width: 220px;  display: inline-block">').appendTo(s),l=$('<div class="form-row" style="padding:  7px 8px 3px 8px;border: 1px solid #ccc;border-radius: 4px;border-top-right-radius: 0;border-bottom-right-radius: 0;border-right-color: white;"></div>').appendTo(d);$('<label class="projects-edit-form-inline-label" style="margin-left: 5px"><input type="radio" style="vertical-align: middle; margin-top:0; margin-right: 10px;" name="projects-encryption-type" value="enabled"> <i style="font-size: 1.4em; margin-right: 8px; vertical-align: middle; color: #888;" class="fa fa-lock"></i> <span style="vertical-align: middle;">Enable encryption</span></label>').appendTo(l);var c=$('<div class="form-row" style="padding:  7px 8px 3px 8px;border: 1px solid white;border-radius: 4px;border-top-right-radius: 0;border-bottom-right-radius: 0;border-right-color: #ccc; "></div>').appendTo(d);return $('<label class="projects-edit-form-inline-label" style="margin-left: 5px"><input type="radio" style="vertical-align: middle; margin-top:0; margin-right: 10px;" name="projects-encryption-type" value="disabled"> <i style="font-size: 1.4em; margin-right: 8px; vertical-align: middle; color: #888;" class="fa fa-unlock"></i> <span style="vertical-align: middle;">Disable encryption</span></label>').appendTo(c),d.find("input[name=projects-encryption-type]").click(function(e){var t,n;"enabled"===$(this).val()?(t=l,n=c,$(".projects-encryption-enabled-row").show(),$(".projects-encryption-disabled-row").hide(),"custom"===$("input[name=projects-encryption-key]:checked").val()&&y.focus()):(n=l,t=c,$(".projects-encryption-enabled-row").hide(),$(".projects-encryption-disabled-row").show()),t.css({borderColor:"#ccc",borderRightColor:"white"}),n.css({borderColor:"white",borderRightColor:"#ccc"}),a()}),i=$('<div class="form-row projects-encryption-enabled-row"></div>').appendTo(r),$('<label class="projects-edit-form-inline-label '+("user"!==RED.settings.flowEncryptionType?"disabled":"")+'" style="margin-left: 5px"><input '+("user"!==RED.settings.flowEncryptionType?"disabled":"")+' type="radio" style="vertical-align: middle; margin-top:0; margin-right: 10px;" value="default" name="projects-encryption-key"> <span style="vertical-align: middle;">Copy over existing key</span></label>').appendTo(i),i=$('<div class="form-row projects-encryption-enabled-row"></div>').appendTo(r),$('<label class="projects-edit-form-inline-label" style="margin-left: 5px"><input type="radio" style="vertical-align: middle; margin-top:0; margin-right: 10px;" value="custom" name="projects-encryption-key"> <span style="vertical-align: middle;">Use custom key</span></label>').appendTo(i),i=$('<div class="projects-encryption-enabled-row"></div>').appendTo(r),(y=$('<input disabled type="password" style="margin-left: 25px; width: calc(100% - 30px);"></input>').appendTo(i)).on("change keyup paste",a),i=$('<div class="form-row projects-encryption-disabled-row"></div>').hide().appendTo(r),$('<div class="" style="padding: 5px 20px;"><i class="fa fa-warning"></i> The credentials file will not be encrypted and its contents easily read</div>').appendTo(i),r.find("input[name=projects-encryption-key]").click(function(){var e=$(this).val();y.attr("disabled","default"===e),"custom"===e&&y.focus(),a()}),setTimeout(function(){d.find("input[name=projects-encryption-type][value=enabled]").click(),"user"!==RED.settings.flowEncryptionType?r.find("input[name=projects-encryption-key][value=custom]").click():r.find("input[name=projects-encryption-key][value=default]").click(),a()},100),n},buttons:function(t){return[{text:"Back",click:function(){s("default-files",t)}},{id:"projects-dialog-create-encryption",text:t.existingProject?"Create project files":"Create project",class:"primary disabled",disabled:!0,click:function(){"enabled"===$("input[name=projects-encryption-type]:checked").val()?"custom"===$("input[name=projects-encryption-key]:checked").val()&&(k.credentialSecret=y.val()):k.credentialSecret=!1,RED.deploy.setDeployInflight(!0),RED.projects.settings.switchProject(k.name);var a="POST",i="projects";t.existingProject&&(k.initialise=!0,a="PUT",i="projects/"+n.name);var r=this;d({url:i,type:a,requireCleanWorkspace:!0,handleAuthFail:!1,responses:{200:function(e){k={},t.existingProject?$(r).dialog("close"):(s("create-success"),RED.menu.setDisabled("menu-item-projects-open",!1),RED.menu.setDisabled("menu-item-projects-settings",!1))},400:{project_exists:function(e){console.log("already exists")},git_error:function(e){console.log("git error",e)},git_connection_failed:function(e){projectRepoInput.addClass("input-error")},git_auth_failed:function(e){projectRepoUserInput.addClass("input-error"),projectRepoPasswordInput.addClass("input-error"),console.log("git auth error",e)},"*":function(t){o(t),$(e).dialog("close")}}}},k).always(function(){setTimeout(function(){RED.deploy.setDeployInflight(!1)},500)})}}]}},"create-success":{content:function(e){var n=$('<div class="projects-dialog-screen-start"></div>');t.appendTo(n);var o=$('<div class="projects-dialog-screen-start-body"></div>').appendTo(n);return $("<p>").text("You have successfully created your first project!").appendTo(o),$("<p>").text("You can now continue to use Node-RED just as you always have.").appendTo(o),$("<p>").text("The 'info' tab in the sidebar shows you what your current active project is. The button next to the name can be used to access the project settings view.").appendTo(o),$("<p>").text("The 'history' tab in the sidebar can be used to view files that have changed in your project and to commit them. It shows you a complete history of your commits and allows you to push your changes to a remote repository.").appendTo(o),n},buttons:[{text:"Done",click:function(){$(this).dialog("close")}}]},create:{title:"Projects",content:function(e){var t=null;b=null;var o=!1;$.getJSON("projects",function(e){t={},e.projects.forEach(function(e){t[e]=!0,o&&(o=!1,y())})});var a,s=$('<div class="projects-dialog-screen-create"></div>'),y=function(){var e=i.val(),n=!0;if(_){if(null===t)return void(o=!0);k.empty(),!/^[a-zA-Z0-9\-_]+$/.test(e)||t[e]?(i.addClass("input-error"),$('<i style="margin-top: 8px;" class="fa fa-exclamation-triangle"></i>').appendTo(k),x=!1,n=!1,t[e]?g.text("Project already exists"):g.text("Must contain only A-Z 0-9 _ -")):(i.removeClass("input-error"),$('<i style="margin-top: 8px;" class="fa fa-check"></i>').appendTo(k),g.text("Must contain only A-Z 0-9 _ -"),x=!0),C=e}n=x;var a=$(".projects-dialog-screen-create-type.selected").data("type");if("copy"===a)n=!1;else if("clone"===a){var s=p.val(),r=s.length>0&&!/\s/.test(s);/^https?:\/\/[^/]+@/i.test(s)&&($("#projects-dialog-screen-create-project-repo-label small").text("Do not include the username/password in the url"),r=!1),r?p.removeClass("input-error"):(I&&p.addClass("input-error"),n=!1),/^https?:\/\//.test(s)?($(".projects-dialog-screen-create-row-creds").show(),$(".projects-dialog-screen-create-row-sshkey").hide()):/^(?:ssh|[\S]+?@[\S]+?):(?:\/\/)?/.test(s)?($(".projects-dialog-screen-create-row-creds").hide(),$(".projects-dialog-screen-create-row-sshkey").show()):($(".projects-dialog-screen-create-row-creds").hide(),$(".projects-dialog-screen-create-row-sshkey").hide())}else if("empty"===a){var d=l.val();""!==d&&/\.json$/.test(d)?l.hasClass("input-error")&&(l.removeClass("input-error"),l.next().empty()):(n=!1,l.hasClass("input-error")||(l.addClass("input-error"),l.next().empty().append('<i style="margin-top: 8px;" class="fa fa-exclamation-triangle"></i>'))),"enabled"===$("input[name=projects-encryption-type]:checked").val()&&"custom"===$("input[name=projects-encryption-key]:checked").val()&&(n=n&&""!==u.val())}else"open"===a&&(n=!!b);$("#projects-dialog-create").prop("disabled",!n).toggleClass("disabled ui-button-disabled ui-state-disabled",!n)};a=$('<div class="form-row button-group"></div>').appendTo(s);var w=$('<button data-type="open" class="editor-button projects-dialog-screen-create-type toggle"><i class="fa fa-archive fa-2x"></i><i style="position: absolute;" class="fa fa-folder-open"></i><br/>Open Project</button>').appendTo(a),D=$('<button data-type="empty" class="editor-button projects-dialog-screen-create-type toggle"><i class="fa fa-archive fa-2x"></i><i style="position: absolute;" class="fa fa-asterisk"></i><br/>Create Project</button>').appendTo(a),E=$('<button data-type="clone" class="editor-button projects-dialog-screen-create-type toggle"><i class="fa fa-archive fa-2x"></i><i style="position: absolute;" class="fa fa-git"></i><br/>Clone Repository</button>').appendTo(a);a.find(".projects-dialog-screen-create-type").click(function(e){switch(e.preventDefault(),s.find(".projects-dialog-screen-create-type").removeClass("selected"),$(this).addClass("selected"),s.find(".projects-dialog-screen-create-row").hide(),s.find(".projects-dialog-screen-create-row-"+$(this).data("type")).show(),y(),i.focus(),$(this).data("type")){case"open":$("#projects-dialog-create").text("Open project");break;case"empty":$("#projects-dialog-create").text("Create project");break;case"clone":$("#projects-dialog-create").text("Clone project")}}),a=$('<div class="form-row projects-dialog-screen-create-row projects-dialog-screen-create-row-open"></div>').hide().appendTo(s),function(e){(e=e||{}).height;var t,o=$("<div></div>",{class:"projects-dialog-project-list-container"}),a="",i=$("<div>",{class:"red-ui-search-container"}).appendTo(o),s=$('<input id="projects-dialog-project-list-search" type="text" placeholder="search your projects">').appendTo(i).searchBox({delay:200,change:function(){a=$(this).val().toLowerCase(),c.editableList("filter"),t&&!t.is(":visible")?(t.children().children().removeClass("selected"),(t=c.children(":visible").first()).children().children().addClass("selected"),e.select&&e.select(t.children().data("data"))):((t=c.children(":visible").first()).children().children().addClass("selected"),e.select&&e.select(t.children().data("data"))),r()}});s.on("keydown",function(n){if(40===n.keyCode){n.preventDefault();var o=t;if(t){do{o=o.next()}while(0!==o.length&&!o.is(":visible"));if(0===o.length)return;t.children().children().removeClass("selected")}else o=c.children(":visible").first();(t=o).children().children().addClass("selected"),e.select&&e.select(t.children().data("data")),r()}else if(38===n.keyCode){n.preventDefault();var a=t;if(t){do{a=a.prev()}while(0!==a.length&&!a.is(":visible"));if(0===a.length)return;t.children().children().removeClass("selected")}else a=c.children(":visible").first();(t=a).children().children().addClass("selected"),e.select&&e.select(t.children().data("data")),r()}else 13===n.keyCode&&(n.preventDefault(),t&&e.dblclick&&e.dblclick(t.children().data("data")))}),s.i18n();var r=function(){var e=c.find(".projects-dialog-project-list-entry.selected").parent().parent();if(1===e.length){var t=l,n=t.height(),o=(t.scrollTop(),e.position().top),a=e.height();o+a>n?t.animate({scrollTop:"-="+(n-o-a)},50):o<0&&t.animate({scrollTop:"+="+o},50)}},l=$("<div></div>",{class:"projects-dialog-project-list-inner-container"}).appendTo(o),c=$("<ol>",{class:"projects-dialog-project-list"}).appendTo(l).editableList({addButton:!1,height:"auto",scrollOnAdd:!1,addItem:function(o,a,i){var l=$("<div></div>",{class:"projects-dialog-project-list-entry"}).appendTo(o);if($('<span class="projects-dialog-project-list-entry-icon"><i class="fa fa-archive"></i></span>').appendTo(l),$('<span class="projects-dialog-project-list-entry-name" style=""></span>').text(i.name).appendTo(l),!n||n.name!==i.name||(l.addClass("projects-list-entry-current"),$('<span class="projects-dialog-project-list-entry-current">current</span>').appendTo(l),!1!==e.canSelectActive)){l.addClass("selectable");var p=$('<div class="projects-dialog-project-list-entry-tools"></div>').appendTo(l);$('<button class="editor-button editor-button-small" style="float: right;"><i class="fa fa-trash"></i></button>').appendTo(p).click(function(t){var n,a,s,r;t.stopPropagation(),t.preventDefault(),n=o,a=i.name,s=function(t){t||o.fadeOut(300,function(){c.editableList("removeItem",i),e.delete&&e.delete(i)})},r=$("<div>").css({background:"white",position:"absolute",top:0,right:0,bottom:0,left:"100%",overflow:"hidden",padding:"5px 20px",transition:"left 0.4s",whitespace:"nowrap",width:"1000px"}).click(function(e){e.stopPropagation()}).appendTo(n),$("<span>").css({lineHeight:"40px"}).text("Are you sure you want to delete this project?").appendTo(r),$('<button style="margin-left:20px" class="editor-button">Cancel</button>').appendTo(r).click(function(e){e.stopPropagation(),r.remove(),s(!0)}),$('<button style="margin-left:20px" class="editor-button primary">Delete</button>').appendTo(r).click(function(e){e.stopPropagation(),r.remove(),d({url:"projects/"+a,type:"DELETE",responses:{200:function(e){s(!1)},400:{unexpected_error:function(e){r.remove(),s(!0)}}}})}),setTimeout(function(){r.css("left",0)},50)}),o.click(function(n){$(".projects-dialog-project-list-entry").removeClass("selected"),l.addClass("selected"),t=o.parent(),e.select&&e.select(i),r(),s.focus()}),e.dblclick&&o.dblclick(function(t){t.preventDefault(),e.dblclick(i)})}},filter:function(e){return""===a||-1!==e.name.toLowerCase().indexOf(a)}});return $.getJSON("projects",function(e){e.projects.forEach(function(e){c.editableList("addItem",{name:e})})}),o}({canSelectActive:!1,dblclick:function(e){b=e,$("#projects-dialog-create").click()},select:function(e){b=e,y()},delete:function(e){t&&delete t[e.name],b=null,y()}}).appendTo(a),a=$('<div class="form-row projects-dialog-screen-create-row projects-dialog-screen-create-row-empty projects-dialog-screen-create-row-clone"></div>').appendTo(s),$('<label for="projects-dialog-screen-create-project-name">Project name</label>').appendTo(a);var R=$('<div style="position:relative;"></div>').appendTo(a);i=$('<input id="projects-dialog-screen-create-project-name" type="text"></input>').appendTo(R);var x,T,k=$('<div class="projects-dialog-screen-input-status"></div>').appendTo(R),_=!1,C="",j="";i.on("change keyup paste",function(){if(_=i.val()!==C,T)clearTimeout(T);else if(_&&(k.empty(),$('<img src="red/images/spin.svg"/>').appendTo(k),""===i.val()))return void y();T=setTimeout(function(){y(),T=null},300)}),g=$('<label class="projects-edit-form-sublabel"><small>Must contain only A-Z 0-9 _ -</small></label>').appendTo(a).find("small"),a=$('<div class="form-row projects-dialog-screen-create-row projects-dialog-screen-create-row-empty"></div>').appendTo(s),$('<label for="projects-dialog-screen-create-project-desc">Description</label>').appendTo(a),r=$('<input id="projects-dialog-screen-create-project-desc" type="text">').appendTo(a),$('<label class="projects-edit-form-sublabel"><small>Optional</small></label>').appendTo(a),a=$('<div class="form-row projects-dialog-screen-create-row projects-dialog-screen-create-row-empty"></div>').appendTo(s),$('<label for="projects-dialog-screen-create-project-file">Flow file</label>').appendTo(a),R=$('<div style="position:relative;"></div>').appendTo(a),l=$('<input id="projects-dialog-screen-create-project-file" type="text">').val("flow.json").on("change keyup paste",y).appendTo(R),$('<div class="projects-dialog-screen-input-status"></div>').appendTo(R),$('<label class="projects-edit-form-sublabel"><small>*.json</small></label>').appendTo(a),a=$('<div class="form-row projects-dialog-screen-create-row projects-dialog-screen-create-row-empty"></div>').appendTo(s),$("<label>Credentials</label>").appendTo(a);var S=$('<div style="width: 550px">').appendTo(a),O=$('<div style="min-height:150px; box-sizing: border-box; float: right; vertical-align: top; width: 331px; margin-left: -1px; padding: 15px; margin-top: -15px; border: 1px solid #ccc; border-radius: 3px;  display: inline-block">').appendTo(S),L=$('<div style="vertical-align: top; width: 220px;  display: inline-block">').appendTo(S),P=$('<div class="form-row" style="padding:  7px 8px 3px 8px;border: 1px solid #ccc;border-radius: 4px;border-top-right-radius: 0;border-bottom-right-radius: 0;border-right-color: white;"></div>').appendTo(L);$('<label class="projects-edit-form-inline-label" style="margin-left: 5px"><input type="radio" checked style="vertical-align: middle; margin-top:0; margin-right: 10px;" name="projects-encryption-type" value="enabled"> <i style="font-size: 1.4em; margin-right: 8px; vertical-align: middle; color: #888;" class="fa fa-lock"></i> <span style="vertical-align: middle;">Enable encryption</span></label>').appendTo(P);var N=$('<div class="form-row" style="padding:  7px 8px 3px 8px;border: 1px solid white;border-radius: 4px;border-top-right-radius: 0;border-bottom-right-radius: 0;border-right-color: #ccc; "></div>').appendTo(L);$('<label class="projects-edit-form-inline-label" style="margin-left: 5px"><input type="radio" style="vertical-align: middle; margin-top:0; margin-right: 10px;" name="projects-encryption-type" value="disabled"> <i style="font-size: 1.4em; margin-right: 8px; vertical-align: middle; color: #888;" class="fa fa-unlock"></i> <span style="vertical-align: middle;">Disable encryption</span></label>').appendTo(N),L.find("input[name=projects-encryption-type]").click(function(e){var t,n;"enabled"===$(this).val()?(t=P,n=N,$(".projects-encryption-enabled-row").show(),$(".projects-encryption-disabled-row").hide(),"custom"===$("input[name=projects-encryption-key]:checked").val()&&u.focus()):(n=P,t=N,$(".projects-encryption-enabled-row").hide(),$(".projects-encryption-disabled-row").show()),t.css({borderColor:"#ccc",borderRightColor:"white"}),n.css({borderColor:"white",borderRightColor:"#ccc"}),y()}),a=$('<div class="form-row projects-encryption-enabled-row"></div>').appendTo(O),$('<label class="projects-edit-form-inline-label">Encryption key</label>').appendTo(a),(u=$('<input type="password"></input>').appendTo(a)).on("change keyup paste",y),$('<label class="projects-edit-form-sublabel"><small>A phrase to secure your credentials with</small></label>').appendTo(a),a=$('<div class="form-row projects-encryption-disabled-row"></div>').hide().appendTo(O),$('<div class="" style="padding: 5px 20px;"><i class="fa fa-warning"></i> The credentials file will not be encrypted and its contents easily read</div>').appendTo(a),O.find("input[name=projects-encryption-key]").click(function(){var e=$(this).val();u.attr("disabled","default"===e),"custom"===e&&u.focus(),y()}),a=$('<div class="hide form-row projects-dialog-screen-create-row projects-dialog-screen-create-row-clone"></div>').appendTo(s),$('<label for="projects-dialog-screen-create-project-repo">Git repository URL</label>').appendTo(a),p=$('<input id="projects-dialog-screen-create-project-repo" type="text" placeholder="https://git.example.com/path/my-project.git"></input>').appendTo(a),$('<label id="projects-dialog-screen-create-project-repo-label" class="projects-edit-form-sublabel"><small>https://, ssh:// or file://</small></label>').appendTo(a);var I=!1,A="";p.on("change keyup paste",function(){I=!0;var e=$(this).val();A!==e&&$("#projects-dialog-screen-create-project-repo-label small").text("https://, ssh:// or file://"),A=e;var t=/\/([^/]+?)(?:\.git)?$/.exec(e);if(t){var n=i.val();""!==n&&n!==j||(j=t[1],i.val(j),i.change())}y()});var z=$('<div class="hide projects-dialog-screen-create-row projects-dialog-screen-create-row-clone"></div>').hide().appendTo(s);a=$('<div class="form-row projects-dialog-screen-create-row-auth-error"></div>').hide().appendTo(z),$('<div><i class="fa fa-warning"></i> Authentication failed</div>').appendTo(a),a=$('<div class="hide form-row projects-dialog-screen-create-row-creds"></div>').hide().appendTo(z),R=$('<div style="width: calc(50% - 10px); display:inline-block;"></div>').appendTo(a),$('<label for="projects-dialog-screen-create-project-repo-user">Username</label>').appendTo(R),f=$('<input id="projects-dialog-screen-create-project-repo-user" type="text"></input>').appendTo(R),R=$('<div style="width: calc(50% - 10px); margin-left: 20px; display:inline-block;"></div>').appendTo(a),$('<label for="projects-dialog-screen-create-project-repo-pass">Password</label>').appendTo(R),h=$('<input id="projects-dialog-screen-create-project-repo-pass" type="password"></input>').appendTo(R),a=$('<div class="form-row projects-dialog-screen-create-row projects-dialog-screen-create-row-sshkey"></div>').hide().appendTo(z),R=$('<div style="width: calc(50% - 10px); display:inline-block;"></div>').appendTo(a),$('<label for="projects-dialog-screen-create-project-repo-passphrase">SSH Key</label>').appendTo(R),v=$("<select>",{style:"width: 100%"}).appendTo(R),$.getJSON("settings/user/keys",function(e){var t=0;e.keys.forEach(function(e){v.append($("<option></option>").val(e.name).text(e.name)),t++}),0===t?(v.addClass("input-error"),v.attr("disabled",!0),M.show()):(v.removeClass("input-error"),v.attr("disabled",!1),M.hide())}),R=$('<div style="width: calc(50% - 10px); margin-left: 20px; display:inline-block;"></div>').appendTo(a),$('<label for="projects-dialog-screen-create-project-repo-passphrase">Passphrase</label>').appendTo(R),m=$('<input id="projects-dialog-screen-create-project-repo-passphrase" type="password"></input>').appendTo(R),R=$('<div class="form-row projects-dialog-screen-create-row projects-dialog-screen-create-row-sshkey"></div>').appendTo(z);var M=$('<div class="projects-dialog-screen-create-row-auth-error-no-keys"></div>').hide().appendTo(R);switch($('<div class="form-row"><i class="fa fa-warning"></i> Before you can clone a repository over ssh you must add an SSH key to access it.</div>').appendTo(M),R=$('<div style="text-align: center">').appendTo(M),$('<button class="editor-button">Add an ssh key</button>').appendTo(R).click(function(e){e.preventDefault(),$("#projects-dialog-cancel").click(),RED.userSettings.show("gitconfig"),setTimeout(function(){$("#user-settings-gitconfig-add-key").click()},500)}),a=$('<div class="hide form-row projects-dialog-screen-create-row projects-dialog-screen-create-row-clone"></div>').appendTo(s),$("<label>Credentials encryption key</label>").appendTo(a),c=$('<input type="password"></input>').appendTo(a),e.screen||"empty"){case"empty":D.click();break;case"open":w.click();break;case"clone":E.click()}return setTimeout(function(){"open"!==(e.screen||"empty")?i.focus():$("#projects-dialog-project-list-search").focus()},50),s},buttons:function(t){var n;switch(t.screen||"empty"){case"open":n="Open project";break;case"empty":n="Create project";break;case"clone":n="Clone project"}return[{id:"projects-dialog-cancel",text:RED._("common.label.cancel"),click:function(){$(this).dialog("close")}},{id:"projects-dialog-create",text:n,class:"primary disabled",disabled:!0,click:function(){var t,n,a=$(".projects-dialog-screen-create-type.selected").data("type"),s={name:i.val()};if("empty"===a){s.summary=r.val(),s.files={flow:l.val()};var g=$("input[name=projects-encryption-type]:checked").val();s.credentialSecret="enabled"===g&&u.val()}else if("copy"===a)s.copy=(void 0).name;else if("clone"===a){s.credentialSecret=c.val();var y=p.val();if(/^(?:ssh|[\d\w\.\-_]+@[\w\.]+):(?:\/\/)?/.test(y)){var w=v.val();if(!w)return void console.log("Error! Can't get selected SSH key path.");s.git={remotes:{origin:{url:y,keyFile:w,passphrase:m.val()}}}}else s.git={remotes:{origin:{url:y,username:f.val(),password:h.val()}}}}else if("open"===a)return t=b.name,n=function(t,n){e.dialog("close"),t&&"credentials_load_failed"!==t.error&&console.log("unexpected_error",t)},RED.deploy.setDeployInflight(!0),RED.projects.settings.switchProject(t),void d({url:"projects/"+t,type:"PUT",requireCleanWorkspace:!0,responses:{200:function(e){n(null,e)},400:{"*":n}}},{active:!0}).then(function(){RED.events.emit("project:change",{name:t})}).always(function(){setTimeout(function(){RED.deploy.setDeployInflight(!1)},500)});$(".projects-dialog-screen-create-row-auth-error").hide(),f.removeClass("input-error"),h.removeClass("input-error"),v.removeClass("input-error"),m.removeClass("input-error"),RED.deploy.setDeployInflight(!0),RED.projects.settings.switchProject(s.name),d({url:"projects",type:"POST",handleAuthFail:!1,responses:{200:function(t){e.dialog("close")},400:{project_exists:function(e){console.log("already exists")},git_error:function(e){console.log("git error",e)},git_connection_failed:function(e){p.addClass("input-error"),$("#projects-dialog-screen-create-project-repo-label small").text("Connection failed")},git_not_a_repository:function(e){p.addClass("input-error"),$("#projects-dialog-screen-create-project-repo-label small").text("Not a git repository")},git_repository_not_found:function(e){p.addClass("input-error"),$("#projects-dialog-screen-create-project-repo-label small").text("Repository not found")},git_auth_failed:function(e){$(".projects-dialog-screen-create-row-auth-error").show(),f.addClass("input-error"),h.addClass("input-error"),v.addClass("input-error"),m.addClass("input-error")},missing_flow_file:function(t){e.dialog("close")},project_empty:function(t){e.dialog("close")},credentials_load_failed:function(t){e.dialog("close")},"*":function(t){o(t),$(e).dialog("close")}}}},s).then(function(){RED.events.emit("project:change",{name:name})}).always(function(){setTimeout(function(){RED.deploy.setDeployInflight(!1)},500)})}}]}}}}function s(n,o){e||RED.projects.init();var i=a[n],s=i.content(o||{});t.empty();var r=i.buttons;"function"==typeof r&&(r=r(o||{})),e.dialog("option","buttons",r),t.append(s),e.dialog("option","title",i.title||""),e.dialog("open"),e.dialog({position:{my:"center top",at:"center top+10%",of:window}})}function r(e){if(RED.nodes.dirty())var t=RED.notify("<p>You have undeployed changes that will be lost.</p><p>Do you want to continue?</p>",{type:"info",fixed:!0,modal:!0,buttons:[{text:RED._("common.label.cancel"),click:function(){t.close(),e(!0)}},{text:"Continue",click:function(){t.close(),e(!1)}}]})}function d(e,t){var o,a;if(e.requireCleanWorkspace&&RED.nodes.dirty())return r(function(n){n?e.cancel&&(e.cancel(),a&&a()):(delete e.requireCleanWorkspace,d(e,t).then(function(){o&&o()}).always(function(){a&&a()}))}),{then:function(e){return o=e,{always:function(e){a=e}}},always:function(e){a=e}};var i,s,l=Date.now();return $(".projects-dialog-spinner").show(),$("#projects-dialog").parent().find(".ui-dialog-buttonset").children().css("visibility","hidden"),t&&(e.data=JSON.stringify(t),e.contentType="application/json; charset=utf-8"),$.ajax(e).done(function(t,n,o){e.responses&&e.responses[200]&&(i=e.responses[200],s=t)}).fail(function(o,a,r){if(e.responses&&e.responses[o.status]){var l=e.responses[o.status];if("function"==typeof l)return i=l,void(s={error:l.statusText});if(!1!==e.handleAuthFail&&"git_auth_failed"===o.responseJSON.error){var c=n.git.remotes[o.responseJSON.remote||e.remote||"origin"].fetch,p=$('<div><div class="form-row">Authentication required for repository:</div><div class="form-row"><div style="margin-left: 20px;">'+c+"</div></div></div>"),u=!1;if(/^https?:\/\//.test(c))$('<div class="form-row"><label for="projects-user-auth-username">Username</label><input id="projects-user-auth-username" type="text"></input></div><div class="form-row"><label for=projects-user-auth-password">Password</label><input id="projects-user-auth-password" type="password"></input></div>').appendTo(p);else if(/^(?:ssh|[\d\w\.\-_]+@[\w\.]+):(?:\/\/)?/.test(c)){u=!0;var f=$('<div class="form-row"></div>').appendTo(p);$('<label for="projects-user-auth-key">SSH Key</label>').appendTo(f);var h=$('<select id="projects-user-auth-key">').width("70%").appendTo(f);$.getJSON("settings/user/keys",function(e){e.keys.forEach(function(e){h.append($("<option></option>").val(e.name).text(e.name)),0})}),f=$('<div class="form-row"></div>').appendTo(p),$('<label for="projects-user-auth-passphrase">Passphrase</label>').appendTo(f),$('<input id="projects-user-auth-passphrase" type="password"></input>').appendTo(f)}var g=RED.notify(p,{type:"error",fixed:!0,modal:!0,buttons:[{text:RED._("common.label.cancel"),click:function(){g.close()}},{text:$('<span><i class="fa fa-refresh"></i> Retry</span>'),click:function(){t=t||{};var a={};u?(a.keyFile=$("#projects-user-auth-key").val(),a.passphrase=$("#projects-user-auth-passphrase").val()):(a.username=$("#projects-user-auth-username").val(),a.password=$("#projects-user-auth-password").val());var i=function(n){n?(console.log("Failed to update auth"),console.log(n)):(d(e,t),g.close())};d({url:"projects/"+n.name+"/remotes/"+(o.responseJSON.remote||e.remote||"origin"),type:"PUT",responses:{0:function(e){i(e)},200:function(e){i(null)},400:{unexpected_error:function(e){i(e)}}}},{auth:a})}}]});return}if(l[o.responseJSON.error])return i=l[o.responseJSON.error],void(s=o.responseJSON);if(l["*"])return i=l["*"],void(s=o.responseJSON)}console.log("Unhandled error response:"),console.log(o),console.log(a),console.log(r)}).always(function(){var e=Date.now()-l;e=Math.max(0,500-e),setTimeout(function(){$(".projects-dialog-spinner").hide(),$("#projects-dialog").parent().find(".ui-dialog-buttonset").children().css("visibility",""),i&&i(s)},e)})}function l(e){var t,n="",a=[],i="",s=$('<div class="projects-branch-list">').appendTo(e.container),r=$('<input type="text">').attr("placeholder",e.placeholder).appendTo(s).searchBox({delay:200,change:function(){n=$(this).val(),/(\.\.|\/\.|[?*[~^: \\]|\/\/|\/.$|\/$)/.test(n)?(t.hasClass("input-error")||(t.addClass("input-error"),t.find("i").addClass("fa-warning").removeClass("fa-code-fork")),t.find("span").text("Invalid branch: "+i+n)):(t.hasClass("input-error")&&(t.removeClass("input-error"),t.find("i").removeClass("fa-warning").addClass("fa-code-fork")),t.find(".sidebar-version-control-branch-list-entry-create-name").text(i+n)),l.editableList("filter")}}),l=$("<ol>",{style:"height: 130px;"}).appendTo(s);return l.editableList({addButton:!1,scrollOnAdd:!1,addItem:function(n,o,a){var i=$('<div class="sidebar-version-control-branch-list-entry">').appendTo(n);a.hasOwnProperty("commit")?($('<i class="fa fa-code-fork"></i>').appendTo(i),$("<span>").text(a.name).appendTo(i),a.current&&(i.addClass("selected"),$('<span class="current"></span>').text(e.currentLabel||"current").appendTo(i))):(t=i,$('<i class="fa fa-code-fork"></i>').appendTo(i),$("<span>").text("Create branch:").appendTo(i),$('<div class="sidebar-version-control-branch-list-entry-create-name" style="margin-left: 10px;">').text(a.name).appendTo(i)),i.click(function(t){if(t.preventDefault(),!$(this).hasClass("input-error")){var n={};a.hasOwnProperty("commit")?($(this).hasClass("selected")&&(n.current=!0),n.name=a.name):(n.name=r.val(),n.create=!0,e.remote&&(n.name=e.remote()+"/"+n.name)),e.onselect&&e.onselect(n)}})},filter:function(e){var t=!e.hasOwnProperty("commit");return t&&""!==n&&-1===a.indexOf(i+n)||!t&&-1!==e.name.indexOf(n)}}),{refresh:function(t){r.searchBox("value",""),l.editableList("empty");var n=Date.now(),p=c(s).addClass("projects-dialog-spinner-contain");i=e.remote?e.remote()+"/":"",d({url:t,type:"GET",responses:{0:function(e){console.log(e)},200:function(e){a=e.branches,e.branches.forEach(function(e){l.editableList("addItem",e)}),l.editableList("addItem",{}),setTimeout(function(){p.remove()},Math.max(300-(Date.now()-n),0))},400:{git_connection_failed:function(e){RED.notify(e.message,"error")},git_not_a_repository:function(e){RED.notify(e.message,"error")},git_repository_not_found:function(e){RED.notify(e.message,"error")},unexpected_error:function(e){o(e)}}}})},filter:function(){l.editableList("filter")},focus:function(){r.focus()}}}function c(e){return $('<div class="projects-dialog-spinner"><img src="red/images/spin.svg"/></div>').appendTo(e)}function p(){createProjectOptions={},n?s("create",{screen:"empty"}):s("welcome")}return{init:function(){e=$('<div id="projects-dialog" class="hide node-red-dialog projects-edit-form"><form class="form-horizontal"></form><div class="projects-dialog-spinner hide"><img src="red/images/spin.svg"/></div></div>').appendTo("body").dialog({modal:!0,autoOpen:!1,width:600,resizable:!1,open:function(e){$(this).parent().find(".ui-dialog-titlebar-close").hide()},close:function(e){}}),t=e.find("form"),RED.actions.add("core:new-project",RED.projects.newProject),RED.actions.add("core:open-project",RED.projects.selectProject),RED.actions.add("core:show-project-settings",RED.projects.settings.show);var n={sendRequest:d,createBranchList:l,addSpinnerOverlay:c,reportUnexpectedError:o};RED.projects.settings.init(n),RED.projects.userSettings.init(n),RED.sidebar.versionControl.init(n),i()},showStartup:function(){RED.user.hasPermission("projects.write")?s("welcome"):RED.notify(RED._("user.errors.notAuthorized"),"error")},newProject:function(){if(RED.user.hasPermission("projects.write"))return RED.nodes.dirty()?r(function(e){e||p()}):void p();RED.notify(RED._("user.errors.notAuthorized"),"error")},selectProject:function(){RED.user.hasPermission("projects.write")?s("create",{screen:"open"}):RED.notify(RED._("user.errors.notAuthorized"),"error")},showCredentialsPrompt:function(){RED.user.hasPermission("projects.write")?RED.projects.settings.show("settings"):RED.notify(RED._("user.errors.notAuthorized"),"error")},showFilesPrompt:function(){RED.user.hasPermission("projects.write")?RED.projects.settings.show("settings"):RED.notify(RED._("user.errors.notAuthorized"),"error")},showProjectDependencies:function(){RED.projects.settings.show("deps")},createDefaultFileSet:function(){if(!n)throw new Error("Cannot create default file set without an active project");if(!n.empty)throw new Error("Cannot create default file set on a non-empty project");RED.user.hasPermission("projects.write")?(createProjectOptions={},s("default-files",{existingProject:!0})):RED.notify(RED._("user.errors.notAuthorized"),"error")},refresh:function(e){$.getJSON("projects",function(t){t.active?$.getJSON("projects/"+t.active,function(t){n=t,RED.sidebar.versionControl.refresh(!0),e&&e(n)}):e&&e(null)})},editProject:function(){RED.projects.settings.show()},getActiveProject:function(){return n}}}(),RED.projects.settings=function(){var e,t,n=700,o=!1,a=[];function i(e){a.push(e)}function s(e,t){var n,o;t.empty(),n=e.description?marked(e.description):'<span class="node-info-none">No description available</span>',(o=$('<span class="bidiAware" dir="'+RED.text.bidi.resolveBaseTextDir(n)+'">'+n+"</span>"),$(o).find("a").each(function(e){var t=$(this).attr("href");/^https?:/.test(t)&&$(this).attr("target","_blank")}),o).appendTo(t).find(".bidiAware").contents().filter(function(){return 3===this.nodeType&&""!==this.textContent.trim()}).wrap("<span></span>")}function r(e,t){t.empty(),e?t.text(e).removeClass("node-info-node"):t.text("No summary available").addClass("node-info-none")}function d(e){var n=$('<div id="project-settings-tab-main" class="project-settings-tab-pane node-help"></div>');$("<h1>").text(e.name).appendTo(n);var o=$('<div style="position: relative">').appendTo(n),a=$("<div></div>",{style:"color: #999"}).appendTo(o);r(e.summary,a),RED.user.hasPermission("projects.write")&&$('<button class="editor-button editor-button-small" style="float: right;">edit description</button>').prependTo(o).click(function(n){n.preventDefault(),function e(n,o,a){var i=a.prev();i.hide(),a.empty();var s=$('<span class="button-row" style="position: relative; float: right; margin-right:0;"></span>').appendTo(a),d=$('<input type="text" style="width: calc(100% - 150px); margin-right: 10px;">').val(o||"").appendTo(a);$('<button class="editor-button">Cancel</button>').appendTo(s).click(function(e){e.preventDefault(),r(n.summary,a),i.show()}),$('<button class="editor-button">Save</button>').appendTo(s).click(function(s){s.preventDefault();var l=d.val();r(l,a);var c=t.addSpinnerOverlay(a),p=function(t,s){if(t)return c.remove(),e(n,o,a);n.summary=l,c.remove(),r(n.summary,a),i.show()};t.sendRequest({url:"projects/"+n.name,type:"PUT",responses:{0:function(e){p(e)},200:function(e){RED.sidebar.versionControl.refresh(!0),p(null)},400:{"*":function(e){t.reportUnexpectedError(e),p(e)}}}},{summary:l})})}(e,e.summary,a)}),$("<hr>").appendTo(n);var i=$('<div class="node-help" style="position: relative"></div>').appendTo(n),d=$("<div>",{style:"min-height: 200px"}).appendTo(i);return s(e,d),RED.user.hasPermission("projects.write")&&$('<button class="editor-button editor-button-small" style="float: right;">edit README.md</button>').prependTo(i).click(function(n){n.preventDefault(),function e(n,o){RED.editor.editMarkdown({title:RED._("sidebar.project.editDescription"),header:$('<span><i class="fa fa-book"></i> README.md</span>'),value:n.description,complete:function(a){o.empty();var i=t.addSpinnerOverlay(o),r=function(t,i){if(t)return e(n,o);n.description=a,s(n,o)};t.sendRequest({url:"projects/"+n.name,type:"PUT",responses:{0:function(e){r(e)},200:function(e){r(null),RED.sidebar.versionControl.refresh(!0)},400:{"*":function(e){t.reportUnexpectedError(e),r(e)}}}},{description:a}).always(function(){i.remove()})}})}(e,d)}),n}function l(e,t){t.editableList("empty");var n=0;for(var o in v)v.hasOwnProperty(o)&&(t.editableList("addItem",{id:v[o].module,version:v[o].version,count:v[o].count,known:e.dependencies.hasOwnProperty(o),installed:!0}),n++,0===v[o].count&&0,e.dependencies.hasOwnProperty(o)||0);if(e.dependencies)for(var o in e.dependencies)if(e.dependencies.hasOwnProperty(o)&&!v.hasOwnProperty(o)){var a=!!RED.nodes.registry.getModule(o);t.editableList("addItem",{id:o,version:e.dependencies[o],count:0,known:!0,installed:a}),n++,a?0:0}0===n&&t.editableList("addItem",{index:0,label:"None"})}function c(e,n,o,a){var i=RED.projects.getActiveProject(),s=t.addSpinnerOverlay(n).addClass("projects-dialog-spinner-contain"),r=function(e,t){if(s.remove(),e)return a(e);i.dependencies=o,RED.sidebar.versionControl.refresh(!0),a()};t.sendRequest({url:"projects/"+i.name,type:"PUT",responses:{0:function(e){r(e)},200:function(e){RED.sidebar.versionControl.refresh(!0),r(null)},400:{"*":function(e){r(e)}}}},{dependencies:o})}function p(e){var t=$('<div id="project-settings-tab-deps" class="project-settings-tab-pane node-help"></div>');RED.user.hasPermission("projects.write")&&$('<button class="editor-button editor-button-small" style="margin-top:10px;float: right;">edit</button>').appendTo(t).click(function(o){o.preventDefault(),function e(t,n,o,a){var i=n||JSON.stringify(t.dependencies||{},"",4);"{}"===i&&(i="{\n\n}"),RED.editor.editJSON({title:RED._("sidebar.project.editDependencies"),value:i,requireValid:!0,complete:function(n){try{var i=JSON.parse(n);c(0,o,i,function(s){if(s)return e(t,n,o,a);t.dependencies=i,l(t,a)})}catch(i){e(t,n,o,a)}}})}(e,null,t,n)});var n=$("<ol>",{style:"position: absolute;top: 60px;bottom: 20px;left: 20px;right: 20px;"}).appendTo(t);return n.editableList({addButton:!1,addItem:function(t,o,a){var i=$("<div>",{class:"palette-module-header"}).appendTo(t);if(a.label)0===a.index?i.addClass("red-ui-search-empty"):t.parent().addClass("palette-module-section"),i.text(a.label);else{i.addClass("palette-module-header"),a.installed?0===a.count?i.addClass("palette-module-unused"):a.known||i.addClass("palette-module-unknown"):i.addClass("palette-module-not-installed"),a.element=i;var s=$('<div class="palette-module-meta palette-module-name"></div>').appendTo(i),r="fa-cube";a.installed||(r="fa-warning");var d=$('<i class="fa '+r+'"></i>').appendTo(s);a.icon=d,$("<span>").html(a.id).appendTo(s);var l=$('<div class="palette-module-meta palette-module-version"><i class="fa fa-tag"></i></div>').appendTo(i);$("<span>").html(a.version).appendTo(l);l=$('<div class="palette-module-meta"></div>').appendTo(i);var p=$('<div class="palette-module-button-group"></div>').appendTo(l);RED.user.hasPermission("projects.write")&&(a.installed||!1===RED.settings.theme("palette.editable")?a.known&&0===a.count?$('<a href="#" class="editor-button editor-button-small">remove from project</a>').appendTo(p).click(function(o){o.preventDefault();var i=$.extend(!0,{},e.dependencies);delete i[a.id],c(0,t,i,function(e){e?console.log(e):t.fadeOut(200,function(){n.editableList("removeItem",a)})})}):a.known||$('<a href="#" class="editor-button editor-button-small">add to project</a>').appendTo(p).click(function(n){n.preventDefault();var o=$.extend(!0,{},e.dependencies);o[a.id]=v[a.id].version,c(0,t,o,function(e){e?console.log(e):(p.remove(),i.removeClass("palette-module-unknown"))})}):$('<a href="#" class="editor-button editor-button-small">install</a>').appendTo(p).click(function(e){e.preventDefault(),RED.palette.editor.install(a,t,function(e){if(!e){a.installed=!0;RED.utils.addSpinnerOverlay(t,!0);setTimeout(function(){n.editableList("removeItem",a),v={},RED.nodes.eachNode(g),RED.nodes.eachConfig(g),a.count=v[a.id].count,n.editableList("addItem",a)},500)}})}))}},sort:function(e,t){return e.id.localeCompare(t.id)}}),l(e,n),t}function u(e,n,o,a,i){var s=$('<div class="project-file-listing-container"></div>',{style:"position: relative; min-height: 175px; height: 175px;"}).hide().appendTo(e),r=t.addSpinnerOverlay(s);return $.getJSON("projects/"+n.name+"/files",function(e){var t=Object.keys(e),n={};(t=t.filter(function(t){return!e[t].status||!/D/.test(e[t].status)})).sort(),t.forEach(function(e){e.split("/").reduce(function(e,t,n,o){if(t)return n<o.length-1?e[t]=e[t]||{}:e[t]=!0,e[t]},n)});var d=function(e,t,n){var o={name:e||"/",path:n+(n?"/":"")+e};return!0===t?(o.type="f",o):(o.type="d",o.children=[],o.path=o.path,Object.keys(t).forEach(function(e){o.children.push(d(e,t[e],o.path))}),o.children.sort(function(e,t){return e.hasOwnProperty("children")&&!t.hasOwnProperty("children")?-1:!e.hasOwnProperty("children")&&t.hasOwnProperty("children")?1:e.name.localeCompare(t.name)}),o)};n=d("",n,"");!function e(t,n,o,a,i,s){s=s||"";var r=$("<ol>",{class:"projects-dialog-file-list",style:s}).appendTo(t).editableList({addButton:!1,scrollOnAdd:!1,addItem:function(t,n,s){var r=$("<div></div>",{class:"projects-dialog-file-list-entry"}).appendTo(t);if(s.children){if($('<span class="projects-dialog-file-list-entry-folder"><i class="fa fa-angle-right"></i> <i class="fa fa-folder-o"></i></span>').appendTo(r),s.children.length>0){var d=$("<div></div>",{style:"padding-left: 20px;"}).appendTo(t);0===o.indexOf(s.path+"/")?r.addClass("expanded"):d.hide(),e(d,s.children,o,a,i),r.addClass("selectable"),r.click(function(e){$(this).hasClass("expanded")?($(this).removeClass("expanded"),d.slideUp(200)):($(this).addClass("expanded"),d.slideDown(200))})}}else{var l="fa-file-o";/\.json$/i.test(s.name)?l="fa-file-code-o":/\.md$/i.test(s.name)?l="fa-book":/^\.git/i.test(s.name)&&(l="fa-code-fork",r.addClass("projects-dialog-file-list-entry-file-type-git")),$('<span class="projects-dialog-file-list-entry-file"> <i class="fa '+l+'"></i></span>').appendTo(r),a.test(s.name)?(r.addClass("selectable"),s.path===o&&r.addClass("selected"),r.click(function(e){$(".projects-dialog-file-list-entry.selected").removeClass("selected"),$(this).addClass("selected"),i(s.path)}),r.dblclick(function(e){e.preventDefault(),i(s.path,!0)})):r.addClass("unselectable")}$('<span class="projects-dialog-file-list-entry-name" style=""></span>').text(s.name).appendTo(r)}});s||r.parent().css("overflow-y","");n.forEach(function(e){r.editableList("addItem",e)})}(s,n.children,o,a,i,"height: 175px"),r.remove()}),s}function f(e,n){$("<h3></h3>").text("Version Control").appendTo(n),function(e,n){var o=$('<div class="user-settings-section"></div>').appendTo(n);$("<h4></h4>").text("Branches").appendTo(o);var a=$('<div class="user-settings-row projects-dialog-list"></div>').appendTo(o),i=$("<ol>").appendTo(a).editableList({height:"auto",addButton:!1,scrollOnAdd:!1,addItem:function(n,o,a){var s=$('<div class="projects-dialog-list-entry">').appendTo(n);if(a.empty)return s.addClass("red-ui-search-empty"),void s.text("No branches");a.current&&s.addClass("current"),$('<span class="entry-icon"><i class="fa fa-code-fork"></i></span>').appendTo(s);var r=$("<span>").appendTo(s),d=$("<div>").appendTo(r);if($('<span class="entry-name">').text(a.name).appendTo(d),a.commit&&$('<span class="entry-detail">').text(a.commit.sha).appendTo(d),a.remote){var l=$("<div>").appendTo(r);$('<span class="entry-detail entry-remote-name">').text(a.remote||"").appendTo(l),a.status.ahead+a.status.behind>0&&$('<span class="entry-detail"><i class="fa fa-long-arrow-up"></i> <span>'+a.status.ahead+'</span> <i class="fa fa-long-arrow-down"></i> <span>'+a.status.behind+"</span></span>").appendTo(l)}if(!a.current){var c=$('<span class="entry-tools">').appendTo(s);$('<button class="editor-button editor-button-small"><i class="fa fa-trash"></i></button>').appendTo(c).click(function(o){o.preventDefault();var s=t.addSpinnerOverlay(n).addClass("projects-dialog-spinner-contain"),r=RED.notify("Are you sure you want to delete the local branch '"+a.name+"'? This cannot be undone.",{type:"warning",modal:!0,fixed:!0,buttons:[{text:RED._("common.label.cancel"),click:function(){s.remove(),r.close()}},{text:"Delete branch",click:function(){r.close();var o={url:"projects/"+e.name+"/branches/"+a.name,type:"DELETE",responses:{200:function(e){n.fadeOut(200,function(){i.editableList("removeItem",a),s.remove()})},400:{git_delete_branch_unmerged:function(e){r=RED.notify("The local branch '"+a.name+"' has unmerged changes that will be lost. Are you sure you want to delete it?",{type:"warning",modal:!0,fixed:!0,buttons:[{text:RED._("common.label.cancel"),click:function(){s.remove(),r.close()}},{text:"Delete unmerged branch",click:function(){o.url+="?force=true",r.close(),t.sendRequest(o)}}]})},"*":function(e){t.reportUnexpectedError(e),s.remove()}}}};t.sendRequest(o)}}]})})}}});$.getJSON("projects/"+e.name+"/branches",function(e){e.branches&&(e.branches.length>0?(e.branches.sort(function(e,t){return e.current?-1:t.current?1:e.name.localeCompare(t.name)}),e.branches.forEach(function(e){i.editableList("addItem",e)})):i.editableList("addItem",{empty:!0}))})}(e,n);var o=$('<div class="user-settings-section"></div>').appendTo(n),a=$("<h4></h4>").text("Git remotes").appendTo(o),i=$('<button class="editor-button editor-button-small" style="float: right; margin-right: 10px;">add remote</button>').appendTo(a).click(function(e){i.attr("disabled",!0),l.slideDown(200,function(){l[0].scrollIntoView(),r?(g.val("origin"),v.focus()):g.focus(),u()})}),s={empty:!0},r=!0,d=$('<div class="user-settings-row"></div>').appendTo(o),l=$('<div class="projects-dialog-list-dialog"></div>').hide().appendTo(d);d=$('<div class="user-settings-row projects-dialog-list"></div>').appendTo(o);var c=$("<ol>").appendTo(d);c.editableList({addButton:!1,height:"auto",addItem:function(n,o,a){var i=$('<div class="projects-dialog-list-entry">').appendTo(n);if(a.empty)return i.addClass("red-ui-search-empty"),void i.text("No remotes");$('<span class="entry-icon"><i class="fa fa-globe"></i></span>').appendTo(i);var d=$("<span>").appendTo(i);$('<div class="entry-name">').text(a.name).appendTo(d),a.urls.fetch===a.urls.push?$('<div class="entry-detail">').text(a.urls.fetch).appendTo(d):($('<div class="entry-detail">').text("fetch: "+a.urls.fetch).appendTo(d),$('<div class="entry-detail">').text("push: "+a.urls.push).appendTo(d));var l=$('<span class="entry-tools">').appendTo(i);$('<button class="editor-button editor-button-small"><i class="fa fa-trash"></i></button>').appendTo(l).click(function(o){o.preventDefault();var i=t.addSpinnerOverlay(n).addClass("projects-dialog-spinner-contain"),d=RED.notify("Are you sure you want to delete the remote '"+a.name+"'?",{type:"warning",modal:!0,fixed:!0,buttons:[{text:RED._("common.label.cancel"),click:function(){i.remove(),d.close()}},{text:"Delete remote",click:function(){d.close();var o={url:"projects/"+e.name+"/remotes/"+a.name,type:"DELETE",responses:{200:function(t){n.fadeOut(200,function(){c.editableList("removeItem",a),setTimeout(i.remove,100),0===t.remotes.length?(delete e.git.remotes,r=!0,c.editableList("addItem",s)):(e.git.remotes={},t.remotes.forEach(function(t){var n=t.name;delete t.name,e.git.remotes[n]=t})),RED.sidebar.versionControl.refresh()})},400:{"*":function(e){t.reportUnexpectedError(e),i.remove()}}}};t.sendRequest(o)}}]})})}});var p,u=function(){var e=/^[a-zA-Z0-9\-_]+$/.test(g.val()),t=v.val(),n=t.length>0&&!/\s/.test(t);/^https?:\/\/[^/]+@/i.test(t)?(m.text("Do not include the username/password in the url"),n=!1):m.text("https://, ssh:// or file://"),w.attr("disabled",!e||!n),g.toggleClass("input-error",f&&!e),v.toggleClass("input-error",h&&!n),p&&(p.close(),p=null)},f=!1,h=!1;$('<div class="projects-dialog-list-dialog-header">').text("Add remote").appendTo(l),d=$('<div class="user-settings-row"></div>').appendTo(l),$('<label for=""></label>').text("Remote name").appendTo(d);var g=$('<input type="text">').appendTo(d).on("change keyup paste",function(){f=!0,u()});$('<label class="projects-edit-form-sublabel"><small>Must contain only A-Z 0-9 _ -</small></label>').appendTo(d).find("small"),d=$('<div class="user-settings-row"></div>').appendTo(l),$('<label for=""></label>').text("URL").appendTo(d);var v=$('<input type="text">').appendTo(d).on("change keyup paste",function(){h=!0,u()}),m=$('<label class="projects-edit-form-sublabel"><small>https://, ssh:// or file://</small></label>').appendTo(d).find("small"),b=function(){i.attr("disabled",!1),l.hide(),g.val(""),v.val(""),p&&(p.close(),p=null)},y=$('<span class="button-row" style="position: relative; float: right; margin: 10px;"></span>').appendTo(l);$('<button class="editor-button">Cancel</button>').appendTo(y).click(function(e){e.preventDefault(),b()});var w=$('<button class="editor-button">Add remote</button>').appendTo(y).click(function(n){n.preventDefault();var o=t.addSpinnerOverlay(l).addClass("projects-dialog-spinner-contain"),a={name:g.val(),url:v.val()},i=function(e){o.remove(),e||b()};RED.deploy.setDeployInflight(!0),t.sendRequest({url:"projects/"+e.name+"/remotes",type:"POST",responses:{0:function(e){i(e)},200:function(t){e.git.remotes={},t.remotes.forEach(function(t){var n=t.name;delete t.name,e.git.remotes[n]=t}),D(),RED.sidebar.versionControl.refresh(),i()},400:{git_remote_already_exists:function(e){p=RED.popover.create({target:g,direction:"right",size:"small",content:"Remote already exists",autoClose:6e3}).open(),g.addClass("input-error"),i(e)},"*":function(e){t.reportUnexpectedError(e),i(e)}}}},a)}),D=function(){c.editableList("empty");var t=0;if(e.git.hasOwnProperty("remotes"))for(var n in e.git.remotes)e.git.remotes.hasOwnProperty(n)&&(t++,c.editableList("addItem",{name:n,urls:e.git.remotes[n]}));(r=0===t)&&c.editableList("addItem",s)};D()}function h(n){var o=$('<div id="project-settings-tab-settings" class="project-settings-tab-pane node-help"></div>');return function(n,o){var a,i=$("<h3></h3>").text("Files").appendTo(o),s=$('<div class="user-settings-section"></div>').appendTo(o);if(RED.user.hasPermission("projects.write"))var r=$('<button class="editor-button editor-button-small" style="float: right;">edit</button>').appendTo(i).click(function(e){e.preventDefault(),S.show(),r.hide(),l.hide(),c.show(),p.show(),f.hide(),h.show(),c.focus(),v.addClass("uneditable-input"),$(".user-settings-row-credentials").show(),v.css("height","auto"),w.hide(),m.show()});a=$('<div class="user-settings-row"></div>').appendTo(s),$('<label for=""></label>').text("Flow").appendTo(a);var d=$('<div class="uneditable-input" style="padding:0">').appendTo(a),l=$('<span style="display:inline-block; padding: 6px">').text(n.files.flow).appendTo(d),c=$('<input id="" type="text" style="margin-bottom: 0;width: 100%; border: none;">').val(n.files.flow).hide().appendTo(d),p=$('<button class="editor-button" style="border-top-right-radius: 4px; border-bottom-right-radius: 4px; width: 36px; height: 34px; position: absolute; top: -1px; right: -1px;"><i class="fa fa-folder-open-o"></i></button>').hide().appendTo(d).click(function(e){if($(this).hasClass("selected"))$(this).removeClass("selected"),d.find(".project-file-listing-container").slideUp(200,function(){$(this).remove(),d.css("height","")}),d.css("color","");else{$(this).addClass("selected"),d.css("color","inherit");var t=u(d,n,c.val(),/.*\.json$/,function(e,t){e&&c.val(e),t&&$(p).click(),g()});d.css("height","auto"),setTimeout(function(){t.slideDown(200)},50)}});a=$('<div class="user-settings-row"></div>').appendTo(s),$('<label for=""></label>').text("Credentials").appendTo(a);var f=$('<div class="uneditable-input">').text(n.files.credentials).appendTo(a),h=$('<div class="uneditable-input">').text(n.files.credentials).hide().insertAfter(f),g=function(){var e,t=c.val(),n=/^(.+?)(\.[^.]*)?$/.exec(t);n?h.text(n[1]+"_cred"+(n[2]||".json")):""===t&&h.text("");var o=""===t||/\.\./.test(t)||/\/$/.test(t);e=o||""===h.text(),T.is(":visible")&&(T.toggleClass("input-error",""===T.val()),e=e||""===T.val()),_.is(":visible")&&(_.toggleClass("input-error",""===_.val()),e=e||""===_.val()),c.toggleClass("input-error",o),h.toggleClass("input-error",""===h.text()),O.toggleClass("disabled",e),O.prop("disabled",e)};c.on("change keyup paste",g),n.files.flow||$('<span class="form-warning"><i class="fa fa-warning"></i> Missing</span>').appendTo(l),n.files.credentials||$('<span class="form-warning"><i class="fa fa-warning"></i> Missing</span>').appendTo(f),a=$('<div class="user-settings-row"></div>').appendTo(s),$("<label></label>").appendTo(a);var v=$('<span><i class="user-settings-credentials-state-icon fa"></i> <span class="user-settings-credentials-state"></span></span>').appendTo(a),m=$('<span class="button-group" style="margin-left: -72px;">').hide().appendTo(a);v.css("color","#666"),m.css("vertical-align","top");var b=$('<button class="editor-button" style="vertical-align: top; width: 36px; margin-bottom: 10px"><i class="fa fa-trash-o"></i></button>').appendTo(m).click(function(e){e.preventDefault(),$(this).hasClass("selected")?($(this).removeClass("selected"),w.hide()):(_.val(""),x.hide(),k.show(),$(this).addClass("selected"),y.removeClass("selected"),R.show(),C.show(),D.hide(),E.hide(),w.show()),g()}),y=$('<button class="editor-button" style="border-top-right-radius: 4px; border-bottom-right-radius: 4px; vertical-align: top; width: 36px; margin-bottom: 10px"><i class="fa fa-pencil"></i></button>').appendTo(m).click(function(e){e.preventDefault(),$(this).hasClass("selected")?($(this).removeClass("selected"),w.hide()):(T.val(""),_.val(""),n.settings.credentialSecretInvalid||!n.settings.credentialsEncrypted?(D.show(),E.hide(),x.hide()):(x.show(),D.hide(),E.show()),k.show(),y.addClass("selected"),b.removeClass("selected"),R.hide(),C.hide(),w.show()),g()});a=$('<div class="user-settings-row user-settings-row-credentials"></div>').hide().appendTo(s);var w=$("<div>",{style:"margin-top:10px"}).hide().appendTo(v),D=$('<div style="margin: 20px 0 10px 5px;">Set the encryption key:</div>').hide().appendTo(w),E=$('<div style="margin: 20px 0 10px 5px;">Change the encryption key:</div>').hide().appendTo(w),R=$('<div style="margin: 20px 0 10px 5px;">Reset the encryption key:</div>').hide().appendTo(w),x=$('<div class="user-settings-row user-settings-row-credentials"></div>').appendTo(w);$('<label for=""></label>').text("Current key").appendTo(x);var T=$('<input type="password">').appendTo(x).on("change keyup paste",function(){e&&(e.close(),e=null),g()}),k=$('<div class="user-settings-row user-settings-row-credentials"></div>').appendTo(w);$('<label for=""></label>').text("New key").appendTo(k);var _=$('<input type="password">').appendTo(k).on("change keyup paste",g),C=$('<div class="form-tips form-warning" style="margin: 10px;"><i class="fa fa-warning"></i> This will delete all existing credentials</div>').hide().appendTo(w),j=function(){r.show(),S.hide(),l.show(),c.hide(),p.hide(),f.show(),h.hide(),v.removeClass("uneditable-input"),v.css("height",""),p.removeClass("selected"),d.find(".project-file-listing-container").remove(),d.css("height",""),d.css("color",""),$(".user-settings-row-credentials").hide(),w.hide(),m.hide(),b.removeClass("selected"),y.removeClass("selected")},S=$('<span class="button-row" style="position: relative; float: right; margin-right:0;"></span>').hide().appendTo(s);$('<button class="editor-button">Cancel</button>').appendTo(S).click(function(e){e.preventDefault(),j()});var O=$('<button class="editor-button">Save</button>').appendTo(S).click(function(o){o.preventDefault();var a=t.addSpinnerOverlay(s),i=function(e){a.remove(),e?t.reportUnexpectedError(e):(l.text(c.val()),f.text(h.text()),j())},r={files:{flow:c.val(),credentials:h.text()}};b.hasClass("selected")&&(r.resetCredentialSecret=!0),(b.hasClass("selected")||y.hasClass("selected"))&&(r.credentialSecret=_.val(),T.is(":visible")&&(r.currentCredentialSecret=T.val())),RED.deploy.setDeployInflight(!0),t.sendRequest({url:"projects/"+n.name,type:"PUT",responses:{0:function(e){i(e)},200:function(e){n=e,RED.sidebar.versionControl.refresh(!0),L(),i()},400:{credentials_load_failed:function(e){i(e)},missing_current_credential_key:function(t){T.addClass("input-error"),e=RED.popover.create({target:T,direction:"right",size:"small",content:"Incorrect key",autoClose:3e3}).open(),i(t)},"*":function(e){i(e)}}}},r).always(function(){setTimeout(function(){RED.deploy.setDeployInflight(!1)},500)})}),L=function(){n.settings.credentialSecretInvalid?(v.find(".user-settings-credentials-state-icon").removeClass().addClass("user-settings-credentials-state-icon fa fa-warning"),v.find(".user-settings-credentials-state").text("Invalid encryption key")):n.settings.credentialsEncrypted?(v.find(".user-settings-credentials-state-icon").removeClass().addClass("user-settings-credentials-state-icon fa fa-lock"),v.find(".user-settings-credentials-state").text("Encryption enabled")):(v.find(".user-settings-credentials-state-icon").removeClass().addClass("user-settings-credentials-state-icon fa fa-unlock"),v.find(".user-settings-credentials-state").text("Encryption disabled")),b.toggleClass("disabled",!n.settings.credentialSecretInvalid&&!n.settings.credentialsEncrypted),b.prop("disabled",!n.settings.credentialSecretInvalid&&!n.settings.credentialsEncrypted)};g(),L()}(n,o),f(n,o),o}function g(e){if(!/^subflow:/.test(e.type)){var t=RED.nodes.registry.getNodeSetForType(e.type).module;"node-red"!==t&&(v.hasOwnProperty(t)||(v[t]={module:t,version:RED.nodes.registry.getModule(t).version,count:0,known:!1}),v[t].count++)}}var v={};return{init:function(n){t=n,i({id:"main",title:"Project",get:d,close:function(){}}),i({id:"deps",title:"Dependencies",get:p,close:function(){}}),i({id:"settings",title:"Settings",get:h,close:function(){e&&(e.close(),e=null)}}),RED.events.on("nodes:add",g),RED.events.on("nodes:remove",function(e){if(!/^subflow:/.test(e.type)){var t=RED.nodes.registry.getNodeSetForType(e.type).module;"node-red"!==t&&v.hasOwnProperty(t)&&(v[t].count--,0===v[t].count&&(v[t].known||delete v[t]))}})},show:function(e){if(!o)if(RED.user.hasPermission("projects.write")){o=!0;var t={title:"Project Settings",buttons:[{id:"node-dialog-ok",text:RED._("common.label.close"),class:"primary",click:function(){RED.tray.close()}}],resize:function(e){n=e.width},open:function(t){var n=RED.projects.getActiveProject(),o=t.find(".editor-tray-body"),i=$("<div></div>").appendTo(o),s=$("<div></div>",{id:"user-settings-tabs-container"}).appendTo(i);$("<ul></ul>",{id:"user-settings-tabs"}).appendTo(s);var r=RED.tabs.create({id:"user-settings-tabs",vertical:!0,onchange:function(e){setTimeout(function(){$("#user-settings-tabs-content").children().hide(),$("#"+e.id).show(),e.pane.focus&&e.pane.focus()},50)}}),d=$("<div></div>",{id:"user-settings-tabs-content"}).appendTo(i);a.forEach(function(e){r.addTab({id:"project-settings-tab-"+e.id,label:e.title,pane:e}),e.get(n).hide().appendTo(d)}),i.i18n(),r.activateTab("project-settings-tab-"+(e||"main")),$("#sidebar-shade").show()},close:function(){o=!1,a.forEach(function(e){e.close&&e.close()}),$("#sidebar-shade").hide()},show:function(){}};null!==n&&(t.width=n),RED.tray.show(t)}else RED.notify(RED._("user.errors.notAuthorized"),"error")},switchProject:function(e){v={}}}}(),RED.projects.userSettings=function(){var e,t,n;function o(o){var a=$('<div id="user-settings-tab-gitconfig" class="project-settings-tab-pane node-help"></div>');return function(n){var o=RED.settings.get("git")||{};o.user=o.user||{},$("<h3></h3>").text("Committer Details").appendTo(n);var a=$('<div class="user-settings-section"></div>').appendTo(n);$('<div style="color:#aaa;"></div>').appendTo(a).text("Leave blank to use system default");var i=$('<div class="user-settings-row"></div>').appendTo(a);$('<label for=""></label>').text("Username").appendTo(i),(e=$('<input type="text">').appendTo(i)).val(o.user.name||""),i=$('<div class="user-settings-row"></div>').appendTo(a),$('<label for=""></label>').text("Email").appendTo(i),(t=$('<input type="text">').appendTo(i)).val(o.user.email||"")}(a),function(e){var o,a=$('<div class="user-settings-section"></div>').appendTo(e),i=($("<h3></h3>").text("SSH Keys").appendTo(a),$('<div style="color:#aaa;"></div>').appendTo(a).text("Allows you to create secure connections to remote git repositories.")),s=$('<button id="user-settings-gitconfig-add-key" class="editor-button editor-button-small" style="float: right; margin-right: 10px;">add key</button>').appendTo(i).click(function(e){s.attr("disabled",!0),b.attr("disabled",!0),l.slideDown(200),u.focus()}),r=function(){var e=/^[a-zA-Z0-9\-_]+$/.test(u.val());u.toggleClass("input-error",p&&!e);var t=h.val(),n=0===t.length||t.length>=8;h.toggleClass("input-error",!n),n?0===t.length?g.text("Optional"):g.text(""):g.text("Passphrase too short"),e=e&&n,b.attr("disabled",!e),o&&(o.close(),o=null)},d=$('<div class="user-settings-row"></div>').appendTo(a),l=$('<div class="projects-dialog-list-dialog"></div>').hide().appendTo(d);$('<div class="projects-dialog-list-dialog-header">').text("Add SSH Key").appendTo(l);var c=$("<div>").appendTo(l);d=$('<div class="user-settings-row"></div>').appendTo(c),$('<div style="color:#aaa;"></div>').appendTo(d).text("Generate a new public/private key pair"),d=$('<div class="user-settings-row"></div>').appendTo(c),$('<label for=""></label>').text("Name").appendTo(d);var p=!1,u=$('<input type="text">').appendTo(d).on("change keyup paste",function(){p=!0,r()});$('<label class="projects-edit-form-sublabel"><small>Must contain only A-Z 0-9 _ -</small></label>').appendTo(d).find("small");var f=$("<div>").appendTo(c);d=$('<div class="user-settings-row"></div>').appendTo(f),$('<label for=""></label>').text("Passphrase").appendTo(d);var h=$('<input type="password">').appendTo(d).on("change keyup paste",r),g=$('<label class="projects-edit-form-sublabel"><small>Optional</small></label>').appendTo(d).find("small"),v=function(){s.attr("disabled",!1),l.hide(),u.val(""),p=!1,h.val(""),o&&(o.close(),o=null)},m=$('<span class="button-row" style="position: relative; float: right; margin: 10px;"></span>').appendTo(l);$('<button class="editor-button">Cancel</button>').appendTo(m).click(function(e){e.preventDefault(),v()});var b=$('<button class="editor-button">Generate key</button>').appendTo(m).click(function(e){e.preventDefault();var o=n.addSpinnerOverlay(l).addClass("projects-dialog-spinner-contain"),a={name:u.val(),type:"generate"};a.comment=t.val(),a.password=h.val(),a.size=4096;var i=function(e){o.remove(),e||v()};RED.deploy.setDeployInflight(!0),n.sendRequest({url:"settings/user/keys",type:"POST",responses:{0:function(e){i(e)},200:function(e){E(a.name),i()},400:{unexpected_error:function(e){console.log(e),i(e)}}}},a)});d=$('<div class="user-settings-row projects-dialog-list"></div>').appendTo(a);var y={empty:!0},w=function(e,t){var o=$('<div class="projects-dialog-ssh-public-key">',{style:"position:relative"}).appendTo(e),a=$("<pre>",{style:"min-height: 80px"}).appendTo(o),i=n.addSpinnerOverlay(a).addClass("projects-dialog-spinner-contain"),s={url:"settings/user/keys/"+t.name,type:"GET",responses:{200:function(e){a.text(e.publickey),i.remove()},400:{unexpected_error:function(e){console.log(e),i.remove()}}}};n.sendRequest(s);var r=$('<span class="button-row" style="position: relative; float: right; margin: 10px;"></span>').appendTo(o);return $('<button class="editor-button editor-button-small">Copy public key to clipboard</button>').appendTo(r).click(function(e){try{e.stopPropagation(),e.preventDefault(),document.getSelection().selectAllChildren(a[0]),document.execCommand("copy"),document.getSelection().empty()}catch(e){}}),o},D=$('<ol class="projects-dialog-ssh-key-list">').appendTo(d).editableList({height:"auto",addButton:!1,scrollOnAdd:!1,addItem:function(e,t,o){var a=$('<div class="projects-dialog-list-entry">').appendTo(e);if(o.empty)return a.addClass("red-ui-search-empty"),void a.text("No SSH keys");var i=$('<div class="projects-dialog-ssh-key-header">').appendTo(a);$('<span class="entry-icon"><i class="fa fa-key"></i></span>').appendTo(i),$('<span class="entry-name">').text(o.name).appendTo(i);var s,r=$('<span class="button-row entry-tools">').appendTo(i);i.click(function(e){s?s.slideUp(200,function(){s.remove(),s=null}):s=w(a,o)}),o.system||$('<button class="editor-button editor-button-small"><i class="fa fa-trash"></i></button>').appendTo(r).click(function(t){t.stopPropagation();var a=n.addSpinnerOverlay(e).addClass("projects-dialog-spinner-contain"),i=RED.notify("Are you sure you want to delete the SSH key '"+o.name+"'? This cannot be undone.",{type:"warning",modal:!0,fixed:!0,buttons:[{text:RED._("common.label.cancel"),click:function(){a.remove(),i.close()}},{text:"Delete key",click:function(){i.close();var t={url:"settings/user/keys/"+o.name,type:"DELETE",responses:{200:function(t){e.fadeOut(200,function(){D.editableList("removeItem",o),setTimeout(a.remove,100),0===D.editableList("length")&&D.editableList("addItem",y)})},400:{unexpected_error:function(e){console.log(e),a.remove()}}}};n.sendRequest(t)}}]})}),o.expand&&(s=w(a,o))}}),E=function(e){$.getJSON("settings/user/keys",function(t){t.keys&&(t.keys.sort(function(e,t){return e.name.localeCompare(t.name)}),D.editableList("empty"),t.keys.forEach(function(t){t.name===e&&(t.expand=!0),D.editableList("addItem",t)}),0===D.editableList("length")&&D.editableList("addItem",y))})};E()}(a),a}return{init:function(a){n=a,RED.userSettings.add({id:"gitconfig",title:"Git config",get:o,close:function(){var n=RED.settings.get("git")||{};n.user=n.user||{},n.user.name=e.val(),n.user.email=t.val(),RED.settings.set("git",n)}})}}}(),RED.sidebar.versionControl=function(){var e,t,n,o,a,i,s,r,d,l,c,p,u,f,h,g={};function v(e,t,n,o){e.addClass("sidebar-version-control-change-entry");var a=$("<div>").appendTo(e);if(t.label){if(e.addClass("node-info-none"),a.text(t.label),t.button){a.css({display:"inline-block",maxWidth:"300px",textAlign:"left"});var i=$('<div style="float: right; margin: 5px; height: 50px;"></div>').appendTo(a);$('<button class="editor-button editor-button-small"></button>').text(t.button.label).appendTo(i).click(t.button.click)}}else{var s,r,d=$('<i class=""></i>').appendTo(a),l=$('<a href="#">').appendTo(a).click(function(e){var n,a,i,s;e.preventDefault(),n=t,a=o,i=RED.projects.getActiveProject(),s="staged"===a?"index":"tree",h.sendRequest({url:"projects/"+i.name+"/diff/"+s+"/"+encodeURIComponent(n.file),type:"GET",responses:{0:function(e){console.log(e)},200:function(e){var t;t="unstaged"===a?"Unstaged changes : "+n.file:"staged"===a?"Staged changes : "+n.file:"Resolve conflicts : "+n.file;var o={diff:e.diff,title:t,unmerged:"unmerged"===a,project:i};"unstaged"==a?(o.oldRevTitle=" "===n.indexStatus?"HEAD":"Staged",o.newRevTitle="Unstaged",o.oldRev=" "===n.indexStatus?"@":":0",o.newRev="_"):"staged"===a?(o.oldRevTitle="HEAD",o.newRevTitle="Staged",o.oldRev="@",o.newRev=":0"):(o.oldRevTitle="Local",o.newRevTitle="Remote",o.commonRev=":1",o.oldRev=":2",o.newRev=":3",o.onresolve=function(e){h.sendRequest({url:"projects/"+i.name+"/resolve/"+encodeURIComponent(n.file),type:"POST",responses:{0:function(e){console.log(e)},200:function(e){x(!0)},400:{unexpected_error:function(e){console.log(e)}}}},{resolutions:e.resolutions[n.file]})}),RED.diff.showUnifiedDiff(o)},400:{unexpected_error:function(e){console.log(e)}}}})}),c=$("<span>").appendTo(l),p=$('<div class="sidebar-version-control-change-entry-tools">').appendTo(e);"unstaged"===o&&(s=$('<span class="button-group" style="margin-right: 5px;"></span>').appendTo(p),r=$('<button class="editor-button editor-button-small"><i class="fa fa-reply"></i></button>').appendTo(s).click(function(e){e.preventDefault();var n=h.addSpinnerOverlay(a).addClass("projects-dialog-spinner-contain"),o=RED.notify("Are you sure you want to revert the changes to '"+t.file+"'? This cannot be undone.",{type:"warning",modal:!0,fixed:!0,buttons:[{text:RED._("common.label.cancel"),click:function(){n.remove(),o.close()}},{text:"Revert changes",click:function(){o.close();var e={url:"projects/"+RED.projects.getActiveProject().name+"/files/_/"+t.file,type:"DELETE",responses:{200:function(e){n.remove()},400:{unexpected_error:function(e){n.remove(),console.log(e)}}}};RED.deploy.setDeployInflight(!0),h.sendRequest(e).always(function(){setTimeout(function(){RED.deploy.setDeployInflight(!1)},500)})}}]})})),s=$('<span class="button-group"></span>').appendTo(p),"unmerged"!==o&&$('<button class="editor-button editor-button-small"><i class="fa fa-'+("unstaged"===o?"plus":"minus")+'"></i></button>').appendTo(s).click(function(n){n.preventDefault();var a=RED.projects.getActiveProject();t.spinner=h.addSpinnerOverlay(e).addClass("projects-version-control-spinner-sidebar"),h.sendRequest({url:"projects/"+a.name+"/stage/"+encodeURIComponent(t.file),type:"unstaged"===o?"POST":"DELETE",responses:{0:function(e){console.log(e)},200:function(e){R(e)},400:{unexpected_error:function(e){console.log(e)}}}},{})}),t["update"+("unstaged"===o?"Unstaged":"Staged")]=function(e,t){a.removeClass();var n="";"A"===t?(a.addClass("node-diff-added"),n="fa-plus-square"):"?"===t?(a.addClass("node-diff-unchanged"),n="fa-question-circle-o"):"D"===t?(a.addClass("node-diff-deleted"),n="fa-minus-square"):"M"===t?(a.addClass("node-diff-changed"),n="fa-square"):"R"===t?(a.addClass("node-diff-changed"),n="fa-toggle-right"):"U"===t?(a.addClass("node-diff-conflicted"),n="fa-exclamation-triangle"):n="fa-exclamation-triangle",c.empty(),$("<span>").text(e.file.replace(/\\(.)/g,"$1")).appendTo(c),e.oldName&&($('<i class="fa fa-long-arrow-right"></i>').prependTo(c),$("<span>").text(e.oldName.replace(/\\(.)/g,"$1")).prependTo(c)),d.removeClass(),d.addClass("fa "+n),e.spinner&&(e.spinner.remove(),delete e.spinner),r&&r.toggle("?"!==t),l.toggleClass("disabled","D"===t||"?"===t)},t["update"+("unstaged"===o?"Unstaged":"Staged")](t,n)}}function m(e){var t=Date.now()/1e3-e,n=Math.floor(t/86400);if(n>30)return new Date(1e3*e).toLocaleDateString();if(n>0)return n+" day"+(n>1?"s":"")+" ago";var o=Math.floor(t/3600);if(o>0)return o+" hour"+(o>1?"s":"")+" ago";var a=Math.floor(t/60);return a>0?a+" minute"+(a>1?"s":"")+" ago":"Seconds ago"}function b(e,t){var o=RED.projects.getActiveProject();(s=t?h.addSpinnerOverlay(n.parent()):h.addSpinnerOverlay(a.parent())).addClass("projects-dialog-spinner-sidebar");var i=t?{files:e}:void 0;h.sendRequest({url:"projects/"+o.name+"/stage",type:t?"POST":"DELETE",responses:{0:function(e){console.log(e)},200:function(e){R(e)},400:{unexpected_error:function(e){console.log(e)}}}},i)}var y=!1,w={label:"None"},D={label:"All conflicts resolved. Commit the changes to complete the merge."};function E(e,t,n,o,a){var i=h.addSpinnerOverlay(n),s=e+"?limit="+(o||20);a&&(s+="&before="+a),h.sendRequest({url:s,type:"GET",responses:{0:function(e){console.log(e)},200:function(n){var a;n.commits.forEach(function(e){t.editableList("addItem",e),a=e.sha}),t.loadMoreItem&&(t.editableList("removeItem",t.loadMoreItem),delete t.loadMoreItem);var s=t.editableList("length");s<n.total&&(t.loadMoreItem={totalKnown:s,total:n.total,url:e,before:a+"~1",limit:o},t.editableList("addItem",t.loadMoreItem)),i.remove()},400:{unexpected_error:function(e){console.log(e)}}}})}function R(t){var c=t.files;s&&(s.remove(),s=null),(f=!!t.merging)?(e.addClass("sidebar-version-control-merging"),r.show()):(e.removeClass("sidebar-version-control-merging"),r.hide()),n.editableList("removeItem",w),a.editableList("removeItem",w),d.editableList("removeItem",D);var p=Object.keys(c).filter(function(e){return"f"===c[e].type});p.sort();var u=Date.now()+Math.floor(100*Math.random());p.forEach(function(e){var t=c[e],o=!1;t.status&&(t.file=e,t.indexStatus=t.status[0],t.treeStatus=t.status[1],("A"===t.indexStatus&&/[AU]/.test(t.treeStatus)||"U"===t.indexStatus&&/[DAU]/.test(t.treeStatus)||"D"===t.indexStatus&&/[DU]/.test(t.treeStatus))&&(t.unmerged=!0),g[e]?(g[e].unmerged&&!t.unmerged?(d.editableList("removeItem",g[e]),o=!0):!g[e].unmerged&&t.unmerged&&(n.editableList("removeItem",g[e]),a.editableList("removeItem",g[e])),g[e].status!==t.status&&(" "!==g[e].treeStatus?" "===t.treeStatus?n.editableList("removeItem",g[e]):t.treeStatus!==g[e].treeStatus&&g[e].updateUnstaged(t,t.treeStatus):o=!0," "!==g[e].indexStatus&&"?"!==g[e].indexStatus?" "===t.indexStatus||"?"===t.indexStatus?a.editableList("removeItem",g[e]):t.indexStatus!==g[e].indexStatus&&g[e].updateStaged(t,t.indexStatus):o=!0),g[e].status=t.status,g[e].indexStatus=t.indexStatus,g[e].treeStatus=t.treeStatus,g[e].oldName=t.oldName,g[e].unmerged=t.unmerged):(o=!0,g[e]=t),g[e].updateIndex=u,o&&(t.unmerged?d.editableList("addItem",g[e]):(" "!==t.treeStatus&&n.editableList("addItem",g[e])," "!==t.indexStatus&&"?"!==t.indexStatus&&a.editableList("addItem",g[e]))))}),Object.keys(g).forEach(function(e){g[e].updateIndex!==u&&(n.editableList("removeItem",g[e]),a.editableList("removeItem",g[e]),delete g[e])});var h=a.editableList("length"),v=n.editableList("length"),m=d.editableList("length");l.attr("disabled",f&&m>0||!f&&0===h),o.attr("disabled",0===v),i.attr("disabled",0===h),0===h&&a.editableList("addItem",w),0===v&&n.editableList("addItem",w),0===m&&d.editableList("addItem",D)}function x(e,t){if(!y&&(e&&(g={},n.editableList("empty"),a.editableList("empty"),d.editableList("empty")),RED.user.hasPermission("projects.write"))){y=!0,function(){p.editableList("empty");var e=RED.projects.getActiveProject();e&&E("projects/"+e.name+"/commits",p,p.parent())}();var o=RED.projects.getActiveProject();if(o){var i="projects/"+o.name+"/status";t&&(i+="?remote=true"),$.getJSON(i,function(e){R(e),$("#sidebar-version-control-local-branch").text(e.branches.local),$("#sidebar-version-control-remote-branch").text(e.branches.remote||"none");var t=e.commits.ahead||0,n=e.commits.behind||0;o.git.hasOwnProperty("remotes")?e.branches.hasOwnProperty("remoteError")&&"git_remote_gone"!==e.branches.remoteError.code?($("#sidebar-version-control-repo-status-auth-issue").show(),$("#sidebar-version-control-repo-status-stats").hide(),$("#sidebar-version-control-repo-branch").attr("disabled",!0),$("#sidebar-version-control-repo-pull").attr("disabled",!0),$("#sidebar-version-control-repo-push").attr("disabled",!0),$("#sidebar-version-control-repo-toolbar-message").hide(),$("#sidebar-version-control-repo-toolbar-error-message").show()):($("#sidebar-version-control-repo-toolbar-message").show(),$("#sidebar-version-control-repo-toolbar-error-message").hide(),$("#sidebar-version-control-repo-status-auth-issue").hide(),$("#sidebar-version-control-repo-status-stats").show(),$("#sidebar-version-control-repo-branch").attr("disabled",!1),$("#sidebar-version-control-repo-status-button").show(),e.branches.hasOwnProperty("remote")?T(t,n):($("#sidebar-version-control-commits-ahead").text(""),$("#sidebar-version-control-commits-behind").text(""),$("#sidebar-version-control-repo-toolbar-message").text("Your local branch is not currently tracking a remote branch."),$("#sidebar-version-control-repo-pull").attr("disabled",!0),$("#sidebar-version-control-repo-push").attr("disabled",!0))):$("#sidebar-version-control-repo-status-button").hide(),y=!1,$(".sidebar-version-control-shade").hide()}).fail(function(){y=!1})}else $(".sidebar-version-control-shade").show(),n.editableList("empty"),a.editableList("empty"),d.editableList("empty")}}function T(e,t){$("#sidebar-version-control-commits-ahead").text(e),$("#sidebar-version-control-commits-behind").text(t),f?($("#sidebar-version-control-repo-toolbar-message").text("Your repository has unmerged changes. You need to fix the conflicts and commit the result."),$("#sidebar-version-control-repo-pull").attr("disabled",!0),$("#sidebar-version-control-repo-push").attr("disabled",!0)):e>0&&0===t?($("#sidebar-version-control-repo-toolbar-message").text("Your repository is "+e+" commit"+(1===e?"":"s")+" ahead of the remote. You can push "+(1===e?"this commit":"these commits")+" now."),$("#sidebar-version-control-repo-pull").attr("disabled",!0),$("#sidebar-version-control-repo-push").attr("disabled",!1)):0===e&&t>0?($("#sidebar-version-control-repo-toolbar-message").text("Your repository is "+t+" commit"+(1===t?"":"s")+" behind of the remote. You can pull "+(1===t?"this commit":"these commits")+" now."),$("#sidebar-version-control-repo-pull").attr("disabled",!1),$("#sidebar-version-control-repo-push").attr("disabled",!0)):e>0&&t>0?($("#sidebar-version-control-repo-toolbar-message").text("Your repository is "+t+" commit"+(1===t?"":"s")+" behind and "+e+" commit"+(1===e?"":"s")+" ahead of the remote. You must pull the remote commit"+(1===t?"":"s")+" down before pushing."),$("#sidebar-version-control-repo-pull").attr("disabled",!1),$("#sidebar-version-control-repo-push").attr("disabled",!0)):0===e&&0===t&&($("#sidebar-version-control-repo-toolbar-message").text("Your repository is up to date."),$("#sidebar-version-control-repo-pull").attr("disabled",!0),$("#sidebar-version-control-repo-push").attr("disabled",!0))}function k(){x(),RED.sidebar.show("version-control")}return{init:function(s){h=s,RED.actions.add("core:show-version-control-tab",k),RED.events.on("deploy",function(){var e=RED.projects.getActiveProject();e&&(g={},n.editableList("empty"),a.editableList("empty"),d.editableList("empty"),$.getJSON("projects/"+e.name+"/status",function(e){R(e)}))}),RED.events.on("login",function(){x(!0)}),e=$("<div>",{class:"sidebar-version-control"});var f=$("<div>",{class:"sidebar-version-control-stack"}).appendTo(e);t=RED.stack.create({container:f,fill:!0,singleExpanded:!0}),(c=t.add({title:"Local Changes",collapsible:!0})).expand(),c.content.css({height:"100%"});var y=$('<div style="float: right"></div>').appendTo(c.header);$('<button class="editor-button editor-button-small"><i class="fa fa-refresh"></i></button>').appendTo(y).click(function(e){e.preventDefault(),x(!0)});var w=$('<div class="sidebar-version-control-change-container"></div>').appendTo(c.content),_=$('<div class="sidebar-version-control-change-header">Local files</div>').appendTo(w);o=$('<button class="editor-button editor-button-small" style="float: right"><i class="fa fa-plus"></i> all</button>').appendTo(_).click(function(e){e.preventDefault(),e.stopPropagation(),b(Object.keys(g).filter(function(e){return" "!==g[e].treeStatus}),!0)}),(n=$("<ol>",{style:"position: absolute; top: 30px; bottom: 0; right:0; left:0;"}).appendTo(w)).editableList({addButton:!1,scrollOnAdd:!1,addItem:function(e,t,n){v(e,n,n.treeStatus,"unstaged")},sort:function(e,t){return"?"===e.treeStatus&&"?"!==t.treeStatus?1:"?"!==e.treeStatus&&"?"===t.treeStatus?-1:e.file.localeCompare(t.file)}}),r=$('<div class="sidebar-version-control-change-container"></div>').appendTo(c.content),_=$('<div class="sidebar-version-control-change-header">Unmerged changes</div>').appendTo(r),y=$('<div style="float: right"></div>').appendTo(_);var C=$('<button class="editor-button editor-button-small" style="margin-right: 5px;">abort merge</button>').appendTo(y).click(function(e){e.preventDefault(),e.stopPropagation();var t=h.addSpinnerOverlay(r),n=RED.projects.getActiveProject();RED.deploy.setDeployInflight(!0),h.sendRequest({url:"projects/"+n.name+"/merge",type:"DELETE",responses:{0:function(e){console.log(e)},200:function(e){t.remove(),x(!0)},400:{unexpected_error:function(e){console.log(e)}}}}).always(function(){setTimeout(function(){RED.deploy.setDeployInflight(!1)},500)})});(d=$("<ol>",{style:"position: absolute; top: 30px; bottom: 0; right:0; left:0;"}).appendTo(r)).editableList({addButton:!1,scrollOnAdd:!1,addItem:function(e,t,n){n===D&&(n.button={label:"commit",click:function(e){e.preventDefault(),e.stopPropagation(),S()}}),v(e,n,n.treeStatus,"unmerged")},sort:function(e,t){return"?"===e.treeStatus&&"?"!==t.treeStatus?1:"?"!==e.treeStatus&&"?"===t.treeStatus?-1:e.file.localeCompare(t.file)}});var j=$('<div class="sidebar-version-control-change-container"></div>').appendTo(c.content);_=$('<div class="sidebar-version-control-change-header">Changes to commit</div>').appendTo(j),y=$('<div style="float: right"></div>').appendTo(_);var S=function(){O.val(""),N.attr("disabled",!0),w.css("height","30px"),r.is(":visible")?(r.css("height","30px"),j.css("height","calc(100% - 60px - 175px)")):j.css("height","calc(100% - 30px - 175px)"),commitBox.show(),setTimeout(function(){commitBox.css("height","175px")},10),o.attr("disabled",!0),i.attr("disabled",!0),l.attr("disabled",!0),C.attr("disabled",!0),O.focus()};l=$('<button class="editor-button editor-button-small" style="margin-right: 5px;">commit</button>').appendTo(y).click(function(e){e.preventDefault(),e.stopPropagation(),S()}),i=$('<button class="editor-button editor-button-small"><i class="fa fa-minus"></i> all</button>').appendTo(y).click(function(e){e.preventDefault(),e.stopPropagation(),b(Object.keys(g).filter(function(e){return" "!==g[e].indexStatus&&"?"!==g[e].indexStatus}),!1)}),(a=$("<ol>",{style:"position: absolute; top: 30px; bottom: 0; right:0; left:0;"}).appendTo(j)).editableList({addButton:!1,scrollOnAdd:!1,addItem:function(e,t,n){v(e,n,n.indexStatus,"staged")},sort:function(e,t){return e.file.localeCompare(t.file)}}),commitBox=$('<div class="sidebar-version-control-slide-box sidebar-version-control-slide-box-bottom"></div>').hide().appendTo(c.content);var O=$('<textarea placeholder="Enter your commit message"></textarea>').appendTo(commitBox).on("change keyup paste",function(){N.attr("disabled",""===$(this).val().trim())}),L=$('<div class="sidebar-version-control-slide-box-toolbar button-group">').appendTo(commitBox),P=$('<button class="editor-button">Cancel</button>').appendTo(L).click(function(e){e.preventDefault(),O.val(""),w.css("height",""),r.css("height",""),j.css("height",""),commitBox.css("height",0),setTimeout(function(){commitBox.hide()},200),o.attr("disabled",!1),i.attr("disabled",!1),l.attr("disabled",!1),C.attr("disabled",!1)}),N=$('<button class="editor-button">Commit</button>').appendTo(L).click(function(e){e.preventDefault();var t=h.addSpinnerOverlay(N).addClass("projects-dialog-spinner-sidebar"),n=RED.projects.getActiveProject();RED.deploy.setDeployInflight(!0),h.sendRequest({url:"projects/"+n.name+"/commit",type:"POST",responses:{0:function(e){console.log(e)},200:function(e){t.remove(),P.click(),x(!0)},400:{"*":function(e){h.reportUnexpectedError(e)}}}},{message:O.val()}).always(function(){setTimeout(function(){RED.deploy.setDeployInflight(!1)},500)})}),I=t.add({title:"Commit History",collapsible:!0});y=$('<div style="float: right"></div>').appendTo(I.header),$('<button class="editor-button editor-button-small"><i class="fa fa-refresh"></i></button>').appendTo(y).click(function(e){e.preventDefault(),x(!0,!0)});var A=$('<div class="sidebar-version-control-change-header" style="text-align: right;"></div>').appendTo(I.content),z=$('<button class="editor-button editor-button-small"><i class="fa fa-code-fork"></i> Branch: <span id="sidebar-version-control-local-branch"></span></button>').appendTo(A).click(function(e){if(e.preventDefault(),$(this).hasClass("selected"))B();else{F(),u.show(),$(this).addClass("selected");var t=RED.projects.getActiveProject();U.refresh("projects/"+t.name+"/branches"),J.show(),setTimeout(function(){J.css("height","215px"),U.focus()},100)}}),M=$('<button class="editor-button editor-button-small" style="margin-left: 10px;" id="sidebar-version-control-repo-status-button"><span id="sidebar-version-control-repo-status-stats"><i class="fa fa-long-arrow-up"></i> <span id="sidebar-version-control-commits-ahead"></span> <i class="fa fa-long-arrow-down"></i> <span id="sidebar-version-control-commits-behind"></span></span><span id="sidebar-version-control-repo-status-auth-issue"><i class="fa fa-warning"></i></span></button>').appendTo(A).click(function(e){e.preventDefault(),$(this).hasClass("selected")?F():(B(),u.show(),$(this).addClass("selected"),G.show(),setTimeout(function(){G.css("height","265px")},100))});p=$("<ol>",{style:"position: absolute; top: 30px; bottom: 0px; right:0; left:0;"}).appendTo(I.content),u=$('<div class="component-shade" style="z-Index: 3"></div>').css("top","30px").hide().appendTo(I.content),p.editableList({addButton:!1,scrollOnAdd:!1,addItem:function(e,t,n){if(e.addClass("sidebar-version-control-commit-entry"),n.url)e.addClass("sidebar-version-control-commit-more"),e.text("+ "+(n.total-n.totalKnown)+" more commit(s)"),e.click(function(t){t.preventDefault(),E(n.url,p,e,n.limit,n.before)});else{e.click(function(e){var t=RED.projects.getActiveProject();t&&$.getJSON("projects/"+t.name+"/commits/"+n.sha,function(e){e.project=t,e.parents=n.parents,e.oldRev=n.sha+"~1",e.newRev=n.sha,e.oldRevTitle="Commit "+n.sha.substring(0,7)+"~1",e.newRevTitle="Commit "+n.sha.substring(0,7),e.date=m(parseInt(n.date)),RED.diff.showCommitDiff(e)})});var o=$("<div>").appendTo(e);if($('<div class="sidebar-version-control-commit-subject">').text(n.subject).appendTo(o),n.refs){var a=$('<div class="sidebar-version-control-commit-refs">').appendTo(o);n.refs.forEach(function(e){var t=e;/HEAD -> /.test(e)&&(t=e.substring(8)),$('<span class="sidebar-version-control-commit-ref">').text(t).appendTo(a)}),e.addClass("sidebar-version-control-commit-head")}$('<div class="sidebar-version-control-commit-sha">').text(n.sha.substring(0,7)).appendTo(o),$('<div class="sidebar-version-control-commit-date">').text(m(parseInt(n.date))).appendTo(o)}}});var B=function(e){z.removeClass("selected"),J.css("height","0"),u.hide(),setTimeout(function(){J.hide(),e&&e()},200)},J=$('<div class="sidebar-version-control-slide-box sidebar-version-control-slide-box-top" style="top:30px;"></div>').hide().appendTo(I.content);$('<div class="sidebar-version-control-slide-box-header"></div>').text("Change local branch").appendTo(J);var U=h.createBranchList({placeholder:"Find or create a branch",container:J,onselect:function(e){if(e.current)return B();var t=h.addSpinnerOverlay(J),n=RED.projects.getActiveProject();RED.deploy.setDeployInflight(!0),h.sendRequest({url:"projects/"+n.name+"/branches",type:"POST",requireCleanWorkspace:!0,cancel:function(){t.remove()},responses:{0:function(e){t.remove(),console.log(e)},200:function(e){B(function(){t.remove()})},400:{git_local_overwrite:function(e){t.remove(),RED.notify("You have local changes that would be overwritten by changing the branch. You must either commit or undo those changes first.",{type:"error",timeout:8e3})},unexpected_error:function(e){t.remove(),console.log(e)}}}},e).always(function(){setTimeout(function(){RED.deploy.setDeployInflight(!1)},500)})}}),G=$('<div class="sidebar-version-control-slide-box sidebar-version-control-slide-box-top" style="top:30px"></div>').hide().appendTo(I.content),F=function(){$("#sidebar-version-control-repo-toolbar-set-upstream").prop("checked",!1),M.removeClass("selected"),G.css("height","0"),u.hide(),setTimeout(function(){G.hide(),V()},200)},V=function(e){W.hasClass("selected")&&(W.removeClass("selected"),Y.height(0),G.css("height","265px"),setTimeout(function(){Y.hide(),e&&e()},200))};$('<div class="sidebar-version-control-slide-box-header"></div>').text("Manage remote branch").appendTo(G);var q=$('<div style="margin-bottom: 5px;"></div>').appendTo(G),W=$('<button id="sidebar-version-control-repo-branch" class="sidebar-version-control-repo-action editor-button"><i class="fa fa-code-fork"></i> Remote: <span id="sidebar-version-control-remote-branch"></span></button>').appendTo(q).click(function(e){if(e.preventDefault(),$(this).hasClass("selected"))V();else{$(this).addClass("selected");var t=RED.projects.getActiveProject();X.refresh("projects/"+t.name+"/branches/remote"),Y.show(),setTimeout(function(){Y.height(180),G.css("height","445px"),X.focus()},100)}});$('<div id="sidebar-version-control-repo-toolbar-message" class="sidebar-version-control-slide-box-header" style="min-height: 100px;"></div>').appendTo(G);var H=$('<div id="sidebar-version-control-repo-toolbar-error-message" class="sidebar-version-control-slide-box-header" style="min-height: 100px;"></div>').hide().appendTo(G);$('<div style="margin-top: 10px;"><i class="fa fa-warning"></i> Unable to access remote repository</div>').appendTo(H);var K=$('<div style="margin: 10px 30px; text-align: center"></div>').appendTo(H);$('<button class="editor-button" style="width: 80%;"><i class="fa fa-refresh"></i> Retry</button>').appendTo(K).click(function(e){e.preventDefault();var t=RED.projects.getActiveProject(),n=h.addSpinnerOverlay(G).addClass("projects-dialog-spinner-contain");h.sendRequest({url:"projects/"+t.name+"/branches/remote",type:"GET",responses:{0:function(e){console.log(e)},200:function(e){x(!0)},400:{git_connection_failed:function(e){RED.notify(e.message,"error")},git_not_a_repository:function(e){RED.notify(e.message,"error")},git_repository_not_found:function(e){RED.notify(e.message,"error")},unexpected_error:function(e){console.log(e)}}}}).always(function(){n.remove()})}),$('<div class="sidebar-version-control-slide-box-header" style="height: 20px;"><label id="sidebar-version-control-repo-toolbar-set-upstream-row" for="sidebar-version-control-repo-toolbar-set-upstream" class="hide"><input type="checkbox" id="sidebar-version-control-repo-toolbar-set-upstream"> Set as upstream branch</label></div>').appendTo(G);var Y=$('<div style="height: 0;overflow:hidden; transition: height 0.2s ease-in-out;"></div>').hide().appendTo(q),X=h.createBranchList({placeholder:"Find or create a remote branch",currentLabel:"upstream",remote:function(){var e=RED.projects.getActiveProject();return Object.keys(e.git.remotes)[0]},container:Y,onselect:function(e){$("#sidebar-version-control-repo-toolbar-set-upstream").prop("checked",!1),$("#sidebar-version-control-repo-toolbar-set-upstream").prop("disabled",!1),$("#sidebar-version-control-remote-branch").text(e.name+(e.create?" *":""));var t=RED.projects.getActiveProject();t.git.branches.remote===e.name?delete t.git.branches.remoteAlt:t.git.branches.remoteAlt=e.name,$("#sidebar-version-control-repo-toolbar-set-upstream-row").toggle(!!t.git.branches.remoteAlt),V(function(){if(e.create)t.git.branches.remote?$("#sidebar-version-control-repo-toolbar-message").text("The branch will be created. Select below to set it as the tracked upstream branch."):($("#sidebar-version-control-repo-toolbar-message").text("The created branch will be set as the tracked upstream branch."),$("#sidebar-version-control-repo-toolbar-set-upstream").prop("checked",!0),$("#sidebar-version-control-repo-toolbar-set-upstream").prop("disabled",!0)),$("#sidebar-version-control-repo-pull").attr("disabled",!0),$("#sidebar-version-control-repo-push").attr("disabled",!1);else{var n=Date.now(),o=h.addSpinnerOverlay($("#sidebar-version-control-repo-toolbar-message")).addClass("projects-dialog-spinner-contain");$.getJSON("projects/"+t.name+"/branches/remote/"+e.name+"/status",function(e){setTimeout(function(){T(e.commits.ahead,e.commits.behind),o.remove()},Math.max(400-(Date.now()-n),0))})}})}}),Z=$('<div style="margin-bottom: 5px;"></div>').appendTo(G);$('<button id="sidebar-version-control-repo-push" class="sidebar-version-control-repo-sub-action editor-button"><i class="fa fa-long-arrow-up"></i> <span>push</span></button>').appendTo(Z).click(function(e){e.preventDefault();var t=h.addSpinnerOverlay(G).addClass("projects-dialog-spinner-contain"),n=RED.projects.getActiveProject(),o="projects/"+n.name+"/push";n.git.branches.remoteAlt&&(o+="/"+n.git.branches.remoteAlt),$("#sidebar-version-control-repo-toolbar-set-upstream").prop("checked")&&(o+="?u=true"),h.sendRequest({url:o,type:"POST",responses:{0:function(e){console.log(e)},200:function(e){x(!0),F()},400:{git_push_failed:function(e){RED.notify("NLS: Push failed as the remote has more recent commits. Pull first and write a better error message!","error")},unexpected_error:function(e){console.log(e)}}}},{}).always(function(){t.remove()})});var Q=function(e){e=e||{};var t=h.addSpinnerOverlay(G).addClass("projects-dialog-spinner-contain"),n=RED.projects.getActiveProject(),o="projects/"+n.name+"/pull";n.git.branches.remoteAlt&&(o+="/"+n.git.branches.remoteAlt),(e.setUpstream||e.allowUnrelatedHistories)&&(o+="?"),e.setUpstream&&(o+="setUpstream=true",e.allowUnrelatedHistories&&(o+="&")),e.allowUnrelatedHistories&&(o+="allowUnrelatedHistories=true"),h.sendRequest({url:o,type:"POST",responses:{0:function(e){console.log(e)},200:function(e){x(!0),F()},400:{git_local_overwrite:function(e){RED.notify('<p>Unable to pull remote changes; your unstaged local changes would be overwritten.</p><p>Commit your changes and try again.</p><p><a href="#" onclick="RED.sidebar.versionControl.showLocalChanges(); return false;">Show unstaged changes</a></p>',"error",!1,1e7)},git_pull_merge_conflict:function(e){x(!0),F()},git_connection_failed:function(e){RED.notify("Could not connect to remote repository: "+e.toString(),"warning")},git_pull_unrelated_history:function(t){var n=RED.notify("<p>The remote has an unrelated history of commits.</p><p>Are you sure you want to pull the changes into your local repository?</p>",{type:"error",modal:!0,fixed:!0,buttons:[{text:RED._("common.label.cancel"),click:function(){n.close()}},{text:"Pull changes",click:function(){n.close(),e.allowUnrelatedHistories=!0,Q(e)}}]})},"*":function(e){h.reportUnexpectedError(e)}}}},{}).always(function(){t.remove()})};$('<button id="sidebar-version-control-repo-pull" class="sidebar-version-control-repo-sub-action editor-button"><i class="fa fa-long-arrow-down"></i> <span>pull</span></button>').appendTo(Z).click(function(e){e.preventDefault(),Q({setUpstream:$("#sidebar-version-control-repo-toolbar-set-upstream").prop("checked")})}),$('<div class="component-shade sidebar-version-control-shade">').appendTo(e),RED.sidebar.addTab({id:"version-control",label:"history",name:"Project History",content:e,enableOnEdit:!1,onchange:function(){setTimeout(function(){t.resize()},10)}})},show:k,refresh:x,showLocalChanges:function(){RED.sidebar.show("version-control"),c.expand()}}}(),RED.touch=RED.touch||{},RED.touch.radialMenu=function(){var e=null,t=!1,n=!1,o=null;return{show:function(a,i,s){t=!0;try{$("body").width(),$("body").height();for(var r=(e=d3.select("body").append("div").style({position:"absolute",top:0,left:0,bottom:0,right:0,"z-index":1e3}).on("touchstart",function(){v(),d3.event.preventDefault()})).append("div").style({position:"absolute",top:i[1]-80+"px",left:i[0]-80+"px","border-radius":"80px",width:"160px",height:"160px",background:"rgba(255,255,255,0.6)",border:"1px solid #666"}),d=[],l=function(e,t,n){n.el=r.append("div").style({position:"absolute",top:t+80-25+"px",left:e+80-25+"px","border-radius":"20px",width:"50px",height:"50px",background:"#fff",border:"2px solid #666","text-align":"center","line-height":"50px"}),n.el.html(n.name),n.disabled&&n.el.style({"border-color":"#ccc",color:"#ccc"}),n.x=e,n.y=t,d.push(n),n.el.on("touchstart",function(){n.el.style("background","#999"),d3.event.preventDefault(),d3.event.stopPropagation()}),n.el.on("touchend",function(){v(),n.onselect(),d3.event.preventDefault(),d3.event.stopPropagation()})},c=s.length,p=Math.max(Math.PI/(c-1),Math.PI/4),u=Math.PI,f=0;f<c;f++){var h=Math.floor(80*Math.cos(u)),g=Math.floor(80*Math.sin(u));s[f].name&&l(h,g,s[f]),u+=p}var v=function(){t=!1,o=null,e.remove(),e=null};a.on("touchend.radial",function(){if(a.on("touchend.radial",null),a.on("touchmenu.radial",null),o){try{o.onselect()}catch(e){RED._debug(e)}v()}else n&&v()}),a.on("touchmove.radial",function(){try{for(var e=d3.event.touches.item(0),t=[e.pageX-i[0],e.pageY-i[1]],a=0;a<d.length;a++){var s=d[a];s.disabled||(t[0]>s.x-30&&t[0]<s.x+30&&t[1]>s.y-30&&t[1]<s.y+30?s!==o&&(s.el.style("background","#999"),o=s):s===o?(s.el.style("background","#fff"),o=null):s.el.style("background","#fff"))}if(!o){var r=Math.abs(t[0]*t[0]+t[1]*t[1]);n=r>6400}}catch(e){RED._debug(e)}})}catch(e){RED._debug(e)}},active:function(){return t}}}();